# Story 2.5: Submit Borrower Application

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to submit my completed loan application for underwriting review,
**so that** banks can evaluate my creditworthiness and provide loan offers.

## Acceptance Criteria

1. POST /api/borrower/applications/{applicationId}/submit endpoint transitions application from DRAFT to SUBMITTED
2. Submission requires: loan_type, loan_amount, loan_term_months, currency (all filled in)
3. Optional but recommended: annual_income, employment_status, down_payment_amount
4. Validation: application must be in DRAFT status (409 if already submitted)
5. Submission creates audit trail entry (ApplicationHistory: DRAFT -> SUBMITTED)
6. Borrower receives confirmation email with application details
7. Application becomes visible to banks in their application queue (Story 4.1)
8. Response returns updated ApplicationDTO with status=SUBMITTED and submission timestamp
9. Only borrower who owns the application can submit it (403 Forbidden otherwise)
10. No rate limiting on submissions (unlike creation in Story 2.2)

## Tasks / Subtasks

- [ ] Task 1: Create Submit Application Request/Response DTOs (AC: 2, 3, 8)
  - [ ] Create SubmitApplicationRequest DTO (src/main/java/com/creditapp/borrower/dto/SubmitApplicationRequest.java)
    - Empty request body (POST body required for consistency, but no parameters)
    - Or: optional confirmationFlag: Boolean (user confirms submission)
    - Validation: confirmationFlag must be true if provided
  - [ ] Create SubmitApplicationResponse DTO (src/main/java/com/creditapp/borrower/dto/SubmitApplicationResponse.java)
    - Fields: id, status, submittedAt, message, application (full ApplicationDTO)
    - Message: "Application submitted successfully. Banks will review and contact you with offers."
  - [ ] Unit tests: test DTO serialization/deserialization

- [ ] Task 2: Create Application Submission Service (AC: 2, 3, 4, 5)
  - [ ] Create SubmitApplicationService or extend ApplicationService
    - Method: submitApplication(UUID applicationId, UUID borrowerId) returns SubmitApplicationResponse
    - Verify borrower owns application (access control)
    - Verify application status == DRAFT (throw ApplicationAlreadySubmittedException if not)
    - Validate required fields: loan_type, loan_amount, loan_term_months, currency must be non-null
    - Throw SubmissionValidationException if required fields missing
    - Update application: status = ApplicationStatus.SUBMITTED, submittedAt = now
    - Save to ApplicationRepository
    - Record status transition via ApplicationStatusTransitionService:
      - Old status: DRAFT
      - New status: SUBMITTED
      - Changed by: borrowerId
      - Reason: "Borrower submitted application for underwriting review"
    - Log APPLICATION_SUBMITTED audit event via AuditService
    - Return SubmitApplicationResponse
    - Error handling:
      - ApplicationNotFoundException (404)
      - AccessDeniedException (403) - different borrower
      - ApplicationAlreadySubmittedException (409) - not DRAFT status
      - SubmissionValidationException (400) - missing required fields
  - [ ] Unit tests: mock repositories, test validation, test status transition

- [ ] Task 3: Create Submission Notification Service (AC: 6)
  - [ ] Create ApplicationSubmissionEmailService (src/main/java/com/creditapp/shared/service/ApplicationSubmissionEmailService.java)
    - Method: sendSubmissionConfirmation(UUID applicationId, String borrowerEmail, String borrowerName) returns boolean
    - Use SendGrid to send confirmation email
    - Email includes: application summary (loan type, amount, term), submission timestamp, next steps
    - Email message: "Your application has been submitted successfully. Banks will review and contact you within 2-5 business days."
    - Email sending is non-blocking: use @Async
    - Handle email sending failures gracefully (log but don't fail application submission)
    - Unit tests: mock SendGrid, verify email method called with correct parameters

- [ ] Task 4: Create Submit Application REST Endpoint (AC: 1, 4, 8, 9)
  - [ ] Add POST endpoint in BorrowerApplicationController
    - Endpoint: POST /api/borrower/applications/{applicationId}/submit
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Path parameter: applicationId (UUID)
    - Request body: @Valid SubmitApplicationRequest (can be empty or minimal)
    - Extract borrowerId from SecurityContext
    - Call SubmitApplicationService.submitApplication(applicationId, borrowerId)
    - Send confirmation email asynchronously via ApplicationSubmissionEmailService
    - Return: ResponseEntity<SubmitApplicationResponse> with HTTP 200 OK
    - Response includes: id, status=SUBMITTED, submittedAt, message, full application details
    - Error handling:
      - 400 Bad Request: missing required fields (validation)
      - 401 Unauthorized: not authenticated
      - 403 Forbidden: not borrower
      - 404 Not Found: application doesn't exist
      - 409 Conflict: application already submitted (not DRAFT)
      - 500 Internal Server Error: unexpected failures
    - Controller logs: borrowerId, applicationId, status (success/failure)
  - [ ] Unit tests: mock SubmitApplicationService, test success and error paths
  - [ ] Integration tests: real HTTP requests with JWT token

- [ ] Task 5: Add Exception Handlers (AC: 4, 5)
  - [ ] Create custom exceptions:
    - ApplicationAlreadySubmittedException (extends RuntimeException)
    - SubmissionValidationException (extends RuntimeException)
    - ApplicationSubmissionException (extends RuntimeException)
  - [ ] Update GlobalExceptionHandler (src/main/java/com/creditapp/shared/exception/GlobalExceptionHandler.java)
    - @ExceptionHandler for ApplicationAlreadySubmittedException  409 Conflict
      - Response: { "error": "Application Already Submitted", "message": "This application has already been submitted.", "currentStatus": "SUBMITTED" }
    - @ExceptionHandler for SubmissionValidationException  400 Bad Request
      - Response: { "error": "Submission Validation Failed", "message": "Required fields missing: annual_income, employment_status", "missingFields": [...] }
    - @ExceptionHandler for ApplicationSubmissionException  500 Internal Server Error
  - [ ] Unit tests: test exception handler responses

- [ ] Task 6: Add Audit Logging (AC: 5)
  - [ ] Ensure SubmitApplicationService logs to AuditService:
    - Event: APPLICATION_SUBMITTED
    - Fields: borrower_id, application_id, loan_type, loan_amount, loan_term_months, submittedAt
    - Include submission timestamp and source (API endpoint)
  - [ ] Ensure ApplicationStatusTransitionService creates ApplicationHistory entry:
    - Old status: DRAFT
    - New status: SUBMITTED
    - Changed by: borrowerId
    - Change reason: "Borrower submission"
  - [ ] Verify audit log entries created after successful submission

- [ ] Task 7: Create Unit Tests (AC: 2, 4, 5, 8)
  - [ ] Create ApplicationSubmissionUnitTest (src/test/java/com/creditapp/unit/borrower/ApplicationSubmissionUnitTest.java)
    - Test 1: Happy path - submit valid DRAFT application, verify status=SUBMITTED
    - Test 2: Submit application without loan_type, verify SubmissionValidationException
    - Test 3: Submit application without loan_amount, verify SubmissionValidationException
    - Test 4: Submit application without loan_term_months, verify SubmissionValidationException
    - Test 5: Submit already submitted application, verify ApplicationAlreadySubmittedException
    - Test 6: Submit application with optional fields (income, employment), verify all persisted
    - Test 7: Verify submittedAt timestamp set to current time
    - Test 8: Verify ApplicationStatusTransitionService called with DRAFT->SUBMITTED
    - Test 9: Verify AuditService.logEvent() called with APPLICATION_SUBMITTED
    - Test 10: Verify email service called asynchronously
  - [ ] Mock: ApplicationRepository, ApplicationStatusTransitionService, ApplicationSubmissionEmailService
  - [ ] Framework: JUnit 5, Mockito

- [ ] Task 8: Create Access Control Tests (AC: 9)
  - [ ] Create ApplicationSubmissionAccessControlTest
    - Test 1: Borrower submit own DRAFT application, verify 200 OK
    - Test 2: Borrower A submit Borrower B's application, verify 403 Forbidden
    - Test 3: BANK_ADMIN role submit application, verify 403 Forbidden
    - Test 4: Unauthenticated POST request, verify 401 Unauthorized
  - [ ] Use Spring Security Test with @WithMockUser

- [ ] Task 9: Create Integration Tests (AC: 1, 2, 4, 5, 6, 8, 9)
  - [ ] Create ApplicationSubmissionIntegrationTest (src/test/java/com/creditapp/integration/borrower/ApplicationSubmissionIntegrationTest.java)
    - Setup: Create borrower, create DRAFT application with Story 2.2
    - Test 1: POST submit valid application, verify 200 OK with status=SUBMITTED
    - Test 2: POST submit application, verify persisted in database with SUBMITTED status
    - Test 3: POST submit application, verify submittedAt timestamp set
    - Test 4: POST submit application with minimal required fields, verify success
    - Test 5: POST submit application without loan_type, verify 400 Bad Request
    - Test 6: POST submit application without loan_amount, verify 400 Bad Request
    - Test 7: POST submit application without loan_term_months, verify 400 Bad Request
    - Test 8: Submit DRAFT application, attempt submit again, verify 409 Conflict
    - Test 9: Verify ApplicationHistory entry created (DRAFT->SUBMITTED transition)
    - Test 10: Verify ApplicationHistory entry includes borrower_id as changed_by_user_id
    - Test 11: Verify audit log entry created with APPLICATION_SUBMITTED event
    - Test 12: Verify confirmation email sent (mock SendGrid)
    - Test 13: Submit application, verify no longer appears in borrower's "draft" list
    - Test 14: Submit application, verify appears in banks' queue (if Story 4.1 available)
    - Test 15: Different borrower cannot submit another's application (403 Forbidden)
    - Test 16: POST submit returns full ApplicationDTO with updated status
  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate, @WithMockUser for auth
  - [ ] Mock SendGrid for email verification
  - [ ] Database: Real database with applications from Story 2.2

- [ ] Task 10: Create Validation Tests (AC: 2, 3)
  - [ ] Create ApplicationSubmissionValidationTest
    - Test 1: Submit with all required fields present, verify success
    - Test 2: Submit with loan_type=null, verify SubmissionValidationException
    - Test 3: Submit with loan_amount=null, verify SubmissionValidationException
    - Test 4: Submit with loan_term_months=null, verify SubmissionValidationException
    - Test 5: Submit with currency=null, verify SubmissionValidationException
    - Test 6: Submit with optional fields (income, employment, down_payment) provided, verify accepted
    - Test 7: Submit with applicationDetails=null, verify optional (allowed)
    - Test 8: Response includes error message listing missing required fields
  - [ ] Framework: JUnit 5, Spring validation testing

- [ ] Task 11: Create Status Transition Tests (AC: 4, 5)
  - [ ] Create ApplicationStatusTransitionTest
    - Test 1: DRAFT->SUBMITTED transition recorded in ApplicationHistory
    - Test 2: ApplicationHistory.oldStatus = DRAFT, newStatus = SUBMITTED
    - Test 3: ApplicationHistory.changedByUserId = borrower_id
    - Test 4: ApplicationHistory.changeReason contains "Borrower submission" or similar
    - Test 5: ApplicationHistory.changedAt = current timestamp
    - Test 6: Attempt invalid transition (e.g., SUBMITTED->DRAFT), verify prevented
  - [ ] Integration test: verify state machine enforced

- [ ] Task 12: Create Email Notification Tests (AC: 6)
  - [ ] Create ApplicationSubmissionEmailTest
    - Test 1: Submit application, verify email sent to borrower
    - Test 2: Email includes application details (loan type, amount, term)
    - Test 3: Email includes submission timestamp
    - Test 4: Email includes next steps message
    - Test 5: Email sending is asynchronous (doesn't delay submission response)
    - Test 6: Email sending failure doesn't fail submission (graceful degradation)
  - [ ] Mock SendGrid, verify email method called with correct parameters
  - [ ] Use @Async testing patterns

- [ ] Task 13: Create Workflow Integration Tests (AC: 1, 2, 8)
  - [ ] Create ApplicationSubmissionWorkflowTest
    - Test 1: Create app (2.2)  List apps (2.3, verify DRAFT)  Edit app (2.4, optional)  Submit (2.5)  Verify status=SUBMITTED
    - Test 2: Create app  Submit  View details (2.3 GET /id, verify SUBMITTED)  Verify cannot edit (Story 2.4 should reject)
    - Test 3: Create app  Submit  Submit again (409 Conflict)
    - Test 4: Create minimal app  Submit (verify optional fields don't block submission)
    - Test 5: Create app with details  Edit details  Submit  Verify final details persisted
  - [ ] Integration test combining Stories 2.2, 2.3, 2.4, 2.5

- [ ] Task 14: Create API Documentation (AC: 1, 2, 8)
  - [ ] Update docs/API_ENDPOINTS.md
    - POST /api/borrower/applications/{applicationId}/submit
      - Authentication: Bearer {JWT token}, BORROWER role required
      - Path parameter: applicationId (UUID)
      - Request body: {} (empty JSON or minimal SubmitApplicationRequest)
      - Response (200 OK):
        `json
        {
          "id": "550e8400-e29b-41d4-a716-446655440000",
          "status": "SUBMITTED",
          "submittedAt": "2026-01-15T15:30:00Z",
          "message": "Application submitted successfully. Banks will review and contact you with offers.",
          "application": {
            "id": "550e8400-e29b-41d4-a716-446655440000",
            "loanType": "PERSONAL",
            "loanAmount": 25000,
            "loanTermMonths": 36,
            "currency": "EUR",
            "ratePreference": "VARIABLE",
            "status": "SUBMITTED",
            "createdAt": "2026-01-14T10:30:00Z",
            "submittedAt": "2026-01-15T15:30:00Z",
            "updatedAt": "2026-01-15T15:30:00Z"
          }
        }
        `
      - Error responses:
        - 400 Bad Request: missing required fields (loan_type, loan_amount, loan_term_months, currency)
        - 401 Unauthorized: not authenticated
        - 403 Forbidden: not borrower
        - 404 Not Found: application doesn't exist
        - 409 Conflict: application already submitted (not DRAFT)
      - Submission triggers: confirmation email sent, banks can view in queue
      - Validation note: Required fields must be filled before submission

## Dev Notes

### Previous Story Dependencies
- **Story 2.1**: Application entity, ApplicationStatus enum, ApplicationHistory
- **Story 2.2**: CreateApplicationService, application creation
- **Story 2.3**: ListApplicationsService, view endpoints
- **Story 2.4**: EditApplicationService, update endpoints
- **Story 1.6**: RBAC - @PreAuthorize("hasAuthority('BORROWER')")
- **Story 1.7**: AuditService for logging

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Web MVC
- **Email Service**: SendGrid (reuse from Story 1.3)
- **Async Processing**: @Async for non-blocking email sending
- **Testing**: JUnit 5, Mockito, TestContainers

### Application Status State Machine
[Source: Story 2.1 and architecture]
`
DRAFT > SUBMITTED > UNDER_REVIEW > OFFERS_AVAILABLE > ACCEPTED > COMPLETED
                  > REJECTED      > EXPIRED
                            
                           WITHDRAWN
`

**Submission Flow:**
1. Borrower creates application in DRAFT state
2. Borrower edits application (optional) to add details
3. Borrower submits application:
   - Status transitions DRAFT  SUBMITTED
   - submittedAt timestamp recorded
   - ApplicationHistory entry created
   - Audit log entry created
   - Confirmation email sent
   - Application visible to banks in queue

### Submission Validation Rules
[Source: Story 2.5 AC]
- **Required Fields**: loan_type, loan_amount, loan_term_months, currency (must not be null)
- **Optional Fields**: annual_income, employment_status, down_payment_amount (optional but recommended)
- **Status Check**: Application must be in DRAFT status
- **Borrower Check**: Only borrower who owns application can submit

### Email Notification
[Source: Story 1.3 and requirements]
**Email Content:**
- Subject: "Loan Application Submitted - Reference #{applicationId}"
- Body includes:
  - Greeting with borrower name
  - Application summary (loan type, amount, term, currency)
  - Submission timestamp
  - Next steps: "Banks in our network will review your application and contact you within 2-5 business days."
  - Support contact information
- **Async Delivery**: Sent in background, doesn't delay API response
- **Failure Handling**: Log error but don't fail submission if email fails to send

### Audit Logging
[Source: architecture/7-monitoring-observability.md]
**Event:** APPLICATION_SUBMITTED
**Fields:**
- timestamp: ISO-8601 UTC
- event_type: "APPLICATION_SUBMITTED"
- borrower_id: UUID
- application_id: UUID
- loan_type: VARCHAR
- loan_amount: DECIMAL
- loan_term_months: INT
- currency: VARCHAR
- submittedAt: TIMESTAMP
- status_transition: "DRAFT -> SUBMITTED"

**ApplicationHistory Entry:**
- application_id: UUID
- old_status: "DRAFT"
- new_status: "SUBMITTED"
- changed_by_user_id: borrower_id
- changed_at: TIMESTAMP
- change_reason: "Borrower submission"

### Project Directory Structure
[Source: Story 1.1 context]
`
src/main/java/com/creditapp/
 borrower/
    controller/        # BorrowerApplicationController.java (add POST /submit endpoint)
    service/           # SubmitApplicationService.java
    dto/               # SubmitApplicationRequest.java, SubmitApplicationResponse.java
    exception/         # ApplicationAlreadySubmittedException.java, SubmissionValidationException.java
 shared/
    service/           # ApplicationSubmissionEmailService.java (extends email services from 1.3)
    exception/         # GlobalExceptionHandler.java (add handlers for new exceptions)
    audit/             # AuditService.java (from Story 1.7, called here)

src/test/java/com/creditapp/
 unit/
    borrower/
      ApplicationSubmissionUnitTest.java
      ApplicationSubmissionAccessControlTest.java
      ApplicationSubmissionValidationTest.java
      ApplicationStatusTransitionTest.java
      ApplicationSubmissionEmailTest.java
 integration/
    borrower/
      ApplicationSubmissionIntegrationTest.java
      ApplicationSubmissionWorkflowTest.java
`

### Testing Standards
[Source: frontend-architecture/10-testing-strategy.md]
- **Unit Tests**: Mock repositories, email service, test validation and state transitions
- **Integration Tests**: Real database (TestContainers), real HTTP client, full workflows
- **Test Framework**: JUnit 5, Mockito, Spring Boot Test
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/
- **Coverage Goal**: 80%+ code coverage

### Important Notes
1. **Status Check**: Enforce DRAFT-only submission; prevent resubmission of already submitted apps
2. **Required Fields**: Loan type, amount, term, currency must be non-null before submission
3. **Async Email**: Use @Async to send confirmation email without blocking response
4. **State Transition**: Record status change in ApplicationHistory for audit trail
5. **Audit Logging**: Log APPLICATION_SUBMITTED event with all submission details
6. **Error Handling**: Provide specific error messages for validation failures
7. **Email Failures**: Log but don't fail submission if email sending fails (graceful degradation)
8. **Access Control**: Verify borrower owns application before allowing submission
9. **Immutable History**: ApplicationHistory is append-only; status transitions create new entries
10. **Queue Visibility**: After submission, application becomes visible to banks (Story 4.1 dependency)

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, Spring Security Test, TestContainers
- **HTTP Client**: TestRestTemplate
- **Mocking**: Mockito, WireMock for SendGrid
- **Async Testing**: Spring @Async patterns
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/

### Testing Checklist
- [ ] SubmitApplicationRequest DTO deserializes correctly
- [ ] SubmitApplicationService validates required fields (loan_type, loan_amount, loan_term_months, currency)
- [ ] SubmitApplicationService checks application status == DRAFT
- [ ] SubmitApplicationService throws ApplicationAlreadySubmittedException if not DRAFT
- [ ] SubmitApplicationService calls ApplicationStatusTransitionService to record status change
- [ ] SubmitApplicationService calls AuditService.logEvent() with APPLICATION_SUBMITTED
- [ ] SubmitApplicationService sets submittedAt timestamp to current time
- [ ] ApplicationSubmissionEmailService sends confirmation email asynchronously
- [ ] Email includes borrower name, application details, submission timestamp
- [ ] Email service failure doesn't prevent submission (graceful degradation)
- [ ] BorrowerApplicationController POST /submit returns 200 OK with SubmitApplicationResponse
- [ ] SubmitApplicationResponse includes id, status=SUBMITTED, submittedAt, full application details
- [ ] POST /submit requires @PreAuthorize BORROWER role
- [ ] GlobalExceptionHandler returns 400 for SubmissionValidationException
- [ ] GlobalExceptionHandler returns 409 for ApplicationAlreadySubmittedException
- [ ] Integration test: submit DRAFT application, verify SUBMITTED in database
- [ ] Integration test: submit already submitted application, verify 409 Conflict
- [ ] Integration test: submit without required fields, verify 400 Bad Request with missing field list
- [ ] Integration test: access control - different borrower cannot submit (403)
- [ ] Integration test: ApplicationHistory entry created with DRAFT->SUBMITTED transition
- [ ] Integration test: confirmation email sent and can be verified
- [ ] Workflow test: create  (optional edit)  submit  verify workflow
- [ ] Workflow test: submit  view details  verify updated status
- [ ] Audit logging: APPLICATION_SUBMITTED event logged with all required fields
- [ ] Status transition: ApplicationHistory records change with borrower_id as changed_by
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - Submit Borrower Application | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
