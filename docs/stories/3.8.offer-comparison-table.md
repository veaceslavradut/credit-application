# Story 3.8: Offer Comparison Table (UI Endpoint)

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to see all my preliminary offers in a sortable, filterable comparison table,
**so that** I can easily identify the best offer for my needs.

## Acceptance Criteria

1. GET /api/borrower/applications/{applicationId}/offers-table returns offer comparison data
2. Response includes: bank name, APR, monthly payment, total cost, origination fee, insurance cost, term, processing time, validity period, status
3. Sortable by: APR (default), monthly payment, total cost, bank name
4. Filterable by: APR range, monthly payment range, bank category
5. Response includes pagination: limit, offset, total count
6. Response includes expiration countdown: days/hours/minutes remaining
7. Includes "select offer" button state: enabled/disabled based on offer status
8. Response includes comparison mode: full details vs. summary
9. Performance: <100ms response time including all filters/sorts
10. Integration test: retrieve offers table, apply filters/sorts, verify results

## Tasks / Subtasks

- [ ] Task 1: Create Offer Comparison Table Request/Response DTOs (AC: 1, 5, 6, 7)
  - [ ] Create OfferComparisonTableRequest (src/main/java/com/creditapp/borrower/dto/OfferComparisonTableRequest.java)
    - Field: sortBy (String, optional) - values: "apr", "monthlyPayment", "totalCost", "bankName"
      - Default: "apr"
      - Validation: @Pattern regex
    - Field: sortOrder (String, optional) - values: "asc", "desc"
      - Default: "asc"
    - Field: limit (Integer, optional)
      - Default: 20, Max: 100
    - Field: offset (Integer, optional)
      - Default: 0
    - Field: aprMin (BigDecimal, optional) - filter minimum APR
    - Field: aprMax (BigDecimal, optional) - filter maximum APR
    - Field: monthlyPaymentMin (BigDecimal, optional)
    - Field: monthlyPaymentMax (BigDecimal, optional)
    - Field: bankCategory (String, optional) - values: "all", "national", "regional", "credit-union"
    - Field: comparisonMode (String, optional) - values: "full", "summary"
      - Default: "full"
  - [ ] Create OfferComparisonTableRow (src/main/java/com/creditapp/borrower/dto/OfferComparisonTableRow.java)
    - Fields (AC: 2, 7):
      - offerId (UUID)
      - bankId (UUID)
      - bankName (String)
      - bankLogoUrl (String)
      - apr (BigDecimal)
      - monthlyPayment (BigDecimal)
      - totalCost (BigDecimal)
      - originationFee (BigDecimal)
      - insuranceCost (BigDecimal)
      - termMonths (Integer)
      - processingTimeDays (Integer)
      - validityPeriodDays (Integer)
      - expiresAt (LocalDateTime)
      - offerStatus (String) - "calculated", "accepted", "expired"
      - selectButtonState (String) - "enabled", "disabled-expired", "disabled-selected", "disabled-submitted"
      - expirationCountdown (String) - "5 days 3 hours", "2 hours 30 minutes"
  - [ ] Create OfferComparisonTableResponse (src/main/java/com/creditapp/borrower/dto/OfferComparisonTableResponse.java)
    - Field: offers (List<OfferComparisonTableRow>)
    - Field: totalCount (Integer) - total offers matching filters
    - Field: limit (Integer)
    - Field: offset (Integer)
    - Field: hasMore (boolean) - true if more results available
    - Field: sortBy (String)
    - Field: sortOrder (String)
    - Field: appliedFilters (Map<String, Object>) - echo back filters applied
    - Field: retrievedAt (LocalDateTime)
  - [ ] Unit tests: validate DTOs, verify field mappings

- [ ] Task 2: Create Offer Comparison Table Service (AC: 2, 3, 4, 5, 6, 7, 9)
  - [ ] Create OfferComparisonTableService (src/main/java/com/creditapp/borrower/service/OfferComparisonTableService.java)
    - Method: getOffersTable(UUID applicationId, UUID borrowerId, OfferComparisonTableRequest request) returns OfferComparisonTableResponse
      - Fetch application, verify borrower owns it (access control)
      - Query offers with filters applied (AC4):
        - APR range: aprMin <= apr <= aprMax
        - Monthly payment range: monthlyPaymentMin <= monthlyPayment <= monthlyPaymentMax
        - Bank category filter (if provided)
        - Status: exclude EXPIRED offers (or include for informational purposes)
      - Apply sorting (AC3):
        - Sort by requested field: apr, monthlyPayment, totalCost, bankName
        - Sort order: asc or desc
        - Default: apr ascending (lowest rate first)
      - Apply pagination (AC5):
        - Skip offset records
        - Limit to limit records (max 100)
        - Return total count of matching records
      - Build response rows (AC2, 6, 7):
        - Map offer fields to OfferComparisonTableRow
        - Calculate expirationCountdown: now to expiresAt
        - Set selectButtonState based on offer status and application status
      - Return OfferComparisonTableResponse with metadata (AC5)
    - Helper: calculateExpirationCountdown(LocalDateTime expiresAt) returns String
      - Calculate Duration from now to expiresAt
      - Format as human-readable: "5 days 3 hours", "2 hours 30 minutes"
      - If < 1 hour: show in minutes
      - If < 1 day: show in hours
      - If >= 1 day: show in days and hours
    - Helper: determineSelectButtonState(Offer offer, Application application) returns String
      - If offer is EXPIRED: "disabled-expired"
      - If offer is ACCEPTED: "disabled-selected"
      - If application status is not SUBMITTED: "disabled-not-ready"
      - Else: "enabled"
    - Error handling: validate filters, sorting, pagination parameters
  - [ ] Unit tests: mock repositories, test filtering, test sorting, test pagination

- [ ] Task 3: Create REST Controller Endpoint (AC: 1, 8)
  - [ ] Create or update BorrowerOfferController
    - GET /api/borrower/applications/{applicationId}/offers-table
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Path parameter: applicationId
      - Query parameters: sortBy, sortOrder, limit, offset, aprMin, aprMax, monthlyPaymentMin, monthlyPaymentMax, bankCategory, comparisonMode
        - Can use @RequestParam or create request DTO
      - Extract borrowerId from SecurityContext
      - Call OfferComparisonTableService.getOffersTable(...)
      - Return ResponseEntity<OfferComparisonTableResponse> with HTTP 200 OK
      - Cache response (optional, AC9)
  - [ ] Error handling:
    - 400 Bad Request: invalid parameters
    - 403 Forbidden: borrower doesn't own application
    - 404 Not Found: application not found
    - 500 Internal Server Error: unexpected failures
  - [ ] Unit tests: mock service, test parameter validation

- [ ] Task 4: Implement Filtering Logic (AC: 4)
  - [ ] Create FilterBuilder class (src/main/java/com/creditapp/shared/util/FilterBuilder.java)
    - Method: buildAPRFilter(BigDecimal min, BigDecimal max) returns Predicate<Offer>
    - Method: buildMonthlyPaymentFilter(BigDecimal min, BigDecimal max) returns Predicate<Offer>
    - Method: buildBankCategoryFilter(String category) returns Predicate<Offer>
      - Categories: "national" (banks with assets > ), "regional", "credit-union"
      - Map bank ID to category (hardcoded or via BankCategory entity)
    - All methods combine filters with AND logic
  - [ ] Alternative: Use database query with WHERE clauses
    - More efficient for large datasets
    - Use Spring Data JPA @Query with dynamic WHERE clauses
  - [ ] Unit tests: verify filter logic

- [ ] Task 5: Implement Sorting Logic (AC: 3)
  - [ ] Create SortBuilder class (src/main/java/com/creditapp/shared/util/SortBuilder.java)
    - Method: buildSort(String sortBy, String sortOrder) returns Sort
      - "apr" -> Sort.by(Sort.Order.asc("apr")) or desc
      - "monthlyPayment" -> Sort.by(Sort.Order.asc("monthlyPayment"))
      - "totalCost" -> Sort.by(Sort.Order.asc("totalCost"))
      - "bankName" -> Sort.by(Sort.Order.asc("organization.name"))
    - Validate sortBy and sortOrder
    - Default: sort by APR ascending
  - [ ] Use Spring Data JPA Sort API
  - [ ] Unit tests: verify sort logic

- [ ] Task 6: Add Pagination Support (AC: 5)
  - [ ] Create PaginationUtils (src/main/java/com/creditapp/shared/util/PaginationUtils.java)
    - Method: validateAndGetPageable(int limit, int offset) returns Pageable
      - Validate: limit >= 1 and limit <= 100
      - Validate: offset >= 0
      - Convert offset + limit to PageRequest
  - [ ] Use Spring Data JPA Pageable interface
    - PageRequest.of(pageNumber, pageSize, sort)
  - [ ] Catch PagingAndSortingRepository
  - [ ] Unit tests: verify pagination logic

- [ ] Task 7: Add Caching for Performance (AC: 9)
  - [ ] Add @Cacheable to OfferComparisonTableService.getOffersTable()
    - Cache key: applicationId + borrowerId + request hash (sortBy, sortOrder, filters, pagination)
    - TTL: 5 minutes (offers may change if new calculations triggered)
  - [ ] Cache configuration: Caffeine cache with max 5,000 entries
  - [ ] Cache invalidation: clear when new offers calculated or selected
    - Use CacheEvict("offers-table") when offers change
  - [ ] Unit tests: verify cache behavior

- [ ] Task 8: Create Countdown Timer Calculation (AC: 6)
  - [ ] Implement calculateExpirationCountdown(LocalDateTime expiresAt) method
    - Calculate: Duration.between(LocalDateTime.now(ZoneId.of("UTC")), expiresAt)
    - Format: Chunked into days, hours, minutes
    - If duration < 0: return "Expired"
    - If duration < 1 minute: return "Less than 1 minute"
    - If duration < 1 hour: return "{minutes} minutes"
    - If duration < 1 day: return "{hours} hours {minutes} minutes"
    - Else: return "{days} days {hours} hours"
    - Example: 131 hours = "5 days 11 hours"
  - [ ] Unit tests: verify countdown calculation for various durations

- [ ] Task 9: Implement Comparison Mode (AC: 8)
  - [ ] Create two response variants
    - Full mode: all fields in OfferComparisonTableRow
    - Summary mode: limited fields (offerId, bankName, apr, monthlyPayment, status, selectButtonState)
  - [ ] Implement in OfferComparisonTableService
    - If comparisonMode = "summary": return limited fields
    - If comparisonMode = "full": return all fields
    - Default: "full"
  - [ ] Update OfferComparisonTableRow to support both modes
    - Mark optional fields as @JsonInclude(JsonInclude.Include.NON_NULL)
  - [ ] Unit tests: verify both modes

- [ ] Task 10: Create Unit Tests (AC: 3, 4, 5, 7, 9)
  - [ ] Create OfferComparisonTableServiceTest (src/test/java/com/creditapp/unit/borrower/OfferComparisonTableServiceTest.java)
    - Test 1: Get offers table - return all offers sorted by APR ascending
    - Test 2: Sort by monthly payment - verify correct sort order
    - Test 3: Sort by total cost - verify correct sort order
    - Test 4: Sort descending - verify reverse order
    - Test 5: Filter by APR range - verify only matching offers returned
    - Test 6: Filter by monthly payment range - verify filters applied
    - Test 7: Pagination - verify offset and limit applied correctly
    - Test 8: Pagination - verify totalCount and hasMore correct
    - Test 9: Expiration countdown - verify correct format
    - Test 10: Select button states - verify different states based on offer status
    - Test 11: Bank category filter - verify category filtering
    - Test 12: Comparison mode summary - verify limited fields
    - Test 13: Comparison mode full - verify all fields
    - Test 14: Access control - different borrower cannot access
    - Test 15: Application not found - 404 error
  - [ ] Mock: OfferRepository, ApplicationRepository
  - [ ] Framework: JUnit 5, Mockito

- [ ] Task 11: Create Controller Tests (AC: 1, 8)
  - [ ] Create OfferComparisonTableControllerTest (src/test/java/com/creditapp/unit/borrower/OfferComparisonTableControllerTest.java)
    - Test 1: GET endpoint returns 200 OK
    - Test 2: Query parameters accepted (sortBy, sortOrder, limit, offset, filters)
    - Test 3: Invalid sortBy - default sort applied
    - Test 4: Invalid limit (> 100) - clamped to 100
    - Test 5: Negative offset - rejected with 400
    - Test 6: Unauthenticated - 401 Unauthorized
    - Test 7: Different borrower - 403 Forbidden
    - Test 8: Response includes all required fields
    - Test 9: Comparison mode parameter honored
  - [ ] Mock: OfferComparisonTableService
  - [ ] Framework: Spring Boot Test

- [ ] Task 12: Create Integration Tests (AC: 2, 3, 4, 5, 6, 10)
  - [ ] Create OfferComparisonTableIntegrationTest (src/test/java/com/creditapp/integration/borrower/OfferComparisonTableIntegrationTest.java)
    - Setup: Create application with multiple offers (5+ from different banks)
    - Test 1: GET /offers-table returns all offers
    - Test 2: Sort by APR ascending - verify order (lowest to highest)
    - Test 3: Sort by APR descending - verify order (highest to lowest)
    - Test 4: Sort by monthly payment - verify order
    - Test 5: Filter APR range - verify subset returned
    - Test 6: Filter monthly payment range - verify subset returned
    - Test 7: Combined filters - multiple filters applied
    - Test 8: Pagination limit 20 - verify 20 offers returned if available
    - Test 9: Pagination offset 10 - verify correct offset
    - Test 10: Expiration countdown - verify format and accuracy
    - Test 11: Select button states - verify different states
    - Test 12: Comparison mode summary - verify limited fields
    - Test 13: Comparison mode full - verify all fields
    - Test 14: Total count - verify correct count
    - Test 15: Has more - verify hasMore flag set correctly
  - [ ] Use: TestRestTemplate, TestContainers (PostgreSQL)
  - [ ] Database: Real test data with offers

- [ ] Task 13: Create API Documentation (AC: 1, 2, 8)
  - [ ] Update docs/API_ENDPOINTS.md
    - Endpoint: GET /api/borrower/applications/{applicationId}/offers-table
    - Query parameters with examples
    - Response structure with all fields
    - Example request and response
  - [ ] Add OpenAPI annotations to controller method
    - @Operation, @ApiResponse, @Parameter, @Schema
    - Document all query parameters
  - [ ] Create example responses in documentation

- [ ] Task 14: Add Performance Optimization (AC: 9)
  - [ ] Database query optimization
    - Use JPA @Query with JOIN FETCH to prevent N+1 queries
    - Load offers with organizations (banks) in single query
    - Create index on (applicationId, expiresAt, status) for filtering/sorting
  - [ ] Implement caching (AC9)
    - Cache entire response for 5 minutes
    - Invalidate on new offer creation or selection
  - [ ] Add query timeout: max 1 second
  - [ ] Add StopWatch logging to measure query time
  - [ ] Unit tests: verify query performance

- [ ] Task 15: Create Logging and Monitoring (AC: 9)
  - [ ] Add logging to OfferComparisonTableService
    - DEBUG: filters and sort parameters received
    - INFO: query executed in Xms, returned Y offers
    - WARN: performance issue if query > 100ms
    - ERROR: database query failure
  - [ ] Add metrics
    - Histogram: creditapp.offers.table-query-time - query execution time
    - Counter: creditapp.offers.table-requests - total requests
    - Gauge: creditapp.offers.active-count - total active offers
  - [ ] Configure metrics export (Prometheus)

## Dev Notes

### Previous Stories Dependencies
- **Story 3.3**: Offer calculation
- **Story 3.4**: Offer retrieval (AC: 2)
- **Story 3.5**: Offer selection (button state logic)
- **Story 3.6**: Offer expiration (countdown timer)
- **Story 1.6**: RBAC for @PreAuthorize

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA
- **Query**: Spring Data JPA with Pageable, Sort
- **Caching**: Caffeine cache (Spring Cache abstraction)
- **API**: Spring RestController with RequestParam for query parameters
- **JSON**: Jackson with custom serialization for countdown

### Filtering Strategy
[Source: AC: 4]
- **APR Range**: aprMin <= apr <= aprMax
- **Monthly Payment Range**: monthlyPaymentMin <= monthlyPayment <= monthlyPaymentMax
- **Bank Category**: "national" | "regional" | "credit-union"
- **Implementation**: Database WHERE clauses (JPA @Query) for efficiency
- **Combination**: All filters combined with AND logic

### Sorting Options
[Source: AC: 3]
- **Default**: Sort by APR ascending (lowest rate first)
- **Options**:
  - APR (ascending or descending)
  - Monthly Payment (ascending or descending)
  - Total Cost (ascending or descending)
  - Bank Name (ascending or descending)
- **Implementation**: Spring Data JPA Sort API

### Pagination
[Source: AC: 5]
- **Limit**: Number of results per page (default 20, max 100)
- **Offset**: Number of results to skip (default 0)
- **Total Count**: Total matching records (excluding limit/offset)
- **Has More**: Boolean flag indicating more results available
- **Response**: limit, offset, totalCount, hasMore

### Expiration Countdown
[Source: AC: 6]
- **Format**: Human-readable string
  - "5 days 3 hours"
  - "2 hours 30 minutes"
  - "45 minutes"
  - "Less than 1 minute"
  - "Expired"
- **Calculation**: Duration.between(now, expiresAt)
- **Granularity**: Days and hours, or hours and minutes, or minutes

### Select Button States
[Source: AC: 7]
- **"enabled"**: Offer not yet selected, not expired, can select
- **"disabled-expired"**: Offer past expiration time
- **"disabled-selected"**: Borrower already selected this offer
- **"disabled-not-ready"**: Application not in SUBMITTED status
- **Implementation**: Determine based on offer status and application status

### Project Directory Structure
`
src/main/java/com/creditapp/
 borrower/
    controller/        # BorrowerOfferController.java (add GET /offers-table)
    service/           # OfferComparisonTableService.java
    dto/               # OfferComparisonTableRequest.java, OfferComparisonTableRow.java, OfferComparisonTableResponse.java
 shared/
    util/              # FilterBuilder.java, SortBuilder.java, PaginationUtils.java

src/test/java/com/creditapp/
 unit/
    borrower/
      OfferComparisonTableServiceTest.java
      OfferComparisonTableControllerTest.java
 integration/
    borrower/
      OfferComparisonTableIntegrationTest.java
`

### Important Notes
1. **Sorting**: Default is APR ascending (best rate first)
2. **Filtering**: Multiple filters combined with AND
3. **Pagination**: Max 100 results per page
4. **Performance**: <100ms target with caching
5. **Countdown**: Human-readable duration format
6. **Button States**: Enable/disable based on offer and application status
7. **Comparison Mode**: Support both full and summary details
8. **Access Control**: Borrower can only see own offers
9. **Query Optimization**: JOIN FETCH to prevent N+1
10. **Caching**: 5-minute TTL, invalidate on offer changes

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, TestContainers
- **Mocking**: Mockito for services and repositories
- **HTTP Client**: TestRestTemplate
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/

### Testing Checklist
- [ ] Offers table: returns all offers for application
- [ ] Sorting by APR: correct ascending order
- [ ] Sorting by APR: correct descending order
- [ ] Sorting by monthly payment: correct order
- [ ] Sorting by total cost: correct order
- [ ] Sorting by bank name: correct alphabetical order
- [ ] Filtering by APR range: only matching offers returned
- [ ] Filtering by monthly payment: only matching offers returned
- [ ] Filtering by bank category: correct category selected
- [ ] Multiple filters: all filters applied with AND logic
- [ ] Pagination limit: correct number of results
- [ ] Pagination offset: correct starting position
- [ ] Pagination total count: correct total matching records
- [ ] Pagination has more: correct flag value
- [ ] Expiration countdown: correct format and calculation
- [ ] Select button state: enabled for valid offers
- [ ] Select button state: disabled-expired for expired offers
- [ ] Select button state: disabled-selected for selected offer
- [ ] Comparison mode full: all fields present
- [ ] Comparison mode summary: limited fields only
- [ ] Access control: borrower can only see own offers
- [ ] Response time: <100ms including filters/sorts
- [ ] Query optimization: no N+1 queries
- [ ] Caching: responses cached for 5 minutes
- [ ] Cache invalidation: cleared on offer changes
- [ ] API documentation: endpoint documented with examples
- [ ] Error handling: 400, 403, 404, 500 errors
- [ ] Integration test: end-to-end table retrieval with filters
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Comparison Table | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
