# Story 2.6: Document Upload & Management

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to upload supporting documents (income statements, employment verification, identification) to my application,
**so that** banks have the information needed to assess my creditworthiness.

## Acceptance Criteria

1. POST /api/borrower/applications/{applicationId}/documents endpoint accepts file upload
2. Supported file types: PDF, JPG, PNG, DOC, DOCX (configurable)
3. File size limit: 10 MB per file, 50 MB total per application
4. Document types: INCOME_STATEMENT, EMPLOYMENT_VERIFICATION, IDENTIFICATION, BANK_STATEMENT, OTHER
5. Virus/malware scanning: scan uploaded files (optional for MVP)
6. Document metadata stored: filename, upload_date, document_type, file_size, mime_type
7. GET /api/borrower/applications/{applicationId}/documents lists uploaded documents
8. DELETE /api/borrower/applications/{applicationId}/documents/{documentId} removes document (soft delete)
9. Only borrower who owns the application can upload documents (403 Forbidden otherwise)
10. Documents can only be uploaded to DRAFT or SUBMITTED applications (409 if UNDER_REVIEW or later)

## Tasks / Subtasks

- [ ] Task 1: Create Database Schema for Documents (AC: 4, 6, 8)
  - [ ] Create V11__Create_Application_Documents_Table.sql migration
    - Columns: id (UUID PK), application_id (UUID FK), document_type (VARCHAR), original_filename (VARCHAR), stored_filename (VARCHAR UUID), file_size (BIGINT), mime_type (VARCHAR), upload_date (TIMESTAMP), deleted_at (TIMESTAMP nullable), uploaded_by_user_id (UUID FK)
    - Foreign key: application_id -> applications(id) ON DELETE CASCADE
    - Foreign key: uploaded_by_user_id -> users(id) ON DELETE SET NULL
    - Index on (application_id), (upload_date)
    - Soft delete via deleted_at

- [ ] Task 2: Create Document JPA Entity (AC: 4, 6)
  - [ ] Create ApplicationDocument entity (src/main/java/com/creditapp/borrower/model/ApplicationDocument.java)
    - Fields: id (UUID), applicationId (UUID), documentType (DocumentType enum), originalFilename (String), storedFilename (String), fileSize (Long), mimeType (String), uploadDate (LocalDateTime), deletedAt (LocalDateTime), uploadedByUserId (UUID)
    - @Entity, @Table(name = "application_documents")
    - @Enumerated(EnumType.STRING) for documentType
    - @ManyToOne relationship to Application
  - [ ] Create DocumentType enum: INCOME_STATEMENT, EMPLOYMENT_VERIFICATION, IDENTIFICATION, BANK_STATEMENT, OTHER

- [ ] Task 3: Create Document Repository (AC: 6)
  - [ ] Create ApplicationDocumentRepository (src/main/java/com/creditapp/borrower/repository/ApplicationDocumentRepository.java)
    - Extends JpaRepository<ApplicationDocument, UUID>
    - Method: findByApplicationId(UUID applicationId) returns List<ApplicationDocument>
    - Method: findByApplicationIdAndDeletedAtIsNull(UUID applicationId) returns List<ApplicationDocument>
    - Query only non-deleted documents

- [ ] Task 4: Create Document Upload Service (AC: 2, 3, 4, 5, 6)
  - [ ] Create ApplicationDocumentService (src/main/java/com/creditapp/borrower/service/ApplicationDocumentService.java)
    - Method: uploadDocument(UUID applicationId, UUID borrowerId, MultipartFile file, DocumentType docType) returns DocumentDTO
    - Verify borrower owns application (access control)
    - Verify application status in [DRAFT, SUBMITTED] (throw ApplicationLockedException if not)
    - Validate file:
      - File not null/empty
      - File size <= 10 MB
      - Total docs for app <= 50 MB
      - MIME type in allowed list (PDF, JPG, PNG, DOC, DOCX)
    - Generate unique stored filename (UUID-based)
    - Store file to disk/S3 (configurable: local filesystem or cloud storage)
    - Create ApplicationDocument entity
    - Save to ApplicationDocumentRepository
    - Log DOCUMENT_UPLOADED audit event
    - Return DocumentDTO
    - Error handling:
      - InvalidDocumentException (400) for validation failures
      - FileSizeExceededException (413) for file too large
      - ApplicationLockedException (409) for non-editable status
      - DocumentStorageException (500) for persistence errors

    - Method: deleteDocument(UUID applicationId, UUID borrowerId, UUID documentId) returns void
    - Verify borrower owns application
    - Mark document: deleted_at = now (soft delete)
    - Save to ApplicationDocumentRepository
    - Log DOCUMENT_DELETED audit event
    - Error handling: DocumentNotFoundException (404)

    - Method: listDocuments(UUID applicationId, UUID borrowerId) returns List<DocumentDTO>
    - Verify borrower owns application
    - Query non-deleted documents
    - Return list of DocumentDTO

  - [ ] Unit tests: mock repository, file storage, test validation

- [ ] Task 5: Create File Storage Service (AC: 5)
  - [ ] Create DocumentStorageService (src/main/java/com/creditapp/shared/service/DocumentStorageService.java)
    - Method: storeFile(InputStream fileContent, String storedFilename, String mimeType) returns String (storage path/URL)
    - Store to configured location (local filesystem or S3)
    - Return access path or URL
    - Error handling: DocumentStorageException if storage fails

    - Method: deleteFile(String storedFilename) returns void
    - Delete from storage (physical or logical)

    - Method: getFile(String storedFilename) returns InputStream
    - Retrieve file from storage for download

  - [ ] Configuration: app.document-storage.type (filesystem|s3), app.document-storage.path, app.document-storage.bucket
  - [ ] Unit tests: mock file system or S3

- [ ] Task 6: Create Document Upload REST Endpoint (AC: 1, 7, 9)
  - [ ] Add POST endpoint in BorrowerApplicationController
    - Endpoint: POST /api/borrower/applications/{applicationId}/documents
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Path parameter: applicationId (UUID)
    - Request: multipart/form-data with file and documentType
    - Extract borrowerId from SecurityContext
    - Call ApplicationDocumentService.uploadDocument()
    - Return: ResponseEntity<DocumentDTO> with HTTP 201 CREATED
    - Response includes: id, documentType, originalFilename, fileSize, uploadDate
    - Error handling:
      - 400 Bad Request: validation failures
      - 401 Unauthorized: not authenticated
      - 403 Forbidden: not borrower
      - 404 Not Found: application doesn't exist
      - 409 Conflict: application status doesn't allow uploads
      - 413 Payload Too Large: file size exceeds limit
      - 500 Internal Server Error: storage failure

  - [ ] Add GET endpoint to list documents
    - Endpoint: GET /api/borrower/applications/{applicationId}/documents
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Return: List<DocumentDTO> with HTTP 200 OK

  - [ ] Add DELETE endpoint to remove document
    - Endpoint: DELETE /api/borrower/applications/{applicationId}/documents/{documentId}
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Return: HTTP 204 No Content
    - Error handling: 404 Not Found, 403 Forbidden

  - [ ] Unit tests: mock service, test success and error paths

- [ ] Task 7: Create Document DTOs (AC: 4)
  - [ ] Create DocumentDTO (src/main/java/com/creditapp/borrower/dto/DocumentDTO.java)
    - Fields: id, applicationId, documentType, originalFilename, fileSize, uploadDate, uploadedByUserId
    - Read-only response DTO

  - [ ] Create DocumentUploadRequest (if needed for form data)
    - Fields: file (MultipartFile), documentType (DocumentType)

- [ ] Task 8: Add Exception Handlers (AC: 1)
  - [ ] Update GlobalExceptionHandler
    - @ExceptionHandler for InvalidDocumentException  400 Bad Request
    - @ExceptionHandler for FileSizeExceededException  413 Payload Too Large
    - @ExceptionHandler for ApplicationLockedException  409 Conflict
    - @ExceptionHandler for DocumentStorageException  500 Internal Server Error
    - @ExceptionHandler for DocumentNotFoundException  404 Not Found

- [ ] Task 9: Create Integration Tests (AC: 1, 7, 8, 9, 10)
  - [ ] Create ApplicationDocumentIntegrationTest
    - Setup: Create borrower, create DRAFT application
    - Test 1: Upload valid PDF document, verify 201 Created
    - Test 2: Upload document, verify file stored and metadata persisted
    - Test 3: Upload document, verify appears in GET /documents list
    - Test 4: Upload file > 10 MB, verify 413 Payload Too Large
    - Test 5: Upload file with invalid MIME type, verify 400 Bad Request
    - Test 6: Upload documents totaling > 50 MB, verify 413 after limit
    - Test 7: Upload to SUBMITTED application, verify success (editable status)
    - Test 8: Upload to UNDER_REVIEW application, verify 409 Conflict (locked status)
    - Test 9: Different borrower upload to application, verify 403 Forbidden
    - Test 10: DELETE document, verify soft delete (deleted_at set)
    - Test 11: GET documents, verify deleted documents not returned
    - Test 12: Verify audit log DOCUMENT_UPLOADED and DOCUMENT_DELETED events
  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate, MockMultipartFile

- [ ] Task 10: Create API Documentation (AC: 1, 7)
  - [ ] Document POST /api/borrower/applications/{applicationId}/documents
  - [ ] Document GET /api/borrower/applications/{applicationId}/documents
  - [ ] Document DELETE /api/borrower/applications/{applicationId}/documents/{documentId}
  - [ ] Include file size limits, supported types, error responses

## Dev Notes

### Previous Story Dependencies
- **Story 2.1**: Application entity
- **Story 1.6**: RBAC - @PreAuthorize

### Technology Stack
- **File Upload**: Spring MultipartFile, Apache Commons FileUpload
- **File Storage**: Local filesystem or AWS S3 (configurable)
- **Virus Scanning**: Optional - ClamAV or cloud-based (future enhancement)

### File Storage Strategy
- Local filesystem: src/main/resources/uploads/ with UUID-based naming
- AWS S3: creditapp-documents bucket with borrower-id/application-id folder structure
- Soft delete: mark deleted_at, don't physically delete files initially

### Testing Standards
- Unit tests: Mock file storage service
- Integration tests: TestContainers with real filesystem or S3 mock

## Testing Checklist
- [ ] File upload validation (size, type, count)
- [ ] Document metadata persistence
- [ ] GET documents list
- [ ] DELETE document (soft delete)
- [ ] Access control (403 for different borrower)
- [ ] Application status lock (409 for UNDER_REVIEW+)
- [ ] Audit logging
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - Document Upload & Management | Bob (Scrum Master) |
