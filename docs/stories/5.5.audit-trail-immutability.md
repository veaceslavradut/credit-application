# Story 5.5: Audit Trail Immutability & Compliance Logging

## Status
Ready for Development

## Story

**As a** compliance officer,
**I want** all user actions logged immutably,
**so that** regulatory audits can reconstruct activity.

## Acceptance Criteria

1. All audit log entries immutable: no UPDATE or DELETE
2. Database constraints: no foreign key cascades from audit_logs
3. Audit log retention: 3 years minimum; after 3 years, optional archival
4. GET /api/compliance/audit-logs endpoint (COMPLIANCE_OFFICER role only)
5. Filtering: by user_id, action type, date range, result
6. Export: download as CSV
7. Critical events logged: registration, login, application submission, consent, offer submission, selection, data export, data deletion
8. Context: user_id, role, IP, user agent, timestamp (UTC), action, resource_id, result
9. Sensitive data never logged
10. Tamper-proof: stored with cryptographic hash (optional: blockchain in Phase 2)
11. Integration test: perform 10 actions, retrieve logs, verify all captured

## Tasks / Subtasks

- [ ] Task 1: Review Audit Table from Story 1.7 (AC: 1, 2, 3)
  - [ ] Verify audit_logs table schema:
    - Columns: id, user_id, action, result, timestamp, ip_address, user_agent, resource_id, resource_type, details (JSON)
    - No UPDATE/DELETE constraints: prevent modifications
    - No foreign key on user_id (allow audit entries even if user deleted)
    - APPEND-ONLY pattern: only INSERT allowed
  - [ ] Verify retention policy in code/config: DELETE records older than 3 years (optional, can be moved to data warehouse)

- [ ] Task 2: Create Audit Log Repository Enhancement (AC: 4, 5)
  - [ ] Create AuditLogRepository (extends from Story 1.7 if not present)
    - Extends JpaRepository<AuditLog, Long>
    - Method: findByUserIdOrderByTimestampDesc(UUID userId, Pageable pageable) returns Page<AuditLog>
    - Method: findByActionOrderByTimestampDesc(String action, Pageable pageable) returns Page<AuditLog>
    - Method: findByTimestampBetweenOrderByTimestampDesc(LocalDateTime start, LocalDateTime end, Pageable pageable) returns Page<AuditLog>
    - Method: findByResultOrderByTimestampDesc(String result, Pageable pageable) returns Page<AuditLog> (SUCCESS, FAILURE)
    - Custom query: combined filters (user_id AND action AND dateRange AND result)

- [ ] Task 3: Create Audit Log DTOs (AC: 8)
  - [ ] Create AuditLogResponse DTO
    - Fields: id, userId, action, result, timestamp, ipAddress, userAgent, resourceId, resourceType, details (JSON)
    - Exclude sensitive data from details
  - [ ] Create AuditLogFilterDTO
    - Fields: userId (optional), action (optional), dateFrom, dateTo, result (optional), limit, offset
  - [ ] Create AuditLogExportDTO
    - Mapped to CSV columns: Timestamp, User ID, Action, Result, IP Address, Resource Type, Resource ID

- [ ] Task 4: Create Compliance Audit Service (AC: 4, 5, 6)
  - [ ] Create ComplianceAuditService
    - Method: getAuditLogs(AuditLogFilterDTO filter) returns Page<AuditLogResponse>
      - Query audit_logs with provided filters
      - Apply pagination (limit default 100, max 1000)
      - Order by timestamp DESC
      - Return paginated results
    - Method: exportAuditLogsAsCSV(AuditLogFilterDTO filter) returns byte[]
      - Generate CSV file with filtered audit logs
      - Columns: Timestamp, User ID, Action, Result, IP Address, User Agent, Resource Type, Resource ID
      - Include headers
      - Return CSV content
    - Method: getAuditLogsByUser(UUID userId, LocalDate from, LocalDate to) returns List<AuditLogResponse>
      - Query all actions by specific user in date range
      - Used for user-specific compliance reports
    - Method: getAuditLogsByAction(String action, LocalDate from, LocalDate to) returns List<AuditLogResponse>
      - Query all instances of specific action
      - Used for action-specific audits (e.g., all login attempts)
  - [ ] Unit tests: mock repository, test filtering and export

- [ ] Task 5: Create Compliance Audit REST Controller (AC: 4, 5, 6)
  - [ ] Create ComplianceAuditController (src/main/java/com/creditapp/compliance/controller/ComplianceAuditController.java)
    - GET /api/compliance/audit-logs
      - @PreAuthorize("hasAuthority('COMPLIANCE_OFFICER')")
      - Query params: userId (optional), action (optional), dateFrom, dateTo, result (SUCCESS/FAILURE, optional), page, size
      - Call ComplianceAuditService.getAuditLogs()
      - Return paginated Page<AuditLogResponse> with 200 OK
    - GET /api/compliance/audit-logs/export
      - @PreAuthorize("hasAuthority('COMPLIANCE_OFFICER')")
      - Query params: same as above
      - Call ComplianceAuditService.exportAuditLogsAsCSV()
      - Return CSV file for download (Content-Type: text/csv)
    - GET /api/compliance/audit-logs/user/{userId}
      - @PreAuthorize("hasAuthority('COMPLIANCE_OFFICER')")
      - Path param: userId
      - Query params: dateFrom, dateTo
      - Return user's audit trail
  - [ ] Unit tests: mock service, test endpoints
  - [ ] Integration tests: real HTTP requests with COMPLIANCE_OFFICER JWT token

- [ ] Task 6: Create Critical Event Validation (AC: 7)
  - [ ] Verify all critical events are logged by respective stories:
    - USER_REGISTERED (Story 1.3)
    - USER_LOGGED_IN (Story 1.5)
    - APPLICATION_SUBMITTED (Story 2.3)
    - CONSENT_GRANTED (Story 5.1)
    - CONSENT_WITHDRAWN (Story 5.1)
    - OFFER_SUBMITTED_BY_BANK (Story 4.4)
    - OFFER_SELECTED_BY_BORROWER (Story 3.5)
    - DATA_EXPORT_REQUESTED (Story 5.3)
    - DATA_EXPORT_DOWNLOADED (Story 5.3)
    - DATA_DELETION_REQUESTED (Story 5.4)
    - DATA_DELETION_COMPLETED (Story 5.4)
  - [ ] Create AuditEventType enum with all event types
  - [ ] Document in code: which service logs which event

- [ ] Task 7: Create Sensitive Data Redaction (AC: 9)
  - [ ] Create DataRedactionService
    - Method: redactSensitiveData(Map<String, Object> details) returns Map<String, Object>
      - Remove: email addresses (except domain), phone numbers, SSN/ID numbers, password hashes
      - Redact in audit details JSON
      - Keep: user_id, application_id, resource_ids, action outcome
  - [ ] Apply to all audit log writes: ensure no PII in details field

- [ ] Task 8: Create Audit Log Integrity Check (AC: 10)
  - [ ] Create AuditLogIntegrityService
    - Method: calculateHash(AuditLog entry) returns String
      - Compute SHA-256 hash of: user_id, action, timestamp, resource_id (in order)
      - Use for tamper detection
    - Method: verifyIntegrity(AuditLog entry, String expectedHash) returns boolean
      - Recalculate hash and compare
      - Return true if match (not tampered), false if modified
  - [ ] Optional: Store hash in audit_logs table for verification
  - [ ] Unit tests: verify hash calculation consistency

- [ ] Task 9: Create Retention & Archival Policy (AC: 3)
  - [ ] Create AuditLogArchivalJob (scheduled batch job)
    - Run every 30 days or monthly
    - Query audit logs older than 3 years
    - Export to CSV and archive to cold storage (S3 Glacier, etc.)
    - Delete from primary database (optional, depends on compliance needs)
  - [ ] Config: app.audit.retention.days=1095 (3 years)
  - [ ] Document archival process and restore procedures

- [ ] Task 10: Create Unit Tests (AC: 1, 4, 5, 11)
  - [ ] Create AuditLogImmutabilityUnitTest
    - Test 1: Create audit log entry, verify persisted
    - Test 2: Attempt to update audit log entry, verify fails/rejected
    - Test 3: Attempt to delete audit log entry, verify fails/rejected
    - Test 4: Filter by user_id, verify returns correct entries
    - Test 5: Filter by action, verify returns correct entries
    - Test 6: Filter by date range, verify correct results
    - Test 7: Export to CSV, verify format and content
  - [ ] Mock: AuditLogRepository

- [ ] Task 11: Create Integration Tests (AC: 11)
  - [ ] Create AuditTrailIntegrationTest
    - Setup: Create user, perform 10 actions (register, login, create application, submit, consent, offer, etc.)
    - Test 1: Query all audit logs for user
    - Test 2: Verify all 10 actions captured
    - Test 3: Verify each log has: user_id, action, timestamp, IP, result
    - Test 4: Verify sensitive data NOT in details field
    - Test 5: Filter by specific action, verify returns only those
    - Test 6: Filter by date range, verify correct subset
    - Test 7: Export audit logs, verify CSV format valid
    - Test 8: Verify immutability: cannot modify/delete logs
    - Test 9: Verify 3-year retention policy config
  - [ ] Use TestContainers for PostgreSQL, TestRestTemplate

## Dev Notes

### Previous Story Insights
- **Story 1.7**: AuditService foundation - this story extends the basic audit logging with immutability enforcement and compliance features
- **Story 1.2**: User entity - audit logs reference user_id but without foreign key constraint (allows audit preservation after user deletion)
- **Story 5.7**: Data Encryption at Rest & in Transit - audit logs must use PII redaction from encryption story

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA
- **Database**: PostgreSQL 15.4 with immutability constraints
- **Export**: Apache Commons CSV or OpenCSV for CSV generation
- **Archival**: AWS S3 Glacier for cold storage (optional)
- **Hashing**: SHA-256 for tamper detection (optional)

### GDPR/Compliance Context
[Source: architecture/4-security-architecture.md]
**Regulatory Requirements:**
- **GDPR Article 5(1)(f)**: Integrity and confidentiality - audit logs demonstrate security measures
- **GDPR Article 32**: Security of processing - audit trails required for breach detection
- **Moldovan NBM Requirements**: Financial institutions must maintain audit logs for regulatory inspection
- **Retention Period**: 3 years minimum (7 years for financial records in some jurisdictions)

**Audit Trail Purpose:**
1. **Regulatory Compliance**: Demonstrate compliance with data protection and financial regulations
2. **Breach Detection**: Identify unauthorized access or data manipulation
3. **Forensic Analysis**: Reconstruct events during security incidents
4. **User Accountability**: Track who did what and when

### Audit Log Immutability Architecture
[Source: architecture/7-monitoring-observability.md]
**Immutability Implementation:**
- **Database Level**: No UPDATE/DELETE permissions on audit_logs table
- **Application Level**: Repository provides only INSERT operations
- **No Foreign Keys**: user_id not constrained - allows audit preservation even after user deletion
- **Append-Only**: INSERT-only pattern enforced via code and database permissions

**Tamper Detection (Optional):**
```java
// Calculate hash: SHA-256(user_id + action + timestamp + resource_id)
String hash = DigestUtils.sha256Hex(userId + action + timestamp + resourceId);
// Store in audit_logs.integrity_hash column
```

**Blockchain Integration (Phase 2):**
- Store hash in distributed ledger for absolute tamper-proof guarantee
- Periodic merkle tree commitment to blockchain
- Not required for MVP but documented for future enhancement

### Critical Events to Audit
[Source: Story requirements]
**User Management:**
- USER_REGISTERED (Story 1.3)
- USER_LOGGED_IN (Story 1.5)
- USER_LOGGED_OUT (Story 1.5)
- PASSWORD_CHANGED (Story 1.8)

**Application Lifecycle:**
- APPLICATION_CREATED (Story 2.2)
- APPLICATION_SUBMITTED (Story 2.3)
- APPLICATION_WITHDRAWN (Story 2.8)
- APPLICATION_STATUS_CHANGED (Story 2.1)

**Consent Management:**
- CONSENT_GRANTED (Story 5.1)
- CONSENT_WITHDRAWN (Story 5.1)

**Offer Management:**
- OFFER_CREATED (Story 4.4)
- OFFER_SUBMITTED (Story 4.4)
- OFFER_SELECTED (Story 3.5)
- OFFER_ACCEPTED (Story 3.5)

**Data Subject Rights:**
- DATA_EXPORT_REQUESTED (Story 5.3)
- DATA_EXPORT_DOWNLOADED (Story 5.3)
- DATA_DELETION_REQUESTED (Story 5.4)
- DATA_DELETION_COMPLETED (Story 5.4)

### Audit Log Data Model
[Source: Story 1.7 context]
```sql
CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID,  -- NO FOREIGN KEY CONSTRAINT
    action VARCHAR(100) NOT NULL,
    result VARCHAR(20) NOT NULL,  -- SUCCESS, FAILURE
    timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR(45),
    user_agent VARCHAR(500),
    resource_id VARCHAR(255),
    resource_type VARCHAR(50),
    details JSONB,  -- Additional context, PII redacted
    integrity_hash VARCHAR(64),  -- Optional: SHA-256 for tamper detection
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Indexes for query performance
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp DESC);
CREATE INDEX idx_audit_logs_result ON audit_logs(result);

-- Prevent UPDATE/DELETE at database level (optional)
CREATE RULE audit_logs_no_update AS ON UPDATE TO audit_logs DO INSTEAD NOTHING;
CREATE RULE audit_logs_no_delete AS ON DELETE TO audit_logs DO INSTEAD NOTHING;
```

### API Specification
[Source: architecture/2-detailed-service-architecture.md]

**GET /api/compliance/audit-logs**
```json
Request:
GET /api/compliance/audit-logs?userId=550e8400&action=USER_LOGGED_IN&dateFrom=2026-01-01&dateTo=2026-01-31&page=0&size=100
Authorization: Bearer {JWT with COMPLIANCE_OFFICER role}

Response (200 OK):
{
  "content": [
    {
      "id": 12345,
      "userId": "550e8400-e29b-41d4-a716-446655440000",
      "action": "USER_LOGGED_IN",
      "result": "SUCCESS",
      "timestamp": "2026-01-15T10:30:00Z",
      "ipAddress": "192.168.1.100",
      "userAgent": "Mozilla/5.0...",
      "resourceId": null,
      "resourceType": null,
      "details": {}
    }
  ],
  "totalElements": 1,
  "totalPages": 1,
  "size": 100,
  "number": 0
}
```

**GET /api/compliance/audit-logs/export**
```
Request:
GET /api/compliance/audit-logs/export?dateFrom=2026-01-01&dateTo=2026-01-31
Authorization: Bearer {JWT with COMPLIANCE_OFFICER role}

Response (200 OK):
Content-Type: text/csv
Content-Disposition: attachment; filename="audit-logs-2026-01-01-to-2026-01-31.csv"

Timestamp,User ID,Action,Result,IP Address,User Agent,Resource Type,Resource ID
2026-01-15T10:30:00Z,550e8400-e29b-41d4-a716-446655440000,USER_LOGGED_IN,SUCCESS,192.168.1.100,Mozilla/5.0...,null,null
```

### Retention and Archival Policy
[Source: architecture/7-monitoring-observability.md]
**Retention Tiers:**
1. **Hot Storage (Database)**: 0-3 years - fast query access
2. **Cold Storage (S3 Glacier)**: 3-7 years - compliance archival, slower retrieval
3. **Deletion**: After 7 years (configurable based on regulatory requirements)

**Archival Process:**
1. Monthly batch job runs (1st of each month)
2. Query audit_logs WHERE timestamp < (NOW() - INTERVAL '3 years')
3. Export to CSV format
4. Upload to S3 Glacier with metadata (dateRange, recordCount)
5. Delete from primary database (optional - some orgs keep indefinitely)
6. Log archival action: AUDIT_LOGS_ARCHIVED

**Configuration:**
```yaml
app:
  audit:
    retention:
      hot-storage-days: 1095  # 3 years
      cold-storage-days: 2555  # 7 years
    archival:
      enabled: true
      cron: "0 0 1 * * *"  # 1st of month at midnight
      destination: "s3://credit-app-audit-archive/"
```

### Sensitive Data Redaction
[Source: Story 5.7 context - Data Encryption]
**PII to Redact from Audit Logs:**
- Email addresses: keep domain only (e.g., "***@example.com")
- Phone numbers: replace with "[REDACTED]"
- Names: replace with "[REDACTED]" or keep first letter ("J***")
- Addresses: remove completely
- Password hashes: NEVER log (even hashed)
- Credit card numbers: NEVER log

**Safe to Log:**
- user_id (UUID)
- application_id, offer_id (resource UUIDs)
- Action type (enum)
- Result (SUCCESS/FAILURE)
- IP address (pseudonymous identifier)
- User agent string
- Timestamps

**Implementation:**
```java
public Map<String, Object> redactPII(Map<String, Object> details) {
    Map<String, Object> redacted = new HashMap<>(details);
    redacted.remove("email");
    redacted.remove("phone");
    redacted.remove("name");
    redacted.remove("address");
    redacted.remove("password");
    return redacted;
}
```

### Project Directory Structure
[Source: Story 1.1 context]
```
src/main/java/com/creditapp/
 compliance/
    controller/        # ComplianceAuditController.java
    service/           # ComplianceAuditService.java, AuditLogIntegrityService.java
    dto/               # AuditLogResponse.java, AuditLogFilterDTO.java, AuditLogExportDTO.java
 shared/
    model/             # AuditLog.java (from Story 1.7)
    repository/        # AuditLogRepository.java (enhance from Story 1.7)
    service/           # AuditService.java (from Story 1.7), DataRedactionService.java
    batch/             # AuditLogArchivalJob.java (scheduled task)

src/test/java/com/creditapp/
 unit/
    compliance/
      ComplianceAuditServiceUnitTest.java
      AuditLogIntegrityServiceUnitTest.java
 integration/
    compliance/
      AuditTrailIntegrationTest.java
```

### Key Dependencies
```xml
<!-- CSV Export -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-csv</artifactId>
    <version>1.10.0</version>
</dependency>

<!-- Hashing (Optional) -->
<dependency>
    <groupId>commons-codec</groupId>
    <artifactId>commons-codec</artifactId>
    <version>1.15</version>
</dependency>

<!-- AWS S3 for Archival (Optional) -->
<dependency>
    <groupId>com.amazonaws</groupId>
    <artifactId>aws-java-sdk-s3</artifactId>
    <version>1.12.400</version>
</dependency>
```

### Testing Standards
[Source: frontend-architecture/10-testing-strategy.md]
- **Unit Tests**: Mock repositories and services
- **Integration Tests**: Real database (TestContainers), verify immutability constraints
- **Test Framework**: JUnit 5, Mockito, Spring Boot Test
- **Test Location**: `src/test/java/com/creditapp/unit/compliance/`, `src/test/java/com/creditapp/integration/compliance/`
- **Coverage Goal**: 80%+ code coverage

### Important Notes
1. **Immutability Critical**: Audit logs MUST NOT be modifiable. Database-level constraints recommended.
2. **No Foreign Keys**: user_id should NOT have foreign key constraint to allow audit preservation after user deletion.
3. **Performance**: Pagination required for large result sets. Default page size 100, max 1000.
4. **CSV Export**: Large exports may timeout. Consider async job for exports >10,000 records.
5. **Compliance Officer Access**: Only COMPLIANCE_OFFICER role can access audit logs. NEVER expose to borrowers or bank admins.
6. **Retention Policy**: Configurable per jurisdiction. Moldovan law may require 7 years for financial records.
7. **Archival Strategy**: Balance cost (database vs cold storage) with query performance needs.
8. **Hash Integrity**: Optional for MVP. Blockchain integration in Phase 2 for absolute tamper-proof guarantee.

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5 (Jupiter) + Spring Boot Test
- **Mocking**: Mockito for unit tests
- **Integration Testing**: TestContainers (PostgreSQL) for database tests
- **HTTP Testing**: TestRestTemplate for REST API integration tests
- **Security Testing**: Spring Security Test with @WithMockUser(roles="COMPLIANCE_OFFICER")
- **CSV Testing**: Apache Commons CSV parser for export validation
- **Test Location**: `src/test/java/com/creditapp/`
  - Unit tests: `src/test/java/com/creditapp/unit/compliance/ComplianceAuditServiceUnitTest.java`
  - Integration tests: `src/test/java/com/creditapp/integration/compliance/AuditTrailIntegrationTest.java`
- **Test Class Naming**: `{ComponentName}UnitTest.java` for unit tests, `{Feature}IntegrationTest.java` for integration tests

### Testing Checklist

**Unit Tests (ComplianceAuditServiceUnitTest.java)**
- [ ] Query audit logs by user_id, verify correct entries returned
- [ ] Query audit logs by action type, verify filtered correctly
- [ ] Query audit logs by date range, verify correct subset
- [ ] Query audit logs by result (SUCCESS/FAILURE), verify filtering
- [ ] Combined filters (userId + action + dateRange), verify AND logic
- [ ] Export to CSV, verify CSV format with headers
- [ ] Export to CSV, verify all required columns present
- [ ] Pagination: page 0 size 100, verify correct subset
- [ ] Pagination: page 1, verify next page results
- [ ] Redact PII from audit details, verify sensitive data removed
- [ ] Calculate integrity hash, verify SHA-256 output
- [ ] Verify integrity hash, verify tamper detection works
- [ ] AuditLogRepository mock verifies correct queries executed

**Integration Tests (AuditTrailIntegrationTest.java)**
- [ ] Perform 10 different actions (register, login, create app, submit, consent, offer, export, delete, etc.)
- [ ] Query all audit logs for user, verify all 10 actions captured
- [ ] Verify each log entry has: user_id, action, result, timestamp, ip_address
- [ ] Verify sensitive data NOT in details field (no email, phone, name)
- [ ] Filter by specific action (e.g., USER_LOGGED_IN), verify returns only those
- [ ] Filter by date range (last 7 days), verify correct subset
- [ ] Filter by result=SUCCESS, verify failures excluded
- [ ] GET /api/compliance/audit-logs with COMPLIANCE_OFFICER role, verify 200 OK
- [ ] GET /api/compliance/audit-logs with BORROWER role, verify 403 Forbidden
- [ ] GET /api/compliance/audit-logs with BANK_ADMIN role, verify 403 Forbidden
- [ ] GET /api/compliance/audit-logs/export, verify CSV file downloaded
- [ ] Export CSV, verify headers: Timestamp, User ID, Action, Result, IP Address
- [ ] Export CSV, verify data rows match filtered query results
- [ ] Verify audit log immutability: attempt UPDATE, verify rejected/no-op
- [ ] Verify audit log immutability: attempt DELETE, verify rejected/no-op
- [ ] Query audit_logs table directly, verify INSERT-only (no UPDATE/DELETE via SQL)
- [ ] Verify 3-year retention policy config loaded correctly
- [ ] Verify archival job configuration (cron schedule)
- [ ] Database constraint test: verify no foreign key on user_id (allows user deletion without cascade)
- [ ] Database index test: queries on (user_id, action, timestamp) use indexes (verify with EXPLAIN)
- [ ] Performance test: query 10,000 audit logs, verify response time < 2 seconds
- [ ] Performance test: export 10,000 audit logs to CSV, verify completes within timeout

**Edge Cases & Error Handling**
- [ ] Query with invalid date range (from > to), verify validation error
- [ ] Query with page size > 1000, verify capped at max limit
- [ ] Export with no results, verify empty CSV with headers only
- [ ] Query audit logs for deleted user, verify logs still accessible (no foreign key constraint)
- [ ] Verify integrity hash calculation consistent (same input = same hash)
- [ ] Tamper detection: modify audit log in database, verify hash mismatch detected

**Archival Tests (Optional)**
- [ ] Run archival job manually, verify old logs exported to CSV
- [ ] Verify archival job uploads to S3 Glacier (or configured destination)
- [ ] Verify archived logs deleted from database (if configured)
- [ ] Verify AUDIT_LOGS_ARCHIVED event logged
- [ ] Restore archived logs from S3, verify data integrity

**Test Coverage Requirements**
- [ ] All ComplianceAuditService methods covered (getAuditLogs, exportCSV, getByUser, getByAction)
- [ ] All REST endpoints covered (GET /audit-logs, GET /audit-logs/export, GET /audit-logs/user/{id})
- [ ] All error handlers covered (invalid filters, unauthorized access)
- [ ] All redaction logic covered (PII removal from details)
- [ ] Code coverage >80% (measured by JaCoCo)
- [ ] All tests pass with `mvn clean test`
- [ ] Integration tests pass with `mvn verify`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Audit Trail Immutability & Compliance Logging | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
