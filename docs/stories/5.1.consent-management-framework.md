# Story 5.1: Consent Management Framework

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to explicitly consent to data collection and sharing before application submission,
**so that** I understand how my data will be used.

## Acceptance Criteria

1. Consent types: DATA_COLLECTION, BANK_SHARING, MARKETING, ESIGNATURE (Phase 2)
2. Consent table: borrower_id, consent_type, consented_at, withdrawn_at, ip_address, user_agent, version
3. POST /api/borrower/consent accepts consent_type array
4. Borrower cannot submit application without DATA_COLLECTION and BANK_SHARING consent
5. Consent checkboxes during application flow
6. Consent withdrawal: PUT /api/borrower/consent/withdraw triggers data deletion
7. Immutable consent log: original preserved even if withdrawn
8. GET /api/borrower/consent returns current status and timestamps
9. Privacy policy version tracking
10. Audit log: CONSENT_GRANTED and CONSENT_WITHDRAWN
11. Integration test: attempt submission without consent, verify rejection; provide consent, verify succeeds

## Tasks / Subtasks

- [ ] Task 1: Create Database Migrations for Consent Tables (AC: 1, 2, 7)
  - [ ] Create V11__Create_Consent_Table.sql migration
    - Create consents table with columns: id (UUID PK), borrower_id (UUID FK), consent_type (VARCHAR), consented_at (TIMESTAMP), withdrawn_at (TIMESTAMP nullable), ip_address (VARCHAR), user_agent (VARCHAR), version (INT), created_at (TIMESTAMP)
    - Foreign key: borrower_id -> users(id) ON DELETE CASCADE
    - Create index on (borrower_id, consent_type)
    - Unique constraint: (borrower_id, consent_type, version) to track versions

- [ ] Task 2: Create Consent JPA Entity (AC: 1, 2, 9)
  - [ ] Create Consent entity (src/main/java/com/creditapp/shared/model/Consent.java)
    - Fields: id (UUID), borrowerId (UUID), consentType (ConsentType enum), consentedAt (LocalDateTime), withdrawnAt (LocalDateTime nullable), ipAddress (String), userAgent (String), version (Integer), createdAt (LocalDateTime)
    - @Entity, @Table(name="consents")
    - @Enumerated(EnumType.STRING) for consentType
    - @CreationTimestamp for createdAt
    - Immutable: no setters for persisted fields
  - [ ] Create ConsentType enum: DATA_COLLECTION, BANK_SHARING, MARKETING, ESIGNATURE

- [ ] Task 3: Create Consent Repository (AC: 2, 8)
  - [ ] Create ConsentRepository (src/main/java/com/creditapp/shared/repository/ConsentRepository.java)
    - Extends JpaRepository<Consent, UUID>
    - Method: findLatestByBorrowerIdAndType(UUID borrowerId, ConsentType type) returns Optional<Consent>
    - Method: findAllByBorrowerId(UUID borrowerId) returns List<Consent>
    - Method: findByBorrowerIdAndTypeAndWithdrawnAtNull(UUID borrowerId, ConsentType type) returns Optional<Consent>

- [ ] Task 4: Create Consent DTOs (AC: 1, 3, 8)
  - [ ] Create ConsentRequest DTO (src/main/java/com/creditapp/borrower/dto/ConsentRequest.java)
    - Fields: consentTypes (List<ConsentType>)
    - Validation: @NotEmpty
  - [ ] Create ConsentResponse DTO (src/main/java/com/creditapp/borrower/dto/ConsentResponse.java)
    - Fields: consentType, consentedAt, withdrawnAt (nullable), version, currentlyConsented (boolean)
  - [ ] Create ConsentWithdrawalRequest DTO (src/main/java/com/creditapp/borrower/dto/ConsentWithdrawalRequest.java)
    - Fields: consentType

- [ ] Task 5: Create Consent Service (AC: 1, 2, 3, 6, 7, 8)
  - [ ] Create ConsentService (src/main/java/com/creditapp/shared/service/ConsentService.java)
    - Method: grantConsent(UUID borrowerId, List<ConsentType> types, String ipAddress, String userAgent) returns List<ConsentResponse>
      - For each type, create new Consent entity with consentedAt=now
      - Save to ConsentRepository
      - Log CONSENT_GRANTED audit event
      - Return list of ConsentResponse
    - Method: withdrawConsent(UUID borrowerId, ConsentType type) returns ConsentResponse
      - Find latest consent for borrower and type
      - Update withdrawn_at = now
      - Do NOT delete (immutable log)
      - Log CONSENT_WITHDRAWN audit event
      - Return ConsentResponse with withdrawnAt timestamp
    - Method: isConsentGiven(UUID borrowerId, ConsentType type) returns boolean
      - Query: find latest consent where withdrawn_at IS NULL
      - Return true if exists, false otherwise
    - Method: getCurrentConsents(UUID borrowerId) returns List<ConsentResponse>
      - Fetch all current active consents (withdrawn_at IS NULL)
      - Return list of ConsentResponse
  - [ ] Unit tests: mock repository, test consent granting, withdrawal, and checking

- [ ] Task 6: Create Consent REST Controller (AC: 3, 5, 8, 10)
  - [ ] Create BorrowerConsentController (src/main/java/com/creditapp/borrower/controller/BorrowerConsentController.java)
    - GET /api/borrower/consent
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Extract borrowerId from SecurityContext
      - Call ConsentService.getCurrentConsents(borrowerId)
      - Return List<ConsentResponse> with 200 OK
    - POST /api/borrower/consent
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Body: @Valid ConsentRequest
      - Extract borrowerId from SecurityContext
      - Extract ipAddress and userAgent from request headers
      - Call ConsentService.grantConsent(borrowerId, types, ipAddress, userAgent)
      - Return List<ConsentResponse> with 201 CREATED
    - PUT /api/borrower/consent/withdraw
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Body: ConsentWithdrawalRequest
      - Extract borrowerId from SecurityContext
      - Call ConsentService.withdrawConsent(borrowerId, type)
      - Return ConsentResponse with 200 OK
  - [ ] Unit tests: mock service, test endpoints and error paths
  - [ ] Integration tests: real HTTP requests with JWT token

- [ ] Task 7: Create Application Submission Validation (AC: 4, 5)
  - [ ] Update ApplicationSubmissionService (or create validator)
    - Before allowing submission, verify DATA_COLLECTION and BANK_SHARING consents granted
    - Method: validateConsents(UUID borrowerId) returns boolean
    - If consents missing, throw MissingConsentException (400)
    - Include in application submission flow (Story 2.3)
  - [ ] Add consent checkboxes to application form: "I consent to data collection" and "I authorize sharing with banks"

- [ ] Task 8: Create Audit Logging Integration (AC: 10)
  - [ ] Ensure ConsentService logs to AuditService:
    - Event: CONSENT_GRANTED with borrower_id, consent_type, ip_address
    - Event: CONSENT_WITHDRAWN with borrower_id, consent_type
  - [ ] Verify AuditService integration (Story 1.7)

- [ ] Task 9: Create Unit Tests (AC: 1, 2, 8)
  - [ ] Create ConsentServiceUnitTest
    - Test 1: Grant consent, verify persisted with consentedAt timestamp
    - Test 2: Withdraw consent, verify withdrawnAt set (not deleted)
    - Test 3: Check consent status after withdrawal, verify false
    - Test 4: Grant multiple consent types, verify all created
    - Test 5: Get current consents, verify only active (withdrawn_at NULL)
  - [ ] Mock: ConsentRepository, AuditService

- [ ] Task 10: Create Integration Tests (AC: 4, 11)
  - [ ] Create ConsentManagementIntegrationTest
    - Setup: Create and authenticate borrower
    - Test 1: Grant DATA_COLLECTION and BANK_SHARING consents, verify 201 Created
    - Test 2: GET consent, verify current consents returned
    - Test 3: Attempt to submit application without consent, verify 400 Bad Request
    - Test 4: Grant required consents, submit application, verify 201 Created
    - Test 5: Withdraw consent, verify withdrawnAt timestamp set
    - Test 6: Get consents after withdrawal, verify not in current list
    - Test 7: Verify audit log entries created for CONSENT_GRANTED and CONSENT_WITHDRAWN
  - [ ] Use TestContainers for PostgreSQL, TestRestTemplate

## Dev Notes

### Previous Story Insights
- **Story 1.7**: AuditService foundation - used for logging CONSENT_GRANTED and CONSENT_WITHDRAWN events
- **Story 1.9**: Email service infrastructure - may be used for consent confirmation emails
- **Story 2.2**: Application creation - consents must be validated before submission
- **Story 2.3**: Application submission flow - integrated with consent validation

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA
- **Database**: PostgreSQL 15.4 with Flyway migrations
- **ORM**: Hibernate with Spring Data JPA
- **Security**: Spring Security with @PreAuthorize
- **Audit**: AuditService from Story 1.7

### GDPR/Compliance Context
[Source: architecture/4-security-architecture.md]
**GDPR Articles Referenced:**
- **Article 6**: Lawful basis for processing (consent as legal basis)
- **Article 7**: Conditions for consent (explicit, informed, freely given)
- **Article 17**: Right to erasure (consent withdrawal triggers deletion)

**Consent Requirements:**
- **Explicit**: Borrower must actively consent (no pre-checked boxes)
- **Informed**: Privacy policy version must be displayed
- **Specific**: Separate consent for different purposes (data collection vs bank sharing vs marketing)
- **Freely Given**: Can be withdrawn at any time
- **Granular**: Borrower can consent to some types and not others

**Immutability**: Consent log is append-only for regulatory audit compliance. Even withdrawn consents must remain in database with withdrawn_at timestamp.

### Consent Types Explained
[Source: Story requirements and GDPR]
1. **DATA_COLLECTION**: Required for basic platform usage. Allows collection of personal and financial data.
2. **BANK_SHARING**: Required for application submission. Authorizes sharing application with partner banks.
3. **MARKETING**: Optional. Allows promotional emails and offers from platform and partners.
4. **ESIGNATURE**: Optional (Phase 2). Required for digital document signing.

**Mandatory for Application Submission**: DATA_COLLECTION + BANK_SHARING
**Optional**: MARKETING, ESIGNATURE

### Application Submission Integration
[Source: Story 2.3 context]
Before allowing application status transition from DRAFT to SUBMITTED:
1. Validate DATA_COLLECTION consent exists and not withdrawn
2. Validate BANK_SHARING consent exists and not withdrawn
3. If either missing, throw MissingConsentException (400) with message: "Required consents not granted. Please accept data collection and bank sharing terms."
4. Block submission API call until consents provided

**Implementation Location**: ApplicationSubmissionService (Story 2.3) or separate ConsentValidator

### Consent Withdrawal Flow
[Source: Story 5.4 context - Right to Erasure]
1. Borrower withdraws consent via PUT /api/borrower/consent/withdraw
2. ConsentService sets withdrawn_at = now (does NOT delete record)
3. Audit event CONSENT_WITHDRAWN logged
4. If BANK_SHARING withdrawn:
   - Trigger data deletion process (Story 5.4)
   - Cancel any pending applications
   - Notify borrower of implications
5. Original consent record preserved for regulatory compliance (7-year retention)

### Project Directory Structure
```
src/main/java/com/creditapp/
 shared/
    model/             # Consent.java, ConsentType.java (enum)
    repository/        # ConsentRepository.java
    service/           # ConsentService.java
 borrower/
    controller/        # BorrowerConsentController.java
    dto/               # ConsentRequest.java, ConsentResponse.java, ConsentWithdrawalRequest.java
    exception/         # MissingConsentException.java
 audit/                # AuditService.java (from Story 1.7, called here)

src/test/java/com/creditapp/
 unit/
    shared/
      ConsentServiceUnitTest.java
 integration/
    borrower/
      ConsentManagementIntegrationTest.java
```

### Key Dependencies
```xml
<!-- All dependencies already in previous stories -->
<!-- No new external dependencies required -->
<!-- Uses existing Spring Data JPA, Spring Security, Flyway -->
```

### Database Schema Details
[Source: Task 1 requirements]
```sql
CREATE TABLE consents (
    id UUID PRIMARY KEY,
    borrower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    consent_type VARCHAR(50) NOT NULL,
    consented_at TIMESTAMP NOT NULL,
    withdrawn_at TIMESTAMP NULL,
    ip_address VARCHAR(45),  -- IPv4 (15) or IPv6 (45)
    user_agent VARCHAR(500),
    version INT NOT NULL DEFAULT 1,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_consent_version UNIQUE (borrower_id, consent_type, version)
);

CREATE INDEX idx_consents_borrower_type ON consents(borrower_id, consent_type);
CREATE INDEX idx_consents_withdrawn ON consents(borrower_id, withdrawn_at);
```

**Design Notes:**
- UUID for id (consistency with other entities)
- version tracks consent re-grants (e.g., privacy policy updates)
- ip_address and user_agent for audit trail (GDPR Article 7 requirement)
- withdrawn_at nullable: NULL = active, NOT NULL = withdrawn
- No DELETE operations: immutable audit log

### API Specification
[Source: architecture/2-detailed-service-architecture.md]

**POST /api/borrower/consent**
```json
Request:
{
  "consentTypes": ["DATA_COLLECTION", "BANK_SHARING"]
}

Response (201 Created):
[
  {
    "consentType": "DATA_COLLECTION",
    "consentedAt": "2026-01-15T10:30:00Z",
    "withdrawnAt": null,
    "version": 1,
    "currentlyConsented": true
  },
  {
    "consentType": "BANK_SHARING",
    "consentedAt": "2026-01-15T10:30:00Z",
    "withdrawnAt": null,
    "version": 1,
    "currentlyConsented": true
  }
]
```

**GET /api/borrower/consent**
```json
Response (200 OK):
[
  {
    "consentType": "DATA_COLLECTION",
    "consentedAt": "2026-01-15T10:30:00Z",
    "withdrawnAt": null,
    "version": 1,
    "currentlyConsented": true
  },
  {
    "consentType": "BANK_SHARING",
    "consentedAt": "2026-01-15T10:30:00Z",
    "withdrawnAt": null,
    "version": 1,
    "currentlyConsented": true
  }
]
```

**PUT /api/borrower/consent/withdraw**
```json
Request:
{
  "consentType": "MARKETING"
}

Response (200 OK):
{
  "consentType": "MARKETING",
  "consentedAt": "2026-01-15T10:30:00Z",
  "withdrawnAt": "2026-01-15T14:00:00Z",
  "version": 1,
  "currentlyConsented": false
}
```

### Audit Logging
[Source: architecture/7-monitoring-observability.md]
**Event: CONSENT_GRANTED**
```json
{
  "timestamp": "2026-01-15T10:30:00Z",
  "event_type": "CONSENT_GRANTED",
  "borrower_id": "550e8400-e29b-41d4-a716-446655440000",
  "consent_type": "DATA_COLLECTION",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "version": 1
}
```

**Event: CONSENT_WITHDRAWN**
```json
{
  "timestamp": "2026-01-15T14:00:00Z",
  "event_type": "CONSENT_WITHDRAWN",
  "borrower_id": "550e8400-e29b-41d4-a716-446655440000",
  "consent_type": "MARKETING",
  "withdrawn_at": "2026-01-15T14:00:00Z"
}
```

### Testing Standards
[Source: frontend-architecture/10-testing-strategy.md]
- **Unit Tests**: Mock repositories and AuditService
- **Integration Tests**: Real database (TestContainers), real HTTP client
- **Test Framework**: JUnit 5, Mockito, Spring Boot Test
- **Test Location**: `src/test/java/com/creditapp/unit/shared/`, `src/test/java/com/creditapp/integration/borrower/`
- **Coverage Goal**: 80%+ code coverage

### Important Notes
1. **Immutability**: Never DELETE consent records. Use withdrawn_at for revocation.
2. **Blocking Submission**: Story 2.3 must validate consents before allowing DRAFT → SUBMITTED transition.
3. **Versioning**: Privacy policy updates may require new consent version (increment version field).
4. **IP & User Agent**: Capture from request headers for regulatory compliance.
5. **Cascade Delete**: If user deleted, consents cascade (but retention rules apply - see Story 5.4).
6. **Marketing Consent**: Optional, can be withdrawn without affecting application.
7. **ESIGNATURE Consent**: Placeholder for Phase 2, not enforced in MVP.
8. **Frontend Integration**: Consent checkboxes must be unchecked by default (explicit consent).

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5 (Jupiter) + Spring Boot Test
- **Mocking**: Mockito for unit tests
- **Integration Testing**: TestContainers (PostgreSQL) for database tests
- **HTTP Testing**: TestRestTemplate for REST API integration tests
- **Security Testing**: Spring Security Test with @WithMockUser
- **Test Location**: `src/test/java/com/creditapp/`
  - Unit tests: `src/test/java/com/creditapp/unit/shared/ConsentServiceUnitTest.java`
  - Integration tests: `src/test/java/com/creditapp/integration/borrower/ConsentManagementIntegrationTest.java`
- **Test Class Naming**: `{ComponentName}UnitTest.java` for unit tests, `{Feature}IntegrationTest.java` for integration tests

### Testing Checklist

**Unit Tests (ConsentServiceUnitTest.java)**
- [ ] Grant DATA_COLLECTION consent, verify Consent entity created with consentedAt timestamp
- [ ] Grant multiple consent types simultaneously, verify all persisted
- [ ] Withdraw consent, verify withdrawnAt set (record NOT deleted)
- [ ] Verify withdrawn consent returns false for isConsentGiven()
- [ ] Get current consents, verify only active consents returned (withdrawn_at IS NULL)
- [ ] Re-grant previously withdrawn consent, verify new version created
- [ ] Verify AuditService.logEvent() called for CONSENT_GRANTED events
- [ ] Verify AuditService.logEvent() called for CONSENT_WITHDRAWN events
- [ ] ConsentRepository mock verifies correct queries executed

**Integration Tests (ConsentManagementIntegrationTest.java)**
- [ ] POST /api/borrower/consent with valid consent types, verify 201 Created
- [ ] POST consent, verify persisted in database with borrower_id foreign key
- [ ] GET /api/borrower/consent, verify returns list of current consents
- [ ] GET consent, verify withdrawn consents NOT included in list
- [ ] PUT /api/borrower/consent/withdraw, verify withdrawnAt timestamp updated
- [ ] Withdraw consent, verify original consent record preserved (not deleted)
- [ ] Attempt application submission without DATA_COLLECTION consent, verify 400 Bad Request
- [ ] Attempt application submission without BANK_SHARING consent, verify 400 Bad Request
- [ ] Grant required consents (DATA_COLLECTION + BANK_SHARING), submit application, verify 201 Created
- [ ] Withdraw BANK_SHARING consent, verify pending applications cancelled
- [ ] Verify ip_address and user_agent captured from request headers
- [ ] Verify consent version increments on re-grant
- [ ] Verify audit log entry created with CONSENT_GRANTED event
- [ ] Verify audit log entry created with CONSENT_WITHDRAWN event
- [ ] Unauthenticated request to consent endpoints, verify 401 Unauthorized
- [ ] Non-BORROWER role accessing consent endpoints, verify 403 Forbidden
- [ ] Different borrower cannot access other borrower's consents, verify 403 Forbidden
- [ ] Database constraint test: unique (borrower_id, consent_type, version) enforced
- [ ] Database index test: queries on (borrower_id, consent_type) use index (verify with EXPLAIN)

**Edge Cases & Error Handling**
- [ ] Grant consent with invalid consent_type, verify validation error
- [ ] Withdraw consent that was never granted, verify 404 Not Found
- [ ] Withdraw already withdrawn consent, verify idempotent (no error)
- [ ] Grant consent with missing request body, verify 400 Bad Request
- [ ] Verify ConsentType enum validation (invalid values rejected)

**Performance Tests**
- [ ] Query 1000 consents for borrower, verify response time < 100ms
- [ ] Verify database indexes improve query performance (compare with/without indexes)

**Test Coverage Requirements**
- [ ] All ConsentService methods covered (grantConsent, withdrawConsent, isConsentGiven, getCurrentConsents)
- [ ] All REST endpoints covered (GET, POST, PUT /api/borrower/consent)
- [ ] All error handlers covered (MissingConsentException, validation errors)
- [ ] Code coverage >80% (measured by JaCoCo)
- [ ] All tests pass with `mvn clean test`
- [ ] Integration tests pass with `mvn verify`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Consent Management Framework | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*


