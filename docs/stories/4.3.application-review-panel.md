# Story 4.3: Application Review Panel

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to view full application details and consents in a dedicated review panel,
**so that** I can assess borrower's fitness before submitting an offer.

## Acceptance Criteria

1. GET /api/bank/applications/{applicationId} returns full application details
2. Display borrower details: name, email, phone, address
3. Display loan request: type, amount, term (months), purpose, income documentation status
4. Display employment: employer, position, annual income, years employed
5. Display consent checklist: Consent 1 (Credit Check), Consent 2 (Third-party Share), Consent 3 (Loan Service Terms)
6. Each consent shows: consent text, borrower signature, timestamp
7. Show calculated offer (from Story 3.3) or submitted offer (if exists)
8. Mark application status as VIEWED when bank views it (audit log: APPLICATION_VIEWED_BY_BANK)
9. Collapsible internal notes section (text field, default blank)
10. Response time: <200ms

## Tasks / Subtasks

- [ ] Task 1: Create Application Details DTOs
  - [ ] Create BorrowerDetailsDTO (name, email, phone, address)
  - [ ] Create LoanRequestDTO (type, amount, term, purpose, docStatus)
  - [ ] Create EmploymentDetailsDTO (employer, position, annualIncome, yearsEmployed)
  - [ ] Create ConsentDetailsDTO (text, borrowerSignature, timestamp, status)
  - [ ] Create ApplicationDetailsResponse (borrower, loan, employment, consents[], offer, internalNotes)

- [ ] Task 2: Create Application Details Service
  - [ ] Create BankApplicationDetailsService
    - Method: getApplicationDetails(UUID bankId, UUID applicationId)
      - Fetch Application by ID, verify it matches bankId (offer from bankId)
      - Fetch Borrower details
      - Fetch LoanRequest details
      - Fetch Employment details
      - Fetch Consents (all 3), include text and timestamp
      - Fetch Offer (calculated from Story 3.3 or submitted)
      - Return ApplicationDetailsResponse
      - Ensure <200ms response

- [ ] Task 3: Create Application Review Controller
  - [ ] Create BankApplicationReviewController
    - GET /api/bank/applications/{applicationId}
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Extract bankId from SecurityContext
      - Call ApplicationDetailsService.getApplicationDetails()
      - Mark application as VIEWED (see Task 4)
      - Return ApplicationDetailsResponse with 200 OK

- [ ] Task 4: Mark as VIEWED Functionality
  - [ ] Update Application status to VIEWED
    - Add audit log entry: type=APPLICATION_VIEWED_BY_BANK, bankId, applicationId, timestamp
    - Verify application not already declined
    - Only allow one VIEWED status per bank
  - [ ] Create AuditLog entity (id, type, bankId, applicationId, timestamp, details)
  - [ ] Create BankApplicationAuditService

- [ ] Task 5: Internal Notes Section
  - [ ] Add internalNotes field to ApplicationBankNotes (or create new entity)
  - [ ] GET includes current notes (empty string if none)
  - [ ] Support PUT /api/bank/applications/{applicationId}/notes with notes text
  - [ ] Audit log: APPLICATION_NOTES_UPDATED when notes change

- [ ] Task 6: Consent Display
  - [ ] Fetch all 3 consents from Consent entity
    - Consent 1: "I authorize the bank to check my credit report and history"
    - Consent 2: "I authorize the bank to share my information with third-party service providers"
    - Consent 3: "I agree to the loan service terms and conditions"
  - [ ] Display consent status: signed=true (with signature), pending=false
  - [ ] Show signature and timestamp for each signed consent

- [ ] Task 7: Unit Tests
  - [ ] Test fetching application details
  - [ ] Test VIEWED status update
  - [ ] Test audit log entry creation
  - [ ] Test internal notes save/retrieve
  - [ ] Test consent display

- [ ] Task 8: Integration Tests
  - [ ] Create application with all details
  - [ ] Fetch via controller, verify all details returned
  - [ ] Verify status changed to VIEWED
  - [ ] Verify audit log entry created
  - [ ] Verify performance <200ms
  - [ ] Test notes persist across requests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Application Review Panel | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
