# Story 3.5: Offer Selection & Intent Submission

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to indicate which preliminary offer I'm interested in,
**so that** the bank knows I'm a qualified borrower.

## Acceptance Criteria

1. POST /api/borrower/applications/{applicationId}/select-offer accepts offer_id
2. Validation: offer_id must belong to application, not expired
3. Sets borrower_selected_at timestamp; status to ACCEPTED
4. Only one offer can be selected per application
5. Borrower can change selection until expires
6. Application status updates to OFFER_ACCEPTED
7. Email sent to borrower and bank
8. Audit log: "OFFER_SELECTED"
9. Response includes selected offer + next steps
10. Integration test: retrieve offers, select one, verify status ACCEPTED, verify email sent

## Tasks / Subtasks

- [ ] Task 1: Create Offer Selection Request/Response DTOs (AC: 1, 9)
  - [ ] Create SelectOfferRequest (src/main/java/com/creditapp/borrower/dto/SelectOfferRequest.java)
    - Field: offerId (UUID)
    - Validation: @NotNull, @NotBlank
  - [ ] Create SelectOfferResponse (src/main/java/com/creditapp/borrower/dto/SelectOfferResponse.java)
    - Fields: selectedOfferId, bankName, apr, monthlyPayment, totalCost, expiresAt, nextSteps, message
    - nextSteps: List of recommended next actions (e.g., "Submit income documents", "Schedule call with bank")
    - message: "You've selected this offer. The bank will review your application."

- [ ] Task 2: Create Offer Selection Service (AC: 2, 3, 4, 5, 6)
  - [ ] Create OfferSelectionService (src/main/java/com/creditapp/borrower/service/OfferSelectionService.java)
    - Method: selectOffer(UUID applicationId, UUID borrowerId, UUID offerId) returns SelectOfferResponse
      - Fetch Application, verify borrowerId matches (access control)
      - Fetch Offer, verify offerId belongs to applicationId
      - If offer not found or expired (expiresAt < now), throw OfferExpiredException
      - Check if offer is not already selected by different borrower (AC4)
      - Set offer.borrower_selected_at = now
      - Set offer.offerStatus = ACCEPTED
      - Update application.status = OFFER_ACCEPTED
      - Save both entities
      - Call email service to notify borrower and bank (async, AC7)
      - Log audit event: OFFER_SELECTED (AC8)
      - Return SelectOfferResponse with offer details + next steps
    - Method: changeOfferSelection(UUID applicationId, UUID borrowerId, UUID newOfferId)
      - Fetch current selected offer, mark as CALCULATED or REJECTED
      - Select new offer (same validation as selectOffer)
      - Send email to old bank (offer deselected) and new bank (offer selected)
      - Log: OFFER_SELECTION_CHANGED
    - Error handling:
      - OfferExpiredException (410 Gone) if offer expired
      - InvalidOfferException (400) if offer doesn't belong to application
      - ApplicationNotFoundException (404) if app not found
      - UnauthorizedException (403) if borrower doesn't own application
  - [ ] Unit tests: mock repositories, test validation, test status updates

- [ ] Task 3: Create REST Controller Endpoint (AC: 1, 9)
  - [ ] Create or update BorrowerOfferController
    - POST /api/borrower/applications/{applicationId}/select-offer
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Path parameter: applicationId
      - Request body: @Valid SelectOfferRequest
      - Extract borrowerId from SecurityContext
      - Call OfferSelectionService.selectOffer(applicationId, borrowerId, offerId)
      - Return ResponseEntity<SelectOfferResponse> with HTTP 200 OK
      - Response includes: selectedOffer, nextSteps, message
  - [ ] Error handling:
    - 400 Bad Request: invalid offer, offer expired, validation failure
    - 403 Forbidden: borrower doesn't own application
    - 404 Not Found: application not found
    - 410 Gone: offer expired
    - 500 Internal Server Error: unexpected failures
  - [ ] Unit tests: mock service, test success and error paths

- [ ] Task 4: Create Email Notification Service (AC: 7)
  - [ ] Create OfferSelectionEmailService (src/main/java/com/creditapp/shared/service/OfferSelectionEmailService.java)
    - Method: sendOfferSelectedToBorrower(Borrower borrower, Offer offer, Application app) returns boolean
      - Send email to borrower
      - Subject: "You've selected an offer from {bankName}"
      - Body: Recap of offer terms, next steps, ask borrower to provide documents
      - Include link to application dashboard
    - Method: sendOfferSelectedToBank(Organization bank, Offer offer, Borrower borrower) returns boolean
      - Send email to bank
      - Subject: "A borrower has selected your offer"
      - Body: Borrower details, offer recap, instruction to review and contact
    - Method: sendOfferDeselectedToBank(Organization bank, Offer offer, Borrower borrower)
      - Send email to old bank when borrower changes selection
      - Subject: "A borrower has deselected your offer"
      - Body: Borrower deselected, not longer interested in offer
    - All methods non-blocking: use @Async
  - [ ] Unit tests: mock email service, verify correct recipients and content

- [ ] Task 5: Create Application Status Transition (AC: 3, 6)
  - [ ] Update Application entity to include:
    - Field: offerSelectedAt (LocalDateTime, nullable)
    - Field: selectedOfferId (UUID, nullable FK to Offer)
  - [ ] Update ApplicationStatus enum to include: OFFER_ACCEPTED (new status)
  - [ ] Update ApplicationStatusTransitionService (from Story 2.1)
    - Add valid transition: SUBMITTED -> OFFER_ACCEPTED
    - Add valid transition: OFFER_ACCEPTED -> OFFER_ACCEPTED (can change selection)
  - [ ] Database migration: add columns to applications table

- [ ] Task 6: Add One Offer Per Application Validation (AC: 4)
  - [ ] In OfferSelectionService.selectOffer()
    - Query for existing selected offers for application
    - If one already selected and is different from current selection
      - Deselect previous offer (mark as CALCULATED)
      - Mark new one as ACCEPTED
    - Enforce: only ONE offer can have status=ACCEPTED per application

- [ ] Task 7: Add Expiration Check (AC: 2, 5)
  - [ ] In OfferSelectionService.selectOffer()
    - Validate offer.expiresAt > now
    - If expired, throw OfferExpiredException with 410 Gone response
    - Include expiration time in error message: "Offer expired at {expiresAt}"
  - [ ] Allow selection until moment of expiration (not before)

- [ ] Task 8: Create Next Steps Generator (AC: 9)
  - [ ] Create NextStepsService (src/main/java/com/creditapp/shared/service/NextStepsService.java)
    - Method: generateNextSteps(Offer offer, LoanType loanType) returns List<String>
      - Return personalized list of next actions based on offer and loan type
      - Examples:
        - "Submit proof of income (pay stubs or tax returns)"
        - "Submit government-issued ID"
        - "Schedule a call with our loan officer"
        - "Provide recent bank statements"
      - For each bank, maintain custom next steps or use defaults
    - nextSteps should align with offer.requiredDocuments
  - [ ] Unit tests: verify next steps include loan type and offer-specific items

- [ ] Task 9: Add Audit Logging (AC: 8)
  - [ ] Ensure OfferSelectionService logs to AuditService (Story 1.7)
    - Event: OFFER_SELECTED
    - Fields: borrowerId, applicationId, offerId, bankId, apr, selectedAt
  - [ ] Log offer deselection: OFFER_DESELECTED
    - Fields: borrowerId, applicationId, deselectedOfferId, reason (if applicable)
  - [ ] Log error attempts: OFFER_SELECTION_FAILED
    - Fields: borrowerId, applicationId, offerId, reason (expired, invalid, etc.)

- [ ] Task 10: Create Unit Tests (AC: 2, 4, 5, 6)
  - [ ] Create OfferSelectionServiceTest (src/test/java/com/creditapp/unit/borrower/OfferSelectionServiceTest.java)
    - Test 1: Happy path - select valid offer, verify ACCEPTED status, verify application OFFER_ACCEPTED
    - Test 2: Offer expired - select expired offer, verify 410 Gone
    - Test 3: Offer doesn't belong to application - select wrong offer, verify 400 Bad Request
    - Test 4: One offer max - select new offer, verify old deselected and new selected
    - Test 5: Can change selection - select offer A, then offer B, verify B selected and A deselected
    - Test 6: Access control - different borrower cannot select offer
    - Test 7: Application not found - select offer for non-existent app, verify 404
    - Test 8: Email service called - verify sendOfferSelectedToBorrower and Bank called
    - Test 9: borrower_selected_at timestamp - verify set to current time
    - Test 10: Audit event logged - verify OFFER_SELECTED event
  - [ ] Mock: OfferRepository, ApplicationRepository, OrganizationRepository, OfferSelectionEmailService, AuditService
  - [ ] Framework: JUnit 5, Mockito

- [ ] Task 11: Create Integration Tests (AC: 1, 10)
  - [ ] Create OfferSelectionIntegrationTest (src/test/java/com/creditapp/integration/borrower/OfferSelectionIntegrationTest.java)
    - Setup: Create application, submit, create offers, retrieve offers
    - Test 1: POST select offer, verify 200 OK with SelectOfferResponse
    - Test 2: Verify offer status changed to ACCEPTED in database
    - Test 3: Verify application status changed to OFFER_ACCEPTED
    - Test 4: Verify borrower_selected_at timestamp set
    - Test 5: Verify email sent to borrower (mock email service)
    - Test 6: Verify email sent to bank (mock email service)
    - Test 7: Verify next steps included in response
    - Test 8: Select expired offer - verify 410 Gone
    - Test 9: Change selection - select offer A, then B, verify A deselected
    - Test 10: Unauthenticated POST - verify 401 Unauthorized
    - Test 11: Different borrower - verify 403 Forbidden
    - Test 12: Invalid offer ID - verify 400 Bad Request
    - Test 13: Verify audit log entry created with OFFER_SELECTED event
  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate, WireMock for email service
  - [ ] Database: Real data with application and offers

- [ ] Task 12: Create API Documentation (AC: 1, 7, 9)
  - [ ] Update docs/API_ENDPOINTS.md
    - Endpoint: POST /api/borrower/applications/{applicationId}/select-offer
    - Authentication: Bearer {JWT token}, BORROWER role required
    - Request body:
      `json
      {
        "offerId": "550e8400-e29b-41d4-a716-446655440001"
      }
      `
    - Response (200 OK):
      `json
      {
        "selectedOfferId": "550e8400-e29b-41d4-a716-446655440001",
        "bankName": "Example Bank",
        "apr": 8.5,
        "monthlyPayment": 775.67,
        "totalCost": 27944.12,
        "expiresAt": "2026-01-15T10:30:00Z",
        "nextSteps": [
          "Submit proof of income",
          "Submit government-issued ID",
          "Schedule call with loan officer"
        ],
        "message": "You've selected this offer. The bank will review your application."
      }
      `
    - Error responses:
      - 400 Bad Request: { "error": "Invalid Offer", "message": "Offer does not belong to this application" }
      - 403 Forbidden: { "error": "Forbidden", "message": "You cannot access this application" }
      - 404 Not Found: { "error": "Not Found", "message": "Application not found" }
      - 410 Gone: { "error": "Offer Expired", "message": "This offer expired at 2026-01-15T10:30:00Z" }

- [ ] Task 13: Create Exception Classes (AC: 2)
  - [ ] Create OfferExpiredException (extends RuntimeException)
    - Include expiresAt in exception for error response
  - [ ] Create InvalidOfferException (extends RuntimeException)
  - [ ] Create OfferAlreadySelectedException (extends RuntimeException)
  - [ ] Update GlobalExceptionHandler to handle new exceptions
    - OfferExpiredException -> 410 Gone
    - InvalidOfferException -> 400 Bad Request
    - OfferAlreadySelectedException -> 409 Conflict

- [ ] Task 14: Add Transaction Management (AC: 3, 4, 6)
  - [ ] Update OfferSelectionService methods with @Transactional
    - selectOffer: @Transactional(isolation = Isolation.SERIALIZABLE)
      - Prevents race condition where two borrowers select same offer simultaneously
  - [ ] Use pessimistic locking if needed (SELECT FOR UPDATE)

- [ ] Task 15: Create Logging and Monitoring (AC: 8)
  - [ ] Add logging to OfferSelectionService
    - DEBUG: offer selection started, validations passed
    - INFO: offer selected successfully
    - WARN: offer expired, invalid offer
    - ERROR: database errors, email sending failures
  - [ ] Add metrics: number of offer selections per day, average time to selection

## Dev Notes

### Previous Stories Dependencies
- **Story 2.1 & 2.2**: Application entity and submission
- **Story 3.3**: Offer calculation
- **Story 3.4**: Offer retrieval (borrower views offers first)
- **Story 1.7**: AuditService for logging

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA
- **Transaction Management**: @Transactional with SERIALIZABLE isolation
- **Email Service**: SendGrid or similar (reuse from Story 1.4)
- **Async Processing**: @Async for email sending
- **Database**: PostgreSQL 15.4

### API Specification
[Source: Story 3.5 AC]
- **Endpoint**: POST /api/borrower/applications/{applicationId}/select-offer
- **Request**: SelectOfferRequest with offerId
- **Response**: SelectOfferResponse with offer details + next steps
- **Status Updates**: Offer -> ACCEPTED, Application -> OFFER_ACCEPTED
- **Expiration Check**: Must validate offer not expired
- **Email Notifications**: To borrower and bank (async)

### Email Templates
[Source: AC: 7]
**To Borrower:**
- Subject: "You've selected an offer from {bankName}"
- Include: Offer terms recap, next steps, application dashboard link

**To Bank:**
- Subject: "A borrower has selected your offer"
- Include: Borrower details, offer recap, instructions for bank follow-up

**On Deselection:**
- Subject: "A borrower has deselected your offer"
- Include: Notification that borrower chose different offer

### One Offer Per Application Pattern
[Source: AC: 4, 5]
- Only one Offer can have status=ACCEPTED per application
- When new offer selected:
  - Deselect previous (mark as CALCULATED or REJECTED)
  - Select new offer (mark as ACCEPTED)
- Borrower can change selection multiple times until offer expires

### Transaction Safety
[Source: AC: 2, 4]
- Use @Transactional(isolation = Isolation.SERIALIZABLE) on selectOffer
- Prevents race condition where two borrowers select same offer
- Alternative: Use pessimistic locking (SELECT FOR UPDATE) on offer row

### Project Directory Structure
`
src/main/java/com/creditapp/
 borrower/
    controller/        # BorrowerOfferController.java (add POST endpoint)
    service/           # OfferSelectionService.java, NextStepsService.java
    dto/               # SelectOfferRequest.java, SelectOfferResponse.java
    exception/         # OfferExpiredException.java, InvalidOfferException.java
 shared/
    service/           # OfferSelectionEmailService.java
    model/             # Application.java (update with offerSelectedAt, selectedOfferId, OFFER_ACCEPTED status)

src/test/java/com/creditapp/
 unit/
    borrower/
      OfferSelectionServiceTest.java
 integration/
    borrower/
      OfferSelectionIntegrationTest.java
`

### Important Notes
1. **Expiration Enforcement**: Offer must not be expired (expiresAt > now)
2. **One Per Application**: Only ONE offer can be selected; changing selection deselects previous
3. **Borrower Can Change**: Selection can be changed until offer expires
4. **Email Notifications**: Async, non-blocking email to both borrower and bank
5. **Application Status**: Updates to OFFER_ACCEPTED to track workflow
6. **Selected Timestamp**: borrower_selected_at captures moment of selection
7. **Transaction Safety**: SERIALIZABLE isolation prevents race conditions
8. **Next Steps**: Personalized based on loan type and required documents
9. **Audit Trail**: All selections/deselections logged for compliance
10. **Error Messages**: Clear explanation if offer expired or invalid

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, Spring Data JPA Test, TestContainers
- **Mocking**: Mockito for repositories and email service
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/

### Testing Checklist
- [ ] Offer selection: valid offer selected successfully
- [ ] Offer status: updated to ACCEPTED
- [ ] Application status: updated to OFFER_ACCEPTED
- [ ] Timestamp: borrower_selected_at set to current time
- [ ] Expired offer: rejected with 410 Gone
- [ ] Invalid offer: rejected with 400 Bad Request
- [ ] Access control: different borrower gets 403
- [ ] One per application: new selection deselects old
- [ ] Can change: selection can be changed multiple times
- [ ] Email to borrower: sent with correct content
- [ ] Email to bank: sent with correct content
- [ ] Next steps: included in response, matches loan type
- [ ] Audit logging: OFFER_SELECTED event logged
- [ ] Transaction safety: concurrent selections handled
- [ ] Application not found: 404 error
- [ ] Controller endpoint: POST returns 200 OK
- [ ] Controller authorization: requires BORROWER role
- [ ] Error responses: all codes (400, 403, 404, 410)
- [ ] Integration test: end-to-end offer selection
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Selection & Intent Submission | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
