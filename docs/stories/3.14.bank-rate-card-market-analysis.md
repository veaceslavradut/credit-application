# Story 3.14: Bank Rate Card Market Analysis

## Status
Ready for Review

## Story

**As a** bank administrator,
**I want** to see market analysis comparing my bank's rate cards to competitors,
**so that** I can price my offers competitively and attract more borrowers.

## Acceptance Criteria

1. GET /api/bank/rate-cards/market-analysis returns competitive analysis for authenticated bank
2. Response includes: my_bank_rates, market_average_rates, percentile_ranking, competitive_position
3. Market average calculated across all active banks for same loan_type and currency
4. Percentile ranking: where bank's APR falls in market (0-100, lower APR = higher percentile)
5. Competitive position indicator: "More Competitive", "Average", "Less Competitive"
6. Comparison includes: base_apr, origination_fee, insurance_cost, processing_time
7. Only BANK_ADMIN can view analysis for their own bank
8. Market data anonymized: no competitor bank names revealed
9. Minimum 3 banks required for market analysis (privacy protection)
10. Integration test: create rate cards for 3+ banks, verify analysis calculated correctly

## Tasks / Subtasks

- [x] Task 1: Create Market Analysis DTOs (AC: 2, 3, 4, 5, 6)
  - [x] Create MarketAnalysisDTO (src/main/java/com/creditapp/bank/dto/MarketAnalysisDTO.java)
    - Fields: myBankRates (List<MyBankRateCardDTO>), marketAverageRates (List<MarketAverageDTO>), overallCompetitivePosition (String), analysisDate (LocalDateTime), bankCount (Integer)
  - [x] Create MyBankRateCardDTO (src/main/java/com/creditapp/bank/dto/MyBankRateCardDTO.java)
    - Fields: loanType, currency, baseApr, marketPercentileRanking (Integer), competitivePosition (String), originationFeePercent, insurancePercent, processingTimeDays
  - [x] Create MarketAverageDTO (src/main/java/com/creditapp/bank/dto/MarketAverageDTO.java)
    - Fields: loanType, currency, averageApr, medianApr, minApr, maxApr, averageOriginationFee, averageInsuranceCost, averageProcessingTime, bankCount
  - [x] Create CompetitivePositionEnum: MORE_COMPETITIVE, AVERAGE, LESS_COMPETITIVE

- [x] Task 2: Create Market Analysis Service (AC: 2, 3, 4, 5, 6, 9)
  - [ ] Create BankMarketAnalysisService (src/main/java/com/creditapp/bank/service/BankMarketAnalysisService.java)
    - Method: analyzeMarket(UUID bankId) returns MarketAnalysisDTO
      - Fetch all active rate cards for bank
      - For each rate card, fetch market data (same loan_type + currency)
      - Require minimum 3 banks for market analysis (throw InsufficientMarketDataException if < 3)
      - Calculate market averages
      - Calculate percentile ranking for bank
      - Determine competitive position
      - Return MarketAnalysisDTO
    - Method: calculateMarketAverage(LoanType loanType, Currency currency) returns MarketAverageDTO
      - Query all active rate cards for loanType + currency
      - Calculate average APR, median APR, min, max
      - Calculate average fees and processing time
      - Return anonymized market data (no bank names)
    - Method: calculatePercentileRanking(BigDecimal myApr, List<BigDecimal> allAprs) returns Integer
      - Sort all APRs ascending
      - Find position of myApr
      - Return percentile: (position / total)  100
      - Lower APR = higher percentile (better)
    - Method: determineCompetitivePosition(Integer percentile) returns CompetitivePosition
      - percentile >= 75: MORE_COMPETITIVE
      - percentile 25-74: AVERAGE
      - percentile < 25: LESS_COMPETITIVE
  - [x] Unit tests: mock repository, test percentile calculation, test competitive position logic

- [x] Task 3: Create Market Analysis REST Controller (AC: 1, 7)
  - [x] Create BankMarketAnalysisController (src/main/java/com/creditapp/bank/controller/BankMarketAnalysisController.java)
    - GET /api/bank/rate-cards/market-analysis
    - @PreAuthorize("hasAuthority('BANK_ADMIN')")
    - Extract bankId from SecurityContext
    - Call BankMarketAnalysisService.analyzeMarket(bankId)
    - Return MarketAnalysisDTO with 200 OK
    - Error handling:
      - 404 Not Found: no active rate cards for bank
      - 412 Precondition Failed: < 3 banks in market (insufficient data)
  - [x] Unit tests: mock service, test success and error paths

- [x] Task 4: Add Privacy Protection (AC: 8, 9)
  - [x] Ensure no competitor bank names or IDs exposed in response
  - [x] Minimum 3 banks required for analysis
  - [x] MarketAverageDTO includes bankCount field (shows number of competitors)
  - [x] Log market analysis requests (audit trail)

- [x] Task 5: Create Caching Layer (optional for performance)
  - [x] Cache market analysis results
    - @Cacheable("marketAnalysis") on analyzeMarket method
    - Cache key: bankId
    - TTL: 24 hours (market doesn't change frequently)
  - [x] Invalidate cache when any bank updates rate cards

- [x] Task 6: Create Visualization Data (AC: 6)
  - [x] Add chart-ready data to response:
    - aprDistribution: histogram data for market APR distribution
    - feeComparison: bar chart data comparing my fees to market average
    - processingTimeComparison: scatter plot data
  - [x] Create ChartDataDTO for frontend visualization

- [x] Task 7: Create Integration Tests (AC: 10)
  - [x] Create BankMarketAnalysisIntegrationTest (src/test/java/com/creditapp/integration/bank/BankMarketAnalysisIntegrationTest.java)
    - Setup: Create 4 banks with rate cards (same loan_type/currency)
    - Test 1: GET market analysis, verify market average calculated correctly
    - Test 2: GET market analysis, verify median APR calculated
    - Test 3: GET market analysis, verify min/max APR identified
    - Test 4: GET market analysis, verify percentile ranking calculated correctly
    - Test 5: Bank with lowest APR, verify MORE_COMPETITIVE position
    - Test 6: Bank with mid-range APR, verify AVERAGE position
    - Test 7: Bank with highest APR, verify LESS_COMPETITIVE position
    - Test 8: GET with < 3 banks in market, verify 412 Precondition Failed
    - Test 9: Verify no competitor bank names in response (privacy)
    - Test 10: Different BANK_ADMIN cannot see analysis (403 Forbidden)
  - [x] Use: TestContainers (PostgreSQL), TestRestTemplate

- [x] Task 8: Create API Documentation (AC: 1, 2)
  - [x] Document GET /api/bank/rate-cards/market-analysis
    - Response example:
      `json
      {
        "myBankRates": [
          {
            "loanType": "PERSONAL",
            "currency": "EUR",
            "baseApr": 8.5,
            "marketPercentileRanking": 65,
            "competitivePosition": "AVERAGE",
            "originationFeePercent": 2.5,
            "insurancePercent": 0.5,
            "processingTimeDays": 7
          }
        ],
        "marketAverageRates": [
          {
            "loanType": "PERSONAL",
            "currency": "EUR",
            "averageApr": 9.2,
            "medianApr": 8.8,
            "minApr": 7.5,
            "maxApr": 11.0,
            "averageOriginationFee": 2.8,
            "averageInsuranceCost": 0.6,
            "averageProcessingTime": 10,
            "bankCount": 5
          }
        ],
        "overallCompetitivePosition": "AVERAGE",
        "analysisDate": "2026-01-15T10:30:00Z",
        "bankCount": 5
      }
      `

- [x] Task 9: Create Exception Classes
  - [x] Create InsufficientMarketDataException (extends RuntimeException)
    - Thrown when < 3 banks in market
  - [x] Update GlobalExceptionHandler
    - @ExceptionHandler for InsufficientMarketDataException  412 Precondition Failed

## Dev Notes

### Previous Story Insights
- **Story 3.1**: BankRateCard entity and repository
- **Story 3.2**: Bank rate card configuration API

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Web
- **Caching**: Spring Cache / Redis (optional)
- **Statistics**: Java Streams for aggregations

### Percentile Calculation
[Source: Story requirements]
`
Percentile = (Position / Total)  100

Example: 5 banks with APRs [7.5%, 8.0%, 8.5%, 9.0%, 11.0%]
- Bank with 7.5%: position 1, percentile = (1/5)  100 = 20 (but inverted for "lower is better")
- Actually: percentile = ((total - position + 1) / total)  100
- Bank with 7.5%: (5 - 1 + 1) / 5  100 = 100 (most competitive)
- Bank with 11.0%: (5 - 5 + 1) / 5  100 = 20 (least competitive)
`

### Competitive Position Logic
[Source: Story requirements]
- **More Competitive**: Percentile  75 (APR in top 25% lowest)
- **Average**: Percentile 25-74 (APR in middle 50%)
- **Less Competitive**: Percentile < 25 (APR in bottom 25% highest)

### Privacy Protection
[Source: AC: 8, 9]
- Minimum 3 banks required to prevent identifying individual competitors
- No bank names or IDs in market data
- Only aggregated statistics (averages, medians, min/max)
- Bank count disclosed to show market size

### Project Directory Structure
`
src/main/java/com/creditapp/
 bank/
    service/           # BankMarketAnalysisService.java
    controller/        # BankMarketAnalysisController.java
    dto/               # MarketAnalysisDTO.java, MarketAverageDTO.java, MyBankRateCardDTO.java
    exception/         # InsufficientMarketDataException.java
`

## Testing

### Testing Checklist
- [x] BankMarketAnalysisService: calculates market average correctly
- [x] BankMarketAnalysisService: calculates median APR correctly
- [x] BankMarketAnalysisService: identifies min/max APR
- [x] BankMarketAnalysisService: calculates percentile ranking correctly
- [x] BankMarketAnalysisService: determines competitive position (MORE_COMPETITIVE, AVERAGE, LESS_COMPETITIVE)
- [x] BankMarketAnalysisService: requires minimum 3 banks
- [x] GET /market-analysis: returns 200 OK with analysis
- [x] GET /market-analysis: returns 412 if < 3 banks
- [x] GET /market-analysis: no competitor names in response
- [x] Percentile calculation: lower APR = higher percentile
- [x] Competitive position: top 25% APR = MORE_COMPETITIVE
- [x] Integration test: 4 banks, verify rankings correct
- [x] Different BANK_ADMIN cannot access (403 Forbidden)
- [x] All tests pass with `mvn clean test`
- [x] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - Bank Rate Card Market Analysis | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
No critical errors encountered. Minor fixes:
- Redis cache configuration: Created test-specific cache config (TestCacheConfig) to avoid Redis connection errors in test environment
- Used ConcurrentMapCacheManager for in-memory caching during tests
- Added @Profile annotations to separate test and production cache configurations

### Completion Notes
**Implementation Summary:**
- Created 5 DTOs: CompetitivePosition enum, MyBankRateCardDTO, MarketAverageDTO, MarketAnalysisDTO, MarketVisualizationDTO with nested comparison records
- Implemented BankMarketAnalysisService (251 lines) with market analysis, percentile ranking (inverted: lower APR = higher percentile), and competitive position classification
- Created REST endpoint: GET /api/bank/rate-cards/market-analysis with BANK_ADMIN authorization
- Enforced privacy protection: minimum 3 banks required per loan type/currency, anonymized competitor data
- Added Redis caching with 24h TTL: @Cacheable on analyzeMarket and calculateMarketAverage methods, @Caching evictions on rate card create/update
- Built chart-ready visualization data: APR comparisons, fee comparisons, processing time comparisons for frontend charts
- Created InsufficientMarketDataException mapped to 412 Precondition Failed
- Implemented comprehensive testing: 4/4 unit tests (BankMarketAnalysisServiceTest), 11/11 integration tests (BankMarketAnalysisIntegrationTest)
- Documented API endpoint in API_ENDPOINTS.md (157 lines) with examples, field descriptions, caching behavior, privacy notes, UI integration tips
- All compilation and tests passing

**Key Algorithms:**
- Percentile Ranking: `percentile = ((total - position + 1) / total) × 100` where position is based on sorted APRs (ascending)
- Competitive Position: >=75% MORE_COMPETITIVE, 25-74% AVERAGE, <25% LESS_COMPETITIVE
- Market Statistics: average, median (calculated manually), min, max APR across all banks

**Test Results:**
- Unit tests: 4/4 passing (percentile bounds, market average, privacy enforcement, full integration)
- Integration tests: 11/11 passing (market averages, median, min/max, percentile ranking, competitive positions, privacy protection, insufficient data, access control, visualization data)
- All acceptance criteria validated

### File List
**Production Code:**
1. src/main/java/com/creditapp/bank/dto/CompetitivePosition.java (6 lines) - Enum
2. src/main/java/com/creditapp/bank/dto/MyBankRateCardDTO.java (15 lines) - Bank rate with market context
3. src/main/java/com/creditapp/bank/dto/MarketAverageDTO.java (17 lines) - Anonymized market statistics
4. src/main/java/com/creditapp/bank/dto/MarketAnalysisDTO.java (13 lines) - Main response wrapper
5. src/main/java/com/creditapp/bank/dto/MarketVisualizationDTO.java (37 lines) - Chart-ready nested comparison records
6. src/main/java/com/creditapp/bank/service/BankMarketAnalysisService.java (251 lines) - Core market analysis engine
7. src/main/java/com/creditapp/bank/controller/BankMarketAnalysisController.java (29 lines) - REST endpoint
8. src/main/java/com/creditapp/bank/exception/InsufficientMarketDataException.java (11 lines) - Privacy exception
9. src/main/java/com/creditapp/shared/exception/GlobalExceptionHandler.java (modified, +11 lines) - Added exception mapping
10. src/main/java/com/creditapp/shared/config/CacheConfig.java (modified, +1 line) - Added @Profile("!test")
11. src/main/java/com/creditapp/bank/service/BankRateCardService.java (modified, +6 lines) - Added @Caching evictions

**Test Code:**
12. src/test/java/com/creditapp/bank/service/BankMarketAnalysisServiceTest.java (169 lines) - 4 unit tests
13. src/test/java/com/creditapp/integration/bank/BankMarketAnalysisIntegrationTest.java (376 lines) - 11 integration tests
14. src/test/java/com/creditapp/shared/config/TestCacheConfig.java (23 lines) - In-memory cache for tests
15. src/test/resources/application-test.yml (modified, +1 line) - Added spring.cache.type: none

**Documentation:**
16. docs/API_ENDPOINTS.md (modified, +157 lines) - Complete endpoint specification, examples, UI tips, updated to v1.9

## QA Results

*To be completed by QA agent after story is implemented*
