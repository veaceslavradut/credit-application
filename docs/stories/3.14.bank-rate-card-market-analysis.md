# Story 3.14: Bank Rate Card Market Analysis

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to see market analysis comparing my bank's rate cards to competitors,
**so that** I can price my offers competitively and attract more borrowers.

## Acceptance Criteria

1. GET /api/bank/rate-cards/market-analysis returns competitive analysis for authenticated bank
2. Response includes: my_bank_rates, market_average_rates, percentile_ranking, competitive_position
3. Market average calculated across all active banks for same loan_type and currency
4. Percentile ranking: where bank's APR falls in market (0-100, lower APR = higher percentile)
5. Competitive position indicator: "More Competitive", "Average", "Less Competitive"
6. Comparison includes: base_apr, origination_fee, insurance_cost, processing_time
7. Only BANK_ADMIN can view analysis for their own bank
8. Market data anonymized: no competitor bank names revealed
9. Minimum 3 banks required for market analysis (privacy protection)
10. Integration test: create rate cards for 3+ banks, verify analysis calculated correctly

## Tasks / Subtasks

- [ ] Task 1: Create Market Analysis DTOs (AC: 2, 3, 4, 5, 6)
  - [ ] Create MarketAnalysisDTO (src/main/java/com/creditapp/bank/dto/MarketAnalysisDTO.java)
    - Fields: myBankRates (List<MyBankRateCardDTO>), marketAverageRates (List<MarketAverageDTO>), overallCompetitivePosition (String), analysisDate (LocalDateTime), bankCount (Integer)
  - [ ] Create MyBankRateCardDTO (src/main/java/com/creditapp/bank/dto/MyBankRateCardDTO.java)
    - Fields: loanType, currency, baseApr, marketPercentileRanking (Integer), competitivePosition (String), originationFeePercent, insurancePercent, processingTimeDays
  - [ ] Create MarketAverageDTO (src/main/java/com/creditapp/bank/dto/MarketAverageDTO.java)
    - Fields: loanType, currency, averageApr, medianApr, minApr, maxApr, averageOriginationFee, averageInsuranceCost, averageProcessingTime, bankCount
  - [ ] Create CompetitivePositionEnum: MORE_COMPETITIVE, AVERAGE, LESS_COMPETITIVE

- [ ] Task 2: Create Market Analysis Service (AC: 2, 3, 4, 5, 6, 9)
  - [ ] Create BankMarketAnalysisService (src/main/java/com/creditapp/bank/service/BankMarketAnalysisService.java)
    - Method: analyzeMarket(UUID bankId) returns MarketAnalysisDTO
      - Fetch all active rate cards for bank
      - For each rate card, fetch market data (same loan_type + currency)
      - Require minimum 3 banks for market analysis (throw InsufficientMarketDataException if < 3)
      - Calculate market averages
      - Calculate percentile ranking for bank
      - Determine competitive position
      - Return MarketAnalysisDTO
    - Method: calculateMarketAverage(LoanType loanType, Currency currency) returns MarketAverageDTO
      - Query all active rate cards for loanType + currency
      - Calculate average APR, median APR, min, max
      - Calculate average fees and processing time
      - Return anonymized market data (no bank names)
    - Method: calculatePercentileRanking(BigDecimal myApr, List<BigDecimal> allAprs) returns Integer
      - Sort all APRs ascending
      - Find position of myApr
      - Return percentile: (position / total)  100
      - Lower APR = higher percentile (better)
    - Method: determineCompetitivePosition(Integer percentile) returns CompetitivePosition
      - percentile >= 75: MORE_COMPETITIVE
      - percentile 25-74: AVERAGE
      - percentile < 25: LESS_COMPETITIVE
  - [ ] Unit tests: mock repository, test percentile calculation, test competitive position logic

- [ ] Task 3: Create Market Analysis REST Controller (AC: 1, 7)
  - [ ] Create BankMarketAnalysisController (src/main/java/com/creditapp/bank/controller/BankMarketAnalysisController.java)
    - GET /api/bank/rate-cards/market-analysis
    - @PreAuthorize("hasAuthority('BANK_ADMIN')")
    - Extract bankId from SecurityContext
    - Call BankMarketAnalysisService.analyzeMarket(bankId)
    - Return MarketAnalysisDTO with 200 OK
    - Error handling:
      - 404 Not Found: no active rate cards for bank
      - 412 Precondition Failed: < 3 banks in market (insufficient data)
  - [ ] Unit tests: mock service, test success and error paths

- [ ] Task 4: Add Privacy Protection (AC: 8, 9)
  - [ ] Ensure no competitor bank names or IDs exposed in response
  - [ ] Minimum 3 banks required for analysis
  - [ ] MarketAverageDTO includes bankCount field (shows number of competitors)
  - [ ] Log market analysis requests (audit trail)

- [ ] Task 5: Create Caching Layer (optional for performance)
  - [ ] Cache market analysis results
    - @Cacheable("marketAnalysis") on analyzeMarket method
    - Cache key: bankId
    - TTL: 24 hours (market doesn't change frequently)
  - [ ] Invalidate cache when any bank updates rate cards

- [ ] Task 6: Create Visualization Data (AC: 6)
  - [ ] Add chart-ready data to response:
    - aprDistribution: histogram data for market APR distribution
    - feeComparison: bar chart data comparing my fees to market average
    - processingTimeComparison: scatter plot data
  - [ ] Create ChartDataDTO for frontend visualization

- [ ] Task 7: Create Integration Tests (AC: 10)
  - [ ] Create BankMarketAnalysisIntegrationTest (src/test/java/com/creditapp/integration/bank/BankMarketAnalysisIntegrationTest.java)
    - Setup: Create 4 banks with rate cards (same loan_type/currency)
    - Test 1: GET market analysis, verify market average calculated correctly
    - Test 2: GET market analysis, verify median APR calculated
    - Test 3: GET market analysis, verify min/max APR identified
    - Test 4: GET market analysis, verify percentile ranking calculated correctly
    - Test 5: Bank with lowest APR, verify MORE_COMPETITIVE position
    - Test 6: Bank with mid-range APR, verify AVERAGE position
    - Test 7: Bank with highest APR, verify LESS_COMPETITIVE position
    - Test 8: GET with < 3 banks in market, verify 412 Precondition Failed
    - Test 9: Verify no competitor bank names in response (privacy)
    - Test 10: Different BANK_ADMIN cannot see analysis (403 Forbidden)
  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate

- [ ] Task 8: Create API Documentation (AC: 1, 2)
  - [ ] Document GET /api/bank/rate-cards/market-analysis
    - Response example:
      `json
      {
        "myBankRates": [
          {
            "loanType": "PERSONAL",
            "currency": "EUR",
            "baseApr": 8.5,
            "marketPercentileRanking": 65,
            "competitivePosition": "AVERAGE",
            "originationFeePercent": 2.5,
            "insurancePercent": 0.5,
            "processingTimeDays": 7
          }
        ],
        "marketAverageRates": [
          {
            "loanType": "PERSONAL",
            "currency": "EUR",
            "averageApr": 9.2,
            "medianApr": 8.8,
            "minApr": 7.5,
            "maxApr": 11.0,
            "averageOriginationFee": 2.8,
            "averageInsuranceCost": 0.6,
            "averageProcessingTime": 10,
            "bankCount": 5
          }
        ],
        "overallCompetitivePosition": "AVERAGE",
        "analysisDate": "2026-01-15T10:30:00Z",
        "bankCount": 5
      }
      `

- [ ] Task 9: Create Exception Classes
  - [ ] Create InsufficientMarketDataException (extends RuntimeException)
    - Thrown when < 3 banks in market
  - [ ] Update GlobalExceptionHandler
    - @ExceptionHandler for InsufficientMarketDataException  412 Precondition Failed

## Dev Notes

### Previous Story Insights
- **Story 3.1**: BankRateCard entity and repository
- **Story 3.2**: Bank rate card configuration API

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Web
- **Caching**: Spring Cache / Redis (optional)
- **Statistics**: Java Streams for aggregations

### Percentile Calculation
[Source: Story requirements]
`
Percentile = (Position / Total)  100

Example: 5 banks with APRs [7.5%, 8.0%, 8.5%, 9.0%, 11.0%]
- Bank with 7.5%: position 1, percentile = (1/5)  100 = 20 (but inverted for "lower is better")
- Actually: percentile = ((total - position + 1) / total)  100
- Bank with 7.5%: (5 - 1 + 1) / 5  100 = 100 (most competitive)
- Bank with 11.0%: (5 - 5 + 1) / 5  100 = 20 (least competitive)
`

### Competitive Position Logic
[Source: Story requirements]
- **More Competitive**: Percentile  75 (APR in top 25% lowest)
- **Average**: Percentile 25-74 (APR in middle 50%)
- **Less Competitive**: Percentile < 25 (APR in bottom 25% highest)

### Privacy Protection
[Source: AC: 8, 9]
- Minimum 3 banks required to prevent identifying individual competitors
- No bank names or IDs in market data
- Only aggregated statistics (averages, medians, min/max)
- Bank count disclosed to show market size

### Project Directory Structure
`
src/main/java/com/creditapp/
 bank/
    service/           # BankMarketAnalysisService.java
    controller/        # BankMarketAnalysisController.java
    dto/               # MarketAnalysisDTO.java, MarketAverageDTO.java, MyBankRateCardDTO.java
    exception/         # InsufficientMarketDataException.java
`

## Testing

### Testing Checklist
- [ ] BankMarketAnalysisService: calculates market average correctly
- [ ] BankMarketAnalysisService: calculates median APR correctly
- [ ] BankMarketAnalysisService: identifies min/max APR
- [ ] BankMarketAnalysisService: calculates percentile ranking correctly
- [ ] BankMarketAnalysisService: determines competitive position (MORE_COMPETITIVE, AVERAGE, LESS_COMPETITIVE)
- [ ] BankMarketAnalysisService: requires minimum 3 banks
- [ ] GET /market-analysis: returns 200 OK with analysis
- [ ] GET /market-analysis: returns 412 if < 3 banks
- [ ] GET /market-analysis: no competitor names in response
- [ ] Percentile calculation: lower APR = higher percentile
- [ ] Competitive position: top 25% APR = MORE_COMPETITIVE
- [ ] Integration test: 4 banks, verify rankings correct
- [ ] Different BANK_ADMIN cannot access (403 Forbidden)
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - Bank Rate Card Market Analysis | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
