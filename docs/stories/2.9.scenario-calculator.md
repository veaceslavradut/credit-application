# Story 2.9: Scenario Calculator

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to use an interactive calculator to explore different loan scenarios,
**so that** I can understand how loan amount, term, and rate affect my monthly payment.

## Acceptance Criteria

1. GET /api/borrower/calculator?loanAmount={amount}&loanTerm={months}&ratePercentage={rate} calculates monthly payment
2. Calculator formula: monthly_payment = (P * r * (1+r)^n) / ((1+r)^n - 1), where r=annual_rate/12, n=months
3. Response includes: monthlyPayment, totalPayment, totalInterest, breakdownByYear, amortizationSchedule (first 12 months)
4. Query parameters: loanAmount (100-1000000), loanTerm (6-360), ratePercentage (2.0-10.0)
5. Input validation: reject invalid ranges
6. No authentication required (public endpoint)
7. Response cached for 1 hour (same inputs = same output)
8. Performance: response <50ms
9. Integration test: verify calculator accuracy against reference rates

## Tasks / Subtasks

- [ ] Task 1: Create Calculator DTOs (AC: 1, 3, 4)
  - [ ] Create CalculatorRequest DTO (request params or DTO)
    - Fields: loanAmount (BigDecimal), loanTerm (Integer), ratePercentage (BigDecimal)
    - Validations: @DecimalMin(100), @DecimalMax(1000000), @Min(6), @Max(360), @DecimalMin(2.0), @DecimalMax(10.0)
  - [ ] Create CalculatorResponse DTO (src/main/java/com/creditapp/borrower/dto/CalculatorResponse.java)
    - Fields: loanAmount, loanTerm, ratePercentage, monthlyPayment, totalPayment, totalInterest, breakdownByYear, amortizationSchedule
  - [ ] Create AmortizationLine DTO
    - Fields: month, principalPayment, interestPayment, remainingBalance

- [ ] Task 2: Implement Calculator Service (AC: 2, 4, 5)
  - [ ] Create LoanCalculatorService (src/main/java/com/creditapp/borrower/service/LoanCalculatorService.java)
    - Method: calculateMonthlyPayment(BigDecimal principal, int months, BigDecimal annualRate) returns BigDecimal
      - Formula: monthlyPayment = (P * r * (1+r)^n) / ((1+r)^n - 1)
      - where r = annualRate/100/12 (convert to monthly rate)
      - where n = months
      - Use BigDecimal for precision
      - Return result rounded to 2 decimal places
    - Method: generateAmortizationSchedule(BigDecimal principal, int months, BigDecimal annualRate, int maxLines) returns List<AmortizationLine>
      - Generate amortization table (first maxLines, typically 12)
      - For each month: calculate interest, principal, remaining balance
      - Return list of amortization lines
    - Method: calculateBreakdownByYear(BigDecimal principal, int months, BigDecimal annualRate) returns Map<Integer, YearBreakdown>
      - Summarize payments and interest by year
  - [ ] Unit tests: verify calculator accuracy with known values

- [ ] Task 3: Create Calculator Endpoint (AC: 1, 6, 7)
  - [ ] Create CalculatorController (src/main/java/com/creditapp/borrower/controller/CalculatorController.java)
    - Endpoint: GET /api/borrower/calculator
    - Permitall (no authentication required)
    - Query parameters: loanAmount, loanTerm, ratePercentage
    - @CacheResult or @Cacheable("loanCalculations") for caching
    - Cache key: "amount:term:rate"
    - TTL: 1 hour
    - Call LoanCalculatorService.calculate*()
    - Return CalculatorResponse with 200 OK
    - Error handling: 400 Bad Request for invalid parameters

- [ ] Task 4: Add Input Validation (AC: 4, 5)
  - [ ] Validate query parameters
    - loanAmount: 100 to 1,000,000
    - loanTerm: 6 to 360
    - ratePercentage: 2.0 to 10.0
    - Return 400 with error message for validation failures
  - [ ] Unit tests: test validation rules

- [ ] Task 5: Create Tests (AC: 8, 9)
  - [ ] Unit test: calculate monthly payment, verify against known result
    - Example: 25000 EUR at 5% for 36 months = ~581.50 EUR/month
  - [ ] Unit test: calculate amortization schedule, verify totals
  - [ ] Unit test: breakdown by year totals correct
  - [ ] Unit test: zero rate edge case (principal / months)
  - [ ] Unit test: max values (1M at 2% for 360 months)
  - [ ] Integration test: GET /api/borrower/calculator with valid params
  - [ ] Integration test: GET with invalid params, verify 400
  - [ ] Integration test: verify caching (two identical requests)
  - [ ] Integration test: verify response time <50ms
  - [ ] Accuracy test: compare with loan calculator reference tool

- [ ] Task 6: Create Frontend Widget Data (optional)
  - [ ] Provide response format documentation for frontend embedded calculator
  - [ ] Example: frontend calls /api/borrower/calculator?loanAmount=25000&loanTerm=36&ratePercentage=5.0
  - [ ] Frontend receives amortizationSchedule for chart visualization

- [ ] Task 7: Update API Documentation (AC: 1, 3)
  - [ ] Document GET /api/borrower/calculator
    - Query parameters with ranges
    - Response example with amortization schedule
    - Calculation formula documentation
    - Example request: /api/borrower/calculator?loanAmount=25000&loanTerm=36&ratePercentage=5.0

## Dev Notes

### Previous Story Dependencies
- None (standalone calculator utility)

### Technology Stack
- **Calculation Library**: BigDecimal for precision
- **Caching**: Spring Cache with 1-hour TTL

### Key Design Notes
- Public endpoint (no authentication required)
- High precision calculations (BigDecimal)
- Cached for performance and consistency
- Amortization schedule provides detailed breakdown for educational purposes

## Testing

### Testing Checklist
- [ ] Calculate payment for 25000 @ 5% over 36 months  581.50
- [ ] Amortization schedule totals equal expected interest
- [ ] Breakdown by year is accurate
- [ ] Input validation: reject amounts <100 or >1M
- [ ] Input validation: reject terms <6 or >360
- [ ] Input validation: reject rates <2 or >10
- [ ] Caching works: second identical request is instant
- [ ] Response time <50ms for p95
- [ ] Zero rate calculation correct (principal / months)
- [ ] All tests pass with mvn clean test
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Scenario Calculator | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
