# Story 5.4: Data Deletion (Right to Erasure)

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to request deletion of all my personal data,
**so that** I can exercise my right to be forgotten.

## Acceptance Criteria

1. POST /api/borrower/data-deletion initiates deletion request
2. Soft delete: borrower marked deleted, PII anonymized, application history preserved (3-year retention)
3. Data anonymized: name -> Deleted User [hash], email -> [hash]@deleted.local, phone -> NULL
4. Application data retained: loan_amount, term, status (non-PII for audit)
5. Consent withdrawal: all consents marked WITHDRAWN
6. Email confirmation before deletion: You've requested deletion. Confirm within 7 days.
7. Confirmation link: click to confirm (prevents accidental deletion)
8. Grace period: 7 days to cancel
9. After deletion: borrower cannot log in; can re-register with same email
10. Audit log: DATA_DELETION_REQUESTED and DATA_DELETION_COMPLETED
11. Regulatory compliance: honors 3-year audit retention
12. Integration test: request deletion, confirm, verify PII anonymized but history preserved

## Tasks / Subtasks

- [ ] Task 1: Create Database Migrations for Data Deletion (AC: 2, 3, 8)
  - [ ] Create V14__Create_Data_Deletion_Request_Table.sql migration
    - Create deletion_requests table: id (UUID PK), borrower_id (UUID FK), status (PENDING, CONFIRMED, COMPLETED, CANCELLED), confirmation_token (VARCHAR UNIQUE nullable), confirmation_token_expires_at (TIMESTAMP), requested_at (TIMESTAMP), confirmed_at (TIMESTAMP nullable), completed_at (TIMESTAMP nullable), reason (VARCHAR nullable)
    - Foreign key: borrower_id -> users(id) ON DELETE CASCADE
    - Create index on (borrower_id, status)

- [ ] Task 2: Create Data Deletion JPA Entities (AC: 2, 3, 8)
  - [ ] Create DeletionRequest entity (src/main/java/com/creditapp/shared/model/DeletionRequest.java)
    - Fields: id (UUID), borrowerId (UUID), status (DeletionStatus enum), confirmationToken (String nullable), confirmationTokenExpiresAt (LocalDateTime), requestedAt (LocalDateTime), confirmedAt (LocalDateTime nullable), completedAt (LocalDateTime nullable), reason (String nullable)
    - @Entity, @Table(name="deletion_requests")
    - @Enumerated for status
  - [ ] Create DeletionStatus enum: PENDING, CONFIRMED, COMPLETED, CANCELLED

- [ ] Task 3: Create Data Deletion Repository (AC: 1)
  - [ ] Create DeletionRequestRepository (src/main/java/com/creditapp/shared/repository/DeletionRequestRepository.java)
    - Extends JpaRepository<DeletionRequest, UUID>
    - Method: findLatestByBorrowerId(UUID borrowerId) returns Optional<DeletionRequest>
    - Method: findByConfirmationToken(String token) returns Optional<DeletionRequest>
    - Method: findByStatusOrderByRequestedAtAsc(DeletionStatus status) returns List<DeletionRequest> (for batch processing)

- [ ] Task 4: Create Data Deletion Service (AC: 1, 2, 3, 5, 6, 8, 9, 10)
  - [ ] Create DataDeletionService
    - Method: requestDeletion(UUID borrowerId, String reason) returns DeletionRequestResponse
      - Create DeletionRequest with status=PENDING
      - Generate confirmation token (32-char random string)
      - Set confirmationTokenExpiresAt = now + 7 days
      - Queue email to borrower with confirmation link
      - Log DATA_DELETION_REQUESTED audit event
      - Return response: "Deletion request submitted. Check email for confirmation link."
    - Method: confirmDeletion(String confirmationToken, UUID borrowerId) returns DeletionRequestResponse
      - Verify token valid and not expired
      - Verify token belongs to borrower
      - Update status = CONFIRMED
      - Queue async deletion job
      - Log DATA_DELETION_CONFIRMED audit event
      - Return response: "Deletion confirmed. Your data will be erased shortly."
    - Method: executeDataDeletion(UUID deletionRequestId) (async)
      - Fetch User by borrowerId from DeletionRequest
      - Anonymize PII:
        - name -> "Deleted User [hash]" (e.g., "Deleted User d41d8cd98f00b204e9800998ecf8427e")
        - email -> "[hash]@deleted.local"
        - phone -> NULL
        - address -> NULL
      - Retain non-PII: id, created_at, updated_at
      - Withdraw all consents (Story 5.1)
      - Application data: KEEP loan_amount, loan_term_months, status, created_at
      - Anonymize: applicant references (set to NULL)
      - Set user.deleted_at = now
      - Update DeletionRequest status = COMPLETED
      - Log DATA_DELETION_COMPLETED audit event
    - Method: cancelDeletion(UUID borrowerId) returns DeletionRequestResponse
      - Verify pending deletion exists
      - Update status = CANCELLED
      - Send email: "Deletion request cancelled. Your data is safe."
      - Log DATA_DELETION_CANCELLED audit event
  - [ ] Unit tests: mock repositories, test deletion workflow

- [ ] Task 5: Create Data Deletion REST Controller (AC: 1, 6, 7, 8)
  - [ ] Create BorrowerDataDeletionController (src/main/java/com/creditapp/borrower/controller/BorrowerDataDeletionController.java)
    - POST /api/borrower/data-deletion
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Body: optional reason (String)
      - Extract borrowerId from SecurityContext
      - Call DataDeletionService.requestDeletion()
      - Return 202 Accepted with message "Check your email for confirmation."
    - POST /api/borrower/data-deletion/confirm
      - Query parameter: token (confirmation token)
      - Extract borrowerId from SecurityContext
      - Call DataDeletionService.confirmDeletion(token, borrowerId)
      - Return 200 OK with message "Deletion initiated."
      - Error handling: 400 Bad Request (invalid token), 401 Unauthorized
    - POST /api/borrower/data-deletion/cancel
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Extract borrowerId from SecurityContext
      - Call DataDeletionService.cancelDeletion(borrowerId)
      - Return 200 OK with message "Deletion cancelled."
  - [ ] Unit tests: mock service, test endpoints
  - [ ] Integration tests: real HTTP requests

- [ ] Task 6: Create Data Anonymization Helper (AC: 3, 4)
  - [ ] Create DataAnonymizationService
    - Method: hashForAnonymity(String input) returns String
      - Use MD5 or SHA-256 of input (first 8 chars of hash)
      - Example: "John Doe" -> "d41d8cd9" -> "Deleted User d41d8cd9"
    - Method: generateAnonymousEmail(String originalEmail) returns String
      - Extract hash from email
      - Return "[hash]@deleted.local"
  - [ ] Unit tests: verify anonymization produces consistent hashes

- [ ] Task 7: Create Async Deletion Job (AC: 1, 8, 10, 11)
  - [ ] Create DataDeletionJob (scheduled batch job)
    - Run every 1 hour
    - Query DeletionRequest with status=CONFIRMED and confirmedAt < now
    - Process each deletion request
    - Mark as COMPLETED on success, FAILED on error
    - Monitor for timeout (5 min per deletion)
  - [ ] Use @Scheduled or Quartz for scheduling

- [ ] Task 8: Create Email Notifications (AC: 6, 8)
  - [ ] Create email template: deletion-confirmation.html
    - Subject: "Confirm Data Deletion Request"
    - Body: Confirmation link valid for 7 days
    - Warning: "Clicking this link will permanently delete your account and data."
    - Cancel link: to cancel deletion request
  - [ ] Create email template: deletion-completed.html
    - Subject: "Your Account Has Been Deleted"
    - Body: Data erased, account closed
    - Can re-register with same email

- [ ] Task 9: Create Unit Tests (AC: 1, 2, 3, 8, 10)
  - [ ] Create DataDeletionServiceUnitTest
    - Test 1: Request deletion, verify token generated and status=PENDING
    - Test 2: Confirm deletion, verify status=CONFIRMED
    - Test 3: Cancel deletion, verify status=CANCELLED
    - Test 4: Anonymize name, verify format
    - Test 5: Anonymize email, verify format
    - Test 6: Execute deletion, verify user PII anonymized
    - Test 7: Execute deletion, verify application data retained (non-PII)
    - Test 8: Execute deletion, verify all consents withdrawn
  - [ ] Mock: DeletionRequestRepository, UserRepository, ConsentService, AuditService

- [ ] Task 10: Create Integration Tests (AC: 9, 11, 12)
  - [ ] Create DataDeletionIntegrationTest
    - Setup: Create borrower with applications, offers, consents, audit logs
    - Test 1: Request deletion, verify 202 Accepted
    - Test 2: Retrieve confirmation token
    - Test 3: Confirm deletion, verify status=CONFIRMED
    - Test 4: Wait for async job (or mock), verify status=COMPLETED
    - Test 5: Query user, verify name anonymized ("Deleted User...")
    - Test 6: Query user, verify email anonymized ("[hash]@deleted.local")
    - Test 7: Query user, verify phone = NULL
    - Test 8: Query applications, verify loan_amount, status retained
    - Test 9: Verify borrower cannot log in (deleted_at not NULL)
    - Test 10: Verify can re-register with same email
    - Test 11: Verify audit logs preserved (not deleted)
    - Test 12: Verify all consents marked WITHDRAWN
  - [ ] Use TestContainers for PostgreSQL

  ## Dev Notes

  ### Previous Stories Dependencies
  - Story 5.1 (Consent Management): consent withdrawal upon deletion; ensure all consents become WITHDRAWN.
  - Story 5.5 (Audit Trail Immutability): retain audit logs for 3 years; logs must not contain PII post-deletion (redaction policy applies).
  - Story 1.9 (Email Service): send confirmation and completion emails; asynchronous via @Async.
  - Story 1.6 (RBAC): only BORROWER can initiate/cancel/confirm their own deletion; admins cannot delete borrowers via this flow.
  - Story 1.7 (Audit Service): log DATA_DELETION_REQUESTED, DATA_DELETION_CONFIRMED, DATA_DELETION_COMPLETED, DATA_DELETION_CANCELLED.
  - Story 5.7 (Encryption): ensure backups, logs, and any persisted tokens remain encrypted at rest (SSE-KMS) and in transit (TLS 1.3).

  ### GDPR/Compliance Context
  - GDPR Article 17: right to erasure; exceptions for legal obligations and audit retention.
  - GDPR Article 32: processing security; one-time confirmation tokens, short TTL, RBAC enforcement.
  - Moldovan Law 133/2011: align with national data protection requirements; preserve regulatory audit trail for 3 years.
  - Retention: application/audit history preserved as non-PII analytics; PII removed or anonymized deterministically.

  ### Technology Stack
  - Spring Boot 3.2.1, Java 21.0.1, Spring Data JPA, Spring Security.
  - PostgreSQL 15.4 (Flyway migrations).
  - Async + Scheduling: @Async for emails, @Scheduled for batch deletion job.
  - Email: SendGrid provider with templated messages.

  ### Deletion/Anonymization Strategy
  - Soft-delete user with `deleted_at`, disable authentication (e.g., `enabled=false`), revoke/expire refresh tokens.
  - Deterministic anonymization using SHA-256 hash truncated to 8-12 hex chars:
    - name → "Deleted User <hash>"
    - email → "<hash>@deleted.local" (ensure uniqueness; if collision, extend hash length)
    - phone/address → NULL
  - Preserve non-PII facts for analytics and audit (e.g., loan_amount, term, status, timestamps).
  - Maintain referential integrity by nulling or re-pointing foreign keys to anonymized subject where applicable.
  - Idempotent execution: re-running deletion job on same request must not alter preserved data beyond first pass.

  ### API Specification (summary)
  - POST /api/borrower/data-deletion (BORROWER): starts request; responds 202.
  - POST /api/borrower/data-deletion/confirm?token=... (BORROWER): validates one-time token, marks CONFIRMED; responds 200.
  - POST /api/borrower/data-deletion/cancel (BORROWER): cancels if PENDING; responds 200.
  - Tokens: 32-char secure random; expiry 7 days; one-time use; tied to borrower.

  ### Scheduled Job
  - Runs hourly; selects CONFIRMED requests ready for processing.
  - Processes in small batches to avoid long transactions; per-item timeout ~5 minutes.
  - Retries with backoff on transient DB/email errors; marks irrecoverable failures for manual review.

  ### Data Retention and Legal Hold
  - Retain audit logs for 3 years; ensure no PII remains in logs (Story 5.5 redaction policy).
  - Respect any legal hold flags to postpone deletion until cleared.

  ### Security Notes
  - Endpoints require `@PreAuthorize("hasAuthority('BORROWER')")` and must validate subject = borrowerId.
  - One-time tokens stored hashed (SHA-256) to prevent token leakage if DB exposed.
  - All operations emit audit events; include trace_id for correlation.

  ### Project Directory Structure
  ```
  src/main/java/com/creditapp/
   borrower/
     controller/        # BorrowerDataDeletionController.java
   shared/
     model/             # DeletionRequest.java, DeletionStatus.java
     repository/        # DeletionRequestRepository.java
     service/           # DataDeletionService.java, DataAnonymizationService.java
     job/               # DataDeletionJob.java (scheduled)
     email/             # templates/deletion-confirmation.html, deletion-completed.html
  ```

  ### Key Dependencies
  - Story 5.1 (consents), Story 5.5 (audit), Story 5.7 (encryption), Story 1.6 (RBAC), Story 1.9 (email), Story 1.7 (audit foundation).

  ## Testing

  ### Testing Framework & Location
  - Framework: JUnit 5 (Jupiter), Spring Boot Test, Mockito.
  - Async/Jobs: Awaitility for async assertions; @SpringBootTest for scheduled job wiring.
  - Integration: TestContainers (PostgreSQL), TestRestTemplate for HTTP.
  - Location: src/test/java/com/creditapp/ with unit and integration packages mirroring main code.

  ### Testing Checklist
  - Request Flow
    - [ ] POST deletion request returns 202 and creates PENDING request with 7-day expiry token.
    - [ ] Email queued with confirmation link; content includes expiry and warning copy.
    - [ ] Duplicate PENDING request for same borrower prevented or returns idempotent response.
  - Confirmation/Cancel
    - [ ] Confirm with valid token → status=CONFIRMED; invalid/expired → 400.
    - [ ] Cancel PENDING request → status=CANCELLED; cannot cancel after CONFIRMED.
  - Scheduled Deletion Execution
    - [ ] Job picks up CONFIRMED requests and completes anonymization.
    - [ ] Idempotency: re-run job does not change already anonymized records.
    - [ ] Batch processing respects per-item timeout; failed item retried with backoff.
  - Anonymization Correctness
    - [ ] Name becomes "Deleted User <hash>" (SHA-256 truncated); stable across runs.
    - [ ] Email becomes "<hash>@deleted.local" and remains unique.
    - [ ] Phone/address set to NULL; non-PII fields preserved.
    - [ ] Foreign keys referencing borrower updated to maintain referential integrity.
  - Security and Access Control
    - [ ] Only BORROWER role can initiate/confirm/cancel own deletion (403 others).
    - [ ] Post-deletion login blocked; refresh tokens invalidated.
    - [ ] Confirmation tokens are one-time and hashed at rest.
  - Consents and Audit
    - [ ] All consents marked WITHDRAWN.
    - [ ] Audit events logged for requested/confirmed/completed/cancelled.
    - [ ] Audit logs retained and contain no PII post-deletion (verify redaction).
  - Retention and Re-registration
    - [ ] Application/audit history preserved (non-PII) for 3 years.
    - [ ] Borrower can re-register with same email; no uniqueness conflicts due to anonymized email.
  - Error Handling
    - [ ] Robust responses for 400/401/403/409/500 cases; error payloads include timestamp and tracking ID.
    - [ ] Transaction rollback leaves data consistent on mid-process failure.
  - Coverage and CI
    - [ ] All tests pass with `mvn clean test`; coverage ≥ 80%.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Data Deletion (Right to Erasure) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
