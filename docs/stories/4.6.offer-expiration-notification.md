# Story 4.6: Offer Expiration Notification

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to receive notifications when my offers are expiring or have expired,
**so that** I can resubmit offers before the 24-hour window closes.

## Acceptance Criteria

1. Batch job runs every 1 hour checking for offers expiring within 24 hours
2. Notifications: Email to bank contact, In-portal alert (inbox/banner)
3. Email: "Offer expiring soon - {borrowerName} - {APR}% APR - {hours_remaining} hours left to resubmit"
4. In-portal notification shows: Offering expiring in {X} hours, link to resubmit form
5. Dashboard shows expiring offers with orange highlight (<1 hour = red)
6. Resubmit form: Pre-filled with previous APR/fees, allow modifications
7. Prevent duplicate notifications: same offerId not notified twice within 1 hour
8. Include offer link in notification (to review application before resubmit)
9. Audit log: OFFER_EXPIRATION_NOTIFICATION_SENT with details
10. Support up to 10,000 offers without timeout

## Tasks / Subtasks

- [ ] Task 1: Create Expiration Batch Job
  - [ ] Create OfferExpirationBatchJob (src/main/java/com/creditapp/batch/OfferExpirationBatchJob.java)
    - Run on schedule: @Scheduled(fixedRate = 3600000) (every 1 hour)
    - Query offers: WHERE expiryDate > now() AND expiryDate <= now() + 24 hours AND notified=false
    - For each offer:
      - Calculate hoursRemaining
      - Call NotificationService.notifyBankOfExpiration()
      - Set notified=true on offer
      - Create audit log entry

- [ ] Task 2: Create Expiration Notification Service
  - [ ] Create BankOfferExpirationService
    - Method: notifyBankOfExpiration(Offer offer)
      - Fetch bank contact email
      - Send email notification (use Story 1.9 email service)
      - Create in-portal notification
      - Create audit log
      - Return success/failure status

- [ ] Task 3: Email Notification Template
  - [ ] Create email template: offer-expiring-notification.html
    - Subject: "Offer Expiring Soon - {borrowerName}"
    - Body includes: APR, monthly payment, hours remaining, resubmit link, application review link
    - CTA: "Resubmit Offer" button with link to form

- [ ] Task 4: In-Portal Notification
  - [ ] Create Notification entity (id, bankId, type, title, message, link, createdAt, readAt)
  - [ ] Create NotificationRepository
  - [ ] Method: createNotification(UUID bankId, String type, String message, String link)
  - [ ] Store in database for portal display

- [ ] Task 5: Resubmit Form Endpoint
  - [ ] GET /api/bank/offers/{offerId}/resubmit
    - Return previous offer details pre-filled
    - Fields: APR, fees, processingTime, monthlyPayment (all editable)
    - Show time remaining warning

- [ ] Task 6: Resubmit Offer Processing
  - [ ] POST /api/bank/offers/{offerId}/resubmit
    - Accept new offer values (APR, fees, processingTime)
    - Validate APR range (0.5-50%)
    - Recalculate monthlyPayment
    - Create new Offer record with updated values
    - Invalidate old offer (status=EXPIRED)
    - Update expiryDate (now + 24 hours)
    - Send email to borrower: "Updated Offer from {bank}: {new_APR}%"
    - Return 201 CREATED with new offer details

- [ ] Task 7: Dashboard Integration
  - [ ] Modify Story 4.2 queue to show expiration status
    - Orange highlight: expiring within 1 hour (23-24 hours)
    - Red highlight: expired (>24 hours)
    - Show "Resubmit" button for expired offers

- [ ] Task 8: Prevent Duplicate Notifications
  - [ ] Add notified=false flag to Offer entity
  - [ ] Set notified=true after notification sent
  - [ ] Query checks: notified=false in batch job

- [ ] Task 9: Unit Tests
  - [ ] Test batch job query (offers within 24 hour window)
  - [ ] Test notification generation
  - [ ] Test duplicate prevention (notified flag)
  - [ ] Test resubmit form pre-fill
  - [ ] Test resubmit validation and recalculation
  - [ ] Test audit log creation

- [ ] Task 10: Integration Tests
  - [ ] Create offers with expiryDate = now + 20 hours
  - [ ] Run batch job, verify emails sent
  - [ ] Verify in-portal notifications created
  - [ ] Verify notified=true flag set
  - [ ] Test resubmit endpoint updates offer
  - [ ] Verify performance with 10,000 offers

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Expiration Notification | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
