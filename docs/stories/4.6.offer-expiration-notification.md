# Story 4.6: Offer Expiration Notification

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to receive notifications when my offers are expiring or have expired,
**so that** I can resubmit offers before the 24-hour window closes.

## Acceptance Criteria

1. Batch job runs every 1 hour checking for offers expiring within 24 hours
2. Notifications: Email to bank contact, In-portal alert (inbox/banner)
3. Email: "Offer expiring soon - {borrowerName} - {APR}% APR - {hours_remaining} hours left to resubmit"
4. In-portal notification shows: Offering expiring in {X} hours, link to resubmit form
5. Dashboard shows expiring offers with orange highlight (<1 hour = red)
6. Resubmit form: Pre-filled with previous APR/fees, allow modifications
7. Prevent duplicate notifications: same offerId not notified twice within 1 hour
8. Include offer link in notification (to review application before resubmit)
9. Audit log: OFFER_EXPIRATION_NOTIFICATION_SENT with details
10. Support up to 10,000 offers without timeout

## Tasks / Subtasks

- [x] Task 1: Create Expiration Batch Job
  - [x] Create OfferExpirationWarningScheduler (src/main/java/com/creditapp/batch/OfferExpirationWarningScheduler.java)
    - Run on schedule: @Scheduled(fixedRate = 3600000) (every 1 hour)
    - Query offers: WHERE expiresAt > now() AND expiresAt <= now() + 24 hours AND notified=false
    - For each offer:
      - Calculate hoursRemaining
      - Call NotificationService.notifyBankOfExpiration()
      - Set notified=true on offer
      - Audit log created by notification service

- [x] Task 2: Create Expiration Notification Service
  - [x] Create BankOfferExpirationNotificationService (src/main/java/com/creditapp/bank/service/BankOfferExpirationNotificationService.java)
    - Method: notifyBankOfExpiration(Offer offer)
      - Fetch bank contact email from Organization entity
      - Send email notification (uses EmailService from Story 1.9)
      - Creates OFFER_EXPIRATION_NOTIFICATION_SENT audit log
      - Runs @Async to avoid blocking batch job

- [ ] Task 3: Email Notification Template
  - [ ] Create email template: offer-expiring-notification.html
    - Subject: "Offer Expiring Soon - {borrowerName}"
    - Body includes: APR, monthly payment, hours remaining, resubmit link, application review link
    - CTA: "Resubmit Offer" button with link to form

- [ ] Task 4: In-Portal Notification
  - [ ] Create Notification entity (id, bankId, type, title, message, link, createdAt, readAt)
  - [ ] Create NotificationRepository
  - [ ] Method: createNotification(UUID bankId, String type, String message, String link)
  - [ ] Store in database for portal display

- [ ] Task 5: Resubmit Form Endpoint
  - [ ] GET /api/bank/offers/{offerId}/resubmit
    - Return previous offer details pre-filled
    - Fields: APR, fees, processingTime, monthlyPayment (all editable)
    - Show time remaining warning

- [ ] Task 6: Resubmit Offer Processing
  - [ ] POST /api/bank/offers/{offerId}/resubmit
    - Accept new offer values (APR, fees, processingTime)
    - Validate APR range (0.5-50%)
    - Recalculate monthlyPayment
    - Create new Offer record with updated values
    - Invalidate old offer (status=EXPIRED)
    - Update expiryDate (now + 24 hours)
    - Send email to borrower: "Updated Offer from {bank}: {new_APR}%"
    - Return 201 CREATED with new offer details

- [ ] Task 7: Dashboard Integration
  - [ ] Modify Story 4.2 queue to show expiration status
    - Orange highlight: expiring within 1 hour (23-24 hours)
    - Red highlight: expired (>24 hours)
    - Show "Resubmit" button for expired offers

- [x] Task 8: Prevent Duplicate Notifications
  - [x] Add notified field to Offer entity (src/main/java/com/creditapp/bank/model/Offer.java)
  - [x] Create V30 migration: ALTER TABLE offers ADD COLUMN notified BOOLEAN DEFAULT false
  - [x] Set notified=true after notification sent in OfferExpirationWarningScheduler
  - [x] Query checks: notified=false in findOffersExpiringSoon()

- [ ] Task 9: Unit Tests
  - [ ] Test batch job query (offers within 24 hour window)
  - [ ] Test notification generation
  - [ ] Test duplicate prevention (notified flag)
  - [ ] Test resubmit form pre-fill
  - [ ] Test resubmit validation and recalculation
  - [ ] Test audit log creation

- [ ] Task 10: Integration Tests
  - [ ] Create offers with expiryDate = now + 20 hours
  - [ ] Run batch job, verify emails sent
  - [ ] Verify in-portal notifications created
  - [ ] Verify notified=true flag set
  - [ ] Test resubmit endpoint updates offer
  - [ ] Verify performance with 10,000 offers

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Expiration Notification | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
None - Initial implementation

### Completion Notes
**Session 1 - Tasks 1, 2, 8 Complete (30%):**
- ✅ Task 8: Added `notified` boolean field to Offer entity with getter/setter
- ✅ Task 8: Created V30 database migration to add notified column with index
- ✅ Task 2: Created BankOfferExpirationNotificationService with async email sending
- ✅ Task 2: Service fetches bank contact from Organization, builds HTML/text email content
- ✅ Task 2: Integrated with existing EmailService from Story 1.9
- ✅ Task 2: Creates OFFER_EXPIRATION_NOTIFICATION_SENT audit log entry
- ✅ Task 1: Created OfferExpirationWarningScheduler batch job (runs every hour)
- ✅ Task 1: Batch job queries offers expiring within 24h with notified=false
- ✅ Task 1: Sets notified=true after sending notification
- ✅ Task 1: Added Micrometer metrics for monitoring
- ✅ Added AuditAction.OFFER_EXPIRATION_NOTIFICATION_SENT enum constant
- ✅ Added OfferRepository.findOffersExpiringSoon() query method

**Remaining Tasks:**
- Task 3: Email template (optional - inline HTML used)
- Task 4: In-portal notification entity
- Task 5: GET /api/bank/offers/{id}/resubmit endpoint
- Task 6: POST /api/bank/offers/{id}/resubmit endpoint
- Task 7: Dashboard integration (color coding)
- Task 9: Unit tests
- Task 10: Integration tests

### File List
**Created:**
- src/main/java/com/creditapp/batch/OfferExpirationWarningScheduler.java (86 lines)
- src/main/java/com/creditapp/bank/service/BankOfferExpirationNotificationService.java (118 lines)
- src/main/resources/db/migration/V30__Add_Notified_Flag_To_Offers.sql (10 lines)

**Modified:**
- src/main/java/com/creditapp/bank/model/Offer.java (added notified field with getter/setter)
- src/main/java/com/creditapp/shared/model/AuditAction.java (added OFFER_EXPIRATION_NOTIFICATION_SENT)
- src/main/java/com/creditapp/bank/repository/OfferRepository.java (added findOffersExpiringSoon method)

## QA Results

*To be completed by QA agent after story is implemented*
