# Story 3.12: Offer Document Management

## Status
Ready for Development

## Story

**As a** bank loan officer or borrower,
**I want** to upload and download offer-related documents (terms & conditions, fee schedules, disclosures),
**so that** all parties have access to complete offer documentation for review and compliance.

## Acceptance Criteria

1. POST /api/offers/{offerId}/documents allows document upload (Bank officer only)
2. GET /api/offers/{offerId}/documents returns list of documents with metadata
3. GET /api/offers/{offerId}/documents/{documentId}/download returns document file
4. Document types: TERMS_CONDITIONS, FEE_SCHEDULE, DISCLOSURE, TRUTH_IN_LENDING, CUSTOM
5. Metadata: document type, file name, file size, upload date, uploader (officer name)
6. Access control: borrower can view all documents for their offers, officers can upload
7. Virus scanning: uploaded files scanned before storage (optional ClamAV integration)
8. Storage: Files stored in cloud (AWS S3 or similar) with private ACL
9. Audit trail: all uploads logged with officer details
10. Integration test: upload document, retrieve list, download file, verify content

## Tasks / Subtasks

- [ ] Task 1: Create Document Upload Request/Response DTOs (AC: 1, 5)
  - [ ] Create OfferDocumentUploadRequest (src/main/java/com/creditapp/bank/dto/OfferDocumentUploadRequest.java)
    - Field: offerId (UUID, required)
    - Field: documentType (enum, required)
      - Values: TERMS_CONDITIONS, FEE_SCHEDULE, DISCLOSURE, TRUTH_IN_LENDING, CUSTOM
    - Field: file (MultipartFile, required)
      - Validation: @NotNull, max file size 10MB
      - Allowed types: PDF, DOC, DOCX, XLS, XLSX
    - Field: description (String, optional)
      - Additional context about document

  - [ ] Create OfferDocumentMetadata (src/main/java/com/creditapp/bank/dto/OfferDocumentMetadata.java)
    - Field: documentId (UUID)
    - Field: offerId (UUID)
    - Field: documentType (String)
    - Field: fileName (String)
    - Field: fileSize (Long)
    - Field: uploadedAt (LocalDateTime)
    - Field: uploadedByOfficerId (UUID)
    - Field: uploadedByOfficerName (String)
    - Field: description (String, nullable)
    - Field: virusScanStatus (enum): PENDING, CLEAN, INFECTED
    - Field: downloadUrl (String) - signed URL for download

  - [ ] Create OfferDocumentsListResponse (src/main/java/com/creditapp/bank/dto/OfferDocumentsListResponse.java)
    - Field: documents (List<OfferDocumentMetadata>)
    - Field: offerId (UUID)
    - Field: totalCount (Integer)
    - Field: retrievedAt (LocalDateTime)

- [ ] Task 2: Create Document Entity and Repository (AC: 1, 5, 8)
  - [ ] Create OfferDocument entity (src/main/java/com/creditapp/bank/model/OfferDocument.java)
    - Field: id (UUID, @GeneratedValue)
    - Field: offerId (UUID, FK to Offer)
    - Field: documentType (enum): TERMS_CONDITIONS, FEE_SCHEDULE, DISCLOSURE, TRUTH_IN_LENDING, CUSTOM
    - Field: fileName (String)
    - Field: fileSize (Long)
    - Field: mimeType (String)
    - Field: s3Key (String) - AWS S3 object key for storage
    - Field: s3Url (String) - pre-signed download URL (expires in X hours)
    - Field: uploadedByOfficerId (UUID)
    - Field: uploadedAt (LocalDateTime)
    - Field: description (String, nullable)
    - Field: virusScanStatus (enum): PENDING, CLEAN, INFECTED
    - Field: virusScanResult (String, nullable) - details if infected
    - Field: @ManyToOne Offer offer
    - @Index on: (offerId, documentType)

  - [ ] Create OfferDocumentRepository (src/main/java/com/creditapp/bank/repository/OfferDocumentRepository.java)
    - Method: findByOfferId(UUID offerId) returns List<OfferDocument>
    - Method: findByOfferIdAndDocumentType(UUID offerId, DocumentType type)
    - Method: deleteByOfferId(UUID offerId) - cascade delete
    - Custom @Query with filtering and sorting

- [ ] Task 3: Create Document Upload Service (AC: 1, 5, 7, 8, 9)
  - [ ] Create OfferDocumentUploadService (src/main/java/com/creditapp/bank/service/OfferDocumentUploadService.java)
    - Method: uploadDocument(UUID offerId, UUID bankId, UUID officerId, OfferDocumentUploadRequest request) returns OfferDocumentMetadata
      - Fetch offer, verify bankId owns it
      - Validate file:
        - Check file size (max 10MB)
        - Check MIME type (PDF, Office documents only)
        - Check file extension matches MIME type
      - Generate unique S3 key: "offers/{offerId}/{documentType}_{timestamp}_{fileName}"
      - Upload file to S3 with:
        - Server-side encryption
        - Private ACL (only authorized users can download)
        - Metadata tags (offerId, bankId, documentType)
      - Queue file for virus scanning (async, optional ClamAV)
        - Set virusScanStatus = PENDING
      - Create OfferDocument entity:
        - Store s3Key, s3Url (pre-signed, 24-hour expiration)
        - Set uploadedByOfficerId
      - Save to database
      - Log audit event: DOCUMENT_UPLOADED (AC9)
      - Return OfferDocumentMetadata
    - Error handling:
      - File size exceeded (413 Payload Too Large)
      - Invalid file type (400 Bad Request)
      - Offer not found (404)
      - Unauthorized officer (403)
  - [ ] Unit tests: mock S3 service, test validation

- [ ] Task 4: Create Document Retrieval Service (AC: 2)
  - [ ] Create OfferDocumentRetrievalService (src/main/java/com/creditapp/bank/service/OfferDocumentRetrievalService.java)
    - Method: getDocuments(UUID offerId, UUID borrowerIdOrBankId) returns OfferDocumentsListResponse
      - Fetch offer, verify user owns it (borrower or bank officer)
      - Query all documents for offerId
      - Build OfferDocumentMetadata for each:
        - Regenerate pre-signed s3Url if expired
        - Include uploadedByOfficerName (join with User table)
      - Sort by uploadedAt descending (newest first)
      - Return OfferDocumentsListResponse
    - Error handling:
      - Offer not found (404)
      - Unauthorized access (403)

- [ ] Task 5: Create Document Download Service (AC: 3, 8)
  - [ ] Create OfferDocumentDownloadService (src/main/java/com/creditapp/bank/service/OfferDocumentDownloadService.java)
    - Method: downloadDocument(UUID offerId, UUID documentId, UUID userId) returns File stream
      - Fetch document and offer
      - Verify document belongs to offer
      - Verify user has access (borrower owns offer or bank officer from bank)
      - Check virusScanStatus:
        - If INFECTED: return 403 Forbidden (cannot download infected file)
        - If PENDING: return 202 Accepted, document not ready
        - If CLEAN: proceed with download
      - Log audit event: DOCUMENT_DOWNLOADED (AC9)
      - Return S3 file stream (via S3 pre-signed URL or direct download)
    - Error handling:
      - Document not found (404)
      - Unauthorized access (403)
      - File infected (403)
      - S3 download error (500)

- [ ] Task 6: Create Document Upload Controller (AC: 1, 3)
  - [ ] Create OfferDocumentController (src/main/java/com/creditapp/bank/controller/OfferDocumentController.java)
    - POST /api/offers/{offerId}/documents
      - @PreAuthorize("hasAuthority('BANK_OFFICER')")
      - Path param: offerId
      - Request body: @Valid OfferDocumentUploadRequest with @RequestParam file (MultipartFile)
      - Extract bankId and officerId from user context
      - Call OfferDocumentUploadService.uploadDocument(...)
      - Return ResponseEntity<OfferDocumentMetadata> with HTTP 201 CREATED
    - GET /api/offers/{offerId}/documents
      - @PreAuthorize("hasAuthority('BORROWER') or hasAuthority('BANK_OFFICER')")
      - Path param: offerId
      - Extract userId from SecurityContext
      - Call OfferDocumentRetrievalService.getDocuments(...)
      - Return OfferDocumentsListResponse with HTTP 200 OK
    - GET /api/offers/{offerId}/documents/{documentId}/download
      - @PreAuthorize("hasAuthority('BORROWER') or hasAuthority('BANK_OFFICER')")
      - Path params: offerId, documentId
      - Extract userId from SecurityContext
      - Call OfferDocumentDownloadService.downloadDocument(...)
      - Return file stream with appropriate Content-Type and Content-Disposition headers
      - HTTP 200 OK with file, or 202 Accepted if pending scan, or 403 if infected
  - [ ] Error handling: 400, 403, 404, 413, 500

- [ ] Task 7: Create AWS S3 Integration (AC: 8)
  - [ ] Create S3DocumentStorageService (src/main/java/com/creditapp/shared/service/S3DocumentStorageService.java)
    - Method: uploadFile(String key, InputStream fileStream, String contentType, Map<String, String> metadata) returns S3ObjectMetadata
      - Upload file to S3 bucket with:
        - Server-side encryption: AES256 (default) or KMS key
        - Private ACL: BucketOwnerFullControl or Private
        - Metadata tags for querying
      - Return: bucket name, key, ETag, version ID
    - Method: generatePresignedUrl(String key, Duration expiration) returns String
      - Generate pre-signed URL valid for Duration
      - Default: 24 hours
    - Method: downloadFile(String key) returns S3Object (file stream + metadata)
      - Stream file content from S3
    - Method: deleteFile(String key) returns boolean
      - Delete file from S3
    - Error handling: S3 API errors, network errors

  - [ ] Add dependency: software.amazon.awssdk:s3 (AWS SDK v2)
  - [ ] Create S3Configuration (src/main/java/com/creditapp/shared/config/S3Configuration.java)
    - @Configuration class
    - @Bean S3Client configured with:
      - AWS credentials (from environment variables or IAM role)
      - Region (from properties)
      - Request timeout settings
  - [ ] Add to application.properties:
    - creditapp.s3.bucket-name=loan-offers-documents
    - creditapp.s3.region=us-east-1
    - creditapp.s3.encryption=AES256
    - creditapp.s3.presigned-url-expiration-hours=24

- [ ] Task 8: Create Virus Scanning Integration (AC: 7, optional)
  - [ ] Create VirusScanService (src/main/java/com/creditapp/shared/service/VirusScanService.java)
    - Method: scanFile(InputStream fileStream, String fileName) returns VirusScanResult
      - Option A: Integrate with ClamAV (open-source antivirus)
        - Send file to ClamAV daemon for scanning
        - Receive CLEAN or INFECTED status
      - Option B: Third-party service (e.g., VirusTotal API)
      - Option C: Skip for MVP, add in Phase 2
    - Return: status (CLEAN, INFECTED), details (infected file name if detected)
  - [ ] Add to OfferDocumentUploadService:
    - Queue scanning task asynchronously (non-blocking)
    - On scan complete, update virusScanStatus and virusScanResult
    - Optionally notify officer if infected file detected

- [ ] Task 9: Create Unit Tests (AC: 1, 2, 3, 5)
  - [ ] Create OfferDocumentUploadServiceTest (src/test/java/com/creditapp/unit/bank/OfferDocumentUploadServiceTest.java)
    - Test 1: Valid file upload - document created
    - Test 2: File size exceeded - rejected with 413
    - Test 3: Invalid file type - rejected with 400
    - Test 4: S3 upload called - with correct parameters
    - Test 5: Pre-signed URL generated - valid URL created
    - Test 6: Audit event logged - DOCUMENT_UPLOADED event
    - Test 7: Virus scan queued - async scan initiated
    - Test 8: Unauthorized officer - 403 error
    - Test 9: Offer not found - 404 error
  - [ ] Create OfferDocumentRetrievalServiceTest
    - Test 1: Get documents - returns all documents
    - Test 2: Sorted by date - newest first
    - Test 3: Includes metadata - all fields present
    - Test 4: Pre-signed URL valid - not expired
    - Test 5: Unauthorized access - 403 error
  - [ ] Create OfferDocumentDownloadServiceTest
    - Test 1: Download clean file - file stream returned
    - Test 2: File infected - 403 error
    - Test 3: Scan pending - 202 Accepted
    - Test 4: Audit event logged - DOCUMENT_DOWNLOADED event
    - Test 5: Unauthorized download - 403 error
  - [ ] Mock: S3DocumentStorageService, VirusScanService, OfferDocumentRepository

- [ ] Task 10: Create Controller Tests (AC: 1, 3)
  - [ ] Create OfferDocumentControllerTest (src/test/java/com/creditapp/unit/bank/OfferDocumentControllerTest.java)
    - Test 1: POST upload returns 201 CREATED
    - Test 2: GET documents returns 200 OK
    - Test 3: GET download returns 200 OK with file
    - Test 4: Invalid file type - 400 Bad Request
    - Test 5: File size exceeded - 413 Payload Too Large
    - Test 6: Unauthenticated upload - 401 Unauthorized
    - Test 7: Non-officer upload - 403 Forbidden
    - Test 8: Offer not found - 404 Not Found
    - Test 9: Document not found - 404 Not Found
    - Test 10: Content-Type header correct - PDF, Office, etc.
  - [ ] Mock: OfferDocumentUploadService, OfferDocumentRetrievalService, OfferDocumentDownloadService

- [ ] Task 11: Create Integration Tests (AC: 1, 2, 3, 4, 5, 10)
  - [ ] Create OfferDocumentIntegrationTest (src/test/java/com/creditapp/integration/bank/OfferDocumentIntegrationTest.java)
    - Setup: Create offer, bank officer, sample documents
    - Test 1: Upload PDF document - stored in S3
    - Test 2: Upload Office document - stored in S3
    - Test 3: Invalid file type - rejected
    - Test 4: File size exceeded - rejected
    - Test 5: GET documents list - all documents returned
    - Test 6: Download document - file content matches uploaded
    - Test 7: Borrower can view documents - BORROWER access granted
    - Test 8: Officer can upload - BANK_OFFICER access granted
    - Test 9: Non-owner cannot download - 403 error
    - Test 10: Pre-signed URL expires - new URL generated after 24 hours
  - [ ] Use: TestRestTemplate, TestContainers (PostgreSQL)
  - [ ] Mock: S3 (LocalStack or Moto for AWS testing)
  - [ ] Test file: Create sample PDF and Office documents for upload testing

- [ ] Task 12: Create API Documentation (AC: 1, 2, 3)
  - [ ] Update docs/API_ENDPOINTS.md
    - Endpoint: POST /api/offers/{offerId}/documents
    - Endpoint: GET /api/offers/{offerId}/documents
    - Endpoint: GET /api/offers/{offerId}/documents/{documentId}/download
    - Request/response structures and examples
    - File size and type constraints
    - Access control details

- [ ] Task 13: Create File Validation Service (AC: 1)
  - [ ] Create FileValidationService (src/main/java/com/creditapp/shared/service/FileValidationService.java)
    - Method: validateFile(MultipartFile file) returns ValidationResult
      - Check file size: max 10MB
      - Check MIME type: application/pdf, application/msword, application/vnd.openxmlformats-officedocument.*
      - Check file extension matches MIME type
      - Validate file is not empty
      - Use Apache Tika or similar to detect true MIME type
    - Return: ValidationResult with error messages if invalid
  - [ ] Unit tests: verify validation logic

- [ ] Task 14: Create Audit Logging (AC: 9)
  - [ ] Add AuditService logging:
    - Event: DOCUMENT_UPLOADED
      - Fields: offerId, documentType, fileName, fileSize, uploadedByOfficerId, timestamp
    - Event: DOCUMENT_DOWNLOADED
      - Fields: offerId, documentId, downloadedByUserId, timestamp
    - Event: DOCUMENT_DELETED (optional)

- [ ] Task 15: Create Data Export and Management (optional)
  - [ ] Create OfferDocumentAdminService (for bank administrators)
    - Method: deleteDocument(UUID documentId) - cascade delete
    - Method: getDocumentsByDocumentType(DocumentType type) - query all documents of type
    - Method: bulkUploadDocuments() - batch upload multiple documents
    - Endpoint: DELETE /api/admin/documents/{documentId}
    - Endpoint: GET /api/admin/documents/by-type/{type}

## Dev Notes

### Previous Stories Dependencies
- **Story 3.3-3.5**: Offer creation and selection
- **Story 1.6**: RBAC for bank officer role
- **Story 1.7**: AuditService for logging

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1
- **File Upload**: Spring MultipartFile, Apache Commons FileUpload
- **Cloud Storage**: AWS S3 SDK (software.amazon.awssdk:s3)
- **File Type Detection**: Apache Tika
- **Virus Scanning**: ClamAV (optional, Phase 2)
- **Encryption**: AES256 (AWS S3 server-side)

### File Storage Strategy
[Source: AC: 8]
- **Storage**: AWS S3 (cloud, scalable, reliable)
- **Encryption**: Server-side encryption (AES256)
- **ACL**: Private (only authorized users via pre-signed URLs)
- **URL Expiration**: 24 hours (regenerate on demand)
- **S3 Key Format**: "offers/{offerId}/{documentType}_{timestamp}_{fileName}"
- **Backup**: S3 versioning enabled

### Document Types
[Source: AC: 4]
- **TERMS_CONDITIONS**: Standard loan terms document
- **FEE_SCHEDULE**: Breakdown of fees and costs
- **DISCLOSURE**: Truth in Lending Act (TILA) disclosure
- **TRUTH_IN_LENDING**: Required federal disclosure
- **CUSTOM**: Bank-specific or additional documents

### File Constraints
[Source: AC: 1]
- **Max Size**: 10MB
- **Allowed Types**: PDF, DOC, DOCX, XLS, XLSX
- **MIME Types**: application/pdf, application/msword, application/vnd.openxmlformats-officedocument.*
- **Validation**: Check extension + MIME type + file content

### Access Control
[Source: AC: 6]
- **Bank Officers**: Can upload documents (own bank only)
- **Borrowers**: Can download and view documents for their offers
- **Non-Owners**: Cannot access documents (403)
- **Verification**: Check offerId -> offer -> application -> borrowerId

### Project Directory Structure
`
src/main/java/com/creditapp/
 bank/
    controller/        # OfferDocumentController.java
    service/           # OfferDocumentUploadService.java, OfferDocumentRetrievalService.java, OfferDocumentDownloadService.java
    model/             # OfferDocument.java
    repository/        # OfferDocumentRepository.java
    dto/               # OfferDocumentUploadRequest.java, OfferDocumentMetadata.java, OfferDocumentsListResponse.java
 shared/
    service/           # S3DocumentStorageService.java, VirusScanService.java, FileValidationService.java
    config/            # S3Configuration.java

src/test/java/com/creditapp/
 unit/
    bank/
      OfferDocumentUploadServiceTest.java
      OfferDocumentRetrievalServiceTest.java
      OfferDocumentDownloadServiceTest.java
      OfferDocumentControllerTest.java
 integration/
    bank/
      OfferDocumentIntegrationTest.java
`

### Important Notes
1. **Cloud Storage**: Use AWS S3 for scalability and reliability
2. **Encryption**: Server-side AES256 encryption
3. **Pre-signed URLs**: 24-hour expiration, regenerate on demand
4. **Access Control**: Borrower owns offer -> can view documents; Officer can upload
5. **Virus Scanning**: Optional ClamAV integration for security (MVP: skip)
6. **Audit Trail**: All uploads and downloads logged
7. **File Validation**: Check MIME type + extension + content
8. **Document Types**: TERMS_CONDITIONS, FEE_SCHEDULE, DISCLOSURE, TRUTH_IN_LENDING, CUSTOM
9. **Metadata**: Store fileName, fileSize, uploadDate, uploaderName
10. **Error Handling**: File too large (413), invalid type (400), unauthorized (403), not found (404)

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, TestContainers
- **Mocking**: Mockito for S3 and virus scan services
- **AWS Testing**: LocalStack or Moto for local S3 testing
- **Test Location**: src/test/java/com/creditapp/unit/bank/, src/test/java/com/creditapp/integration/bank/

### Testing Checklist
- [ ] File upload: document created successfully
- [ ] File validation: MIME type and extension checked
- [ ] File size limit: max 10MB enforced
- [ ] Invalid file type: rejected with 400
- [ ] File too large: rejected with 413
- [ ] S3 storage: file uploaded to correct bucket and key
- [ ] Pre-signed URL: valid URL generated with 24-hour expiration
- [ ] Document metadata: all fields stored (fileName, fileSize, uploadDate, etc.)
- [ ] Virus scanning: queued asynchronously (if implemented)
- [ ] Audit logging: DOCUMENT_UPLOADED event logged
- [ ] Document retrieval: list returns all documents for offer
- [ ] Documents sorted: by date descending (newest first)
- [ ] Metadata included: uploadedByOfficerName, description, etc.
- [ ] Document download: file content matches original
- [ ] Content-Type header: correct MIME type in response
- [ ] Content-Disposition: attachment header for download
- [ ] Scan pending: 202 Accepted if scan not complete
- [ ] File infected: 403 Forbidden if infected (if scanning implemented)
- [ ] Access control: borrower can view/download own offers' documents
- [ ] Officer upload: bank officer can upload documents
- [ ] Non-owner access: 403 Forbidden for unauthorized users
- [ ] Offer not found: 404 error
- [ ] Document not found: 404 error
- [ ] Integration test: upload, retrieve list, download, verify content
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Document Management | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
