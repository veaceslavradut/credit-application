# Story 3.13: Offer Comparison Analytics & Insights

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to see analytics and insights comparing my offers,
**so that** I can make an informed decision about which offer provides the best value.

## Acceptance Criteria

1. GET /api/borrower/applications/{applicationId}/offers/insights returns comparison analytics
2. Response includes: best_apr_offer, lowest_monthly_payment_offer, lowest_total_cost_offer, average_apr, apr_spread, recommended_offer_id
3. Recommended offer uses weighted scoring: APR (40%), monthly payment (30%), total cost (20%), processing time (10%)
4. Visual comparison metrics: "You could save \ by choosing offer Y over offer Z"
5. Savings calculation compares total cost across all offers
6. Interest rate comparison: percentage difference from average APR
7. Payment affordability indicator: monthly payment as % of stated income (if available)
8. Processing time comparison: fastest vs slowest offer
9. Only authenticated borrower can view insights for their application
10. Integration test: create multiple offers, verify analytics calculated correctly

## Tasks / Subtasks

- [ ] Task 1: Create Insights DTOs (AC: 2, 3)
  - [ ] Create OfferInsightsDTO (src/main/java/com/creditapp/borrower/dto/OfferInsightsDTO.java)
    - Fields: bestAprOffer (OfferSummaryDTO), lowestMonthlyPaymentOffer (OfferSummaryDTO), lowestTotalCostOffer (OfferSummaryDTO), averageApr (BigDecimal), aprSpread (BigDecimal), recommendedOfferId (UUID), savingsAnalysis (SavingsAnalysisDTO)
  - [ ] Create OfferSummaryDTO (src/main/java/com/creditapp/borrower/dto/OfferSummaryDTO.java)
    - Fields: offerId, bankName, apr, monthlyPayment, totalCost
  - [ ] Create SavingsAnalysisDTO (src/main/java/com/creditapp/borrower/dto/SavingsAnalysisDTO.java)
    - Fields: bestOfferId, comparedToWorstOffer (BigDecimal savings), comparedToAverageOffer (BigDecimal savings), savingsMessage (String)
  - [ ] Create OfferRecommendationDTO (src/main/java/com/creditapp/borrower/dto/OfferRecommendationDTO.java)
    - Fields: offerId, bankName, score (BigDecimal), reason (String)

- [ ] Task 2: Create OfferInsightsService (AC: 2, 3, 4, 5, 6, 7, 8)
  - [ ] Create OfferInsightsService (src/main/java/com/creditapp/borrower/service/OfferInsightsService.java)
    - Method: calculateInsights(UUID applicationId, UUID borrowerId) returns OfferInsightsDTO
      - Fetch all offers for application (via OfferService)
      - Verify borrower owns application
      - Calculate best APR offer (min APR)
      - Calculate lowest monthly payment offer (min monthly payment)
      - Calculate lowest total cost offer (min total cost)
      - Calculate average APR
      - Calculate APR spread (max APR - min APR)
      - Calculate recommended offer using weighted scoring
      - Calculate savings analysis
      - Return OfferInsightsDTO
    - Method: calculateRecommendedOffer(List<Offer> offers) returns UUID
      - Score each offer: (1 / apr)  0.4 + (1 / monthlyPayment)  0.3 + (1 / totalCost)  0.2 + (1 / processingTime)  0.1
      - Normalize scores to 0-100 scale
      - Return offer ID with highest score
    - Method: calculateSavings(List<Offer> offers) returns SavingsAnalysisDTO
      - Find best (lowest total cost) and worst (highest total cost) offers
      - Calculate savings: worstTotalCost - bestTotalCost
      - Calculate average total cost
      - Calculate savings vs average
      - Generate savings message: "You could save \ by choosing [Bank Y] over [Bank Z]"
    - Method: calculatePaymentAffordability(BigDecimal monthlyPayment, BigDecimal annualIncome) returns BigDecimal
      - If annualIncome available: return (monthlyPayment  12 / annualIncome)  100
      - Recommended: < 28% (housing expense ratio) or < 36% (debt-to-income ratio)
    - Error handling: if < 2 offers, return null insights (not enough data)
  - [ ] Unit tests: mock repositories, test scoring logic, test edge cases (1 offer, identical offers)

- [ ] Task 3: Create Insights REST Controller (AC: 1, 9)
  - [ ] Create endpoint in BorrowerApplicationController or OfferInsightsController
    - GET /api/borrower/applications/{applicationId}/offers/insights
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Call OfferInsightsService.calculateInsights(applicationId, borrowerId)
    - Return OfferInsightsDTO with 200 OK
    - Error handling:
      - 404 Not Found: application not found
      - 403 Forbidden: different borrower's application
      - 204 No Content: < 2 offers (not enough data for insights)
  - [ ] Unit tests: mock service, test success and error paths

- [ ] Task 4: Create Scoring Algorithm (AC: 3)
  - [ ] Create OfferScoringUtil (src/main/java/com/creditapp/borrower/util/OfferScoringUtil.java)
    - Static method: calculateScore(Offer offer) returns BigDecimal
      - APR weight: 40% (lower is better: score = 1 / apr  0.4)
      - Monthly payment weight: 30% (lower is better: score = 1 / monthlyPayment  0.3)
      - Total cost weight: 20% (lower is better: score = 1 / totalCost  0.2)
      - Processing time weight: 10% (faster is better: score = 1 / processingTimeDays  0.1)
      - Normalize score to 0-100 scale
      - Return weighted score
    - Static method: normalizeScores(List<BigDecimal> scores) returns List<BigDecimal>
      - Scale scores to 0-100 range
  - [ ] Unit tests: test scoring with known values, verify weights sum to 1.0

- [ ] Task 5: Create Comparison Metrics (AC: 4, 5, 6, 8)
  - [ ] Extend OfferInsightsDTO with additional metrics:
    - interestRateComparison: Map<UUID, BigDecimal> (% difference from average APR)
    - processingTimeComparison: Map<UUID, String> ("X days faster/slower than average")
    - paymentAffordabilityIndicator: String ("Affordable" / "Moderate" / "High Risk")
  - [ ] Update OfferInsightsService to calculate these metrics
    - For each offer, calculate: (offer.apr - averageApr) / averageApr  100
    - For processing time: compare to average processing time
    - For affordability: use payment-to-income ratio thresholds

- [ ] Task 6: Add Caching (optional for performance)
  - [ ] Cache insights calculation results (insights don't change unless offers change)
    - @Cacheable("offerInsights") on calculateInsights method
    - Cache key: applicationId
    - TTL: 1 hour
  - [ ] Invalidate cache when new offer added or offer expires

- [ ] Task 7: Create Integration Tests (AC: 10)
  - [ ] Create OfferInsightsIntegrationTest (src/test/java/com/creditapp/integration/borrower/OfferInsightsIntegrationTest.java)
    - Setup: Create application with 3 offers from different banks
    - Test 1: GET insights, verify best APR offer identified correctly
    - Test 2: GET insights, verify lowest monthly payment offer identified
    - Test 3: GET insights, verify lowest total cost offer identified
    - Test 4: GET insights, verify average APR calculated correctly
    - Test 5: GET insights, verify APR spread calculated (max - min)
    - Test 6: GET insights, verify recommended offer has highest score
    - Test 7: GET insights, verify savings calculation correct
    - Test 8: GET insights, verify savings message generated
    - Test 9: GET insights with < 2 offers, verify 204 No Content
    - Test 10: Different borrower, verify 403 Forbidden
    - Test 11: Verify scoring weights: APR change affects score more than processing time
  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate

- [ ] Task 8: Create API Documentation (AC: 1, 2)
  - [ ] Document GET /api/borrower/applications/{applicationId}/offers/insights
    - Response example:
      `json
      {
        "bestAprOffer": { "offerId": "...", "bankName": "Bank A", "apr": 5.5, "monthlyPayment": 450.00, "totalCost": 52000 },
        "lowestMonthlyPaymentOffer": { "offerId": "...", "bankName": "Bank B", "apr": 6.0, "monthlyPayment": 420.00, "totalCost": 53000 },
        "lowestTotalCostOffer": { "offerId": "...", "bankName": "Bank C", "apr": 5.8, "monthlyPayment": 440.00, "totalCost": 51000 },
        "averageApr": 5.77,
        "aprSpread": 0.5,
        "recommendedOfferId": "...",
        "savingsAnalysis": {
          "bestOfferId": "...",
          "comparedToWorstOffer": 2000.00,
          "comparedToAverageOffer": 1000.00,
          "savingsMessage": "You could save \,000 by choosing Bank C over Bank B"
        }
      }
      `

## Dev Notes

### Previous Story Insights
- **Story 3.1**: Offer entity and OfferRepository
- **Story 3.4**: Offer retrieval API
- **Story 2.1**: Application entity with annual_income field (for affordability calculation)

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Web
- **Caching**: Spring Cache / Redis (optional)
- **Financial Calculations**: BigDecimal for precision

### Scoring Algorithm
[Source: Story requirements]
`
Weighted Score = (1/APR)  0.4 + (1/monthlyPayment)  0.3 + (1/totalCost)  0.2 + (1/processingTime)  0.1

Rationale:
- APR: 40% weight (most important long-term cost indicator)
- Monthly Payment: 30% weight (affects cash flow/affordability)
- Total Cost: 20% weight (overall cost over loan term)
- Processing Time: 10% weight (speed of getting funds)
`

### Affordability Indicator Thresholds
[Source: Mortgage lending standards]
- **Affordable**: Monthly payment < 28% of gross monthly income
- **Moderate**: Monthly payment 28-36% of gross monthly income
- **High Risk**: Monthly payment > 36% of gross monthly income

### Project Directory Structure
`
src/main/java/com/creditapp/
 borrower/
    service/           # OfferInsightsService.java
    controller/        # OfferInsightsController.java or extend BorrowerApplicationController
    dto/               # OfferInsightsDTO.java, SavingsAnalysisDTO.java, OfferSummaryDTO.java
    util/              # OfferScoringUtil.java
`

## Testing

### Testing Checklist
- [ ] OfferInsightsService: calculates best APR offer correctly
- [ ] OfferInsightsService: calculates lowest monthly payment offer correctly
- [ ] OfferInsightsService: calculates lowest total cost offer correctly
- [ ] OfferInsightsService: calculates average APR correctly
- [ ] OfferInsightsService: calculates APR spread correctly
- [ ] OfferScoringUtil: scores offers with correct weights
- [ ] OfferScoringUtil: recommended offer has highest score
- [ ] SavingsAnalysis: calculates savings vs worst offer
- [ ] SavingsAnalysis: calculates savings vs average offer
- [ ] SavingsAnalysis: generates savings message
- [ ] GET /insights: returns 200 OK with insights
- [ ] GET /insights: returns 204 No Content if < 2 offers
- [ ] GET /insights: returns 403 Forbidden for different borrower
- [ ] Integration test: verify all metrics calculated correctly
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - Offer Comparison Analytics & Insights | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
