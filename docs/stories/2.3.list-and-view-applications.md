# Story 2.3: List and View Borrower Applications

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to view all my loan applications with their current status and details,
**so that** I can track my applications and see their progress through the system.

## Acceptance Criteria

1. GET /api/borrower/applications returns paginated list of borrower's applications
2. Response includes: id, loanType, loanAmount, loanTermMonths, currency, status, createdAt, submittedAt, updatedAt
3. Supports pagination: page (0-based), size (default 10, max 100), sort by status/createdAt
4. Supports filtering by status (optional query param: DRAFT, SUBMITTED, OFFERS_AVAILABLE, etc.)
5. GET /api/borrower/applications/{applicationId} returns full application details with ApplicationDetails
6. Full details include: all application fields + annual income, employment status, down payment amount
7. GET /api/borrower/applications/{applicationId}/history returns status change timeline ordered by date descending
8. Borrower can only access own applications (403 Forbidden if accessing another borrower's app)
9. Only authenticated BORROWER role can access
10. Integration test: create app, list apps, view details, verify access control

## Tasks / Subtasks

- [ ] Task 1: Review Existing DTOs from Story 2.1 (AC: 2, 5, 6, 7)
  - [ ] Verify ApplicationDTO has all required fields: id, loanType, loanAmount, loanTermMonths, currency, status, createdAt, submittedAt, updatedAt
  - [ ] Verify ApplicationDetailsDTO has: annualIncome, employmentStatus, downPaymentAmount
  - [ ] Verify ApplicationHistoryDTO has: oldStatus, newStatus, changedAt, changedByUserId, changeReason
  - [ ] Create ApplicationListItemDTO (lightweight version for list view)
    - Fields: id, loanType, loanAmount, status, createdAt, updatedAt
    - No sensitive details (for performance)

- [ ] Task 2: Create List Endpoint Query Service (AC: 3, 4)
  - [ ] Create ListApplicationsService (extends or complements ApplicationService from Story 2.1)
    - Method: listApplicationsByBorrower(UUID borrowerId, int page, int size, String sortBy, ApplicationStatus filterStatus) returns Page<ApplicationListItemDTO>
      - Page: 0-based indexing
      - Size: default 10, max 100 (prevent resource exhaustion)
      - SortBy: "status", "createdAt", "loanAmount" (default: createdAt DESC)
      - FilterStatus: optional DRAFT, SUBMITTED, OFFERS_AVAILABLE, ACCEPTED, REJECTED, EXPIRED, WITHDRAWN, COMPLETED
      - Query applications for borrower, apply filters, return paginated results
      - Log LIST_APPLICATIONS audit event (avoid logging all app details, just count)
    - Method: countApplicationsByStatus(UUID borrowerId) returns Map<ApplicationStatus, Long>
      - Used for UI dashboard to show status distribution
  - [ ] Unit tests: mock repository with various page/size/filter combinations, test sorting and filtering

- [ ] Task 3: Update GET Application Details Endpoint (AC: 5, 6)
  - [ ] Verify BorrowerApplicationController has GET /api/borrower/applications/{applicationId}
    - Extract borrowerId from SecurityContext
    - Call ApplicationService.getApplication(applicationId, borrowerId)
    - Return 200 OK with ApplicationDTO including ApplicationDetails
    - Return 403 Forbidden if borrower doesn't own the application
    - Return 404 Not Found if application doesn't exist
    - Log VIEW_APPLICATION audit event
  - [ ] Response includes: application fields + application_details (if exists) + relationship counts

- [ ] Task 4: Create List Applications Endpoint (AC: 1, 2, 3, 4, 9)
  - [ ] Add GET /api/borrower/applications endpoint in BorrowerApplicationController
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Query parameters:
      - page (default 0, 0-based)
      - size (default 10, max 100)
      - sortBy (optional: "status", "createdAt", "loanAmount", default "createdAt")
      - sortOrder (optional: "asc" or "desc", default "desc")
      - status (optional: filter by ApplicationStatus)
    - Call ListApplicationsService.listApplicationsByBorrower()
    - Return 200 OK with Page<ApplicationListItemDTO>
    - Response includes: content array, totalElements, totalPages, currentPage, hasNext, hasPrevious
    - Controller logs: borrowerId, page, size, filter status (for audit)
  - [ ] Error handling:
      - 400 Bad Request: invalid page, size, sortBy
      - 401 Unauthorized: not authenticated
      - 403 Forbidden: not BORROWER role
  - [ ] Unit tests: mock service, test pagination and filtering
  - [ ] Integration tests: real HTTP requests with various query parameters

- [ ] Task 5: Implement Access Control Check (AC: 8)
  - [ ] Create helper method: verifyBorrowerOwnsApplication(UUID borrowerId, UUID applicationId) returns boolean
    - Query application, check borrower_id matches
    - Throw AccessDeniedException (403) if no match
    - Avoid N+1 queries
  - [ ] Applied to GET /api/borrower/applications/{applicationId} and GET .../history endpoints
  - [ ] Unit tests: verify access control with mock data

- [ ] Task 6: Create History Endpoint (AC: 7)
  - [ ] Endpoint: GET /api/borrower/applications/{applicationId}/history
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Verify borrower owns application (access control)
    - Call ApplicationService.getApplicationHistory(applicationId, borrowerId)
    - Return 200 OK with List<ApplicationHistoryDTO> ordered by changedAt DESC
    - Error handling: 404 Not Found, 403 Forbidden (different borrower)
  - [ ] Response format:
    `json
    [
      {
        "oldStatus": "DRAFT",
        "newStatus": "SUBMITTED",
        "changedAt": "2026-01-14T10:30:00Z",
        "changedByUserId": "550e8400-e29b-41d4-a716-446655440000",
        "changeReason": "Borrower submitted application"
      }
    ]
    `
  - [ ] Unit tests: mock repository, test ordering
  - [ ] Integration tests: real HTTP requests, verify timeline accuracy

- [ ] Task 7: Add Pagination Validation (AC: 3)
  - [ ] Create custom validation annotation @ValidPageRequest
    - Validate page >= 0
    - Validate size > 0 and size <= 100
  - [ ] Applied to controller method parameters
  - [ ] Return 400 Bad Request with clear error message for invalid values

- [ ] Task 8: Add Audit Logging (AC: 1, 6, 7)
  - [ ] Ensure endpoints log to AuditService:
    - Event: LIST_APPLICATIONS (on list endpoint)
      - Fields: borrower_id, page, size, filter_status, result_count
    - Event: VIEW_APPLICATION (on details endpoint)
      - Fields: borrower_id, application_id
    - Event: VIEW_APPLICATION_HISTORY (on history endpoint)
      - Fields: borrower_id, application_id, history_count
  - [ ] Avoid logging sensitive application data; log metadata only
  - [ ] Test: verify audit logs created for each endpoint

- [ ] Task 9: Create Unit Tests (AC: 8, 10)
  - [ ] Create ListApplicationsServiceTest (src/test/java/com/creditapp/unit/borrower/ListApplicationsServiceTest.java)
    - Test 1: List applications for borrower with 0 apps, verify empty page
    - Test 2: List applications with 15 apps, page size 10, verify pagination
    - Test 3: Filter by status=DRAFT, verify only DRAFT apps returned
    - Test 4: Sort by createdAt DESC, verify newest first
    - Test 5: Sort by status ASC, verify alphabetical order
    - Test 6: Invalid page (negative), verify exception
    - Test 7: Invalid size (> 100), verify exception
    - Test 8: Count applications by status, verify distribution
  - [ ] Mock: ApplicationRepository, ApplicationDetailsRepository
  - [ ] Framework: JUnit 5, Mockito

- [ ] Task 10: Create Access Control Tests (AC: 8)
  - [ ] Create BorrowerApplicationAccessControlTest
    - Test 1: Borrower A access own application, verify 200 OK
    - Test 2: Borrower A access Borrower B's application, verify 403 Forbidden
    - Test 3: Borrower A view own application history, verify 200 OK
    - Test 4: Borrower A view Borrower B's history, verify 403 Forbidden
    - Test 5: Non-BORROWER role (BANK_ADMIN) access /api/borrower/applications, verify 403 Forbidden
    - Test 6: Unauthenticated access, verify 401 Unauthorized
  - [ ] Use Spring Security Test with @WithMockUser, TestSecurityContextHolder

- [ ] Task 11: Create Integration Tests (AC: 1, 3, 4, 5, 6, 7, 8, 9, 10)
  - [ ] Create ListApplicationsIntegrationTest (src/test/java/com/creditapp/integration/borrower/ListApplicationsIntegrationTest.java)
    - Setup: Create 2 borrowers, create 5 applications (various statuses) for Borrower A
    - Test 1: List all apps for Borrower A, verify count = 5
    - Test 2: List with page=0, size=2, verify returned 2 items
    - Test 3: List with page=1, size=2, verify offset correct
    - Test 4: List with status=DRAFT filter, verify only DRAFT apps
    - Test 5: List with sortBy=createdAt&sortOrder=asc, verify oldest first
    - Test 6: List with sortBy=createdAt&sortOrder=desc, verify newest first
    - Test 7: Invalid page (-1), verify 400 Bad Request
    - Test 8: Invalid size (101), verify 400 Bad Request
    - Test 9: GET specific application, verify all fields including application details
    - Test 10: GET application details for Borrower A's app, Borrower A auth, verify 200 OK
    - Test 11: GET Borrower B app while authenticated as Borrower A, verify 403 Forbidden
    - Test 12: GET non-existent application, verify 404 Not Found
    - Test 13: GET application history, verify timeline ordered by changedAt DESC
    - Test 14: Verify LIST_APPLICATIONS audit event created
    - Test 15: Verify VIEW_APPLICATION audit event created
  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate, @WithMockUser for auth
  - [ ] Database: Use real database with applications from Story 2.2

- [ ] Task 12: Create API Documentation (AC: 1, 2, 3, 5, 6, 7)
  - [ ] Update docs/API_ENDPOINTS.md
    - GET /api/borrower/applications
      - Query parameters: page (default 0), size (default 10, max 100), sortBy (createdAt), sortOrder (desc), status (optional)
      - Response (200): 
        `json
        {
          "content": [
            {
              "id": "550e8400-e29b-41d4-a716-446655440000",
              "loanType": "PERSONAL",
              "loanAmount": 25000,
              "status": "DRAFT",
              "createdAt": "2026-01-14T10:30:00Z",
              "updatedAt": "2026-01-14T10:30:00Z"
            }
          ],
          "totalElements": 5,
          "totalPages": 1,
          "currentPage": 0,
          "hasNext": false,
          "hasPrevious": false
        }
        `
      - Error responses: 400, 401, 403
      - Authentication: Bearer {JWT token}, BORROWER role required
    
    - GET /api/borrower/applications/{applicationId}
      - Path parameter: applicationId (UUID)
      - Response (200): Full ApplicationDTO with nested ApplicationDetails
      - Error responses: 400, 401, 403, 404
      - Authentication: Bearer {JWT token}, BORROWER role required
    
    - GET /api/borrower/applications/{applicationId}/history
      - Path parameter: applicationId (UUID)
      - Response (200): List of ApplicationHistoryDTO ordered by changedAt DESC
      - Error responses: 401, 403, 404
      - Example shows application journey DRAFT -> SUBMITTED -> UNDER_REVIEW

- [ ] Task 13: Performance Optimization (optional but recommended)
  - [ ] Ensure queries use JOIN FETCH or @EntityGraph to avoid N+1
  - [ ] Test: list 100 applications, verify single database query
  - [ ] Add query count assertion in integration tests
  - [ ] Consider caching: @Cacheable for countApplicationsByStatus (cache for 5 minutes)

- [ ] Task 14: Create Response Wrapper DTO (AC: 1, 3)
  - [ ] Create PageableResponse<T> generic wrapper (if not already exists)
    - Fields: content (List<T>), totalElements, totalPages, currentPage, pageSize, hasNext, hasPrevious, isEmpty
    - Used for all paginated endpoints (consistent response format)

## Dev Notes

### Previous Stories Dependencies
- **Story 2.1**: ApplicationDTO, ApplicationService, ApplicationRepository, ApplicationHistoryDTO
- **Story 2.2**: ApplicationCreationService, @RateLimited annotation, application creation endpoints
- **Story 1.6**: RBAC - @PreAuthorize("hasAuthority('BORROWER')")
- **Story 1.7**: AuditService for logging

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA, Spring Web
- **Security**: Spring Security with @PreAuthorize
- **Pagination**: Spring Data's Page<T>, Pageable, PageRequest
- **Testing**: JUnit 5, Mockito, TestContainers, TestRestTemplate

### API Specification
[Source: architecture/2-detailed-service-architecture.md]
**List Endpoint:** GET /api/borrower/applications
- Returns paginated list of borrower's applications (lightweight)
- Supports pagination, sorting, filtering by status
- Max page size: 100 to prevent resource exhaustion
- Always filtered by authenticated borrower_id

**Details Endpoint:** GET /api/borrower/applications/{applicationId}
- Returns complete application with embedded details
- Access control: verify borrower owns application
- Returns 403 if accessing another borrower's app

**History Endpoint:** GET /api/borrower/applications/{applicationId}/history
- Returns immutable status change timeline
- Ordered by changedAt DESC (newest first)
- Access control: verify borrower owns application

### Authorization Context
[Source: architecture/4-security-architecture.md]
- Only BORROWER role can list/view applications
- Borrower can only access own applications
- Return 403 Forbidden for cross-borrower access attempts
- Log access denied attempts for audit

### Pagination Best Practices
[Source: REST API standards]
- 0-based page indexing (page=0 is first page)
- Default page size: 10
- Max page size: 100 (prevent DoS)
- Return metadata: totalElements, totalPages, hasNext, hasPrevious
- Support sorting: sortBy + sortOrder parameters
- Use Spring Data's Page<T> for automatic pagination

### Project Directory Structure
[Source: Story 1.1 context]
`
src/main/java/com/creditapp/
 borrower/
    controller/        # BorrowerApplicationController.java (update with GET endpoints)
    service/           # ListApplicationsService.java, ApplicationService.java (existing)
    dto/               # ApplicationDTO.java, ApplicationListItemDTO.java (existing)
    exception/         # AccessDeniedException.java
 shared/
    exception/         # GlobalExceptionHandler.java (update with 400 for invalid page/size)
    audit/             # AuditService.java (from Story 1.7, called here)

src/test/java/com/creditapp/
 unit/
    borrower/
      ListApplicationsServiceTest.java
      BorrowerApplicationAccessControlTest.java
 integration/
    borrower/
      ListApplicationsIntegrationTest.java
`

### Testing Standards
[Source: frontend-architecture/10-testing-strategy.md]
- **Unit Tests**: Mock repositories, test pagination/filtering logic
- **Integration Tests**: Real database (TestContainers), real HTTP client, full flow
- **Test Coverage**: All query combinations, access control, error cases
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/

### Important Notes
1. **Pagination**: Always use 0-based indexing; validate page >= 0 and size > 0, <= 100
2. **Access Control**: Every GET endpoint must verify borrower owns the resource
3. **N+1 Prevention**: Use JOIN FETCH or @EntityGraph for relationship loading
4. **Sorting**: Support multiple sort fields (createdAt, status, loanAmount)
5. **Filtering**: Support filtering by status; can be extended to other fields later
6. **Caching**: Optional: cache countApplicationsByStatus for 5 minutes
7. **Audit Logging**: Log list operations at metadata level, not individual app details
8. **Response Format**: Use consistent PageableResponse wrapper for all paginated endpoints

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, Spring Security Test, TestContainers
- **HTTP Client**: TestRestTemplate
- **Mocking**: Mockito
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/

### Testing Checklist
- [ ] ListApplicationsService: returns empty page when no applications
- [ ] ListApplicationsService: handles pagination correctly (page, size, offset)
- [ ] ListApplicationsService: filters by status correctly
- [ ] ListApplicationsService: sorts by multiple fields (createdAt, status, loanAmount)
- [ ] ListApplicationsService: validates page >= 0 and size <= 100
- [ ] GET /api/borrower/applications returns 200 with Page<ApplicationListItemDTO>
- [ ] GET /api/borrower/applications/{id} returns 200 with full ApplicationDTO + ApplicationDetails
- [ ] GET /api/borrower/applications/{id} returns 404 for non-existent application
- [ ] GET /api/borrower/applications/{id} returns 403 when accessing another borrower's app
- [ ] GET /api/borrower/applications/{id}/history returns 200 with List<ApplicationHistoryDTO>
- [ ] History ordered by changedAt DESC (newest first)
- [ ] Pagination: verify content, totalElements, totalPages, hasNext, hasPrevious
- [ ] Sorting: verify correct order for each sortBy option
- [ ] Filtering: verify only filtered status apps returned
- [ ] Invalid page (negative): returns 400 Bad Request
- [ ] Invalid size (> 100): returns 400 Bad Request
- [ ] Unauthenticated access: returns 401 Unauthorized
- [ ] Non-BORROWER role: returns 403 Forbidden
- [ ] Access control: Borrower A cannot access Borrower B's apps
- [ ] Audit logging: LIST_APPLICATIONS event created
- [ ] Audit logging: VIEW_APPLICATION event created
- [ ] No N+1 queries: verify single query for list endpoint
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - List and View Borrower Applications | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
