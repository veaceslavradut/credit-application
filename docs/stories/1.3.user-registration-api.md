# Story 1.3: User Registration API & Borrower Account Creation

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to sign up with email, password, and basic information (name, phone),
**so that** I can create an account and start applying for loans.

## Acceptance Criteria

1. POST /api/auth/register endpoint accepts email, password, full name, phone number
2. Email validation: must be valid email format; uniqueness enforced in database
3. Password validation: minimum 12 characters, mixed case, numbers, special characters
4. Passwords hashed with bcrypt (salt rounds  12)
5. User automatically assigned "BORROWER" role
6. Confirmation email sent to borrower (optional activation link; MVP allows immediate login)
7. Response returns user ID and success message; no sensitive data exposed
8. Duplicate email registration rejected with clear error message
9. Integration test verifies full flow: register borrower, verify user exists in database with correct role
10. API rate-limited to 10 registration requests per IP per hour

## Tasks / Subtasks

- [ ] Task 1: Create User Registration Request/Response DTOs (AC: 1, 7)
  - [ ] Create RegistrationRequest DTO (src/main/java/com/creditapp/auth/dto/RegistrationRequest.java)
    - Fields: email, password, passwordConfirm, firstName, lastName, phoneNumber
    - Validation annotations: @Email, @NotBlank, @Size, @Pattern
    - Constraints: password min 12 chars, matches passwordConfirm, contains uppercase/lowercase/digit/special char
  - [ ] Create RegistrationResponse DTO (src/main/java/com/creditapp/auth/dto/RegistrationResponse.java)
    - Fields: userId (UUID), email, message (success message)
    - NO sensitive data: password, password_hash must never be returned
  - [ ] Create user DTO validation tests

- [ ] Task 2: Implement Password Validation Service (AC: 3)
  - [ ] Create PasswordValidator service (src/main/java/com/creditapp/auth/service/PasswordValidator.java)
    - Method: isValid(String password) returns boolean
    - Validate: min 12 characters, contains uppercase [A-Z], contains lowercase [a-z], contains digit [0-9], contains special char [!@#$%^&*()_+-=]
    - Throw PasswordValidationException with specific error message
  - [ ] Create PasswordValidator unit tests with various password patterns
  - [ ] Document validation rules in README

- [ ] Task 3: Implement Password Hashing Service (AC: 4)
  - [ ] Create PasswordHasher service (src/main/java/com/creditapp/auth/service/PasswordHasher.java)
    - Method: hash(String plainPassword) returns String
    - Method: matches(String plainPassword, String hash) returns boolean
    - Use Spring Security's BCryptPasswordEncoder with strength 12
  - [ ] Configure BCryptPasswordEncoder bean in src/main/java/com/creditapp/shared/config/SecurityConfig.java
  - [ ] Unit tests: verify hash is different each call, matches() correctly validates

- [ ] Task 4: Create User Registration Service (AC: 1, 2, 4, 5, 8, 9)
  - [ ] Create UserRegistrationService (src/main/java/com/creditapp/auth/service/UserRegistrationService.java)
    - Method: registerBorrower(RegistrationRequest request) returns RegistrationResponse
    - Validate input: call PasswordValidator.isValid()
    - Check email uniqueness: UserRepository.findByEmail(email) must return empty
    - Throw DuplicateEmailException if exists with 400 Bad Request response
    - Create User entity: email, passwordHash (call PasswordHasher), firstName, lastName, phone, role=BORROWER, isActive=true
    - Save to database: userRepository.save(user)
    - Return RegistrationResponse with userId and success message
  - [ ] Service layer validates and delegates to repository
  - [ ] Unit tests: mock UserRepository, test happy path and error cases (invalid password, duplicate email)
  - [ ] Integration tests: verify user saved to database with bcrypt hash

- [ ] Task 5: Create User Registration REST Controller (AC: 1, 2, 3, 4, 7, 8)
  - [ ] Create AuthController (src/main/java/com/creditapp/auth/controller/AuthController.java)
    - Endpoint: POST /api/auth/register
    - Accept: RegistrationRequest (JSON)
    - Return: RegistrationResponse with HTTP 201 Created
    - Error handling:
      - 400 Bad Request for invalid email format
      - 400 Bad Request for password validation failure (specific message which validation failed)
      - 409 Conflict for duplicate email
      - 500 Internal Server Error for unexpected failures
    - No stack traces in error responses (production-safe)
  - [ ] Use @Valid annotation on request parameter
  - [ ] Controller logs all registration attempts (username, IP, success/failure) to audit log
  - [ ] Unit tests: mock UserRegistrationService, test success and error paths
  - [ ] Integration tests: real HTTP requests to /api/auth/register

- [ ] Task 6: Implement Email Notification Service (AC: 6)
  - [ ] **BLOCKING DECISION RESOLVED**: Async Email Framework
    - **Decision**: Use Spring Application Events with @Async for MVP (clean architecture, zero infra)
    - **Implementation**: Publish UserRegisteredEvent on successful registration, listen with @EventListener @Async
    - **Rationale**: Simplest MVP approach, zero external dependencies, can migrate to message queue post-MVP
    - **MVP**: Spring Events (async, zero infra complexity)
    - **Production**: Migrate to RabbitMQ/Kafka for durability and delivery guarantees (separate story)
  - [ ] Create EmailService interface (src/main/java/com/creditapp/shared/service/EmailService.java)
    - Method: sendRegistrationConfirmation(String email, String userName, UUID userId)
    - Implementation: SendGrid integration via SendGridEmailService
  - [ ] Create SendGridEmailService (src/main/java/com/creditapp/shared/service/SendGridEmailService.java)
    - Configure SendGrid API key from environment variable: SENDGRID_API_KEY
    - Send email with template: "Welcome to Credit Aggregator, {{userName}}"
    - Include optional activation link (for future phases): if activation required, generate token
  - [ ] Create UserRegisteredEvent (src/main/java/com/creditapp/auth/event/UserRegisteredEvent.java)
    - Extends ApplicationEvent, fields: userId, email, userName
  - [ ] Create EmailNotificationListener (src/main/java/com/creditapp/shared/listener/EmailNotificationListener.java)
    - Method: @EventListener @Async handleUserRegistered(UserRegisteredEvent event)
    - Calls SendGridEmailService.sendRegistrationConfirmation()
    - Handles exceptions gracefully (log but don't crash registration)
  - [ ] Configure @EnableAsync in main application config (AsyncConfig.java)
    - ThreadPoolTaskExecutor: corePoolSize=2, maxPoolSize=5, queueCapacity=10
  - [ ] In AuthController.registerBorrower(): publishEvent(new UserRegisteredEvent(user.getId(), user.getEmail(), user.getFirstName()))
  - [ ] Unit tests: mock SendGrid client, verify event published, verify async listener called
  - [ ] Integration tests: verify event propagates and email sent (mock SendGrid)

- [ ] Task 7: Implement Rate Limiting (AC: 10)
  - [ ] Add Bucket4j dependency to pom.xml: io.github.bucket4j:bucket4j-core
  - [ ] Create RateLimitingInterceptor (src/main/java/com/creditapp/common/interceptor/RateLimitingInterceptor.java)
    - Intercept POST /api/auth/register requests
    - Track by client IP address
    - Limit: 10 requests per hour per IP
    - Return 429 Too Many Requests if exceeded
  - [ ] Register interceptor in WebMvcConfigurer.addInterceptors()
  - [ ] Unit tests: verify rate limiting enforced
  - [ ] Integration tests: simulate multiple requests and verify rate limit

- [ ] Task 8: Add Input Validation Exception Handlers (AC: 8)
  - [ ] Create custom exceptions:
    - PasswordValidationException (extends RuntimeException)
    - DuplicateEmailException (extends RuntimeException)
  - [ ] Create GlobalExceptionHandler (src/main/java/com/creditapp/common/exception/GlobalExceptionHandler.java)
    - @ExceptionHandler for PasswordValidationException  400 Bad Request with validation error details
    - @ExceptionHandler for DuplicateEmailException  409 Conflict
    - @ExceptionHandler for ConstraintViolationException  400 Bad Request
    - @ExceptionHandler for generic Exception  500 Internal Server Error (log but don't expose details)
  - [ ] All error responses follow standard format: { "error": "message", "timestamp": "ISO-8601", "path": "/api/auth/register" }

- [ ] Task 9: Create Integration Tests (AC: 9)
  - [ ] Create UserRegistrationIntegrationTest (src/test/java/com/creditapp/integration/auth/UserRegistrationIntegrationTest.java)
    - Test 1: Happy path - register valid borrower, verify user in database with BORROWER role
    - Test 2: Duplicate email - register twice with same email, second request returns 409
    - Test 3: Invalid password - register with weak password, returns 400 with specific error message
    - Test 4: Invalid email format - register with malformed email, returns 400
    - Test 5: Rate limiting - make 11 requests in quick succession, 11th returns 429
    - Test 6: Verify password hashed correctly in database (never plain text)
  - [ ] Use TestContainers for PostgreSQL, real HTTP client (TestRestTemplate)
  - [ ] Use MockServer for SendGrid email API (optional)

- [ ] Task 10: Create API Documentation (AC: 1, 7, 8)
  - [ ] Document endpoint in docs/API_ENDPOINTS.md
    - POST /api/auth/register
    - Request example: { "email": "user@example.com", "password": "SecurePass123!", "firstName": "John", "lastName": "Doe", "phoneNumber": "+373-012-345-67" }
    - Response (201): { "userId": "550e8400-e29b-41d4-a716-446655440000", "email": "user@example.com", "message": "Registration successful" }
    - Error responses: 400 (invalid input), 409 (duplicate email), 429 (rate limited), 500 (server error)
    - Example error: { "error": "Email already registered", "timestamp": "2026-01-14T10:30:00Z", "path": "/api/auth/register" }

## Dev Notes

### Previous Story (1.2) Insights
Story 1.2 creates database schema (users table) and JPA entities. This story depends on:
- User entity with fields: email, password_hash, firstName, lastName, phone, role, isActive
- UserRepository with findByEmail() method
- Flyway migrations: users table with UNIQUE email constraint, password_hash field

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Security
- **Password Hashing**: BCrypt (salt factor  12)
- **Email Service**: SendGrid
- **Rate Limiting**: Bucket4j
- **Validation**: Hibernate Validator (spring-boot-starter-validation)

### User Registration API Specification
[Source: architecture/2-detailed-service-architecture.md]
`
POST /api/auth/register
Request:
{
  "email": "borrower@example.com",
  "password": "SecurePass123!",
  "firstName": "John",
  "lastName": "Doe",
  "phoneNumber": "+373-012-345-67"
}

Response (201 Created):
{
  "userId": "550e8400-e29b-41d4-a716-446655440000",
  "email": "borrower@example.com",
  "message": "Registration successful. You can now log in."
}

Error Responses:
- 400 Bad Request: Invalid email format, weak password, missing fields
- 409 Conflict: Email already registered
- 429 Too Many Requests: Rate limit exceeded (10/hour per IP)
- 500 Internal Server Error: Unexpected server error
`

### Database Schema
[Source: Story 1.2 - Database Schema & ORM Setup]
**Users table (already created in 1.2):**
`sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  phone VARCHAR(20),
  role ENUM('BORROWER', 'BANK_ADMIN') NOT NULL,
  organization_id UUID,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (organization_id) REFERENCES organizations(id)
);
`

### Password Validation Rules
[Source: Epic 1 requirements]
- Minimum 12 characters
- Mixed case: at least one uppercase [A-Z] and one lowercase [a-z]
- Numbers: at least one digit [0-9]
- Special characters: at least one [!@#$%^&*()_+-=]
- No common patterns (e.g., "password123")

### Password Hashing Configuration
[Source: architecture/4-security-architecture.md]
- **Algorithm**: BCrypt
- **Salt Rounds**:  12 (Story uses 12 for security/performance balance)
- **Never log or expose**: Password hashes must never be logged in plaintext
- **Verification**: Use BCryptPasswordEncoder.matches() for authentication

### Email Notification
[Source: Story 1.0 Infrastructure - SendGrid configured]
- **Service**: SendGrid (API key in environment variable SENDGRID_API_KEY)
- **Template**: Basic welcome email with username
- **Non-blocking**: Send email asynchronously to avoid blocking registration response
- **Future**: Activation link/token implementation in later story (MVP: immediate login allowed)

### Rate Limiting Configuration
[Source: Epic 1 requirements]
- **Tool**: Bucket4j (lightweight, in-memory rate limiting)
- **Limit**: 10 requests per hour per IP address
- **Response**: 429 Too Many Requests with Retry-After header
- **Scope**: Only on POST /api/auth/register endpoint
- **Storage**: In-memory cache sufficient for MVP (single-server deployment)

### Project Directory Structure
[Source: Story 1.1 context]
`
src/main/java/com/creditapp/
 auth/
    controller/        # AuthController.java
    service/           # UserRegistrationService.java, PasswordValidator.java, PasswordHasher.java
    dto/               # RegistrationRequest.java, RegistrationResponse.java
    model/             # User.java (from 1.2), UserRole.java (from 1.2)
    repository/        # UserRepository.java (from 1.2)
    exception/         # PasswordValidationException.java, DuplicateEmailException.java
 shared/
    service/           # EmailService.java, SendGridEmailService.java
    config/            # SecurityConfig.java (with BCryptPasswordEncoder bean)
    exception/         # GlobalExceptionHandler.java
 common/
    interceptor/       # RateLimitingInterceptor.java

src/test/java/com/creditapp/
 unit/
    auth/
      service/         # UserRegistrationServiceTest.java, PasswordValidatorTest.java, PasswordHasherTest.java
      controller/      # AuthControllerTest.java
    shared/
      service/         # EmailServiceTest.java
 integration/
    auth/
      UserRegistrationIntegrationTest.java
`

### Key Dependencies to Add to pom.xml
`xml
<!-- SendGrid Email Service -->
<dependency>
  <groupId>com.sendgrid</groupId>
  <artifactId>sendgrid-java</artifactId>
  <version>4.10.2</version>
</dependency>

<!-- Rate Limiting -->
<dependency>
  <groupId>io.github.bucket4j</groupId>
  <artifactId>bucket4j-core</artifactId>
  <version>7.6.0</version>
</dependency>

<!-- Validation -->
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-validation</artifactId>
</dependency>

<!-- Spring Security (already in 1.1) -->
<!-- Already configured in Story 1.1 -->
`

### Testing Standards
[Source: frontend-architecture/10-testing-strategy.md]
- **Unit Tests**: Test services with mocked dependencies (UserRepository, EmailService, PasswordValidator)
- **Integration Tests**: Real database (TestContainers), real HTTP client (TestRestTemplate), real controller
- **Test Location**: src/test/java/com/creditapp/unit/ (unit) and src/test/java/com/creditapp/integration/ (integration)
- **Test Class Naming**: {ComponentName}Test.java for unit, {Feature}IntegrationTest.java for integration
- **Coverage Goal**: 80%+ code coverage (JaCoCo)

### Security Constraints
[Source: architecture/4-security-architecture.md]
- Passwords NEVER stored in plaintext, ALWAYS hashed with BCrypt
- Password hash NEVER exposed in API responses
- Email uniqueness enforced at database level (UNIQUE constraint)
- Audit logging: all registration attempts logged (success/failure, IP, email)
- Rate limiting prevents brute force attacks on registration endpoint

### Email Configuration
[Source: Story 1.0 Infrastructure - SendGrid account created]
- **API Key**: Environment variable SENDGRID_API_KEY (must be configured in CI/CD)
- **From Address**: Verified sender domain from Story 1.0
- **Template**: Transactional email (welcome message with user name)
- **Error Handling**: If email fails to send, log error but don't fail registration (graceful degradation)

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5 (Jupiter), Spring Boot Test, TestContainers
- **HTTP Client**: TestRestTemplate for integration tests
- **Mocking**: Mockito for service dependencies, WireMock for SendGrid API
- **Test Location**: src/test/java/com/creditapp/unit/ (unit), src/test/java/com/creditapp/integration/ (integration)

### Testing Checklist
- [ ] PasswordValidator: validates all password rules, rejects weak passwords
- [ ] PasswordHasher: hashes correctly with BCrypt strength 12, matches() works
- [ ] UserRegistrationService: registers borrower, assigns BORROWER role, hashes password
- [ ] AuthController: POST /api/auth/register returns 201, validates input, handles errors
- [ ] DuplicateEmailException: rejected with 409 Conflict
- [ ] Rate limiting: 10 requests/hour enforced, 11th request returns 429
- [ ] Email service: SendGrid API called correctly (mocked)
- [ ] Integration test: full registration flow end-to-end
- [ ] No plaintext passwords in logs or responses
- [ ] All tests pass with mvn clean test
- [ ] Code coverage >80% (JaCoCo report)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - User Registration API & Borrower Account Creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
