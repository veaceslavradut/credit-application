# Story 2.5: Submit Application API

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to submit my completed draft application for bank review,
**so that** banks can see my application and start calculating preliminary offers.

## Acceptance Criteria

1. POST /api/borrower/applications/{id}/submit transitions DRAFT  SUBMITTED status
2. Only DRAFT applications can be submitted
3. Submit triggers notification to all banks (asynchronously)
4. Response includes updated ApplicationDTO with status=SUBMITTED, submittedAt timestamp
5. Submitted timestamp set to UTC now at submission time
6. Only borrower who owns application can submit (403 if unauthorized)
7. Audit logging: APPLICATION_SUBMITTED event with timestamp
8. Application appears immediately in bank application queue
9. Rate limiting: borrower can submit max 5 applications per hour
10. Integration test: submit application, verify status transitions to SUBMITTED and appears in bank queue

## Tasks / Subtasks

- [ ] Task 1: Create Submit Application Service (AC: 1, 4, 5, 7, 8)
  - [ ] Create SubmitApplicationUseCase (src/main/java/com/creditapp/borrower/service/SubmitApplicationUseCase.java)
    - Method: submitApplication(UUID applicationId, UUID borrowerId) returns ApplicationDTO
    - Authorization check: verify borrowerId owns application
    - Status check: verify application.status == DRAFT
    - Throw ApplicationNotDraftException (400) if not DRAFT
    - Update application: status=SUBMITTED, submittedAt=now
    - Save to ApplicationRepository
    - Record status transition via ApplicationStatusTransitionService
    - Log APPLICATION_SUBMITTED audit event
    - Trigger bank notifications (async, publish event)
    - Return updated ApplicationDTO
  - [ ] Unit tests: mock repositories, test status validation

- [ ] Task 2: Create Submit Endpoint in Controller (AC: 1, 6, 9)
  - [ ] Add POST endpoint to BorrowerApplicationController
    - Endpoint: POST /api/borrower/applications/{applicationId}/submit
    - @PreAuthorize("hasAuthority('BORROWER')")
    - @RateLimited(action="SUBMIT_APPLICATION", limitPerHour=5)
    - Extract borrowerId from SecurityContext
    - Call SubmitApplicationUseCase.submitApplication(applicationId, borrowerId)
    - Return ApplicationDTO with 200 OK
    - Error handling:
      - 400 Bad Request: not DRAFT status, validation failures
      - 403 Forbidden: different borrower
      - 404 Not Found: application not found
      - 429 Too Many Requests: rate limit exceeded
  - [ ] Unit tests: mock service, test rate limiting
  - [ ] Integration tests: real submission flow

- [ ] Task 3: Create Bank Notification Service (AC: 3, 8)
  - [ ] Create ApplicationSubmittedEvent (event class for Spring Events)
    - Fields: applicationId, borrowerId, loanType, loanAmount, submittedAt
  - [ ] Create ApplicationNotificationService
    - Method: notifyBanksOfNewApplication(ApplicationSubmittedEvent event) - async
    - Use @Async to run asynchronously
    - Get all ACTIVE banks from database
    - Send notification to each bank (email or in-app notification)
    - Log notification attempts
  - [ ] Unit tests: mock banks repository, verify notifications triggered

- [ ] Task 4: Add Exception Handlers (AC: 6, 9)
  - [ ] Verify GlobalExceptionHandler handles ApplicationNotDraftException  400
  - [ ] Verify RateLimitExceededException handled  429

- [ ] Task 5: Create Tests (AC: 7, 9, 10)
  - [ ] Unit test: happy path submit, verify status change
  - [ ] Unit test: non-DRAFT application, verify 400 error
  - [ ] Unit test: different borrower, verify 403 error
  - [ ] Unit test: submittedAt timestamp set correctly
  - [ ] Unit test: SubmitApplicationUseCase calls AuditService
  - [ ] Unit test: ApplicationNotificationService called with event
  - [ ] Integration test: submit application, verify in database
  - [ ] Integration test: verify submittedAt timestamp in response
  - [ ] Integration test: rate limiting - 5 submits allowed, 6th returns 429
  - [ ] Integration test: application appears in bank queue

- [ ] Task 6: Update API Documentation (AC: 1, 2, 4, 5)
  - [ ] Document POST /api/borrower/applications/{applicationId}/submit
    - No request body required
    - Response (200 OK): ApplicationDTO with status=SUBMITTED
    - Response example with submittedAt timestamp
    - Error responses: 400, 403, 404, 429
    - Rate limiting note: 5 submissions per hour

## Dev Notes

### Previous Story Dependencies
- **Story 2.1**: ApplicationStatusTransitionService
- **Story 2.2, 2.3**: Application service patterns

### Technology Stack
- **Async Processing**: Spring @Async for bank notifications
- **Event Publishing**: Spring ApplicationEventPublisher
- **Rate Limiting**: Redis-based (5 per hour per borrower)

### Key Design Notes
- Only DRAFT applications can transition to SUBMITTED
- submittedAt timestamp immutable after submission
- Bank notifications sent asynchronously to avoid blocking borrower
- Audit trail tracks submission event for compliance

## Testing

### Testing Checklist
- [ ] Submit DRAFT application, verify statusSUBMITTED
- [ ] Submit non-DRAFT application, verify 400 error
- [ ] Submit with different borrower, verify 403 error
- [ ] Verify submittedAt timestamp set to current UTC
- [ ] Verify audit log entry created (APPLICATION_SUBMITTED)
- [ ] Verify bank notification service called
- [ ] Rate limiting: allow 5, reject 6th with 429
- [ ] Integration test: application appears in bank queue
- [ ] All tests pass with mvn clean test
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Submit Application API | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
