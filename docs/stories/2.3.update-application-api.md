# Story 2.3: Update Application API

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to edit my draft application's details (loan amount, term, rate preference),
**so that** I can refine my application before submission.

## Acceptance Criteria

1. PUT /api/borrower/applications/{id} updates application in DRAFT status only
2. Request body: loan_type, loan_amount, loan_term_months, currency, rate_preference
3. Validation: same as create (amount 100-1000000, term 6-360)
4. Response returns updated ApplicationDTO
5. Only borrower who created application can update
6. Cannot update submitted applications (returns 400 Bad Request)
7. Updated timestamp reflects change time
8. Audit logging: APPLICATION_UPDATED event
9. Integration test: update application, verify changes persisted

## Tasks / Subtasks

- [ ] Task 1: Create Update Application Request DTO (AC: 2, 3)
  - [ ] Create UpdateApplicationRequest (src/main/java/com/creditapp/borrower/dto/UpdateApplicationRequest.java)
    - Fields: loanType, loanAmount, loanTermMonths, currency, ratePreference
    - Same validations as CreateApplicationRequest
    - @Valid annotation for nested validation

- [ ] Task 2: Implement Update Application Service (AC: 1, 6, 8)
  - [ ] Extend ApplicationService with updateApplication method
    - Method: updateApplication(UUID applicationId, UUID borrowerId, UpdateApplicationRequest request) returns ApplicationDTO
    - Verify borrower owns application (authorization check)
    - Verify application status is DRAFT (not submitted)
    - Throw ApplicationNotDraftException if not DRAFT status
    - Validate loan amount and term
    - Update entity fields
    - Save to repository
    - Log APPLICATION_UPDATED audit event
    - Return updated ApplicationDTO
  - [ ] Unit tests: test ownership check, status validation, field updates

- [ ] Task 3: Create Update Endpoint in Controller (AC: 1, 5, 7)
  - [ ] Add PUT endpoint to BorrowerApplicationController
    - Endpoint: PUT /api/borrower/applications/{applicationId}
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Call ApplicationService.updateApplication(applicationId, borrowerId, request)
    - Return ApplicationDTO with 200 OK
    - Error handling:
      - 400 Bad Request: invalid data, not DRAFT status
      - 403 Forbidden: different borrower
      - 404 Not Found: application not found
  - [ ] Unit tests: mock service, test success and error paths
  - [ ] Integration tests: verify update in database, timestamp change

- [ ] Task 4: Add Exception Handlers (AC: 6)
  - [ ] Create ApplicationNotDraftException custom exception
  - [ ] Update GlobalExceptionHandler
    - @ExceptionHandler for ApplicationNotDraftException  400 Bad Request

- [ ] Task 5: Create Tests (AC: 8, 9)
  - [ ] Unit test: happy path update, verify all fields changed
  - [ ] Unit test: non-DRAFT status, verify 400 error
  - [ ] Unit test: different borrower, verify 403 error
  - [ ] Integration test: update application, verify in database
  - [ ] Integration test: verify audit log entry created

- [ ] Task 6: Update API Documentation (AC: 1, 2)
  - [ ] Document PUT /api/borrower/applications/{applicationId}
    - Request body example
    - Response example with updated data
    - Error responses

## Dev Notes

### Previous Story Dependencies
- **Story 2.1**: ApplicationService, DTOs, Entities
- **Story 2.2**: CreateApplicationRequest validation patterns

### Key Design Notes
- Only DRAFT applications can be updated (immutable once submitted)
- Borrower ownership verified before allowing update
- ApplicationDTO returned with updated timestamp
- Audit logging tracks all updates for compliance

## Testing

### Testing Checklist
- [ ] Update DRAFT application, verify all fields change
- [ ] Update application with invalid loan_amount, verify 400
- [ ] Update application with invalid loan_term_months, verify 400
- [ ] Update SUBMITTED application, verify 400 error
- [ ] Update with different borrower ID, verify 403 error
- [ ] Verify updatedAt timestamp changes
- [ ] Verify audit log entry created with APPLICATION_UPDATED
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Update Application API | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
