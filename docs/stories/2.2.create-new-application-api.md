# Story 2.2: Create New Application API

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to start a new loan application by specifying loan type, amount, and term,
**so that** I can begin exploring available credit options.

## Acceptance Criteria

1. POST /api/borrower/applications creates new application in DRAFT status
2. Request body: loan_type, loan_amount (100-1000000), loan_term_months (6-360), currency
3. Optional fields: rate_preference (default VARIABLE)
4. Validation: loan_amount  100, loan_term_months  6
5. Application created with status DRAFT
6. Response returns application ID, status, created_at
7. Only authenticated BORROWER role can access
8. Rate limiting: 1 new application per borrower per minute
9. Integration test: create application, verify it appears with DRAFT status

## Tasks / Subtasks

- [ ] Task 1: Create Request Validation DTOs (AC: 2, 3, 4)
  - [ ] Review CreateApplicationRequest DTO from Story 2.1
    - Fields: loanType, loanAmount, loanTermMonths, currency, ratePreference (optional)
    - Validations: @NotBlank, @DecimalMin(100), @Min(6), @NotNull
    - ratePreference default value: VARIABLE (in controller if not provided)
  - [ ] Verify enum types available: LoanType, Currency, RatePreference, ApplicationStatus
  - [ ] Create custom validation annotation @ValidLoanAmount for range validation (100-1000000)
  - [ ] Create custom validation annotation @ValidLoanTerm for range validation (6-360)
  - [ ] Unit tests: test valid and invalid request payloads

- [ ] Task 2: Implement Rate Limiting Interceptor (AC: 8)
  - [ ] Create RateLimiter (src/main/java/com/creditapp/shared/util/RateLimiter.java)
    - Use Redis for distributed rate limiting (key: borrower_id:action:POST_APPLICATION)
    - Limit: 1 new application per borrower per minute
    - Use Lettuce client with default Spring Boot Redis connection
  - [ ] Create RateLimitingAspect or Interceptor
    - Method: checkRateLimit(String borrowerId, String action) returns boolean
    - Action: "CREATE_APPLICATION"
    - If exceeded, throw RateLimitExceededException (status 429)
  - [ ] Create @RateLimited annotation (src/main/java/com/creditapp/shared/security/RateLimited.java)
    - Annotation parameters: action (e.g., "CREATE_APPLICATION"), limit per minute
    - Applied to POST /api/borrower/applications endpoint
  - [ ] Unit tests: mock Redis, verify rate limit enforcement
  - [ ] Integration tests: create application, verify second attempt within 60 seconds fails with 429

- [ ] Task 3: Create Application Creation Service (AC: 1, 4, 5)
  - [ ] Create CreateApplicationUseCase or extend ApplicationService (src/main/java/com/creditapp/borrower/service/CreateApplicationUseCase.java)
    - Method: createApplication(UUID borrowerId, CreateApplicationRequest request) returns ApplicationDTO
    - Validate loan_amount: 100  amount  1,000,000
    - Validate loan_term_months: 6  months  360
    - Create Application entity:
      - id: UUID.randomUUID()
      - borrowerId: (from SecurityContext)
      - loanType: (from request)
      - loanAmount: (from request)
      - loanTermMonths: (from request)
      - currency: (from request)
      - ratePreference: (from request, default VARIABLE if not provided)
      - status: ApplicationStatus.DRAFT
      - createdAt: now
      - submittedAt: null
      - updatedAt: now
    - Save to ApplicationRepository
    - Log APPLICATION_CREATED audit event via AuditService (Story 1.7)
    - Return ApplicationDTO
    - Error handling:
      - InvalidApplicationException (400) for validation failures
      - ApplicationCreationException (500) for persistence errors
  - [ ] Unit tests: mock repositories and AuditService, test validation and happy path

- [ ] Task 4: Create Application REST Controller Endpoint (AC: 1, 2, 6, 7)
  - [ ] Add/Update POST endpoint in BorrowerApplicationController (src/main/java/com/creditapp/borrower/controller/BorrowerApplicationController.java)
    - Endpoint: POST /api/borrower/applications
    - @PreAuthorize("hasAuthority('BORROWER')")
    - @RateLimited(action = "CREATE_APPLICATION", limitPerMinute = 1)
    - Request parameter: @Valid CreateApplicationRequest body
    - Extract borrowerId from SecurityContext (via AuthorizationService)
    - Call CreateApplicationUseCase.createApplication(borrowerId, request)
    - Return: ResponseEntity<ApplicationDTO> with HTTP 201 CREATED
    - Response includes: id, loanType, loanAmount, loanTermMonths, currency, ratePreference, status, createdAt
    - Error handling:
      - 400 Bad Request: validation failures (invalid amounts, terms)
      - 401 Unauthorized: not authenticated
      - 403 Forbidden: not BORROWER role
      - 429 Too Many Requests: rate limit exceeded
      - 500 Internal Server Error: unexpected failures
  - [ ] Controller logs: borrowerId, loanType, loanAmount, status (success/failure)
  - [ ] Unit tests: mock CreateApplicationUseCase, test success and error paths
  - [ ] Integration tests: real HTTP requests with JWT token, verify 201 and all error codes

- [ ] Task 5: Add Exception Handlers (AC: 4, 8)
  - [ ] Update GlobalExceptionHandler (src/main/java/com/creditapp/shared/exception/GlobalExceptionHandler.java)
    - @ExceptionHandler for InvalidApplicationException  400 Bad Request
      - Response: { "error": "Invalid Application", "message": "...", "timestamp": "..." }
    - @ExceptionHandler for RateLimitExceededException  429 Too Many Requests
      - Response: { "error": "Rate Limit Exceeded", "message": "You can create max 1 application per minute", "retryAfter": 60 }
    - @ExceptionHandler for ApplicationCreationException  500 Internal Server Error
  - [ ] Verify error responses include timestamp and error tracking ID (for logging)
  - [ ] Unit tests: test exception handler responses

- [ ] Task 6: Add Audit Logging (AC: 1)
  - [ ] Ensure CreateApplicationUseCase logs to AuditService:
    - Event: APPLICATION_CREATED
    - Fields: borrower_id, application_id, loan_type, loan_amount, loan_term_months, currency, status
    - Include user IP address (from request) if available
  - [ ] Verify AuditService writes to audit log table (Story 1.7 prerequisite)
  - [ ] Test: verify audit log entry created after successful application creation

- [ ] Task 7: Create Unit Tests (AC: 5, 9)
  - [ ] Create ApplicationCreationUnitTest (src/test/java/com/creditapp/unit/borrower/ApplicationCreationUnitTest.java)
    - Test 1: Happy path - create valid application, verify DRAFT status
    - Test 2: loan_amount < 100 - validation fails, returns 400
    - Test 3: loan_amount > 1,000,000 - validation fails, returns 400
    - Test 4: loan_term_months < 6 - validation fails, returns 400
    - Test 5: loan_term_months > 360 - validation fails, returns 400
    - Test 6: ratePreference not provided - defaults to VARIABLE
    - Test 7: Missing required fields - validation fails, returns 400
    - Test 8: Successful application includes all required fields in response
    - Test 9: ApplicationCreationUseCase calls AuditService.logEvent()
  - [ ] Mock: ApplicationRepository, AuditService, ApplicationStatusTransitionService
  - [ ] Framework: JUnit 5, Mockito

- [ ] Task 8: Create Integration Tests (AC: 1, 8, 9)
  - [ ] Create ApplicationCreationIntegrationTest (src/test/java/com/creditapp/integration/borrower/ApplicationCreationIntegrationTest.java)
    - Setup: Create and authenticate borrower user with BORROWER role, get JWT token
    - Test 1: POST valid application, verify 201 Created with ApplicationDTO
    - Test 2: POST valid application, verify application persisted in database with DRAFT status
    - Test 3: POST valid application, verify response includes id, status, createdAt
    - Test 4: POST with loan_amount = 50, verify 400 Bad Request
    - Test 5: POST with loan_amount = 1,500,000, verify 400 Bad Request
    - Test 6: POST with loan_term_months = 3, verify 400 Bad Request
    - Test 7: POST with loan_term_months = 361, verify 400 Bad Request
    - Test 8: Rate limiting - POST application, POST again within 60 seconds, verify 429 Too Many Requests
    - Test 9: Rate limiting - POST application, wait 61 seconds, POST again, verify 201 Created (success)
    - Test 10: Unauthenticated POST, verify 401 Unauthorized
    - Test 11: Authenticated non-BORROWER role (BANK_ADMIN), verify 403 Forbidden
    - Test 12: Verify application appears in GET /api/borrower/applications (Story 2.4)
    - Test 13: Verify audit log entry created with APPLICATION_CREATED event
  - [ ] Use: TestContainers (PostgreSQL + Redis), TestRestTemplate, @WithMockUser for auth testing
  - [ ] Database: Real database with Flyway migrations from Story 2.1

- [ ] Task 9: Create API Documentation (AC: 1, 2, 6)
  - [ ] Update docs/API_ENDPOINTS.md
    - Endpoint: POST /api/borrower/applications
    - Authentication: Bearer {JWT token}, BORROWER role required
    - Request body:
      `json
      {
        "loanType": "PERSONAL",
        "loanAmount": 25000,
        "loanTermMonths": 36,
        "currency": "EUR",
        "ratePreference": "VARIABLE"
      }
      `
    - Response (201 Created):
      `json
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "loanType": "PERSONAL",
        "loanAmount": 25000,
        "loanTermMonths": 36,
        "currency": "EUR",
        "ratePreference": "VARIABLE",
        "status": "DRAFT",
        "createdAt": "2026-01-14T10:30:00Z",
        "submittedAt": null,
        "updatedAt": "2026-01-14T10:30:00Z"
      }
      `
    - Error responses:
      - 400 Bad Request: { "error": "Invalid Application", "message": "loan_amount must be between 100 and 1000000" }
      - 401 Unauthorized: { "error": "Unauthorized", "message": "Authentication required" }
      - 403 Forbidden: { "error": "Forbidden", "message": "BORROWER role required" }
      - 429 Too Many Requests: { "error": "Rate Limit Exceeded", "message": "You can create max 1 application per minute", "retryAfter": 60 }
    - Query parameters: none
    - Rate limiting note: Maximum 1 application per borrower per minute

- [ ] Task 10: Performance & Load Testing (AC: Optional for MVP, recommended)
  - [ ] Create simple load test (1 POST /api/borrower/applications per second for 60 seconds)
    - Target: API should respond <200ms for p95
    - Verify rate limiting works correctly under load
  - [ ] Monitor: DatabaseConnection pool usage, Redis key operations, application response time
  - [ ] Optional: Use JMeter or load testing framework

## Dev Notes

### Previous Story Dependencies
- **Story 1.6**: RBAC - @PreAuthorize("hasAuthority('BORROWER')") requires UserRole enum and JWT role claims
- **Story 1.7**: AuditService - for APPLICATION_CREATED audit logging
- **Story 2.1**: ApplicationService, DTOs, Entities, Repositories - data model foundation

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Web MVC
- **Security**: Spring Security with @PreAuthorize
- **Rate Limiting**: Redis (Lettuce client, default in Spring Boot)
- **Validation**: Spring Validation, Hibernate Validator
- **Testing**: JUnit 5, Mockito, TestContainers, TestRestTemplate

### API Specification
[Source: architecture/2-detailed-service-architecture.md]
**Endpoint:** POST /api/borrower/applications
- Creates new Application in DRAFT status
- Request: CreateApplicationRequest { loanType, loanAmount, loanTermMonths, currency, ratePreference? }
- Response: ApplicationDTO { id, loanType, loanAmount, loanTermMonths, currency, ratePreference, status, createdAt, submittedAt, updatedAt }
- HTTP Status: 201 Created on success

### Rate Limiting Implementation
[Source: architecture/5-infrastructure-deployment.md]
- **Rate Limiter**: Redis-based (distributed, shared across instances)
- **Limit**: 1 application per borrower per minute
- **Key Pattern**: borrower_id:CREATE_APPLICATION
- **TTL**: 60 seconds
- **Exceeded Response**: 429 Too Many Requests with retryAfter header

### Validation Rules
[Source: Story 2.2 AC and Story 2.1]
- **loan_amount**: 100  amount  1,000,000 (configurable in app.properties)
- **loan_term_months**: 6  months  360
- **loan_type**: Required, enum from LoanType (PERSONAL, HOME, AUTO, DEBT_CONSOLIDATION, STUDENT, BUSINESS, OTHER)
- **currency**: Required, enum from Currency (EUR, USD, MDL)
- **rate_preference**: Optional, enum from RatePreference (VARIABLE, FIXED, EITHER), default VARIABLE

### Authorization Context
[Source: architecture/4-security-architecture.md]
- Only BORROWER role can create applications
- Application is tied to authenticated borrower_id (from JWT subject)
- Bank admins and compliance officers cannot create applications

### Audit Logging
[Source: architecture/7-monitoring-observability.md]
**Event:** APPLICATION_CREATED
**Fields:**
- timestamp: ISO-8601 UTC
- event_type: "APPLICATION_CREATED"
- borrower_id: UUID
- application_id: UUID
- loan_type: VARCHAR
- loan_amount: DECIMAL
- loan_term_months: INT
- currency: VARCHAR
- status: "DRAFT"
- user_ip: VARCHAR (if available)
- user_agent: VARCHAR (if available)

**Log Aggregation:** 
- All logs shipped to CloudWatch (production) or ELK (development)
- Retention: 30 days for info/debug, 7 years for audit logs

### Project Directory Structure
[Source: Story 1.1 context]
`
src/main/java/com/creditapp/
 borrower/
    controller/        # BorrowerApplicationController.java (update with POST endpoint)
    service/           # CreateApplicationUseCase.java
    dto/               # CreateApplicationRequest.java (already from Story 2.1)
    exception/         # InvalidApplicationException.java, ApplicationCreationException.java
 shared/
    util/              # RateLimiter.java
    security/          # @RateLimited annotation
    exception/         # GlobalExceptionHandler.java (update with new exception handlers)
    audit/             # AuditService.java (from Story 1.7, called here)

src/test/java/com/creditapp/
 unit/
    borrower/
      ApplicationCreationUnitTest.java
 integration/
    borrower/
      ApplicationCreationIntegrationTest.java
`

### Key Dependencies
`xml
<!-- All from Story 1.1 and Spring Boot defaults -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>io.lettuce</groupId>
    <artifactId>lettuce-core</artifactId>
    <version>7.2.3</version>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
`

### Testing Standards
[Source: frontend-architecture/10-testing-strategy.md]
- **Unit Tests**: Mock all dependencies (repositories, services, Redis)
- **Integration Tests**: Real database (TestContainers), real Redis (TestContainers), real HTTP client
- **Test Framework**: JUnit 5, Mockito, Spring Boot Test
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/
- **Coverage Goal**: 80%+ code coverage

### Important Notes
1. **Rate Limiting**: Must be Redis-backed for distributed systems (multiple app instances)
2. **Default ratePreference**: If not provided in request, default to VARIABLE in the service layer or controller
3. **Borrower Binding**: Always extract borrowerId from SecurityContext, never from request body
4. **Idempotency**: POST operations are typically not idempotent, but consider if client retries are expected
5. **Timestamps**: All timestamps in UTC ISO-8601 format
6. **Error Messages**: Be descriptive but not expose internals; validation messages should guide users
7. **Logging**: Log all attempts (success and failure) for audit and troubleshooting

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, Spring Security Test, TestContainers, Mockito
- **HTTP Client**: TestRestTemplate
- **Rate Limiting**: Embedded Redis (TestContainers)
- **Test Location**: src/test/java/com/creditapp/unit/borrower/, src/test/java/com/creditapp/integration/borrower/

### Testing Checklist
- [ ] CreateApplicationRequest DTO validates all fields correctly
- [ ] CreateApplicationUseCase validates loan_amount (100-1000000)
- [ ] CreateApplicationUseCase validates loan_term_months (6-360)
- [ ] CreateApplicationUseCase defaults ratePreference to VARIABLE when not provided
- [ ] CreateApplicationUseCase creates Application with status DRAFT
- [ ] CreateApplicationUseCase calls AuditService.logEvent() with APPLICATION_CREATED
- [ ] RateLimiter enforces 1 application per borrower per minute
- [ ] RateLimiter allows new application after 60 seconds
- [ ] BorrowerApplicationController POST returns 201 Created with ApplicationDTO
- [ ] BorrowerApplicationController POST requires @PreAuthorize BORROWER role
- [ ] GlobalExceptionHandler returns 400 for InvalidApplicationException
- [ ] GlobalExceptionHandler returns 429 for RateLimitExceededException
- [ ] GlobalExceptionHandler returns 500 for ApplicationCreationException
- [ ] Integration test: POST valid application, verify persisted in database
- [ ] Integration test: POST invalid amount/term, verify 400 Bad Request
- [ ] Integration test: Rate limiting - second POST within 60 sec returns 429
- [ ] Integration test: Unauthenticated POST returns 401
- [ ] Integration test: Non-BORROWER role returns 403
- [ ] Audit log: APPLICATION_CREATED event logged with all required fields
- [ ] All tests pass with mvn clean test
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Create New Application API | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
