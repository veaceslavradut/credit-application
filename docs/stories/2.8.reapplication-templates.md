# Story 2.8: Reapplication Templates

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to reapply using templates from my previous applications,
**so that** I can quickly start a new application without re-entering all information.

## Acceptance Criteria

1. GET /api/borrower/templates lists past accepted applications as templates
2. POST /api/borrower/templates/{templateId}/apply creates new DRAFT app from template
3. Template includes: loan_type, amount_range (min-max), preferred_term, rate_preference
4. New application can be modified before submission
5. Template only from ACCEPTED or COMPLETED applications
6. Template preserves borrower preferences but allows modifications
7. Response: new ApplicationDTO in DRAFT status
8. Audit logging: APPLICATION_CREATED_FROM_TEMPLATE event
9. Integration test: accept application, use as template, create new app

## Tasks / Subtasks

- [ ] Task 1: Create Template DTO (AC: 1, 3, 5)
  - [ ] Create ApplicationTemplateDTO (src/main/java/com/creditapp/borrower/dto/ApplicationTemplateDTO.java)
    - Fields: templateId (UUID of original application), loanType, originalAmount, minAmount, maxAmount, preferredTerm, ratePreference, lastUsed (LocalDateTime)
    - Read-only: no password or sensitive data
  - [ ] Create Template endpoint
    - GET /api/borrower/templates
    - Query: past ACCEPTED and COMPLETED applications
    - Return List<ApplicationTemplateDTO>

- [ ] Task 2: Create Template Service (AC: 2, 4, 6)
  - [ ] Create TemplateApplicationService (src/main/java/com/creditapp/borrower/service/TemplateApplicationService.java)
    - Method: getTemplates(UUID borrowerId) returns List<ApplicationTemplateDTO>
      - Query applications where borrowerId and status IN (ACCEPTED, COMPLETED)
      - Return list of templates
    - Method: createApplicationFromTemplate(UUID borrowerId, UUID templateId) returns ApplicationDTO
      - Verify template ownership
      - Verify template status is ACCEPTED or COMPLETED
      - Create new Application entity with DRAFT status
      - Copy: loanType, preferred amount, term, currency, rate_preference from template
      - Save to repository
      - Log APPLICATION_CREATED_FROM_TEMPLATE audit event
      - Return new ApplicationDTO
  - [ ] Unit tests: mock repository, test template creation

- [ ] Task 3: Create Template Endpoints (AC: 1, 2, 7)
  - [ ] Add GET /api/borrower/templates endpoint
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Call TemplateApplicationService.getTemplates(borrowerId)
    - Return List<ApplicationTemplateDTO>
  - [ ] Add POST /api/borrower/templates/{templateId}/apply endpoint
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Call TemplateApplicationService.createApplicationFromTemplate(borrowerId, templateId)
    - Return new ApplicationDTO with 201 Created
    - Error handling: 404 template not found, 403 unauthorized

- [ ] Task 4: Create Tests (AC: 4, 8, 9)
  - [ ] Unit test: create application from template, verify fields copied
  - [ ] Unit test: template only from ACCEPTED/COMPLETED apps
  - [ ] Unit test: new application in DRAFT status
  - [ ] Unit test: can modify new application before submission
  - [ ] Integration test: accept application, use as template
  - [ ] Integration test: create new app from template, verify in database
  - [ ] Integration test: verify audit log entry created

- [ ] Task 5: Update API Documentation
  - [ ] Document GET /api/borrower/templates
  - [ ] Document POST /api/borrower/templates/{templateId}/apply

## Dev Notes

### Previous Story Dependencies
- **Story 2.5**: Application submission and status transitions

### Key Design Notes
- Templates only from ACCEPTED or COMPLETED applications
- New application inherits loan type, amount, term, rate preference
- New application created in DRAFT status for review/modification
- Original template not modified

## Testing

### Testing Checklist
- [ ] GET /api/borrower/templates returns ACCEPTED/COMPLETED apps only
- [ ] Create app from template, verify all fields copied
- [ ] New app in DRAFT status, modifiable
- [ ] Template for DRAFT application rejected (403)
- [ ] Template from other borrower rejected (403)
- [ ] Template not found returns 404
- [ ] Audit log entry created with APPLICATION_CREATED_FROM_TEMPLATE
- [ ] All tests pass
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Reapplication Templates | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
