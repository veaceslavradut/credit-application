# Story 4.8: Offer Analytics & Conversion Reports

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to view detailed analytics on offer performance with trends and conversion metrics,
**so that** I can understand what's working and optimize my lending strategy.

## Acceptance Criteria

1. GET /api/bank/analytics with date range returns comprehensive analytics for authenticated bank
2. Metrics displayed: Applications Received, Offers Submitted, Conversion Rate (offers/applications %), Avg Time to Offer, Avg APR, Acceptance by Loan Type, Acceptance by Amount Range
3. Date range support: Today, Last 7 Days, Last 30 Days, Custom (dateFrom, dateTo), Last Year
4. Trend data: Daily/Weekly/Monthly aggregation for Applications, Offers, Acceptance Rate
5. Charts (optional Phase 2): Line chart (trends), Bar chart (loan type breakdown), Pie chart (acceptance by amount range)
6. Leaderboard (optional): Top performing loan types by acceptance rate (anonymized - no competitor data)
7. Phase 2: Borrower demographics trends (age range, income distribution, employment industry)
8. Export options (optional Phase 2): CSV and PDF downloads of report
9. Response time: <1 second
10. Support analysis of 10,000+ applications

## Tasks / Subtasks

- [ ] Task 1: Create Analytics DTOs
  - [ ] Create AnalyticsMetricsDTO (applicationsReceived, offersSubmitted, conversionRate, avgTimeToOffer, avgAPR, acceptanceByLoanType{}, acceptanceByAmountRange{})
  - [ ] Create AnalyticsTrendDTO (date, applicationsCount, offersCount, acceptanceRate)
  - [ ] Create AnalyticsResponseDTO (metrics, trends[], loanTypeBreakdown{}, amountRangeBreakdown{}, reportGeneratedAt)
  - [ ] Create AnalyticsRequest (dateFrom, dateTo, preset: TODAY/LAST_7/LAST_30/LAST_YEAR/CUSTOM)

- [ ] Task 2: Create Analytics Service - Core Metrics
  - [ ] Create BankAnalyticsService
    - Method: getAnalytics(UUID bankId, AnalyticsRequest request)
      - Calculate date range from preset or custom dates
      - Fetch all applications in date range
      - Fetch all offers in date range
      - Calculate metrics:
        - applicationsReceived = count(Application WHERE createdDate in range)
        - offersSubmitted = count(Offer WHERE submittedDate in range)
        - conversionRate = offersSubmitted / applicationsReceived * 100
        - avgTimeToOffer = avg(offer.submittedDate - application.createdDate)
        - avgAPR = avg(Offer.apr)

- [ ] Task 3: Create Analytics Service - Breakdown by Loan Type
  - [ ] Method: getAcceptanceByLoanType(UUID bankId, LocalDate dateFrom, LocalDate dateTo)
    - Group offers by LoanRequest.loanType
    - Count offers per type
    - Count accepted (where ApplicationChoice exists) per type
    - Calculate acceptance rate per type
    - Return map: loanType -> {count, accepted, acceptanceRate}

- [ ] Task 4: Create Analytics Service - Breakdown by Amount Range
  - [ ] Method: getAcceptanceByAmountRange(UUID bankId, LocalDate dateFrom, LocalDate dateTo)
    - Define ranges: 0-10k, 10k-25k, 25k-50k, 50k-100k, 100k+
    - Group offers by amount range
    - Count offers per range
    - Count accepted per range
    - Calculate acceptance rate per range
    - Return map: amountRange -> {count, accepted, acceptanceRate}

- [ ] Task 5: Create Analytics Service - Trend Data
  - [ ] Method: getTrendData(UUID bankId, LocalDate dateFrom, LocalDate dateTo, String granularity)
    - granularity: DAILY, WEEKLY, MONTHLY
    - For each period:
      - Count applications
      - Count offers
      - Calculate acceptance rate (accepted / submitted)
      - Return AnalyticsTrendDTO[]

- [ ] Task 6: Create Analytics Controller
  - [ ] Create BankAnalyticsController
    - GET /api/bank/analytics
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Query params: dateFrom, dateTo, preset (TODAY/LAST_7/LAST_30/LAST_YEAR/CUSTOM)
      - Extract bankId from SecurityContext
      - Call AnalyticsService.getAnalytics()
      - Return AnalyticsResponseDTO with 200 OK
      - Measure response time, ensure <1 second

- [ ] Task 7: Loan Type Breakdown Endpoint
  - [ ] GET /api/bank/analytics/loan-types
    - Query params: dateFrom, dateTo
    - Return breakdown by loan type with acceptance rates

- [ ] Task 8: Amount Range Breakdown Endpoint
  - [ ] GET /api/bank/analytics/amount-ranges
    - Query params: dateFrom, dateTo
    - Return breakdown by amount range with acceptance rates

- [ ] Task 9: Trend Data Endpoint
  - [ ] GET /api/bank/analytics/trends
    - Query params: dateFrom, dateTo, granularity (DAILY/WEEKLY/MONTHLY)
    - Return array of trend data points

- [ ] Task 10: Unit Tests
  - [ ] Test metrics calculation (conversion rate, avg time, avg APR)
  - [ ] Test breakdown by loan type
  - [ ] Test breakdown by amount range
  - [ ] Test trend data generation (daily, weekly, monthly)
  - [ ] Test date range filtering
  - [ ] Test preset date ranges (TODAY, LAST_7, etc.)

- [ ] Task 11: Integration Tests
  - [ ] Create 100 applications and offers with various types and amounts
  - [ ] Get analytics for different date ranges
  - [ ] Verify metrics calculated correctly
  - [ ] Verify loan type breakdown totals match overall metrics
  - [ ] Verify amount range breakdown accuracy
  - [ ] Verify trend data aggregates correctly
  - [ ] Verify performance <1 second with 10,000+ applications

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Analytics & Conversion Reports | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
