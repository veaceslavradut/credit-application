# Story 4.5: Bank Offer History & Tracking

## Status
In Development

## Story

**As a** bank administrator,
**I want** to view all offers submitted by my bank with status tracking and borrower selection status,
**so that** I can monitor offer performance and track borrower acceptance.

## Acceptance Criteria

1. GET /api/bank/offers returns paginated list of offers submitted by authenticated bank
2. Display per offer: offerId, borrowerName, APR, monthlyPayment, processingTime, submittedDate, status (SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN), borrowerStatus (NOT_VIEWED/VIEWED/ACCEPTED_OTHER)
3. Status definitions: SUBMITTED (pending), ACCEPTED (borrower accepted), EXPIRED (24hr window passed), WITHDRAWN (bank recalled)
4. BorrowerStatus: NOT_VIEWED (borrower hasn't viewed), VIEWED (borrower viewed but not decided), ACCEPTED_OTHER (borrower accepted different bank's offer)
5. Pagination: 20 items per page, support page parameter
6. Sorting options: Newest First, Oldest First, APR (Low to High), APR (High to Low), Monthly Payment (Low to High), Monthly Payment (High to Low)
7. Filtering: Status (SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN), Date Range, APR Range, Payment Range
8. Export (optional Phase 2): CSV with all offer data, PDF with summary
9. Response time: <200ms
10. Support 1000+ offers without performance degradation

## Tasks / Subtasks

- [x] Task 1: Create Offer History DTOs
  - [x] Create OfferHistoryItem DTO (offerId, borrowerName, APR, monthlyPayment, processingTime, submittedDate, status, borrowerStatus)
  - [x] Create OfferHistoryResponse DTO with paginated results (items, totalCount, page, pageSize)
  - [x] Create OfferHistoryFilter DTO (statuses[], dateRange, aprRange, paymentRange, sortBy)

- [x] Task 2: Create Offer History Service
  - [x] Create BankOfferHistoryService
    - Method: getOfferHistory(UUID bankId, OfferHistoryFilter filter, int page, int pageSize)
      - Fetch all offers where bankId matches
      - Determine offer status: SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN
      - Determine borrower status: NOT_VIEWED/VIEWED/ACCEPTED_OTHER (based on Offer and ApplicationChoice)
      - Apply filters (status, date range, APR range, payment range)
      - Sort by selected option
      - Apply pagination
      - Ensure <200ms response

- [x] Task 3: Create Offer History Controller
  - [x] Create BankOfferHistoryController
    - GET /api/bank/offers
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Query params: page (default 0), status[], dateFrom, dateTo, aprFrom, aprTo, paymentFrom, paymentTo, sortBy
      - Extract bankId from SecurityContext
      - Call OfferHistoryService
      - Return paginated OfferHistoryResponse with 200 OK

- [x] Task 4: Offer Status Determination
  - [x] Create method: determineOfferStatus(Offer offer)
    - Check if offer.offerStatus == WITHDRAWN: WITHDRAWN
    - Check if offer.offerStatus == EXPIRED: EXPIRED
    - Check if offer.offerStatus == ACCEPTED: ACCEPTED
    - Default: SUBMITTED

- [x] Task 5: Borrower Status Determination
  - [x] Create method: determineBorrowerStatus(UUID offerId)
    - Check if Offer viewed by borrower: VIEWED
    - Check if ApplicationChoice exists for different bank's offer: ACCEPTED_OTHER
    - Check if Application status > VIEWED: implies borrower reviewed
    - Default: NOT_VIEWED

- [x] Task 6: Sorting Implementation
  - [x] Support sorting by: submittedDate (ASC/DESC), APR (ASC/DESC), monthlyPayment (ASC/DESC)
  - [x] Default: Newest First (submittedDate DESC)

- [x] Task 7: Filtering Implementation
  - [x] Filter by status list (allow multiple)
  - [x] Filter by date range (submittedDate between start and end)
  - [x] Filter by APR range (APR between min and max)
  - [x] Filter by payment range (monthlyPayment between min and max)

- [ ] Task 8: Unit Tests
  - [ ] Test offer status determination (SUBMITTED, ACCEPTED, EXPIRED, WITHDRAWN)
  - [ ] Test borrower status determination
  - [ ] Test pagination (page 0, page 1)
  - [ ] Test sorting options
  - [ ] Test filtering (status, date, APR, payment ranges)

- [ ] Task 9: Integration Tests
  - [ ] Create 100+ offers from different borrowers
  - [ ] Verify pagination returns 20 items per page
  - [ ] Verify filters work correctly
  - [ ] Verify status calculations match expectations
  - [ ] Verify performance <200ms with 1000+ offers
  - [ ] Verify sorting options produce correct order

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Bank Offer History & Tracking | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Haiku 4.5

### Debug Log References
- Compilation: BUILD SUCCESS
- No runtime errors in implementation

### Completion Notes
**Tasks 1-7 Complete (Core Implementation)**
- Created OfferHistoryItem, OfferHistoryResponse, OfferHistoryFilter DTOs using Lombok
- Implemented BankOfferHistoryService with:
  - getOfferHistory() method for paginated offer retrieval
  - determineOfferStatus() for offer status calculation (SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN)
  - determineBorrowerStatus() for borrower interaction tracking (NOT_VIEWED/VIEWED/ACCEPTED_OTHER)
  - applyFilters() for status, date range, APR range, payment range filtering
  - sortOffers() for sorting by submittedDate, APR, monthlyPayment (ASC/DESC)
  - convertToHistoryItem() for DTO conversion with borrower name lookup
- Implemented BankOfferHistoryController with:
  - GET /api/bank/offers endpoint with @RequiresBankAdmin
  - Query parameter parsing for pagination, filtering, sorting
  - Security context integration for bank ID extraction

**Tasks 8-9 Pending**
- Unit tests for status determination, borrower status, pagination, sorting, filtering
- Integration tests for performance verification with 1000+ offers

### File List
1. [src/main/java/com/creditapp/bank/dto/OfferHistoryItem.java](src/main/java/com/creditapp/bank/dto/OfferHistoryItem.java) - Item DTO
2. [src/main/java/com/creditapp/bank/dto/OfferHistoryResponse.java](src/main/java/com/creditapp/bank/dto/OfferHistoryResponse.java) - Response DTO
3. [src/main/java/com/creditapp/bank/dto/OfferHistoryFilter.java](src/main/java/com/creditapp/bank/dto/OfferHistoryFilter.java) - Filter DTO
4. [src/main/java/com/creditapp/bank/service/BankOfferHistoryService.java](src/main/java/com/creditapp/bank/service/BankOfferHistoryService.java) - Service (~296 lines)
5. [src/main/java/com/creditapp/bank/controller/BankOfferHistoryController.java](src/main/java/com/creditapp/bank/controller/BankOfferHistoryController.java) - Controller (~125 lines)

## QA Results

*To be completed by QA agent after story is implemented*
