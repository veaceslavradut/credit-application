# Story 4.5: Bank Offer History & Tracking

## Status
In Development

## Story

**As a** bank administrator,
**I want** to view all offers submitted by my bank with status tracking and borrower selection status,
**so that** I can monitor offer performance and track borrower acceptance.

## Acceptance Criteria

1. GET /api/bank/offers returns paginated list of offers submitted by authenticated bank
2. Display per offer: offerId, borrowerName, APR, monthlyPayment, processingTime, submittedDate, status (SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN), borrowerStatus (NOT_VIEWED/VIEWED/ACCEPTED_OTHER)
3. Status definitions: SUBMITTED (pending), ACCEPTED (borrower accepted), EXPIRED (24hr window passed), WITHDRAWN (bank recalled)
4. BorrowerStatus: NOT_VIEWED (borrower hasn't viewed), VIEWED (borrower viewed but not decided), ACCEPTED_OTHER (borrower accepted different bank's offer)
5. Pagination: 20 items per page, support page parameter
6. Sorting options: Newest First, Oldest First, APR (Low to High), APR (High to Low), Monthly Payment (Low to High), Monthly Payment (High to Low)
7. Filtering: Status (SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN), Date Range, APR Range, Payment Range
8. Export (optional Phase 2): CSV with all offer data, PDF with summary
9. Response time: <200ms
10. Support 1000+ offers without performance degradation

## Tasks / Subtasks

- [x] Task 1: Create Offer History DTOs
  - [x] Create OfferHistoryItem DTO (offerId, borrowerName, APR, monthlyPayment, processingTime, submittedDate, status, borrowerStatus)
  - [x] Create OfferHistoryResponse DTO with paginated results (items, totalCount, page, pageSize)
  - [x] Create OfferHistoryFilter DTO (statuses[], dateRange, aprRange, paymentRange, sortBy)

- [ ] Task 2: Create Offer History Service
  - [ ] Create BankOfferHistoryService
    - Method: getOfferHistory(UUID bankId, OfferHistoryFilter filter, int page, int pageSize)
      - Fetch all offers where bankId matches
      - Determine offer status: SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN
      - Determine borrower status: NOT_VIEWED/VIEWED/ACCEPTED_OTHER (based on Offer and ApplicationChoice)
      - Apply filters (status, date range, APR range, payment range)
      - Sort by selected option
      - Apply pagination
      - Ensure <200ms response
    - **STATUS**: DEFERRED - DTOs complete, controller placeholder ready. Service blocked by file encoding issues.

- [x] Task 3: Create Offer History Controller
  - [x] Create BankOfferHistoryController
    - GET /api/bank/offers
      - @RequiresBankAdmin annotation for authorization
      - Query params: page (default 0), status[], dateFrom, dateTo, aprFrom, aprTo, paymentFrom, paymentTo, sortBy
      - Current Status: Placeholder that returns HTTP 501 NOT_IMPLEMENTED
      - Ready for service integration once BankOfferHistoryService is created

- [ ] Task 4: Offer Status Determination
  - [ ] Create method: determineOfferStatus(Offer offer)
    - Check if offer.offerStatus == WITHDRAWN: WITHDRAWN
    - Check if offer.offerStatus == EXPIRED: EXPIRED
    - Check if offer.offerStatus == ACCEPTED: ACCEPTED
    - Default: SUBMITTED
    - **STATUS**: DEFERRED - Part of service layer (Task 2)

- [ ] Task 5: Borrower Status Determination
  - [ ] Create method: determineBorrowerStatus(UUID offerId)
    - Check if Offer viewed by borrower: VIEWED
    - Check if ApplicationChoice exists for different bank's offer: ACCEPTED_OTHER
    - Check if Application status > VIEWED: implies borrower reviewed
    - Default: NOT_VIEWED
    - **STATUS**: DEFERRED - Part of service layer (Task 2)

- [ ] Task 6: Sorting Implementation
  - [ ] Support sorting by: submittedDate (ASC/DESC), APR (ASC/DESC), monthlyPayment (ASC/DESC)
  - [ ] Default: Newest First (submittedDate DESC)
  - **STATUS**: DEFERRED - Part of service layer (Task 2)

- [ ] Task 7: Filtering Implementation
  - [ ] Filter by status list (allow multiple)
  - [ ] Filter by date range (submittedDate between start and end)
  - [ ] Filter by APR range (APR between min and max)
  - [ ] Filter by payment range (monthlyPayment between min and max)
  - **STATUS**: DEFERRED - Part of service layer (Task 2)

- [ ] Task 8: Unit Tests
  - [ ] Test offer status determination (SUBMITTED, ACCEPTED, EXPIRED, WITHDRAWN)
  - [ ] Test borrower status determination
  - [ ] Test pagination (page 0, page 1)
  - [ ] Test sorting options
  - [ ] Test filtering (status, date, APR, payment ranges)

- [ ] Task 9: Integration Tests
  - [ ] Create 100+ offers from different borrowers
  - [ ] Verify pagination returns 20 items per page
  - [ ] Verify filters work correctly
  - [ ] Verify status calculations match expectations
  - [ ] Verify performance <200ms with 1000+ offers
  - [ ] Verify sorting options produce correct order

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Bank Offer History & Tracking | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Haiku 4.5

### Completion Status: PARTIALLY COMPLETE (Blocking Issue)
**Blocking Issue**: Service file creation encountered file encoding issues (BOM character errors). DTOs and controller placeholder are ready but service implementation deferred.

### Progress Summary
- ✅ Task 1 (DTOs): COMPLETE - All 3 DTOs created with Lombok annotations and compiling
- ❌ Task 2 (Service): DEFERRED - File creation blocked by encoding issues  
- ✅ Task 3 (Controller): READY - Placeholder created, waiting for service integration
- ⏳ Tasks 4-7 (Business Logic): DEFERRED - Part of service implementation
- ⏳ Tasks 8-9 (Tests): PENDING - Waiting for service completion

### Debug Log

**Phase 1: DTO Creation (SUCCESS)**
- Created OfferHistoryItem.java with 8 properties (offerId, borrowerName, apr, monthlyPayment, processingTimeDays, submittedDate, status, borrowerStatus)
- Created OfferHistoryResponse.java with pagination (items, totalCount, page, pageSize)
- Created OfferHistoryFilter.java with 9 filter properties and sortBy
- All DTOs use Lombok @Data, @Builder, @RequiredArgsConstructor, @NoArgsConstructor annotations
- Compilation Status: ✅ SUCCESS - All DTOs compile cleanly

**Phase 2: Controller Creation (SUCCESS)**
- Created BankOfferHistoryController with placeholder implementation
- Endpoint: GET /api/bank/offers with @RequiresBankAdmin authorization
- Query parameters properly defined for pagination, filtering, sorting
- Current status: Returns 501 NOT_IMPLEMENTED, ready for service integration
- Compilation Status: ✅ SUCCESS - No compilation errors

**Phase 3: Service Creation (BLOCKED)**
- Attempted multiple methods to create BankOfferHistoryService:
  1. PowerShell Set-Content: Failed - BOM (\ufeff) encoding issue
  2. File copy template + replace_string_in_file: Partial success then corruption
  3. PowerShell [System.IO.File]::WriteAllText with UTF8: Still produced BOM
- Error: "illegal character: '\ufeff'" in compilation
- Result: Service file deleted to clean repository state
- Status: Requires alternative creation method

### Completion Notes
**DTOs Successfully Implemented (Ready)**
- OfferHistoryItem.java: Transfer object for individual offer in history
- OfferHistoryResponse.java: Paginated response wrapper with metadata
- OfferHistoryFilter.java: Query filter criteria container

**Controller Placeholder Ready (Awaiting Service)**
- BankOfferHistoryController: Skeleton with endpoint routing
- Includes TODO comments for integration points
- Compiles without errors despite missing service dependency

**Service Logic Designed (Ready for Implementation)**
- getOfferHistory(): Fetch, filter, sort, paginate offers
- determineOfferStatus(): Status calculation logic SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN
- determineBorrowerStatus(): Borrower interaction tracking NOT_VIEWED/VIEWED/ACCEPTED_OTHER
- applyFilters(): Multi-criteria filtering implementation
- sortOffers(): Flexible sorting by date, APR, payment amount
- convertToHistoryItem(): Entity-to-DTO mapping with borrower lookup

### File List
1. ✅ src/main/java/com/creditapp/bank/dto/OfferHistoryItem.java
2. ✅ src/main/java/com/creditapp/bank/dto/OfferHistoryResponse.java
3. ✅ src/main/java/com/creditapp/bank/dto/OfferHistoryFilter.java
4. ✅ src/main/java/com/creditapp/bank/controller/BankOfferHistoryController.java
5. ❌ src/main/java/com/creditapp/bank/service/BankOfferHistoryService.java (NOT CREATED - Encoding issue)

## QA Results

*To be completed by QA agent after story is implemented*
