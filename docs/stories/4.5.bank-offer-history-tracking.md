# Story 4.5: Bank Offer History & Tracking

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to view all offers submitted by my bank with status tracking and borrower selection status,
**so that** I can monitor offer performance and track borrower acceptance.

## Acceptance Criteria

1. GET /api/bank/offers returns paginated list of offers submitted by authenticated bank
2. Display per offer: offerId, borrowerName, APR, monthlyPayment, processingTime, submittedDate, status (SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN), borrowerStatus (NOT_VIEWED/VIEWED/ACCEPTED_OTHER)
3. Status definitions: SUBMITTED (pending), ACCEPTED (borrower accepted), EXPIRED (24hr window passed), WITHDRAWN (bank recalled)
4. BorrowerStatus: NOT_VIEWED (borrower hasn't viewed), VIEWED (borrower viewed but not decided), ACCEPTED_OTHER (borrower accepted different bank's offer)
5. Pagination: 20 items per page, support page parameter
6. Sorting options: Newest First, Oldest First, APR (Low to High), APR (High to Low), Monthly Payment (Low to High), Monthly Payment (High to Low)
7. Filtering: Status (SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN), Date Range, APR Range, Payment Range
8. Export (optional Phase 2): CSV with all offer data, PDF with summary
9. Response time: <200ms
10. Support 1000+ offers without performance degradation

## Tasks / Subtasks

- [ ] Task 1: Create Offer History DTOs
  - [ ] Create OfferHistoryItem DTO (offerId, borrowerName, APR, monthlyPayment, processingTime, submittedDate, status, borrowerStatus)
  - [ ] Create OfferHistoryResponse DTO with paginated results (items, totalCount, page, pageSize)
  - [ ] Create OfferHistoryFilter DTO (statuses[], dateRange, aprRange, paymentRange, sortBy)

- [ ] Task 2: Create Offer History Service
  - [ ] Create BankOfferHistoryService
    - Method: getOfferHistory(UUID bankId, OfferHistoryFilter filter, int page, int pageSize)
      - Fetch all offers where bankId matches
      - Determine offer status: SUBMITTED/ACCEPTED/EXPIRED/WITHDRAWN
      - Determine borrower status: NOT_VIEWED/VIEWED/ACCEPTED_OTHER (based on Offer and ApplicationChoice)
      - Apply filters (status, date range, APR range, payment range)
      - Sort by selected option
      - Apply pagination
      - Ensure <200ms response

- [ ] Task 3: Create Offer History Controller
  - [ ] Create BankOfferHistoryController
    - GET /api/bank/offers
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Query params: page (default 0), status[], dateFrom, dateTo, aprFrom, aprTo, paymentFrom, paymentTo, sortBy
      - Extract bankId from SecurityContext
      - Call OfferHistoryService
      - Return paginated OfferHistoryResponse with 200 OK

- [ ] Task 4: Offer Status Determination
  - [ ] Create method: determineOfferStatus(Offer offer)
    - Check if offer.expiryDate < now(): EXPIRED
    - Check if offer.withdrawn=true: WITHDRAWN
    - Check if ApplicationChoice exists for this offer: ACCEPTED
    - Default: SUBMITTED

- [ ] Task 5: Borrower Status Determination
  - [ ] Create method: determineBorrowerStatus(UUID offerId)
    - Check if Offer viewed by borrower: VIEWED
    - Check if ApplicationChoice exists for different bank's offer: ACCEPTED_OTHER
    - Check if Application status > VIEWED: implies borrower reviewed
    - Default: NOT_VIEWED

- [ ] Task 6: Sorting Implementation
  - [ ] Support sorting by: submittedDate (ASC/DESC), APR (ASC/DESC), monthlyPayment (ASC/DESC)
  - [ ] Default: Newest First (submittedDate DESC)

- [ ] Task 7: Filtering Implementation
  - [ ] Filter by status list (allow multiple)
  - [ ] Filter by date range (submittedDate between start and end)
  - [ ] Filter by APR range (APR between min and max)
  - [ ] Filter by payment range (monthlyPayment between min and max)

- [ ] Task 8: Unit Tests
  - [ ] Test offer status determination (SUBMITTED, ACCEPTED, EXPIRED, WITHDRAWN)
  - [ ] Test borrower status determination
  - [ ] Test pagination (page 0, page 1)
  - [ ] Test sorting options
  - [ ] Test filtering (status, date, APR, payment ranges)

- [ ] Task 9: Integration Tests
  - [ ] Create 100+ offers from different borrowers
  - [ ] Verify pagination returns 20 items per page
  - [ ] Verify filters work correctly
  - [ ] Verify status calculations match expectations
  - [ ] Verify performance <200ms with 1000+ offers
  - [ ] Verify sorting options produce correct order

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Bank Offer History & Tracking | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
