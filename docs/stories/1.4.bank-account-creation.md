# Story 1.4: Bank Account Creation & Admin Registration

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to register my bank with organization details and create an admin account,
**so that** my bank can participate in the marketplace and review borrower applications.

## Acceptance Criteria

1. POST /api/auth/register-bank endpoint accepts: bank name, registration number, contact email, admin name, admin password, phone
2. Bank organization created in database with unique registration number
3. Admin user created and assigned "BANK_ADMIN" role linked to the bank organization
4. Bank activation workflow: admin receives email with activation link
5. Bank status: PENDING_ACTIVATION  ACTIVE (after email confirmation)
6. Only ACTIVE banks can log in and access application queue
7. Bank cannot be deleted once created (soft delete for audit trail)
8. Integration test verifies bank registration and admin login flow
9. Error handling: duplicate bank registration number, invalid email, password validation

## Tasks / Subtasks

- [ ] Task 1: Create Database Migration for Bank Activation (AC: 2, 5, 6, 7)
  - [ ] Create V3__Add_Bank_Status_and_Activation.sql migration
    - Add column to organizations table: status ENUM('PENDING_ACTIVATION', 'ACTIVE', 'INACTIVE') DEFAULT 'PENDING_ACTIVATION'
    - Add column to organizations table: activation_token VARCHAR(255) UNIQUE
    - Add column to organizations table: activated_at TIMESTAMP (nullable)
    - Add column to organizations table: deleted_at TIMESTAMP (soft delete)
    - Add check constraint: deleted_at IS NULL for logical active status
  - [ ] Create database index on organizations.registration_number (for uniqueness and query performance)
  - [ ] Verify migration runs without errors in docker-compose PostgreSQL

- [ ] Task 2: Update Organization JPA Entity (AC: 2, 5, 6)
  - [ ] Update Organization entity (src/main/java/com/creditapp/shared/model/Organization.java)
    - Add fields: status (BankStatus enum), activationToken, activatedAt, deletedAt
    - Add @Enumerated(EnumType.STRING) for status field
    - Add @CreationTimestamp, @UpdateTimestamp for audit
    - Add @Column(name="deleted_at") deletedAt for soft delete
  - [ ] Create BankStatus enum: PENDING_ACTIVATION, ACTIVE, INACTIVE
  - [ ] Override equals() and hashCode() for JPA compatibility

- [ ] Task 3: Create Bank Registration DTOs (AC: 1, 9)
  - [ ] Create BankRegistrationRequest DTO (src/main/java/com/creditapp/auth/dto/BankRegistrationRequest.java)
    - Fields: bankName, registrationNumber, contactEmail, adminFirstName, adminLastName, adminPassword, adminPasswordConfirm, adminPhone
    - Validations: @NotBlank, @Email, @Size, @Pattern
    - Registration number: alphanumeric, 5-20 characters, must be unique
  - [ ] Create BankRegistrationResponse DTO (src/main/java/com/creditapp/auth/dto/BankRegistrationResponse.java)
    - Fields: bankId (UUID), bankName, adminUserId (UUID), status, message
    - No sensitive data: password, activation token must not be exposed
  - [ ] Create ActivationRequest DTO for email link activation (token parameter)

- [ ] Task 4: Create Bank Registration Service (AC: 2, 3, 4, 5, 7, 9)
  - [ ] Create BankRegistrationService (src/main/java/com/creditapp/auth/service/BankRegistrationService.java)
    - Method: registerBank(BankRegistrationRequest request) returns BankRegistrationResponse
    - Validate input: password, email format, registration number format
    - Check uniqueness: Organization.findByRegistrationNumber(regNum) must be empty
    - Throw DuplicateBankRegistrationException if exists
    - Create Organization entity: name, registrationNumber, status=PENDING_ACTIVATION, activationToken=(random token)
    - Save organization to database
    - Create User entity for admin: email, passwordHash, firstName, lastName, phone, role=BANK_ADMIN, organization_id=bankId
    - Save user to database
    - Return BankRegistrationResponse with bankId, adminUserId, status=PENDING_ACTIVATION
    - Do NOT trigger email here; return activation token for controller to send
  - [ ] Unit tests: mock UserRepository, OrganizationRepository, test happy path and error cases

- [ ] Task 5: Create Activation Token Generator Service (AC: 4)
  - [ ] Create ActivationTokenService (src/main/java/com/creditapp/shared/service/ActivationTokenService.java)
    - Method: generateToken() returns String (secure random 32-character alphanumeric token)
    - Method: validateToken(String token) returns boolean (verify token matches expected format)
    - Use SecureRandom for token generation
    - Tokens valid for 7 days (configurable: app.activation.token.expiry.hours=168)
  - [ ] Store token expiry in organizations table: activation_token_expires_at TIMESTAMP
  - [ ] Unit tests: verify token generation and validation

- [ ] Task 6: Create Bank Activation Email Service (AC: 4)
  - [ ] Create BankActivationEmailService (src/main/java/com/creditapp/shared/service/BankActivationEmailService.java)
    - Method: sendActivationEmail(String email, String bankName, String activationToken) returns boolean
    - Use SendGrid to send activation email with activation link
    - Activation link: /auth/activate?token={activationToken}
    - Email includes: bank name, admin name, activation link, expiry time (7 days)
  - [ ] Email sending is non-blocking: use @Async
    - **INTEGRATION NOTE (Decision 1 - Async Email Framework):**
      - Option A (Preferred for consistency): Reuse Spring Events pattern from Story 1.3
        - Create BankActivationRequestedEvent extending ApplicationEvent
        - BankActivationEmailService listens via @EventListener and @Async
        - Consistent with UserRegisteredEvent pattern in Story 1.3
      - Option B (Simpler for MVP): Direct @Async service without events
        - BankActivationEmailService.sendActivationEmail() directly calls SendGrid
        - Still non-blocking via @Async annotation
      - Choose Option based on architectural preference; both approaches are valid
  - [ ] Unit tests: mock SendGrid, verify email method called with correct parameters

- [ ] Task 7: Create Bank Activation Endpoint (AC: 4, 5)
  - [ ] Create endpoint in AuthController: GET /api/auth/activate
    - Parameter: token (activation token)
    - Find Organization by activationToken
    - Verify token not expired (activation_token_expires_at > now)
    - Update organization: status=ACTIVE, activated_at=now, activationToken=null
    - Return success response with bank details
    - Error handling: invalid token (404), expired token (400), already activated (400)
  - [ ] Unit tests: mock OrganizationRepository, test activation flow

- [ ] Task 8: Create Bank Registration REST Controller (AC: 1, 2, 3, 9)
  - [ ] Create endpoint in AuthController: POST /api/auth/register-bank
    - Accept: BankRegistrationRequest (JSON)
    - Return: BankRegistrationResponse with HTTP 201 Created
    - Call BankRegistrationService.registerBank()
    - Send activation email (async) via BankActivationEmailService
    - Error handling:
      - 400 Bad Request: invalid email, weak password, invalid registration number format
      - 409 Conflict: duplicate registration number
      - 500 Internal Server Error: unexpected failures
    - Controller logs all bank registration attempts (bank name, IP, success/failure)
  - [ ] Use @Valid annotation on request parameter
  - [ ] Unit tests: mock BankRegistrationService, test success and error paths
  - [ ] Integration tests: real HTTP requests to /api/auth/register-bank

- [ ] Task 9: Implement Login Authorization Check (AC: 6)
  - [ ] **PREREQUISITE: Story 1.5 (JWT Authentication) must be completed first**
    - This task updates the login endpoint created in Story 1.5
    - Recommend scheduling: Complete Tasks 1-8 of Story 1.4, then Story 1.5, then Task 9
  - [ ] Create BankActiveValidator custom annotation (src/main/java/com/creditapp/auth/validation/BankActiveValidator.java)
    - Annotation: @BankMustBeActive
    - Used on endpoints that require bank to be ACTIVE (not PENDING_ACTIVATION)
    - Throws UnauthorizedException (401) if bank status != ACTIVE
  - [ ] Update login endpoint from Story 1.5 to check bank status
    - If user is BANK_ADMIN and bank status != ACTIVE, return 401 Unauthorized
    - Message: "Bank account not activated. Please check your email for activation link."
    - Integration: Verify with JwtAuthenticationFilter from Story 1.5 for role extraction

- [ ] Task 10: Add Input Validation Exception Handlers (AC: 9)
  - [ ] Create custom exception: DuplicateBankRegistrationException (extends RuntimeException)
  - [ ] Update GlobalExceptionHandler from Story 1.3
    - @ExceptionHandler for DuplicateBankRegistrationException  409 Conflict
    - @ExceptionHandler for InvalidActivationTokenException  400 Bad Request

- [ ] Task 11: Create Integration Tests (AC: 8, 9)
  - [ ] Create BankRegistrationIntegrationTest (src/test/java/com/creditapp/integration/auth/BankRegistrationIntegrationTest.java)
    - Test 1: Happy path - register valid bank, verify organization and admin user created
    - Test 2: Verify admin user assigned BANK_ADMIN role and linked to organization
    - Test 3: Duplicate registration number - register twice with same reg num, second returns 409
    - Test 4: Activate bank via email token - register, get token from email, call /api/auth/activate
    - Test 5: Verify bank status transitions PENDING_ACTIVATION  ACTIVE after activation
    - Test 6: Verify PENDING_ACTIVATION bank cannot login (return 401)
    - Test 7: Verify ACTIVE bank can login successfully (integration with Story 1.5)
    - Test 8: Invalid email format - register with malformed email, returns 400
    - Test 9: Soft delete test - bank cannot be deleted, deleted_at field prevents permanent removal
  - [ ] Use TestContainers for PostgreSQL, real HTTP client (TestRestTemplate)
  - [ ] Mock SendGrid email API

- [ ] Task 12: Create API Documentation (AC: 1, 8, 9)
  - [ ] Update docs/API_ENDPOINTS.md
    - POST /api/auth/register-bank
    - Request: { "bankName": "Example Bank", "registrationNumber": "BNK123456", "contactEmail": "admin@bank.com", "adminFirstName": "John", "adminLastName": "Doe", "adminPassword": "SecurePass123!", "adminPhone": "+373-012-345-67" }
    - Response (201): { "bankId": "550e8400-e29b-41d4-a716-446655440000", "bankName": "Example Bank", "adminUserId": "660e8400-e29b-41d4-a716-446655440001", "status": "PENDING_ACTIVATION", "message": "Bank registered. Activation email sent." }
    - Error responses: 400, 409
    - GET /api/auth/activate?token={activationToken}
    - Response (200): { "bankId": "...", "bankName": "...", "status": "ACTIVE", "message": "Bank activated successfully" }

## Dev Notes

### Previous Stories Dependencies
- **Story 1.2**: Database schema, Organization and User entities, repositories (REQUIRED FIRST)
- **Story 1.3**: Password validation, hashing, email service infrastructure, authentication patterns (REQUIRED BEFORE Task 6)
- **Story 1.5**: JWT Authentication endpoint (REQUIRED BEFORE Task 9)

### Story Execution Order
- **Sequential Dependency Chain:**
  1. Story 1.1 → Story 1.2 → Story 1.3 → Story 1.4 (Tasks 1-8)
  2. Story 1.5 (JWT Authentication)
  3. Story 1.4 (Task 9 - Bank status check in login)
  4. Story 1.6 (RBAC - uses all previous stories)
  5. Story 1.7 (Audit Logging - uses all previous stories)

- **Alternate (Parallel Opportunity):**
  - Tasks 1-8 of Story 1.4 can run in parallel with Story 1.5 (no code dependencies)
  - Task 9 must wait for Story 1.5 completion

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Security
- **Password Hashing**: BCrypt (salt factor 12) - reuse from Story 1.3
- **Email Service**: SendGrid (reuse from Story 1.3)
- **Async Email Pattern**: Spring Events + @Async (Decision 1, from Story 1.3)
  - See Task 6 for integration options (Option A: Events pattern, Option B: Direct @Async)
- **Token Generation**: SecureRandom for activation tokens
- **UUID**: Java UUID for IDs

### Database Schema Updates
[Source: architecture/2-detailed-service-architecture.md]
**Organizations table additions:**
`sql
ALTER TABLE organizations ADD COLUMN (
  status VARCHAR(20) DEFAULT 'PENDING_ACTIVATION',
  activation_token VARCHAR(255) UNIQUE,
  activation_token_expires_at TIMESTAMP,
  activated_at TIMESTAMP,
  deleted_at TIMESTAMP,
  CHECK (deleted_at IS NULL)  -- Soft delete constraint
);
`

### Bank Registration API Specification
[Source: architecture/2-detailed-service-architecture.md]
`
POST /api/auth/register-bank
Request:
{
  "bankName": "Example Bank",
  "registrationNumber": "BNK123456",
  "contactEmail": "admin@bank.com",
  "adminFirstName": "John",
  "adminLastName": "Doe",
  "adminPassword": "SecurePass123!",
  "adminPasswordConfirm": "SecurePass123!",
  "adminPhone": "+373-012-345-67"
}

Response (201 Created):
{
  "bankId": "550e8400-e29b-41d4-a716-446655440000",
  "bankName": "Example Bank",
  "adminUserId": "660e8400-e29b-41d4-a716-446655440001",
  "status": "PENDING_ACTIVATION",
  "message": "Bank registered successfully. Activation email sent to admin@bank.com"
}

GET /api/auth/activate?token={activationToken}
Response (200 OK):
{
  "bankId": "550e8400-e29b-41d4-a716-446655440000",
  "bankName": "Example Bank",
  "status": "ACTIVE",
  "message": "Bank activated successfully. You can now log in."
}
`

### Bank Status State Machine
[Source: Architecture and requirements]
`
PENDING_ACTIVATION  (activate token)  ACTIVE
      
   INACTIVE (if admin deactivates bank)
`
- Banks start in PENDING_ACTIVATION state
- Email link with activation token triggers transition to ACTIVE
- ACTIVE banks can access application queue and submit offers
- Soft delete: deleted_at timestamp prevents logical deletion

### Activation Token Management
[Source: Security best practice]
- **Token Format**: 32-character secure random alphanumeric string
- **Expiry**: 7 days from creation (configurable)
- **Validation**: Must match token in database and not be expired
- **One-time use**: Token nullified after successful activation (optional for MVP)

### Project Directory Structure
[Source: Story 1.1 context]
`
src/main/java/com/creditapp/
 auth/
    controller/        # AuthController.java (add registerBank, activate endpoints)
    service/           # BankRegistrationService.java
    dto/               # BankRegistrationRequest.java, BankRegistrationResponse.java, ActivationRequest.java
    model/             # (use Organization, User from previous stories)
    repository/        # (use OrganizationRepository from Story 1.2)
    validation/        # BankActiveValidator.java
    exception/         # DuplicateBankRegistrationException.java
 shared/
    model/             # Organization.java (update with status, activation fields)
    service/           # ActivationTokenService.java, BankActivationEmailService.java
    exception/         # InvalidActivationTokenException.java

src/test/java/com/creditapp/
 integration/
    auth/
      BankRegistrationIntegrationTest.java
`

### Key Dependencies
`xml
<!-- All dependencies already in previous stories -->
<!-- No new external dependencies required -->
`

### Testing Standards
[Source: frontend-architecture/10-testing-strategy.md]
- **Unit Tests**: Mock repositories and email service
- **Integration Tests**: Real database (TestContainers), real HTTP client
- **Test Location**: src/test/java/com/creditapp/unit/ (unit), src/test/java/com/creditapp/integration/ (integration)

### Security Constraints
[Source: architecture/4-security-architecture.md]
- Registration number must be unique at database level
- Admin password hashed with BCrypt (reuse from Story 1.3)
- Activation token must be secure random, not predictable
- Soft delete: deleted_at field prevents bank data loss for audit trail
- Bank status must be checked before allowing API access

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, TestContainers
- **HTTP Client**: TestRestTemplate
- **Mocking**: Mockito, WireMock for SendGrid
- **Test Location**: src/test/java/com/creditapp/unit/, src/test/java/com/creditapp/integration/

### Testing Checklist
- [ ] BankRegistrationService: creates organization and admin user, assigns correct role
- [ ] ActivationTokenService: generates and validates tokens correctly
- [ ] Bank activation endpoint: transitions status PENDING_ACTIVATION  ACTIVE
- [ ] Bank registration endpoint: POST /api/auth/register-bank succeeds, returns 201
- [ ] Duplicate registration number: rejected with 409 Conflict
- [ ] PENDING_ACTIVATION bank cannot login (401)
- [ ] ACTIVE bank can login (integration with Story 1.5)
- [ ] Email service: activation email sent correctly
- [ ] Soft delete: bank.deleted_at prevents logical deletion
- [ ] All tests pass with mvn clean test
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Bank Account Creation & Admin Registration | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
