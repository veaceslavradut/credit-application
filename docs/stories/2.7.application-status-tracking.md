# Story 2.7: Application Status Tracking

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to view my application status and see the history of status changes,
**so that** I understand where my application is in the underwriting process.

## Acceptance Criteria

1. GET /api/borrower/applications/{applicationId}/status returns current status with timeline
2. Response includes: current_status, submitted_at, status_history (array of transitions)
3. Status history shows: old_status, new_status, changed_at, changed_by (user or system), reason
4. Status timeline visual data: can be used for progress bar (DRAFT -> SUBMITTED -> UNDER_REVIEW -> OFFERS -> ACCEPTED -> COMPLETED)
5. Timestamps: all in UTC ISO-8601 format
6. Only borrower who owns the application can view status (403 Forbidden otherwise)
7. Real-time updates: status reflects current database state (no caching or delays)
8. Integration test: verify status timeline after application workflow progression

## Tasks / Subtasks

- [ ] Task 1: Create Status Timeline DTOs (AC: 2, 3, 4)
  - [ ] Create StatusTransitionDTO
    - Fields: oldStatus, newStatus, changedAt (timestamp), changedByUserId, changedByName, reason (reason for change)
  - [ ] Create ApplicationStatusDTO
    - Fields: applicationId, currentStatus, submittedAt, createdAt, status_history (List<StatusTransitionDTO>)
    - Include progression percentage (currentIndex / totalStates * 100)

- [ ] Task 2: Create Status Tracking Service (AC: 1, 3, 4)
  - [ ] Create ApplicationStatusTrackingService
    - Method: getApplicationStatus(UUID applicationId, UUID borrowerId) returns ApplicationStatusDTO
    - Verify borrower owns application (access control)
    - Fetch application and status
    - Fetch application history (ordered by changedAt DESC)
    - Build ApplicationStatusDTO with current status and timeline
    - Calculate progression percentage based on expected flow
    - Return ApplicationStatusDTO

  - [ ] Unit tests: mock repositories, test status calculations

- [ ] Task 3: Create Status Tracking REST Endpoint (AC: 1, 6, 7)
  - [ ] Add GET endpoint in BorrowerApplicationController
    - Endpoint: GET /api/borrower/applications/{applicationId}/status
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Call ApplicationStatusTrackingService.getApplicationStatus()
    - Return: ResponseEntity<ApplicationStatusDTO> with HTTP 200 OK
    - Response includes: current_status, timeline, progression_percentage
    - Error handling:
      - 403 Forbidden: not borrower
      - 404 Not Found: application doesn't exist

  - [ ] Unit tests: mock service

- [ ] Task 4: Create Integration Tests (AC: 1, 7, 8)
  - [ ] Create ApplicationStatusTrackingIntegrationTest
    - Setup: Create borrower, create application, progress through states
    - Test 1: New DRAFT application, verify status=DRAFT
    - Test 2: Submit application, verify status=SUBMITTED with submittedAt timestamp
    - Test 3: Verify status history empty for new app (only current state)
    - Test 4: After submission, verify status_history shows DRAFT->SUBMITTED transition
    - Test 5: Check progression percentage (e.g., 20% for SUBMITTED state)
    - Test 6: Different borrower GET status, verify 403 Forbidden
    - Test 7: Full workflow - create -> submit -> (simulate UNDER_REVIEW) -> verify timeline
    - Test 8: Verify timestamps are UTC ISO-8601 formatted

  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate

- [ ] Task 5: Create API Documentation (AC: 1)
  - [ ] Document GET /api/borrower/applications/{applicationId}/status
    - Response example with full status timeline
    - Include progression_percentage field
    - Explain status flow and timeline

## Dev Notes

### Previous Story Dependencies
- **Story 2.1**: ApplicationHistory entity and repository
- **Story 2.2-2.5**: Applications workflow creates status transitions

### Status Flow Timeline
`
DRAFT (0%) -> SUBMITTED (20%) -> UNDER_REVIEW (40%) -> OFFERS_AVAILABLE (60%) -> ACCEPTED (80%) -> COMPLETED (100%)
                              -> REJECTED (failed)
                                        
                           WITHDRAWN (cancelled)
`

## Testing Checklist
- [ ] Get status for DRAFT application
- [ ] Get status for SUBMITTED application
- [ ] Status history timeline populated correctly
- [ ] Progression percentage calculated correctly
- [ ] Timestamps in UTC ISO-8601 format
- [ ] Access control - different borrower gets 403
- [ ] Full workflow status progression
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - Application Status Tracking | Bob (Scrum Master) |
