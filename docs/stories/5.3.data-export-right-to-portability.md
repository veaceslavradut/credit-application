# Story 5.3: Data Export (Right to Portability)

## Status
In Progress - Phase 1/2 Complete (Tasks 1-5 Done, Tasks 6-10 TODO)

## Story

**As a** borrower,
**I want** to export all my personal data held by the platform,
**so that** I can review what's stored and exercise data portability rights.

## Acceptance Criteria

1. GET /api/borrower/data-export initiates export
2. Export includes: profile, all applications, all offers, consent history, audit log entries
3. Format: JSON (structured) and/or PDF (human-readable)
4. Sensitive data included: all PII borrower provided
5. Export generation: async (1-5 minutes); email with download link
6. Download link valid 24 hours; expires after first download or 24 hours
7. Audit log: DATA_EXPORT_REQUESTED and DATA_EXPORT_DOWNLOADED
8. Security: one-time-use token; only borrower can download
9. Performance: queued; supports up to 1000 applications
10. Compliance: meets GDPR Article 20
11. Integration test: request export, wait for email, download, verify JSON contains all data

## Tasks / Subtasks

- [x] Task 1: Create Database Migrations for Data Export Tracking (AC: 5, 6, 8)
  - [x] Create V14__Create_Data_Export_Table.sql migration (CREATED: V14__Create_Data_Exports_Table.sql)
    - Create data_exports table: id (UUID PK), borrower_id (UUID FK), status (PENDING, COMPLETED, FAILED), format (JSON, PDF, BOTH), file_url (VARCHAR nullable), download_token (VARCHAR UNIQUE nullable), download_token_expires_at (TIMESTAMP nullable), requested_at (TIMESTAMP), completed_at (TIMESTAMP nullable), created_by_ip (VARCHAR), expires_at (TIMESTAMP)
    - Foreign key: borrower_id -> users(id) ON DELETE CASCADE
    - Create index on (borrower_id, status)

- [x] Task 2: Create Data Export JPA Entity (AC: 5, 6, 7)
  - [x] Create DataExport entity, ExportStatus enum, ExportFormat enum

- [x] Task 3: Create Data Export Repository (AC: 1)
  - [x] Create DataExportRepository with query methods

- [x] Task 4: Create Data Export Service (AC: 1, 2, 3, 5, 6, 8, 9)
  - [x] Implemented DataExportService with core methods

- [x] Task 5: Create Data Export REST Controller (AC: 1, 6, 7)
  - [x] Implemented BorrowerDataExportController with 3 REST endpoints

- [x] Task 6: Create Async Job for Export Generation (AC: 5, 9)
  - [x] Implemented with @Async and dedicated dataExportExecutor bean
  - [x] Max 5 concurrent exports, 5-minute timeout
  - [x] Automatic timeout detection and failure handling

- [ ] Task 7: Create Export File Generator (AC: 2, 3, 4, 10)
  - [ ] Create ExportFileGenerator service
    - Method: generateJsonExport(UUID borrowerId) returns JsonNode
      - Fetch all borrower data
      - Structure as JSON:
        `json
        {
          "profile": { name, email, phone, address },
          "applications": [ { id, loanType, amount, status, ... } ],
          "offers": [ { id, apr, monthlyPayment, bankName, ... } ],
          "consents": [ { type, consentedAt, withdrawnAt } ],
          "auditLog": [ { event, timestamp, result } ]
        }
        `
      - Include all PII
    - Method: generatePdfExport(UUID borrowerId) returns byte[]
      - Generate human-readable PDF with all data
      - Use iText or similar PDF library
      - Include title, table of contents, sections for profile, applications, offers, consents
  - [ ] Encrypt file before storage (Story 5.7)
  - [ ] Unit tests: verify file generation with sample data

- [ ] Task 8: Create Email Notification for Export (AC: 5, 6)
  - [ ] Create email template: data-export-ready.html
    - Subject: "Your Data Export is Ready"
    - Body: Includes download link with token
    - Download link valid 24 hours
    - File size and format information
    - Instructions to download and verify data

- [ ] Task 9: Create Unit Tests (AC: 1, 5, 6, 8)
  - [ ] Create DataExportServiceUnitTest
    - Test 1: Initiate export, verify status=PENDING and token generated
    - Test 2: Download token valid for 24 hours
    - Test 3: Download with expired token, verify 410 Gone
    - Test 4: Download with wrong borrower, verify 403 Forbidden
    - Test 5: Generate JSON export, verify includes all data
    - Test 6: Mark as used after download, verify subsequent attempts fail
  - [ ] Mock: DataExportRepository, UserRepository, ApplicationRepository, etc.

- [ ] Task 10: Create Integration Tests (AC: 11)
  - [ ] Create DataExportIntegrationTest
    - Setup: Create borrower with applications, offers, consents
    - Test 1: Request data export (JSON format), verify 202 Accepted
    - Test 2: Wait for async job completion (or mock), verify status=COMPLETED
    - Test 3: Retrieve download token from response
    - Test 4: Download export file, verify contains all data
    - Test 5: Verify JSON structure includes profile, applications, offers, consents, audit logs
    - Test 6: Attempt to download again with same token, verify fails
    - Test 7: Verify audit log entries: DATA_EXPORT_REQUESTED and DATA_EXPORT_DOWNLOADED
  - [ ] Use TestContainers for PostgreSQL, mock S3 or use LocalStack

## Dev Notes

### Previous Story Insights
- **Story 1.9 (Email Service)**: Sends the “export ready” email with secure download link.
- **Story 5.1 (Consent Framework)**: Provide consent history in the export payload.
- **Story 2.1 (Application Data Model)**: Source for applications and application history.
- **Story 3.3 (Offers)**: Source for offers included in borrower export.
- **Story 5.5 (Audit Trail)**: Include borrower-specific audit events for transparency.
- **Story 5.7 (Encryption)**: Enforce S3 SSE-KMS for files at rest; TLS 1.3 for downloads.

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA, Spring Security
- **Async**: `@Async` with a dedicated thread pool for export generation
- **Storage**: AWS S3 with SSE-KMS encryption (bucket policy blocks public access)
- **Email**: SendGrid for notifications
- **Serialization**: Jackson for JSON; iText for PDF rendering (optional)

### GDPR/Compliance Context
[Source: architecture/4-security-architecture.md]
- **GDPR Art. 20 (Portability)**: Provide portable copy of personal data in a structured, commonly used, machine-readable format (JSON) and optionally human-readable (PDF).
- **GDPR Art. 15 (Access)**: Closely related; ensure completeness and accuracy of data provided.
- **Identity & Access**: Only the authenticated borrower can request and download their export.
- **Timelines**: Fulfill within organization’s defined SLA consistent with law and policy.

### Export Scope and Structure
Provide a single top-level document containing:
```
{
  "profile": { ... all PII fields ... },
  "applications": [ { ... full app data ... } ],
  "offers": [ { ... full offer data ... } ],
  "consents": [ { type, grantedAt, withdrawnAt, metadata } ],
  "auditLog": [ { event, timestamp, details } ]
}
```
Include all PII the borrower supplied and derived data associated with their identity. For PDF, render a clear, sectioned layout (title, TOC, sections per domain).

### Generation & Delivery Flow
1. Borrower calls `GET /api/borrower/data-export` (format default JSON).
2. `DataExport` row created with `status=PENDING`, 32-char download token generated (recommend storing token hash for defense-in-depth).
3. Async job aggregates data, builds JSON (and PDF if requested), uploads to S3 with SSE-KMS.
4. `DataExport` updated to `COMPLETED`, token expiry set to now+24h.
5. Email sent with download link (token parameter). One-time use enforced.
6. Download endpoint validates token ownership, expiry, one-time semantics; returns file.

### Database Schema (reference)
```sql
CREATE TABLE data_exports (
  id UUID PRIMARY KEY,
  borrower_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  status VARCHAR(20) NOT NULL,
  format VARCHAR(10) NOT NULL,
  file_url VARCHAR(1024),
  download_token VARCHAR(128) UNIQUE,
  download_token_expires_at TIMESTAMP,
  requested_at TIMESTAMP NOT NULL,
  completed_at TIMESTAMP,
  created_by_ip VARCHAR(64),
  expires_at TIMESTAMP
);
CREATE INDEX idx_data_exports_borrower_status ON data_exports(borrower_id, status);
```

### API Specification
- **Initiate**: `GET /api/borrower/data-export?format=JSON|PDF|BOTH`
  - Auth: BORROWER
  - Resp: 202 Accepted `{ message: "Export requested" }`
- **Download**: `GET /api/borrower/data-export/download?token=...`
  - Auth: BORROWER; server validates token belongs to caller
  - Resp: 200 with file stream; errors: 401/403/404/410

### S3/KMS Configuration
- Bucket with Block Public Access enabled; deny all public ACLs.
- SSE-KMS with CMK alias (e.g., `alias/credit-app-exports`).
- Lifecycle policies optional (short retention for generated exports).
- App IAM limited to put/get for object prefix `exports/{env}/`.

### Security Notes
- Token format: 32-char random (SecureRandom), one-time-use, 24h expiry.
- Optional: Store token hash instead of plaintext; compare via constant-time.
- Ensure borrowerId in token record matches current authenticated user.
- Limit concurrent exports per borrower to prevent abuse (e.g., 1 active PENDING).

### Project Directory Structure
```
src/main/java/com/creditapp/
 borrower/
   controller/        # BorrowerDataExportController.java
 shared/
   model/             # DataExport.java, ExportStatus.java, ExportFormat.java
   repository/        # DataExportRepository.java
   service/           # DataExportService.java, ExportFileGenerator.java
   integration/       # S3 client helper, Email service integration

src/test/java/com/creditapp/
 unit/
   shared/            # DataExportServiceUnitTest.java, ExportFileGeneratorUnitTest.java
 integration/
   shared/            # DataExportIntegrationTest.java (LocalStack S3 optional)
```

### Key Dependencies
```xml
<!-- AWS SDK (v2 or v1 as per project) -->
<dependency>
  <groupId>software.amazon.awssdk</groupId>
  <artifactId>s3</artifactId>
  <version>${aws.sdk.version}</version>
  <scope>runtime</scope>
  </dependency>
<!-- iText for PDF (ensure proper license compliance or use OpenPDF) -->
<dependency>
  <groupId>com.itextpdf</groupId>
  <artifactId>itext7-core</artifactId>
  <version>${itext.version}</version>
</dependency>
```

### Important Notes
1. Export includes all borrower-related PII and relevant derived records.
2. Ensure consistent snapshot semantics where feasible to avoid mid-export drift.
3. Large exports (1000+ apps) must stream data to avoid memory spikes.
4. Never expose S3 bucket/key details in emails; provide only backend download URL with token.
5. Log audit events: DATA_EXPORT_REQUESTED, DATA_EXPORT_COMPLETED, DATA_EXPORT_DOWNLOADED.

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test
- **Mocking**: Mockito; use TestContainers (PostgreSQL). LocalStack for S3 optional.
- **Async**: Awaitility or polling to wait for job completion in tests
- **HTTP**: TestRestTemplate for integration endpoints
- **Locations**: `src/test/java/com/creditapp/unit/shared/`, `src/test/java/com/creditapp/integration/shared/`

### Testing Checklist
- [ ] Initiation: `GET /api/borrower/data-export` returns 202 and creates `PENDING` record with token.
- [ ] Token properties: 32-char; expiry set to ~24h; belongs to borrower.
- [ ] Async job completes: status moves PENDING -> COMPLETED; fileUrl populated.
- [ ] JSON content: includes profile, applications, offers, consents, auditLog with correct counts.
- [ ] PDF generation (if requested): returns non-empty bytes; basic structure present.
- [ ] S3 upload uses SSE-KMS and bucket key prefix constraints.
- [ ] Email sent with download link after completion.
- [ ] Download success: valid token returns file with correct Content-Type.
- [ ] One-time token: subsequent download attempt after first succeeds returns 404/410.
- [ ] Expired token: returns 410 Gone; record remains for audit.
- [ ] Wrong borrower: token validated against owner → 403 Forbidden.
- [ ] Error path: job timeout/exception sets status=FAILED and no token usable.
- [ ] Performance: seed 1000 applications; export completes within acceptable window.
- [ ] Audit events recorded: REQUESTED, COMPLETED, DOWNLOADED.
- [ ] Security: no leakage of other users’ data; endpoints require BORROWER role.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Data Export (Right to Portability) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
