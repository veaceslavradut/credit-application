# Story 5.6: E-Signature Integration Readiness

## Status
Ready for Development

## Story

**As a** borrower,
**I want** infrastructure for e-signature prepared so Phase 2 can add document signing without rework,
**so that** future loan document execution is seamless.

## Acceptance Criteria

1. E-signature provider selected (DocuSign, HelloSign, or Moldovan-qualified)
2. Database schema: documents table (id, application_id, document_type, file_url, created_at, signed_at, signature_id)
3. Signature log table: document_id, signer_id, signed_at, ip_address, signature_certificate, signature_status
4. API endpoints stubbed: POST /api/borrower/documents/{documentId}/sign (returns 501 Not Implemented)
5. Consent type ESIGNATURE added to consent framework
6. Document retention: secure S3 bucket, 3+ years
7. Audit log integration: DOCUMENT_SIGNED prepared
8. Legal validation: provider verified as recognized in Moldova
9. Document templates prepared: placeholder agreements
10. Integration test: verify schema supports storage; verify API returns not implemented; verify consent includes ESIGNATURE

## Tasks / Subtasks

- [ ] Task 1: Create Database Migrations for E-Signature Support (AC: 2, 3, 6)
  - [ ] Create V15__Create_Documents_Table.sql migration
    - Create documents table: id (UUID PK), application_id (UUID FK), document_type (VARCHAR), file_url (VARCHAR), document_name (VARCHAR), created_at (TIMESTAMP), uploaded_by (UUID nullable), created_by_ip (VARCHAR)
    - Foreign key: application_id -> applications(id) ON DELETE CASCADE
    - Foreign key: uploaded_by -> users(id) ON DELETE SET NULL
    - Create index on (application_id, document_type)
  - [ ] Create V16__Create_Signature_Log_Table.sql migration
    - Create signature_logs table: id (UUID PK), document_id (UUID FK), signer_id (UUID FK), signed_at (TIMESTAMP nullable), ip_address (VARCHAR), signature_certificate (TEXT nullable), signature_status (VARCHAR: PENDING, SIGNED, REJECTED, EXPIRED), signature_id_external (VARCHAR), created_at (TIMESTAMP)
    - Foreign key: document_id -> documents(id) ON DELETE CASCADE
    - Foreign key: signer_id -> users(id) ON DELETE SET NULL
    - Create index on (document_id, signature_status)

- [ ] Task 2: Create Document JPA Entities (AC: 2, 3, 6)
  - [ ] Create Document entity (src/main/java/com/creditapp/shared/model/Document.java)
    - Fields: id (UUID), applicationId (UUID), documentType (DocumentType enum), fileUrl (String), documentName (String), createdAt (LocalDateTime), uploadedBy (UUID nullable), createdByIp (String)
    - @Entity, @Table(name="documents")
    - @Enumerated for documentType
  - [ ] Create DocumentType enum: LOAN_AGREEMENT, OFFER_LETTER, TERMS_CONDITIONS, PRIVACY_POLICY, CONSENT_FORM, OTHER
  - [ ] Create SignatureLog entity (src/main/java/com/creditapp/shared/model/SignatureLog.java)
    - Fields: id (UUID), documentId (UUID), signerId (UUID), signedAt (LocalDateTime nullable), ipAddress (String), signatureCertificate (String nullable), signatureStatus (SignatureStatus enum), signatureIdExternal (String), createdAt (LocalDateTime)
    - @Entity, @Table(name="signature_logs")
    - @Enumerated for signatureStatus
  - [ ] Create SignatureStatus enum: PENDING, SIGNED, REJECTED, EXPIRED

- [ ] Task 3: Create Document & Signature Repositories (AC: 2, 3)
  - [ ] Create DocumentRepository (src/main/java/com/creditapp/shared/repository/DocumentRepository.java)
    - Extends JpaRepository<Document, UUID>
    - Method: findByApplicationId(UUID applicationId) returns List<Document>
    - Method: findByApplicationIdAndDocumentType(UUID applicationId, DocumentType type) returns List<Document>
  - [ ] Create SignatureLogRepository (src/main/java/com/creditapp/shared/repository/SignatureLogRepository.java)
    - Extends JpaRepository<SignatureLog, UUID>
    - Method: findByDocumentId(UUID documentId) returns List<SignatureLog>
    - Method: findByDocumentIdAndSignatureStatus(UUID documentId, SignatureStatus status) returns List<SignatureLog>

- [ ] Task 4: Select E-Signature Provider (AC: 1, 8, 9)
  - [ ] Research providers:
    - DocuSign: Enterprise-grade, supports EU/GDPR compliance
    - HelloSign (Dropbox Sign): Mid-market friendly, good API
    - LuxTrust: Moldovan-qualified e-signature service
  - [ ] Document selection decision:
    - Provider: [Selected provider]
    - Rationale: compliance, cost, API quality
    - Verification: provider has EU/Moldovan law recognition
  - [ ] Create provider config: store API credentials in environment variables
  - [ ] Document in README or config guide

- [ ] Task 5: Create E-Signature Service (Stubbed) (AC: 4, 7)
  - [ ] Create ESignatureService (src/main/java/com/creditapp/shared/service/ESignatureService.java)
    - Method: sendDocumentForSignature(UUID documentId, UUID signerId, String email) returns SignatureLog
      - Validate document exists
      - Create SignatureLog with status=PENDING
      - Call external provider API (stubbed for Phase 1)
      - Store signature_id_external
      - Log DOCUMENT_SENT_FOR_SIGNATURE audit event
      - Return SignatureLog
    - Method: checkSignatureStatus(UUID signatureLogId) returns SignatureStatus
      - Call external provider API to check status
      - Update SignatureLog with latest status
      - Return status
    - Method: getSignedDocument(UUID documentId) returns byte[] or URL
      - Retrieve signed document from provider or S3
      - Return document content
  - [ ] Stub implementation: methods throw 501 Not Implemented or return placeholder responses
  - [ ] Unit tests: mock external provider calls

- [ ] Task 6: Create Document REST Controller (AC: 4)
  - [ ] Create DocumentController (src/main/java/com/creditapp/borrower/controller/DocumentController.java)
    - GET /api/borrower/applications/{applicationId}/documents
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Return list of documents for application
    - POST /api/borrower/documents/{documentId}/sign
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Return 501 Not Implemented (Phase 2)
      - Response: { "error": "E-signature not yet available", "message": "Coming soon in Phase 2" }
    - GET /api/borrower/documents/{documentId}/signature-status
      - @PreAuthorize("hasAuthority('BORROWER')")
      - Return current signature status (PENDING, SIGNED, REJECTED, EXPIRED)
  - [ ] Unit tests: mock service, test endpoints

- [ ] Task 7: Add ESIGNATURE to Consent Framework (AC: 5)
  - [ ] Update ConsentType enum (from Story 5.1) to include ESIGNATURE
    - ConsentType: DATA_COLLECTION, BANK_SHARING, MARKETING, ESIGNATURE
  - [ ] Add consent requirement for document signing (Phase 2):
    - Before signing document, verify ESIGNATURE consent granted
  - [ ] Update Story 5.1 tests to include ESIGNATURE consent

- [ ] Task 8: Create Document Upload Service (AC: 6)
  - [ ] Create DocumentUploadService
    - Method: uploadDocumentToS3(File file, UUID applicationId, DocumentType type, UUID uploadedBy) returns Document
      - Validate file (PDF only for Phase 1)
      - Generate S3 key: applications/{applicationId}/{documentType}/{timestamp}_{filename}
      - Upload to S3 with encryption (Story 5.7)
      - Create Document entity with fileUrl=S3_URL
      - Set retention: S3 lifecycle rule for 3+ years (Glacier after 1 year)
      - Return Document
  - [ ] Add configuration: app.s3.documents-bucket, app.documents.retention.years=3
  - [ ] Unit tests: mock S3 client

- [ ] Task 9: Create Document Templates (AC: 9)
  - [ ] Prepare placeholder document templates (as resources or in docs folder)
    - LOAN_AGREEMENT: Standard terms template (to be filled in by bank)
    - OFFER_LETTER: Preliminary offer document template
    - CONSENT_FORM: Consent/authorization form
  - [ ] Store as templates in S3 or docs folder
  - [ ] Document: how banks/admins can customize templates (Phase 2)

- [ ] Task 10: Create Unit Tests (AC: 2, 3, 10)
  - [ ] Create DocumentEntityUnitTest
    - Test 1: Create document, verify persisted
    - Test 2: Create signature log, verify PENDING status
    - Test 3: Query documents by application_id
    - Test 4: Query signature logs by status
    - Test 5: Verify document retention policy supports 3+ years
  - [ ] Mock: DocumentRepository, SignatureLogRepository

- [ ] Task 11: Create Integration Tests (AC: 10)
  - [ ] Create ESignatureReadinessIntegrationTest
    - Setup: Create application and document
    - Test 1: Create document, verify persisted
    - Test 2: POST /api/borrower/documents/{id}/sign, verify returns 501 Not Implemented
    - Test 3: Verify ESIGNATURE consent type available
    - Test 4: Verify signature log created with PENDING status
    - Test 5: Verify S3 storage configured and document URL points to S3
    - Test 6: Verify document retention 3+ years configured
  - [ ] Use TestContainers for PostgreSQL, LocalStack for S3 (optional)

  ## Dev Notes

  ### Previous Stories Dependencies
  - Story 5.1 (Consent Management): add `ESIGNATURE` consent type and enforce prior to signing.
  - Story 5.7 (Encryption): S3 buckets must use SSE-KMS and TLS 1.3 for all e-signature document transfers.
  - Story 5.5 (Audit Trail): log `DOCUMENT_SENT_FOR_SIGNATURE`, `DOCUMENT_SIGNED`, `DOCUMENT_SIGNATURE_EXPIRED/REJECTED` immutably; redact PII in logs.
  - Story 1.9 (Email Service): provider invitations/notifications may be sent via email; ensure async delivery.
  - Story 1.6 (RBAC): borrowers access only their documents; bank admins access their organization’s templates and documents.
  - Story 2.1 (Applications): `documents.application_id` references borrower application lifecycle and retention.

  ### GDPR/Compliance Context
  - GDPR Article 32: secure processing for documents and signatures.
  - Moldovan qualified e-signature recognition: ensure selected provider is legally recognized; retain signature evidence and certificate chain.
  - Retention: signed documents retained ≥ 3 years with lifecycle policies (e.g., Glacier after 1 year) and encryption at rest.

  ### Provider Selection Criteria
  - Legal recognition (EU/Moldova), API maturity (webhooks, embedded signing, templates), auditability, pricing, data residency controls, and KMS compatibility.
  - Candidate examples: DocuSign, Dropbox Sign, LuxTrust (qualified).

  ### Architecture & Flow (Phase 1: stubbed)
  - Document storage in S3 with SSE-KMS; metadata in `documents` table.
  - Create `SignatureLog` entries for each signing session.
  - Stub `ESignatureService` to 501 for send/status retrieval; real integration deferred to Phase 2.
  - Webhook endpoint scaffolded (disabled/501) for provider callbacks; capture payload signature verification design.

  ### Security Notes
  - Sign URLs and webhooks validated via HMAC/RSA provider secrets.
  - All tokens/credentials stored in secrets manager; never in logs.
  - Ensure `@PreAuthorize` and ownership checks on document endpoints.

  ### Project Directory Structure
  ```
  src/main/java/com/creditapp/
   borrower/
     controller/          # DocumentController.java
   shared/
     model/               # Document.java, SignatureLog.java, enums
     repository/          # DocumentRepository.java, SignatureLogRepository.java
     service/             # ESignatureService.java (stub), DocumentUploadService.java
     webhook/             # ProviderWebhookController.java (stub 501)
  ```

  ### Key Dependencies
  - Story 5.1 (consents), 5.5 (audit), 5.7 (encryption), 1.6 (RBAC), 2.1 (applications), 1.9 (email).

  ## Testing

  ### Testing Framework & Location
  - Framework: JUnit 5, Spring Boot Test, Mockito.
  - Integration: TestContainers (PostgreSQL), LocalStack (S3) optional.
  - Location: src/test/java/com/creditapp/ mirroring main packages.

  ### Testing Checklist
  - Schema & Entities
    - [ ] Flyway migrations for `documents` and `signature_logs` create tables and indexes.
    - [ ] JPA entities persist/retrieve; enums map correctly.
  - Controller & Stubs
    - [ ] POST /api/borrower/documents/{id}/sign returns 501 with stable error payload.
    - [ ] GET signature-status reflects `SignatureLog` state.
    - [ ] Webhook endpoint (stub) protected and returns 501.
  - Consent & RBAC
    - [ ] `ESIGNATURE` consent exists in ConsentType and is required prior to signing.
    - [ ] Borrower can access only own documents; bank admin access restricted to their org.
  - Storage & Security
    - [ ] DocumentUploadService writes S3 URL; upload mocked; KMS encryption flags present.
    - [ ] No sensitive tokens in logs; credentials from env/secrets.
  - Audit & Retention
    - [ ] Audit events emitted for send/status transitions (stubbed).
    - [ ] S3 lifecycle configuration documented; ≥ 3-year retention expectation validated.
  - CI & Coverage
    - [ ] All tests pass with `mvn clean test`; coverage ≥ 80%.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - E-Signature Integration Readiness | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
