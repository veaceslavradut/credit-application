# Story 4.9: Offer Decline & Withdrawal

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to decline applications or withdraw submitted offers,
**so that** I can manage rejected applicants and retract offers before borrower acceptance.

## Acceptance Criteria

1. POST /api/bank/applications/{applicationId}/decline declines application with optional reason
2. Only allow decline before offer submitted (application status < OFFER_SUBMITTED)
3. Decline reason field (optional, max 500 chars): "Credit score too low", "Income verification failed", "Employment risk", "Other"
4. Send email to borrower: "Your application with {bank_name} has been declined. Reason: {reason_or_generic_message}"
5. DELETE /api/bank/offers/{offerId}/withdraw withdraws submitted offer (before borrower accepts)
6. Prevent withdrawal of accepted offers (status=ACCEPTED)
7. Send email to borrower: "The offer from {bank_name} has been withdrawn"
8. Audit log: APPLICATION_DECLINED or OFFER_WITHDRAWN with details
9. Update application status: DECLINED
10. Update offer status: WITHDRAWN

## Tasks / Subtasks

- [ ] Task 1: Create Decline/Withdrawal DTOs
  - [ ] Create DeclineApplicationRequest (reason?: string, maxLength: 500)
  - [ ] Create DeclineApplicationResponse (applicationId, status: DECLINED, declinedAt, reason)
  - [ ] Create WithdrawOfferResponse (offerId, status: WITHDRAWN, withdrawnAt)

- [ ] Task 2: Create Application Decline Service
  - [ ] Create BankApplicationDeclineService
    - Method: declineApplication(UUID bankId, UUID applicationId, DeclineApplicationRequest request)
      - Fetch Application by ID
      - Verify application status < OFFER_SUBMITTED (AC2)
      - Verify bank has right to decline (offer exists from bankId)
      - Update application status = DECLINED
      - Save decline reason (create or update ApplicationDecline entity)
      - Create audit log: APPLICATION_DECLINED
      - Queue email notification (see Task 4)
      - Return DeclineApplicationResponse

- [ ] Task 3: Create Offer Withdrawal Service
  - [ ] Create BankOfferWithdrawalService
    - Method: withdrawOffer(UUID bankId, UUID offerId)
      - Fetch Offer by ID
      - Verify bank submitted this offer (bankId matches)
      - Verify offer status != ACCEPTED (AC6)
      - Update offer status = WITHDRAWN
      - Create audit log: OFFER_WITHDRAWN
      - Queue email notification (see Task 5)
      - Return WithdrawOfferResponse

- [ ] Task 4: Application Decline Email
  - [ ] Create email template: application-declined.html
    - Subject: "Application Status Update - {bank_name}"
    - Body: Application has been declined
    - Reason section (if provided): "Reason: {reason}"
    - Generic message (if no reason): "Thank you for applying. Unfortunately, we are unable to approve at this time."
    - Suggest next steps or reapply encouragement

- [ ] Task 5: Offer Withdrawal Email
  - [ ] Create email template: offer-withdrawn.html
    - Subject: "Offer Update - {bank_name}"
    - Body: Offer has been withdrawn
    - Reason (optional): Generic message or specific reason
    - Suggest next steps or contact bank message

- [ ] Task 6: Create Decline Controller
  - [ ] Create BankApplicationDeclineController
    - POST /api/bank/applications/{applicationId}/decline
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Body: DeclineApplicationRequest
      - Extract bankId from SecurityContext
      - Call ApplicationDeclineService.declineApplication()
      - Return DeclineApplicationResponse with 200 OK
      - Handle errors: application not found (404), invalid state (400)

- [ ] Task 7: Create Withdrawal Controller
  - [ ] Create BankOfferWithdrawalController
    - DELETE /api/bank/offers/{offerId}/withdraw
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Extract bankId from SecurityContext
      - Call OfferWithdrawalService.withdrawOffer()
      - Return WithdrawOfferResponse with 200 OK
      - Handle errors: offer not found (404), already accepted (400), unauthorized (403)

- [ ] Task 8: Application Decline Validation
  - [ ] Validate reason length: max 500 characters
  - [ ] Validate application exists and belongs to authorized bank
  - [ ] Validate application status allows decline (<OFFER_SUBMITTED)
  - [ ] Reject decline if application already DECLINED, ACCEPTED, or WITHDRAWN

- [ ] Task 9: Unit Tests
  - [ ] Test decline application with valid state
  - [ ] Test decline rejection when status > OFFER_SUBMITTED
  - [ ] Test decline with and without reason
  - [ ] Test withdraw offer with valid state
  - [ ] Test withdraw rejection when offer ACCEPTED
  - [ ] Test email queue on decline and withdrawal
  - [ ] Test audit log creation

- [ ] Task 10: Integration Tests
  - [ ] Create application, decline before offer submitted
  - [ ] Verify email sent with reason
  - [ ] Verify audit log created
  - [ ] Create offer, withdraw before acceptance
  - [ ] Verify withdrawal email sent
  - [ ] Test rejection: attempt to decline application with pending offer (should fail)
  - [ ] Test rejection: attempt to withdraw accepted offer (should fail)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Decline & Withdrawal | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
