# Story 5.9: Consumer Protection & Transparent Disclosures

## Status
Ready for Development

## Story

**As a** borrower,
**I want** clear, transparent disclosures of loan costs (APR, fees, total cost) and my rights,
**so that** I can make informed borrowing decisions without hidden fees.

## Acceptance Criteria

1. All offers display APR prominently (font size  14pt, bold)
2. Standardized comparison metrics include: APR, monthly payment, total cost, all fees
3. No hidden fees: all costs disclosed upfront
4. Effective APR calculated: includes all fees
5. Tooltip explains each fee
6. Borrower rights section in privacy policy: right to compare, withdraw, data access/deletion
7. Preliminary offer disclaimer: Offers are preliminary estimates. Final terms subject to review.
8. Bank contact info: each offer includes customer service email/phone
9. Comparison table includes Total Cost of Credit column
10. Moldovan consumer protection law compliance: all disclosures meet NBM/CNPF requirements
11. Integration test: view offers, verify APR prominent; verify total cost correct; verify disclaimers present

## Tasks / Subtasks

- [ ] Task 1: Create Offer Disclosure DTO (AC: 1, 2, 3, 4, 5)
  - [ ] Create OfferDisclosureResponse DTO (extends OfferDTO from Story 3.4)
    - Fields: id, bankName, bankContactEmail, bankContactPhone
    - APR fields: apr (BigDecimal), aprDisplayFormat (String, "8.5%"), aprExplanation (String: "includes origination fee")
    - Fee fields:
      - originationFee (BigDecimal amount + percentage)
      - insuranceFee (BigDecimal amount + percentage)
      - otherFees (List<FeeDetails>)
      - totalFees (BigDecimal)
    - Cost fields:
      - monthlyPayment (BigDecimal), monthlyPaymentFormatted (String, "250.50")
      - totalPaymentAmount (BigDecimal)
      - totalInterestCost (BigDecimal)
      - effectiveApr (BigDecimal, includes all fees)
      - totalCostOfCredit (BigDecimal: principal + all costs)
    - Disclaimers:
      - preliminaryOfferDisclaimer (String: "This is a preliminary estimate...")
      - termsAndConditionsLink (String: URL)
      - reviewProcessExplanation (String: explains final offer process)
    - Borrower rights section: rightToCompare (boolean=true), rightToWithdraw (boolean=true), rightToDataAccess (boolean=true)
  - [ ] Create FeeDetails DTO
    - Fields: feeType (String), amount (BigDecimal), percentage (BigDecimal), description

- [ ] Task 2: Create Fee Disclosure Service (AC: 2, 3, 4, 5)
  - [ ] Create FeeDisclosureService
    - Method: calculateTotalCostOfCredit(UUID offerId) returns BigDecimal
      - Fetch offer with APR, origination fee, insurance fee
      - Calculate: totalPayment = loanAmount + (monthly_payment * months)
      - Calculate: totalFees = all fees
      - Calculate: totalCostOfCredit = totalFees + totalInterest
      - Return totalCostOfCredit
    - Method: calculateEffectiveApr(UUID offerId) returns BigDecimal
      - Calculate effective APR including all fees
      - Formula: effective_apr = total_cost / principal / years (approximation)
      - More precise: use IRR (internal rate of return) calculation with all costs
      - Return as percentage (8.5 for 8.5%)
    - Method: generateFeeExplanations(UUID offerId) returns Map<String, String>
      - Generate human-readable explanations for each fee
      - Origination fee: "One-time upfront fee charged by the bank"
      - Insurance: "Optional insurance protecting against payment default"
      - Return map for tooltip display
  - [ ] Unit tests: mock offer data, verify calculations

- [ ] Task 3: Create Offer Comparison Table (AC: 2, 9)
  - [ ] Create ComparisonTableDTO
    - Array of offers (max 3-5 for display clarity)
    - Columns: Bank Name, APR, Monthly Payment, Origination Fee, Insurance, Total Cost, Bank Contact
    - Data: comparable metrics for side-by-side comparison
  - [ ] Create ComparisonTableService
    - Method: generateComparisonTable(List<UUID> offerIds) returns ComparisonTableDTO
      - Fetch offers and calculate all disclosure metrics
      - Sort by APR (lowest to highest) or by total cost
      - Return comparison table data
  - [ ] Unit tests: mock offer data, verify column calculations

- [ ] Task 4: Add Disclosure to Offer API Response (AC: 1, 2, 3, 6, 7, 8)
  - [ ] Update Offer API endpoints from Story 3.4 to include disclosure data
    - GET /api/borrower/offers: include full disclosure for each offer
    - GET /api/borrower/offers/{offerId}: include full disclosure
    - Include APR prominently in response structure
    - Include all disclaimers and borrower rights section
  - [ ] Frontend: ensure APR displayed in 14pt bold font (CSS/design requirement, documented)

- [ ] Task 5: Create Borrower Rights in Privacy Policy (AC: 6)
  - [ ] Update Privacy Policy (Story 5.2) to include Borrower Rights section
    - Right to Compare: "You can view offers from multiple banks side-by-side"
    - Right to Withdraw: "You can withdraw your application or decline an offer at any time"
    - Right to Data Access: "You can export all your data held by the platform (Story 5.3)"
    - Right to Deletion: "You can request deletion of your data (Story 5.4)"
    - Right to Explanation: "You can request explanation of any calculation or decision"
  - [ ] Link to specific API endpoints for data access/deletion
  - [ ] Include contact email for questions/disputes

- [ ] Task 6: Create Disclaimers & Notices (AC: 7, 8)
  - [ ] Preliminary Offer Disclaimer:
    - "This is a preliminary estimate of loan terms. Final terms and conditions will be determined after our review of your complete application and documentation. The APR and other terms may vary based on credit decisions and rate changes."
  - [ ] Bank Contact Notice:
    - "If you have questions about this offer, contact {bank_name}:"
    - "Email: {bank_email}"
    - "Phone: {bank_phone}"
  - [ ] Consumer Protection Notice (Moldovan NBM/CNPF requirement):
    - "As a consumer, you have rights to: compare loan offers, withdraw from the application process, access your personal data, and dispute unfair terms. For more information, contact the National Bank of Moldova or Consumer Protection Agency."

- [ ] Task 7: Create Offer Comparison API Endpoint (AC: 2, 9)
  - [ ] Create BorrowerOfferComparisonController
    - GET /api/borrower/offers/comparison
      - Query parameter: selectedOfferIds (array of offer UUIDs)
      - Call ComparisonTableService.generateComparisonTable()

## Dev Notes

### Previous Story Insights
- **Story 3.4**: OfferDTO foundation - extended with disclosure fields (APR, fees, total cost)
- **Story 4.4**: Offer submission form - displays disclosures and collects borrower acceptance
- **Story 2.5**: Application submission - verifies borrower reviewed and accepted disclosures
- **Story 5.2**: Privacy policy - links to consumer rights section
- **Story 5.1**: Consent management - borrower must consent to transparent terms

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA
- **Frontend**: React components for offer display (if applicable)
- **Calculations**: BigDecimal for precise APR and cost calculations
- **Formatting**: NumberFormat for currency display (EUR, MDL)
- **Security**: Spring Security with @PreAuthorize for offer access
- **Validation**: Custom validators for disclosure completeness

### Consumer Protection Context
[Source: architecture/8-compliance-regulatory.md]
**GDPR Articles Referenced:**
- **Article 6/7**: Consent for processing (borrower must view and accept disclosures)
- **Article 13**: Transparency information (complete cost disclosure)

**Moldovan/EU Consumer Law References:**
- **Consumer Rights Directive 2011/83/EU**: Pre-contractual information requirements
- **DIRECTIVE 2016/97/EU (Insurance Distribution)**: Applicability to loan insurance
- **NBM Guidelines**: APR calculation methodology for Moldovan market
- **CNPF Requirements**: Consumer protection standards for financial services

**Key Requirements:**
- APR prominent: font size 14pt, bold, before any secondary information
- Standardized metrics: APR, monthly payment, total cost, all fees
- No hidden fees: all fees disclosed upfront with explanation
- Effective APR: includes origination, insurance, payment processing fees
- Fee tooltips: each fee has explanation available on hover
- Borrower rights section: linked from offer and privacy policy
- Preliminary disclaimer: offers are estimates, final terms subject to review
- Bank contact: customer service email and phone on every offer
- Comparison table: Total Cost of Credit column mandatory
- Moldovan compliance: all disclosures meet NBM/CNPF requirements

### Project Directory Structure
```
src/main/java/com/creditapp/
  borrower/
    dto/
      - OfferDisclosureResponse.java (extends OfferDTO)
      - FeeBreakdownDTO.java
      - ComparisonTableDTO.java
    service/
      - DisclosureCalculationService.java (APR, effective APR, total cost)
      - ComparisonTableService.java
      - ConsumerRightsService.java
    validator/
      - DisclosureCompletionValidator.java
      - APRValidator.java (verifies Moldovan requirements)
  shared/
    config/
      - DisclosureFormatConfig.java (14pt font, bold, currency formatting)
frontend/
  components/
    - OfferDisclosure.jsx (display offer with fees)
    - ComparisonTable.jsx
    - FeesTooltip.jsx
    - ConsumerRightsPanel.jsx
```

### Key Dependencies
```xml
<!-- BigDecimal already in Java core for precise calculations -->
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<!-- Validation -->
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-validation</artifactId>
</dependency>
<!-- JSON formatting for fee display -->
<dependency>
  <groupId>com.fasterxml.jackson.core</groupId>
  <artifactId>jackson-databind</artifactId>
</dependency>
```

### Architecture References
- [Compliance & Regulatory Architecture](architecture/8-compliance-regulatory.md#consumer-protection) - Consumer protection framework
- [Offer Data Model](../../STORY_3.4_COMPLETION_SUMMARY.md) - OfferDTO structure reference
- [API Endpoints](API_ENDPOINTS.md#offer-disclosure-endpoints) - Offer disclosure endpoints

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5 (Jupiter) + Spring Boot Test
- **Mocking**: Mockito for unit tests, testfx for UI component testing
- **Integration Testing**: TestContainers (PostgreSQL) for database tests
- **HTTP Testing**: TestRestTemplate for REST API integration tests
- **Test Location**: `src/test/java/com/creditapp/`
  - Unit tests: `src/test/java/com/creditapp/unit/borrower/DisclosureCalculationServiceTest.java`
  - Integration tests: `src/test/java/com/creditapp/integration/borrower/ConsumerProtectionIntegrationTest.java`
- **Code Coverage Target**: >85% for disclosure calculation (financial accuracy critical)
- **Performance Target**: Disclosure rendering <200ms, APR calculation <50ms

### Testing Checklist

**Unit Tests (DisclosureCalculationServiceTest.java)**
- [x] Calculate effective APR including all fees, verify formula correct
- [x] Calculate monthly payment from APR and principal, verify precision (BigDecimal)
- [x] Calculate total cost (monthly payment × months), verify accuracy
- [x] Include origination fee in effective APR, verify recalculated
- [x] Include insurance fee in effective APR, verify included
- [x] Include payment processing fee in effective APR, verify included
- [x] Verify no fees hidden from total cost
- [x] Format APR as percentage with 2 decimals
- [x] Format currency as EUR/MDL with separator, verify locale
- [x] Validate APR >= 0%, verify non-negative
- [x] Validate monthly payment > 0, verify positive
- [x] Validator rejects disclosure missing APR
- [x] Validator rejects disclosure missing monthly payment
- [x] Validator rejects disclosure missing total cost
- [x] Validator rejects missing bank contact email
- [x] Validator rejects missing bank contact phone

**Integration Tests (ConsumerProtectionIntegrationTest.java)**
- [x] GET /api/borrower/offers/{id}/disclosure, verify 200 OK with all fields
- [x] Offer disclosure includes APR field
- [x] Offer disclosure includes monthly payment field
- [x] Offer disclosure includes total cost field
- [x] Offer disclosure includes all fees (origination, insurance, processing)
- [x] Offer disclosure includes fee breakdown (each fee with amount and explanation)
- [x] Offer disclosure includes preliminary disclaimer text
- [x] Offer disclosure includes "This is a preliminary estimate" disclaimer
- [x] Offer disclosure includes bank customer service contact info
- [x] Offer disclosure includes link to consumer rights section
- [x] Offer disclosure includes link to privacy policy
- [x] APR displayed in 14pt font size equivalent (UI validation)
- [x] APR displayed in bold font (UI validation)
- [x] APR appears before secondary information in DOM (UI validation)
- [x] GET /api/borrower/offers/comparison with 2+ offers, verify comparison table
- [x] Comparison table includes APR column for all offers
- [x] Comparison table includes monthly payment column
- [x] Comparison table includes Total Cost of Credit column (mandatory)
- [x] Comparison table includes all fees for each offer
- [x] Borrower cannot submit application without viewing disclosure (acceptance flag)
- [x] Borrower acceptance of disclosure logged in audit trail
- [x] Moldovan NBM compliance: APR calculation meets standard formula
- [x] CNPF compliance: all required consumer rights disclosed
- [x] Fee tooltip explains origination fee purpose
- [x] Fee tooltip explains insurance fee coverage
- [x] Fee tooltip explains payment processing fee
- [x] Disclaimer text includes: "final terms subject to review"
- [x] Bank contact email format validated
- [x] Bank contact phone format validated for Moldovan numbers
- [x] Unauthenticated request to disclosure, verify 401 Unauthorized
- [x] Borrower can only access their own offers' disclosures
- [x] Disclosure retrieval performance <200ms
- [x] Comparison table generation performance <150ms for 10 offers
- [x] BigDecimal calculations verified for financial accuracy (no floating point errors)
- [x] All consumer rights referenced in privacy policy

## QA Results

*To be completed by QA agent after story is implemented*
      - Return ComparisonTableDTO with all disclosure metrics for comparison
      - permitAll or @PreAuthorize("hasAuthority('BORROWER')")
  - [ ] Unit tests: mock service, test endpoint
  - [ ] Integration tests: real HTTP requests

- [ ] Task 8: Create Disclosure Validation (AC: 1, 2, 3, 10)
  - [ ] Create OfferDisclosureValidator
    - Method: validateDisclosures(Offer offer) returns List<ValidationError>
      - Verify APR is present and not NULL
      - Verify all fees are disclosed (origination, insurance)
      - Verify total cost is calculated
      - Verify monthly payment is correct
      - Verify effective APR is calculated
      - Verify disclaimers present
      - Return list of validation errors (empty if all valid)
  - [ ] Apply validation on offer creation (Story 4.4) and retrieval endpoints
  - [ ] Throw IncompleteOfferDisclosureException if validation fails

- [ ] Task 9: Create Unit Tests (AC: 1, 2, 3, 4, 9)
  - [ ] Create OfferDisclosureUnitTest
    - Test 1: Calculate total cost of credit, verify includes all fees + interest
    - Test 2: Calculate effective APR, verify includes all fees
    - Test 3: Generate fee explanations, verify human-readable
    - Test 4: Create comparison table, verify columns correct and sorted
    - Test 5: Validate offer disclosures, verify all required fields present
    - Test 6: Verify APR formatting: e.g., "8.5%"
    - Test 7: Verify total cost formatted with currency: "3,250.50"
  - [ ] Mock: OfferRepository, BankRateCardRepository

- [ ] Task 10: Create Integration Tests (AC: 11)
  - [ ] Create OfferDisclosureIntegrationTest
    - Setup: Create application, generate offers from multiple banks
    - Test 1: GET offer, verify APR prominently displayed
    - Test 2: GET offer, verify all fees disclosed
    - Test 3: GET offer, verify total cost calculated and displayed
    - Test 4: GET offer, verify preliminary offer disclaimer present
    - Test 5: GET offer, verify bank contact info included
    - Test 6: GET offer, verify borrower rights section present
    - Test 7: GET comparison table, verify all 3+ offers compared
    - Test 8: Verify comparison table columns: APR, monthly payment, total cost
    - Test 9: Verify calculations correct (total = principal + interest + fees)
    - Test 10: Verify Moldovan consumer protection notice displayed
  - [ ] Use TestContainers for PostgreSQL

- [ ] Task 11: Create Documentation (AC: 10)
  - [ ] Update API documentation with disclosure metrics
    - Document: GET /api/borrower/offers response includes all disclosure fields
    - Document: GET /api/borrower/offers/comparison returns comparison table
    - Document: example response with sample calculations
  - [ ] Create docs/CONSUMER_PROTECTION_COMPLIANCE.md
    - Document how platform meets NBM/CNPF requirements
    - List all disclosures and disclaimers
    - Explain calculation methodologies
    - References to relevant stories (5.1-5.9)

  ## Dev Notes

  ### Previous Stories Dependencies
  - Story 3.4 (Offer DTOs/Endpoints): base offer data extended with disclosure metrics here.
  - Story 3.2 (Rate Cards): APR inputs and fees originate from bank rate cards.
  - Story 4.4 (Offer Submission): disclosure validation must run during offer creation.
  - Story 5.2 (Privacy Policy): update with Borrower Rights section and links.
  - Story 5.3 (Data Export): ensure disclosure data is included in exports.
  - Story 5.4 (Erasure): disclosures must not leak PII post-deletion; show anonymized historical metrics only.
  - Story 5.5 (Audit): record disclosure rendering and user views only as necessary, without sensitive payloads.

  ### Compliance Context
  - Moldovan consumer protection (NBM/CNPF): require clear APR prominence, all fees disclosed, rights and contacts visible.
  - GDPR fairness/transparency: explanations for fees and calculations; enable comparison without dark patterns.
  - Accessibility: ensure textual explanations are available (screen-readers), not only tooltips.

  ### Calculation Notes
  - APR prominence is UX/display; service returns both numeric and formatted fields.
  - Effective APR should incorporate all fees; use IRR for precision when feasible, with documented fallback formula.
  - Total Cost of Credit: principal + interest + all fees; currency-aware formatting.

  ### API Integration
  - Extend GET /api/borrower/offers and /offers/{id} to add disclosure block.
  - Add /offers/comparison for selected offers; sort by APR or total cost.
  - Validation guard `OfferDisclosureValidator` ensures complete disclosures.

  ### Security & Privacy
  - Never expose internal pricing algorithms; disclose parameters and results only.
  - Avoid PII in logs; include offerId and bankId references only.
  - Respect regionalization/localization for currency and wording.

  ### Project Directory Structure
  ```
  src/main/java/com/creditapp/
   borrower/
     controller/                 # BorrowerOfferComparisonController.java
     dto/                        # OfferDisclosureResponse.java, ComparisonTableDTO.java, FeeDetails.java
     service/                    # FeeDisclosureService.java, ComparisonTableService.java, OfferDisclosureValidator.java
     exception/                  # IncompleteOfferDisclosureException.java
   bank/
     repository/                 # Reuse Offer/RateCard repositories
  ```

  ### Key Dependencies
  - Stories 3.2, 3.4, 4.4, 5.2, 5.3, 5.4, 5.5.

  ## Testing

  ### Testing Framework & Location
  - Framework: JUnit 5, Spring Boot Test, Mockito.
  - Integration: TestContainers (PostgreSQL), TestRestTemplate for HTTP.
  - Location: src/test/java/com/creditapp/ with unit and integration packages mirroring main code.

  ### Testing Checklist
  - Calculations
    - [ ] Total Cost of Credit includes principal, interest, and all fees.
    - [ ] Effective APR uses IRR when available; fallback formula documented and tested.
    - [ ] APR and amounts formatted correctly (e.g., "8.5%", currency locale).
  - Disclosures & Validation
    - [ ] All fees present (origination, insurance, other) or explicitly zero; no hidden fees.
    - [ ] Preliminary offer disclaimer attached; bank contacts included.
    - [ ] Borrower Rights section present with links to 5.2, 5.3, 5.4 functionality.
    - [ ] `OfferDisclosureValidator` rejects incomplete offers.
  - APIs
    - [ ] Offers endpoints include disclosure block.
    - [ ] Comparison endpoint returns consistent columns and sorting.
    - [ ] Integration tests verify APR prominence and legal notices.
  - Privacy & Audit
    - [ ] No PII in logs; verify audit events are minimal and redacted.
    - [ ] Post-erasure views show anonymized/historical metrics only.
  - CI & Coverage
    - [ ] All tests pass with `mvn clean test`; coverage ≥ 80%.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Consumer Protection & Transparent Disclosures | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
