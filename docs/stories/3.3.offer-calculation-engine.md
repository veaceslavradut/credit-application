# Story 3.3: Offer Calculation Engine (Mock/Simulated)

## Status
Ready for Development

## Story

**As a** system,
**I want** to calculate preliminary offers automatically when borrower submits application using bank rate cards,
**so that** offers appear immediately simulating what banks' calculators would return (without calling external bank APIs).

## Acceptance Criteria

1. Service: OfferCalculationService triggered by application submission
2. Mock/Simulated approach: For each participating bank, retrieve matching rate card from database and perform calculation locally (NO external API calls to banks)
3. Calculation logic: Apply bank's configured formula from rate card:
   - APR = base_apr + adjustment (based on loan_amount/term from rate card parameters)
   - Monthly Payment = standard amortization formula
   - Total Cost = (monthly_payment  months) - principal
   - Origination Fee = loan_amount  origination_fee_percent
   - Insurance Cost = loan_amount  insurance_percent (if applicable)
4. Simulates bank calculator: Result should match what bank's website calculator would show for same inputs
5. Validation: if rate card missing for bank/loan_type/currency, skip that bank with logged warning
6. Offer status set to CALCULATED (indicates simulated/preliminary, not formally submitted by bank)
7. Validity period: 24 hours (configurable per bank in rate card)
8. Required documents: from bank template or default list configured in rate card
9. Async execution: non-blocking; calculations happen in background
10. Audit log: each calculation logged with "MOCK_CALCULATION" indicator and input parameters
11. Calculation result stored immediately in Offer table
12. Error handling: if one bank's calculation fails (e.g., invalid formula), others proceed; failed bank logged
13. Phase 2 preparation: Code structured to easily replace with real bank API calls when endpoints available
14. Integration test: submit application, verify offers created for all banks with rate cards, verify calculations mathematically correct, verify no external API calls made

## Tasks / Subtasks

- [ ] Task 1: Create Offer JPA Entity (AC: 1, 6, 11)
  - [ ] Create Offer entity (src/main/java/com/creditapp/bank/model/Offer.java)
    - Fields: id (UUID), applicationId (UUID FK), bankId (UUID FK), offerStatus (OfferStatus enum), apr (BigDecimal), monthlyPayment (BigDecimal), totalCost (BigDecimal), originationFee (BigDecimal), insuranceCost (BigDecimal), processingTimeDays (Integer), validityPeriodDays (Integer), requiredDocuments (JSON or TEXT), createdAt (LocalDateTime), expiresAt (LocalDateTime)
    - @Entity, @Table(name="offers")
    - @Enumerated(EnumType.STRING) for offerStatus
    - @CreationTimestamp for createdAt
    - @ManyToOne relationships: Application, Organization (bank)
  - [ ] Create OfferStatus enum: CALCULATED, SUBMITTED, ACCEPTED, REJECTED, EXPIRED, WITHDRAWN
  - [ ] Create indexes: (applicationId), (bankId), (expiresAt)
  - [ ] Add foreign keys: applicationId -> applications(id), bankId -> organizations(id)

- [ ] Task 2: Create OfferCalculationLog Entity (AC: 10)
  - [ ] Create OfferCalculationLog entity (src/main/java/com/creditapp/bank/model/OfferCalculationLog.java)
    - Fields: id (UUID), applicationId (UUID FK), bankId (UUID FK), calculationMethod (VARCHAR), inputParameters (JSON), calculatedValues (JSON), calculationTimestamp (LocalDateTime)
    - @Entity, @Table(name="offer_calculation_logs")
    - Store input params: loanAmount, loanTermMonths, rateCardId, rateCardVersion
    - Store calculated values: baseApr, adjustment, finalApr, monthlyPayment, totalCost, originationFee, insuranceCost
    - Mark as "MOCK_CALCULATION" in calculationMethod field
  - [ ] Create database migration to add tables

- [ ] Task 3: Create Offer Repositories (AC: 1)
  - [ ] Create OfferRepository (src/main/java/com/creditapp/bank/repository/OfferRepository.java)
    - Extends JpaRepository<Offer, UUID>
    - Method: findByApplicationId(UUID applicationId) returns List<Offer>
    - Method: findByApplicationIdAndBankId(UUID applicationId, UUID bankId) returns Optional<Offer>
    - Method: findByApplicationIdOrderByAprAsc(UUID applicationId) returns List<Offer>
    - Method: findByExpiresAtBefore(LocalDateTime now) returns List<Offer> (for expiration cleanup)
  - [ ] Create OfferCalculationLogRepository (src/main/java/com/creditapp/bank/repository/OfferCalculationLogRepository.java)
    - Extends JpaRepository<OfferCalculationLog, UUID>
    - Method: findByApplicationId(UUID applicationId) returns List<OfferCalculationLog>

- [ ] Task 4: Create Offer DTOs (AC: 2, 3)
  - [ ] Create OfferDTO (src/main/java/com/creditapp/bank/dto/OfferDTO.java)
    - Fields: id, bankId, bankName, apr, monthlyPayment, totalCost, originationFee, insuranceCost, processingTimeDays, validityPeriodDays, requiredDocuments, offerStatus, expiresAt
    - Read-only response DTO
  - [ ] Create OfferCalculationInput (src/main/java/com/creditapp/bank/dto/OfferCalculationInput.java)
    - Fields: loanAmount, loanTermMonths, loanType, currency, rateCardId (or lookup by type/currency)

- [ ] Task 5: Create OfferCalculationService (AC: 3, 4, 9)
  - [ ] Create OfferCalculationService (src/main/java/com/creditapp/bank/service/OfferCalculationService.java)
    - Method: calculateOffers(UUID applicationId) - main entry point
      - Fetch Application with loan details
      - Query all active organizations (banks) with status ACTIVE
      - For each bank, attempt to calculate offer
      - Store Offer entity with status CALCULATED
      - Log calculation in OfferCalculationLog
      - Return list of created Offer IDs
    - Method: calculateOfferForBank(Application app, Organization bank) returns Offer
      - Get rate card for bank/loanType/currency (from Story 3.2 BankRateCardRepository)
      - If no rate card, log warning and return null (skip this bank)
      - Call calculateAmortization() with loan parameters
      - Set offer status = CALCULATED
      - Set expiresAt = now + 24 hours (configurable)
      - Set requiredDocuments from bank template
      - Save and return Offer
    - Method: calculateAmortization(BigDecimal principal, int months, BigDecimal apr) returns OfferCalculationResult
      - Implement standard amortization formula:
        - monthlyRate = apr / 100 / 12
        - monthlyPayment = principal * (monthlyRate * (1 + monthlyRate)^months) / ((1 + monthlyRate)^months - 1)
        - totalCost = monthlyPayment * months - principal
      - Return result object with all calculated values
    - Method: logCalculation(UUID applicationId, UUID bankId, OfferCalculationInput input, OfferCalculationResult result)
      - Create OfferCalculationLog entry
      - Mark as "MOCK_CALCULATION"
      - Store all input and output parameters as JSON
    - Error handling: if calculation fails for one bank, continue others; log error with bankId and reason
  - [ ] Unit tests: mock repositories, test calculation logic, test error handling per bank

- [ ] Task 6: Create APR Adjustment Logic (AC: 3)
  - [ ] Implement APR adjustment based on loan_amount and loan_term
    - Base adjustment from rate card's aprAdjustmentRange
    - Adjustment = baseApr + (adjustment factor based on risk/amount/term)
    - For MVP: simple adjustment = baseApr + (min adjustment if term > 120 months, else 0)
    - Code should be clear for easy modification in Phase 2
  - [ ] Unit tests: verify APR adjustment calculations

- [ ] Task 7: Create Application Submission Trigger (AC: 1, 9)
  - [ ] Update ApplicationService from Story 2.2
    - After application status changes to SUBMITTED
    - Call OfferCalculationService.calculateOffers(applicationId) asynchronously
    - Use @Async to make non-blocking
    - Log start and completion of offer calculation
  - [ ] Integration point: application submission -> offer creation flow
  - [ ] Unit tests: mock OfferCalculationService, verify called on SUBMIT

- [ ] Task 8: Create Fee Calculation Methods (AC: 3)
  - [ ] Implement originationFee calculation
    - originationFee = loanAmount  originationFeePercent (from rate card)
  - [ ] Implement insuranceCost calculation
    - insuranceCost = loanAmount  insurancePercent (from rate card, if applicable)
  - [ ] Unit tests: verify fee calculations

- [ ] Task 9: Add Configuration for Validity Period (AC: 7)
  - [ ] Add property: app.offer.validity.period.hours=24 (configurable in application.yml)
  - [ ] Allow override per bank in BankRateCard.validityPeriodDays
  - [ ] Default to 24 hours if not specified

- [ ] Task 10: Add Audit Logging (AC: 10)
  - [ ] Ensure OfferCalculationService logs to AuditService (Story 1.7)
    - Event: OFFER_CALCULATED
    - Fields: applicationId, bankId, loanType, loanAmount, calculationMethod="MOCK_CALCULATION"
  - [ ] Log errors: OFFER_CALCULATION_FAILED with reason (no rate card, formula error, etc.)
  - [ ] Verify OfferCalculationLog stored for each calculation

- [ ] Task 11: Create Unit Tests (AC: 4, 12)
  - [ ] Create OfferCalculationServiceTest (src/test/java/com/creditapp/unit/bank/OfferCalculationServiceTest.java)
    - Test 1: Happy path - calculate offers for application, verify offer created per bank
    - Test 2: Missing rate card - skip bank with logged warning, continue others
    - Test 3: Invalid rate card parameters - catch error, skip bank, continue others
    - Test 4: APR calculation - verify formula correct
    - Test 5: Monthly payment calculation - verify amortization formula correct
    - Test 6: Total cost calculation - verify (payment  months - principal)
    - Test 7: Origination fee - verify loanAmount  percent
    - Test 8: Insurance cost - verify loanAmount  percent or zero if not applicable
    - Test 9: Validity period - verify expiresAt set to 24 hours in future
    - Test 10: Offer status - verify CALCULATED status set
    - Test 11: Multiple banks - verify offers created for all with rate cards
    - Test 12: Calculation logging - verify OfferCalculationLog entries created
  - [ ] Mock: BankRateCardRepository, OfferRepository, OrganizationRepository, AuditService
  - [ ] Framework: JUnit 5, Mockito

- [ ] Task 12: Create Integration Tests (AC: 14)
  - [ ] Create OfferCalculationIntegrationTest (src/test/java/com/creditapp/integration/bank/OfferCalculationIntegrationTest.java)
    - Setup: Create application, create 2+ banks with rate cards configured
    - Test 1: Submit application, verify offers created for all banks with rate cards
    - Test 2: Verify all offers in CALCULATED status
    - Test 3: Verify calculations mathematically correct (test with known values)
    - Test 4: Verify APR, monthly payment, total cost calculated correctly
    - Test 5: Verify origination fee and insurance calculated
    - Test 6: Verify offer expires in 24 hours (check expiresAt timestamp)
    - Test 7: No rate card for bank - verify bank skipped, others succeed
    - Test 8: Invalid rate card formula - verify error caught, others continue
    - Test 9: Verify no external API calls made (mock all external services)
    - Test 10: Verify calculation is deterministic (same input = same output)
    - Test 11: Verify OfferCalculationLog entries created with all parameters
    - Test 12: Verify AuditService called with OFFER_CALCULATED event
  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate, real HTTP requests for application submission
  - [ ] Assertions: verify database state, offer values, timestamps

- [ ] Task 13: Create Known Test Cases (AC: 4)
  - [ ] Create test data with known calculation results
    - Example: ,000 at 8.5% APR for 36 months
    - Calculate expected monthly payment = .67
    - Verify service calculates exact same value
  - [ ] Document test cases in test code comments
  - [ ] Use multiple loan amounts/terms to verify formula across ranges

- [ ] Task 14: Create Math Utility (optional) (AC: 3)
  - [ ] Create CalculationUtils (src/main/java/com/creditapp/bank/util/CalculationUtils.java)
    - Static method: calculateMonthlyPayment(principal, apr, months)
    - Static method: calculateTotalCost(monthlyPayment, months, principal)
    - Static method: calculateOriginationFee(principal, percent)
    - Static method: calculateInsuranceCost(principal, percent)
    - All return BigDecimal with proper rounding (2 decimals)
  - [ ] Unit tests: verify all calculations

- [ ] Task 15: Create Exception Classes (AC: 12)
  - [ ] Create OfferCalculationException (extends RuntimeException)
  - [ ] Create RateCardMissingException (extends OfferCalculationException)
  - [ ] Create InvalidRateCardException (extends OfferCalculationException)
  - [ ] Add exception handlers to GlobalExceptionHandler (Story 1.3)
    - OfferCalculationException -> 500 Internal Server Error
    - Log with context for debugging

- [ ] Task 16: Create API Documentation (AC: 3, 4)
  - [ ] Document offer calculation flow in architecture docs
    - Input: Application with loan amount, term, type, currency
    - Process: Retrieve rate cards for each bank, calculate offer
    - Output: Offer entities with calculated values
  - [ ] Example calculation walkthrough:
    - Input: ,000 loan, 36 months, PERSONAL, EUR
    - Bank A rate card: base_apr=8.5%, adjustment=0, origination=2.5%, insurance=0.5%
    - Calculation: apr=8.5%, payment=.67, origFee=, insFee=, total cost=,944
  - [ ] Update docs/API_ENDPOINTS.md with note about offer calculation

## Dev Notes

### Previous Stories Dependencies
- **Story 2.1 & 2.2**: Application entity and submission workflow
- **Story 3.1**: Offer entity, OfferCalculationLog entity
- **Story 3.2**: BankRateCard entity and repository
- **Story 1.7**: AuditService for logging

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Data JPA
- **Async Processing**: @Async, ThreadPoolTaskExecutor
- **Financial Math**: BigDecimal for precision
- **Database**: PostgreSQL 15.4

### Calculation Formula Reference
**Amortization Formula:**
- M = P  [r(1 + r)^n] / [(1 + r)^n - 1]
- Where: M = monthly payment, P = principal, r = monthly interest rate, n = number of payments
- Monthly rate = annual APR / 100 / 12

**Total Cost:**
- Total = (M  n) - P

**Fees:**
- Origination Fee = P  origination_fee_percent / 100
- Insurance = P  insurance_percent / 100

### Mock/Simulated Approach
[Source: Story 3.3 AC]
- NO external API calls to banks in MVP
- Use locally-configured rate cards from Story 3.2
- Calculations happen in-database to match bank formulas
- Result status = CALCULATED (not submitted by bank, simulated)
- Phase 2: replace calculation logic with real bank API calls
- Code structure allows easy transition (OfferCalculationService interface)

### Async Execution
[Source: Story 3.3 AC]
- Application submission triggers async offer calculation
- Borrower doesn't wait for offers to appear
- Offers typically available within seconds
- Non-blocking: borrower can proceed to next step while calculations happen
- Audit log captures all calculation steps for debugging

### BigDecimal Usage
[Source: Financial Standards]
- All monetary amounts: BigDecimal with scale=2 (2 decimal places)
- APR: BigDecimal with scale=4 (e.g., 8.5500)
- Avoid floating-point arithmetic for financial calculations
- Use BigDecimal.ROUND_HALF_UP for rounding

### Project Directory Structure
`
src/main/java/com/creditapp/
 bank/
    model/                 # Offer.java, OfferStatus.java, OfferCalculationLog.java
    repository/            # OfferRepository.java, OfferCalculationLogRepository.java
    service/               # OfferCalculationService.java
    dto/                   # OfferDTO.java, OfferCalculationInput.java
    util/                  # CalculationUtils.java (optional)
    exception/             # OfferCalculationException.java, RateCardMissingException.java, InvalidRateCardException.java
 borrower/
    service/               # ApplicationService.java (update to call OfferCalculationService on SUBMIT)

src/test/java/com/creditapp/
 unit/
    bank/
      OfferCalculationServiceTest.java
      CalculationUtilsTest.java (optional)
 integration/
    bank/
      OfferCalculationIntegrationTest.java
`

### Testing Strategy
[Source: Story 3.3 AC]
- **Unit Tests**: Mock all repositories, test calculation formulas in isolation
- **Integration Tests**: Real database, real rate cards, real offer creation
- **Known Test Cases**: Use exact calculation examples (e.g.,  at 8.5% for 36mo = .67/month)
- **Error Scenarios**: Missing rate card, invalid formula, bad parameters
- **No External Calls**: Verify mock/simulated (NO actual bank API calls)

### Important Notes
1. **BigDecimal Precision**: All financial calculations use BigDecimal, never Double
2. **Monthly Payment Formula**: Standard amortization; ensure formula correct (test with calculators)
3. **Async Trigger**: Offer calculation runs async after application SUBMITTED
4. **Rate Card Lookup**: By bank + loanType + currency; skip if not found
5. **One Offer Per Bank**: One offer record per application per bank
6. **Status CALCULATED**: Indicates preliminary/simulated, not submitted by bank
7. **Validity Period**: Default 24 hours; configurable per bank
8. **Phase 2 Ready**: Structure code to easily swap mock calculations for real API calls
9. **Error Resilience**: One bank failure doesn't block others from being calculated
10. **Audit Trail**: All calculations logged for compliance and debugging

## Testing

### Testing Framework & Location
- **Framework**: JUnit 5, Spring Boot Test, TestContainers, Mockito
- **Assertions**: BigDecimal comparison with scale tolerance
- **Test Location**: src/test/java/com/creditapp/unit/bank/, src/test/java/com/creditapp/integration/bank/

### Testing Checklist
- [ ] Offer entity: persists to database with all fields
- [ ] OfferCalculationLog entity: created and stores all parameters
- [ ] OfferRepository: findByApplicationId, findByExpiresAtBefore work correctly
- [ ] OfferCalculationService: retrieves rate cards for each bank
- [ ] OfferCalculationService: skips banks without rate cards (with warning)
- [ ] OfferCalculationService: calculates all offers for multi-bank scenario
- [ ] APR calculation: correctly applies base APR and adjustments
- [ ] Monthly payment: amortization formula correct (verify with known values)
- [ ] Total cost: (payment  months - principal) correct
- [ ] Origination fee: loanAmount  percent
- [ ] Insurance cost: loanAmount  percent or 0
- [ ] Offer status: CALCULATED
- [ ] Expiration: expiresAt set to 24 hours in future
- [ ] Async trigger: application SUBMIT triggers offer calculation
- [ ] Error handling: missing rate card skips bank, others proceed
- [ ] Error handling: invalid formula caught, others proceed
- [ ] Audit logging: OFFER_CALCULATED events logged
- [ ] OfferCalculationLog: entries created with all parameters
- [ ] No external API calls: all mocked/verified locally
- [ ] Calculation deterministic: same inputs = same outputs
- [ ] BigDecimal precision: all values rounded to 2 decimals
- [ ] Integration test: end-to-end application submission -> offer creation
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Offer Calculation Engine | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
