# Story 4.7: Bank Settings & Profile Management

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to manage my bank's profile, team members, and notification preferences,
**so that** the bank information is accurate and my team can collaborate effectively.

## Acceptance Criteria

1. GET /api/bank/profile returns current bank profile for authenticated bank
2. Profile fields: Bank Name, Registration Number, Contact Email, Phone, Address (street, city, state, zip), Website, Logo URL
3. PUT /api/bank/profile updates any profile field (all optional)
4. Profile update audit log: BANK_PROFILE_UPDATED with changed fields
5. Team member list: GET /api/bank/team returns list of team members (Phase 2: role management)
6. Team member fields: Email, Name, Joined Date, Last Login, Status (ACTIVE/INACTIVE)
7. Invite team member: POST /api/bank/team/invite with email, name, role (basic for Phase 1, prepared for Phase 2)
8. Send invite email: {team_name_of_inviter} invites you to join {bank_name} - click link to accept
9. Link to rate cards: GET /api/bank/rate-cards endpoint for quick access to Story 3.2
10. Response time: <200ms for profile operations

## Tasks / Subtasks

- [ ] Task 1: Create Bank Profile DTOs
  - [ ] Create BankProfileDTO (id, name, registrationNumber, contactEmail, phone, address, website, logoUrl)
  - [ ] Create UpdateBankProfileRequest (name?, registrationNumber?, contactEmail?, phone?, address?, website?, logoUrl?)
  - [ ] Create BankAddressDTO (street, city, state, zip)

- [ ] Task 2: Create Bank Profile Service
  - [ ] Create BankProfileService
    - Method: getBankProfile(UUID bankId)
      - Fetch Bank entity
      - Return BankProfileDTO
    - Method: updateBankProfile(UUID bankId, UpdateBankProfileRequest request)
      - Fetch Bank entity
      - Update provided fields (ignore null values)
      - Audit log: BANK_PROFILE_UPDATED with field changes
      - Return updated BankProfileDTO

- [ ] Task 3: Create Bank Profile Controller
  - [ ] Create BankProfileController
    - GET /api/bank/profile
      - Extract bankId from SecurityContext
      - Call BankProfileService.getBankProfile()
      - Return BankProfileDTO with 200 OK
    - PUT /api/bank/profile
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Body: UpdateBankProfileRequest
      - Extract bankId from SecurityContext
      - Call BankProfileService.updateBankProfile()
      - Return updated BankProfileDTO with 200 OK

- [ ] Task 4: Create Team Member DTOs
  - [ ] Create TeamMemberDTO (id, email, name, joinedDate, lastLogin, status)
  - [ ] Create InviteTeamMemberRequest (email, name, role)
  - [ ] Create InviteTeamMemberResponse (inviteId, email, status, sentAt)

- [ ] Task 5: Create Team Member Service
  - [ ] Create BankTeamService
    - Method: getTeamMembers(UUID bankId)
      - Fetch all BankTeamMember entities for bankId
      - Return list of TeamMemberDTO
    - Method: inviteTeamMember(UUID bankId, InviteTeamMemberRequest request)
      - Create TeamMemberInvite entity
      - Send invite email (see Task 6)
      - Audit log: TEAM_MEMBER_INVITED
      - Return InviteTeamMemberResponse
    - Method: acceptInvite(String inviteToken)
      - Verify token not expired
      - Create BankTeamMember entity
      - Mark invite as ACCEPTED
      - Send welcome email

- [ ] Task 6: Team Member Invite Email
  - [ ] Create email template: team-invite.html
    - Subject: "Join {bank_name} on Credit Application Platform"
    - Body: {inviter_name} invites you to join the team
    - CTA: "Accept Invite" link with token
    - Link expires in 7 days

- [ ] Task 7: Create Team Member Controller
  - [ ] Create BankTeamController
    - GET /api/bank/team
      - Extract bankId from SecurityContext
      - Call BankTeamService.getTeamMembers()
      - Return list of TeamMemberDTO
    - POST /api/bank/team/invite
      - Body: InviteTeamMemberRequest
      - Extract bankId from SecurityContext
      - Call BankTeamService.inviteTeamMember()
      - Return InviteTeamMemberResponse with 201 CREATED
    - POST /api/bank/team/invite/{token}/accept
      - Call BankTeamService.acceptInvite()
      - Return 200 OK with welcome message

- [ ] Task 8: Rate Card Quick Link
  - [ ] Add rateCardsUrl to BankProfileDTO
    - Link to: /api/bank/rate-cards (from Story 3.2)
    - Include in profile response

- [ ] Task 9: Notification Preferences (Phase 2 preparation)
  - [ ] Create NotificationPreference entity fields (prepared but not implemented)
    - Fields: bankId, emailOnOfferExpiration, emailOnNewApplication, inPortalAlerts
  - [ ] Add GET /api/bank/notification-preferences (returns defaults for Phase 1)
  - [ ] Add PUT endpoint placeholder for Phase 2

- [ ] Task 10: Unit Tests
  - [ ] Test get bank profile
  - [ ] Test update profile (single field, multiple fields)
  - [ ] Test audit log on profile update
  - [ ] Test get team members
  - [ ] Test invite team member
  - [ ] Test invite token generation and expiration

- [ ] Task 11: Integration Tests
  - [ ] Create bank, get profile
  - [ ] Update profile fields, verify updated
  - [ ] Verify audit log entries created
  - [ ] Invite team member, verify email sent
  - [ ] Accept invite with token, verify team member created
  - [ ] Test performance <200ms

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Bank Settings & Profile Management | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
