# Story 2.9: Borrower Notifications

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to receive notifications when my application status changes,
**so that** I'm always informed about the progress of my loan application.

## Acceptance Criteria

1. Notification events: APPLICATION_SUBMITTED, APPLICATION_UNDER_REVIEW, OFFERS_AVAILABLE, OFFER_ACCEPTED, APPLICATION_REJECTED, APPLICATION_EXPIRED, APPLICATION_WITHDRAWN
2. Notification channels: Email (required), In-app notification (optional), SMS (optional for future)
3. Email notifications sent asynchronously (don't block API responses)
4. Notification templates: customizable per event, support variables (app_id, borrower_name, loan_amount, etc.)
5. Borrower preference settings: can opt-in/opt-out per notification type (Story 2.11)
6. Notification delivery: store in database for audit trail, mark as read/unread
7. GET /api/borrower/notifications returns list of notifications with read status
8. PUT /api/borrower/notifications/{notificationId}/read marks notification as read
9. Integration test: verify notifications created for each status transition

## Tasks / Subtasks

- [ ] Task 1: Create Database Schema for Notifications (AC: 3, 6)
  - [ ] Create V13__Create_Borrower_Notifications_Table.sql migration
    - Columns: id (UUID PK), borrower_id (UUID FK), application_id (UUID FK), notification_type (VARCHAR), subject (VARCHAR), message (TEXT), channel (VARCHAR: email, in_app, sms), sent_at (TIMESTAMP), read_at (TIMESTAMP nullable), delivery_status (PENDING, SENT, FAILED)
    - Foreign keys: borrower_id, application_id
    - Index on (borrower_id, sent_at), (borrower_id, read_at)

- [ ] Task 2: Create Notification JPA Entity (AC: 1, 6)
  - [ ] Create BorrowerNotification entity (src/main/java/com/creditapp/borrower/model/BorrowerNotification.java)
    - Fields: id (UUID), borrowerId (UUID), applicationId (UUID), notificationType (NotificationType enum), subject (String), message (String), channel (NotificationChannel enum), sentAt (LocalDateTime), readAt (LocalDateTime), deliveryStatus (DeliveryStatus enum)
    - @Entity, @Table(name = "borrower_notifications")
    - @Enumerated(EnumType.STRING) for all enums
  - [ ] Create NotificationType enum: APPLICATION_SUBMITTED, APPLICATION_UNDER_REVIEW, OFFERS_AVAILABLE, OFFER_ACCEPTED, APPLICATION_REJECTED, APPLICATION_EXPIRED, APPLICATION_WITHDRAWN
  - [ ] Create NotificationChannel enum: EMAIL, IN_APP, SMS
  - [ ] Create DeliveryStatus enum: PENDING, SENT, FAILED

- [ ] Task 3: Create Notification Repository (AC: 6)
  - [ ] Create BorrowerNotificationRepository (src/main/java/com/creditapp/borrower/repository/BorrowerNotificationRepository.java)
    - Extends JpaRepository<BorrowerNotification, UUID>
    - Method: findByBorrowerId(UUID borrowerId, Pageable pageable) returns Page<BorrowerNotification>
    - Method: findByBorrowerIdOrderBySentAtDesc(UUID borrowerId) returns List<BorrowerNotification>
    - Custom query to support pagination and sorting

- [ ] Task 4: Create Notification Service (AC: 1, 3, 4, 6)
  - [ ] Create NotificationService (src/main/java/com/creditapp/shared/service/NotificationService.java)
    - Method: createNotification(UUID borrowerId, UUID applicationId, NotificationType type, String subject, String message) returns BorrowerNotification
    - Create BorrowerNotification entity with channel=EMAIL, deliveryStatus=PENDING
    - Save to BorrowerNotificationRepository
    - Trigger async notification delivery
    - Return saved notification

    - Method: sendNotification(UUID notificationId) returns boolean (async method)
    - Fetch notification from repository
    - Check borrower notification preferences (opt-in)
    - Send via configured channels (email, SMS, in-app)
    - Update deliveryStatus based on result
    - Log NOTIFICATION_SENT audit event
    - Return success/failure

    - Method: getNotifications(UUID borrowerId, Pageable pageable) returns Page<NotificationDTO>
    - Fetch paginated notifications ordered by sentAt DESC
    - Return NotificationDTO list with read status

    - Method: markAsRead(UUID notificationId, UUID borrowerId) returns void
    - Verify notification belongs to borrower
    - Set readAt = now
    - Save to repository
    - Error handling: NotificationNotFoundException (404)

  - [ ] Unit tests: mock repositories, test notification creation and delivery

- [ ] Task 5: Create Notification Event Listeners (AC: 1, 7)
  - [ ] Create ApplicationStatusChangeListener (event-driven or scheduled)
    - Listen for APPLICATION_SUBMITTED events -> trigger APPLICATION_SUBMITTED notification
    - Listen for APPLICATION_UNDER_REVIEW events -> trigger APPLICATION_UNDER_REVIEW notification
    - Listen for OFFERS_AVAILABLE events -> trigger OFFERS_AVAILABLE notification
    - Listen for APPLICATION_WITHDRAWN events -> trigger APPLICATION_WITHDRAWN notification
  - [ ] Notification templates for each event type:
    - Load from database (template table) or hardcoded (v1)
    - Support variable substitution: {borrower_name}, {loan_amount}, {loan_term}

- [ ] Task 6: Create Notification REST Endpoints (AC: 7, 8)
  - [ ] Add GET endpoint in BorrowerNotificationController
    - Endpoint: GET /api/borrower/notifications
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Query parameters: page, size, read (filter by read status)
    - Call NotificationService.getNotifications()
    - Return: Page<NotificationDTO> with HTTP 200 OK

  - [ ] Add PUT endpoint to mark notification as read
    - Endpoint: PUT /api/borrower/notifications/{notificationId}/read
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Call NotificationService.markAsRead()
    - Return: HTTP 204 No Content
    - Error handling: 404 Not Found, 403 Forbidden

  - [ ] Unit tests: mock service, test success and error paths

- [ ] Task 7: Create Notification DTOs (AC: 7, 8)
  - [ ] Create NotificationDTO (src/main/java/com/creditapp/borrower/dto/NotificationDTO.java)
    - Fields: id, notificationType, subject, message, sentAt, readAt (nullable), isRead (boolean)
    - Read-only response DTO

  - [ ] Create NotificationPageDTO
    - Paginated response with notifications

- [ ] Task 8: Create Email Notification Service (AC: 3, 4)
  - [ ] Create EmailNotificationService (src/main/java/com/creditapp/shared/service/EmailNotificationService.java)
    - Method: sendEmail(String email, String subject, String message) returns boolean (async)
    - Use SendGrid to send email
    - Handle failures gracefully (log, don't throw)
    - @Async annotation for non-blocking delivery
    - Unit tests: mock SendGrid

- [ ] Task 9: Add Exception Handlers (AC: 6)
  - [ ] Create custom exception: NotificationNotFoundException (extends RuntimeException)
  - [ ] Update GlobalExceptionHandler
    - @ExceptionHandler for NotificationNotFoundException  404 Not Found

- [ ] Task 10: Create Integration Tests (AC: 7, 9)
  - [ ] Create BorrowerNotificationIntegrationTest
    - Setup: Create borrower, create application
    - Test 1: Submit application, verify APPLICATION_SUBMITTED notification created
    - Test 2: GET /api/borrower/notifications, verify submitted notification in list
    - Test 3: PUT mark notification as read, verify readAt timestamp set
    - Test 4: GET notifications, verify unread count and isRead flag
    - Test 5: Filter notifications by read status (read=true, read=false)
    - Test 6: Simulate status change -> UNDER_REVIEW, verify notification created
    - Test 7: Simulate OFFERS_AVAILABLE, verify notification created
    - Test 8: Verify email sent asynchronously (mock SendGrid)
    - Test 9: Verify notification delivery_status updates (PENDING -> SENT)
    - Test 10: Different borrower cannot see notifications (403)

  - [ ] Use: TestContainers (PostgreSQL), TestRestTemplate, @WithMockUser

- [ ] Task 11: Create Notification Templates (AC: 4)
  - [ ] Create notification template strings or database table:
    - APPLICATION_SUBMITTED: "Your loan application for {loan_amount} {currency} has been submitted. Banks will review it shortly."
    - APPLICATION_UNDER_REVIEW: "Your application is now under review by our partner banks."
    - OFFERS_AVAILABLE: "Good news! You have received offers. Visit your dashboard to review them."
    - APPLICATION_REJECTED: "Unfortunately, your application was not approved at this time."
    - APPLICATION_WITHDRAWN: "Your application has been withdrawn as requested."

- [ ] Task 12: Create API Documentation (AC: 7, 8)
  - [ ] Document GET /api/borrower/notifications
    - Query parameters: page, size, read
    - Response example: paginated list of notifications
  - [ ] Document PUT /api/borrower/notifications/{notificationId}/read
    - Response: 204 No Content

## Dev Notes

### Previous Story Dependencies
- **Story 2.2, 2.5, 2.8**: Status transitions trigger notifications
- **Story 1.6**: RBAC - @PreAuthorize
- **Story 2.11**: Notification preferences (future)

### Notification Event Flow
1. Application status changes (e.g., DRAFT -> SUBMITTED)
2. ApplicationStatusTransitionService records status transition
3. Event listener triggered (ApplicationStatusChangeListener)
4. NotificationService.createNotification() called
5. BorrowerNotification stored in database
6. Async email sent via EmailNotificationService
7. Notification available in GET /api/borrower/notifications

### Channels
- EMAIL: primary channel, sent immediately
- IN_APP: future enhancement (web/mobile notifications)
- SMS: future enhancement (opt-in)

### Template Variables
- {borrower_name}, {loan_amount}, {currency}, {loan_type}, {loan_term}, {application_id}

## Testing Checklist
- [ ] Notifications created for status transitions
- [ ] Emails sent asynchronously
- [ ] GET /notifications returns paginated list
- [ ] PUT mark as read updates readAt
- [ ] Filter by read status works
- [ ] Access control (cannot see other borrower's notifications)
- [ ] Delivery status tracking (PENDING -> SENT)
- [ ] Notification templates populated with variables
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-15 | 1.0 | Initial story draft - Borrower Notifications | Bob (Scrum Master) |
