# Story 2.4: Retrieve Application API

## Status
Ready for Development

## Story

**As a** borrower,
**I want** to view my complete application details and status history,
**so that** I can understand my application progress and see all submitted information.

## Acceptance Criteria

1. GET /api/borrower/applications/{id} returns complete ApplicationDTO with details and metadata
2. GET /api/borrower/applications/{id}/history returns status change timeline with pagination
3. Response includes: loanType, loanAmount, loanTermMonths, currency, ratePreference, status, timestamps, details, history
4. Only borrower who owns application can view (403 if unauthorized)
5. Pagination support for history (page, size, defaultPageSize=20)
6. Returns 404 if application not found
7. Returns 403 if different borrower owns application
8. No sensitive data exposed (passwords, tokens, bank internal data)
9. Response times <200ms for p95 (optimize N+1 queries)
10. Integration test: retrieve application with history, verify all fields present

## Tasks / Subtasks

- [ ] Task 1: Verify Application Service Methods (AC: 1, 2, 3, 4)
  - [ ] Verify ApplicationService.getApplication(UUID applicationId, UUID borrowerId) method
    - Authorization check: verify borrowerId matches application.borrowerId
    - Throw AccessDeniedException (403) if mismatch
    - Fetch Application entity with eager-loaded relationships (ApplicationDetails, ApplicationHistory)
    - Use @Query with @EntityGraph for optimized loading
    - Return fully-populated ApplicationDTO
    - Throw ApplicationNotFoundException (404) if application not found
  - [ ] Verify ApplicationService.getApplicationHistory(UUID applicationId, UUID borrowerId) method
    - Authorization check: verify borrowerId owns application
    - Fetch ApplicationHistory entities ordered by changedAt DESC
    - Return List<ApplicationHistoryDTO> or Page<ApplicationHistoryDTO> for pagination
    - Support pagination with Pageable parameter
  - [ ] Unit tests: mock repositories, test authorization and data fetching
  - [ ] Verify ApplicationService has getApplicationHistory(applicationId, borrowerId, Pageable) method
    - Verify borrower ownership
    - Fetch paginated history
    - Return List<ApplicationHistoryDTO>

- [ ] Task 2: Create GET Endpoints in Controller (AC: 1, 2, 4, 7)
  - [ ] Verify GET /api/borrower/applications/{applicationId} exists
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Call ApplicationService.getApplication(applicationId, borrowerId)
    - Return ApplicationDTO with 200 OK
    - Error handling: 403, 404
  - [ ] Verify GET /api/borrower/applications/{applicationId}/history exists
    - @PreAuthorize("hasAuthority('BORROWER')")
    - Extract borrowerId from SecurityContext
    - Query parameters: page (default 0), size (default 20)
    - Call ApplicationService.getApplicationHistory(applicationId, borrowerId, pageable)
    - Return paginated response with List<ApplicationHistoryDTO>
  - [ ] Unit tests: mock service, test success and error paths
  - [ ] Integration tests: real HTTP requests with JWT token

- [ ] Task 3: Add Exception Handlers (AC: 6, 7)
  - [ ] Verify GlobalExceptionHandler has:
    - @ExceptionHandler for ApplicationNotFoundException  404 Not Found
    - Verify 403 Forbidden returned for ownership check failure

- [ ] Task 4: Create Response DTOs (AC: 3, 8)
  - [ ] Verify ApplicationDTO includes all required fields
  - [ ] Verify ApplicationHistoryDTO includes: oldStatus, newStatus, changedAt, changedByUserId (nulled for privacy), changeReason
  - [ ] Ensure no sensitive data in responses (password, tokens, activation codes)

- [ ] Task 5: Create Tests (AC: 5, 9)
  - [ ] Unit test: happy path retrieve application with all details
  - [ ] Unit test: different borrower, verify 403 error
  - [ ] Unit test: non-existent application, verify 404 error
  - [ ] Unit test: retrieve history with pagination
  - [ ] Integration test: retrieve application, verify all fields present in response
  - [ ] Integration test: retrieve history, verify ordered by changedAt DESC
  - [ ] Integration test: verify pagination works (page, size)

- [ ] Task 6: Update API Documentation (AC: 1, 2)
  - [ ] Document GET /api/borrower/applications/{applicationId}
    - Response example with all fields
    - Error responses
  - [ ] Document GET /api/borrower/applications/{applicationId}/history
    - Query parameters: page, size
    - Response example with ApplicationHistoryDTO array
    - Pagination info

## Dev Notes

### Previous Story Dependencies
- **Story 2.1**: ApplicationService, ApplicationDTO, ApplicationHistoryDTO
- **Story 2.2**: Authorization patterns with @PreAuthorize

### Key Design Notes
- Borrower ownership enforced for all GET operations
- History returned in descending order by timestamp
- Pagination supports large history records
- No sensitive data (changedByUserId nulled for privacy)

## Testing

### Testing Checklist
- [ ] Retrieve own application, verify all fields
- [ ] Retrieve with different borrower, verify 403 error
- [ ] Retrieve non-existent application, verify 404 error
- [ ] Retrieve history, verify ordered by changedAt DESC
- [ ] Retrieve history with pagination (page 0, size 10)
- [ ] Retrieve history next page, verify correct records
- [ ] Verify no sensitive data exposed in response
- [ ] All tests pass with \mvn clean test\
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Retrieve Application API | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
