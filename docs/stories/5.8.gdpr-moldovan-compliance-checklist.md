# Story 5.8: GDPR & Moldovan Data Protection Compliance Checklist

## Status
Ready for Development

## Story

**As a** compliance officer,
**I want** a comprehensive checklist documenting platform compliance,
**so that** regulatory review can be completed efficiently.

## Acceptance Criteria

1. Compliance checklist: covers GDPR Articles 6, 7, 15, 16, 17, 20, 32
2. Moldovan-specific: data residency (EU/Moldova), registration with data protection authority, privacy policy in Romanian/Russian if required
3. Checklist items:  Explicit consent, Privacy policy published, Data export, Data deletion, Audit logs immutable, Encryption, Data retention policy (3 years), DPO identified
4. GET /api/compliance/checklist returns status (COMPLIANCE_OFFICER role only)
5. Red/yellow/green status for each item
6. Regulatory submission package: downloadable PDF with all compliance documentation
7. NBM/CNPF communication: prepared template letter requesting licensing clarification
8. Annual review: refreshed annually or when regulations change
9. Audit log: COMPLIANCE_CHECKLIST_REVIEWED
10. Integration test: retrieve checklist, verify all items green; generate submission package, verify PDF includes all sections

## Tasks / Subtasks

- [ ] Task 1: Create Compliance Checklist Data Model (AC: 1, 2, 3, 5)
  - [ ] Create ComplianceChecklistItem entity (src/main/java/com/creditapp/shared/model/ComplianceChecklistItem.java)
    - Fields: id (UUID), item (String: name/title), description, status (RED, YELLOW, GREEN), gdprArticles (String: e.g., "6, 7, 15"), evidence (String: URL/reference), lastReviewedAt (LocalDateTime), notes (TEXT)
    - Enum: ComplianceStatus: RED (not done), YELLOW (in progress), GREEN (done)
  - [ ] Create predefined items:
    1. Explicit Consent (AC 6, 7) -> Story 5.1 -> GREEN
    2. Privacy Policy Published (AC 7) -> Story 5.2 -> GREEN
    3. Data Export Capability (AC 15, 20) -> Story 5.3 -> GREEN
    4. Data Deletion Capability (AC 17) -> Story 5.4 -> GREEN
    5. Audit Logs Immutable (AC 32) -> Story 5.5 -> GREEN
    6. Data Encryption (AC 32) -> Story 5.7 -> GREEN
    7. Data Retention Policy (3 years) -> Story 5.4 -> GREEN
    8. DPO Identified -> YELLOW (requires manual entry)
    9. Data Processing Agreement with Processors -> YELLOW
    10. Subprocessor List -> YELLOW
    11. ROPA (Records of Processing Activities) -> GREEN (auto-generated from code)
    12. Data Breach Notification Procedure -> YELLOW

- [ ] Task 2: Create Compliance Checklist Service (AC: 1, 4, 5)
  - [ ] Create ComplianceChecklistService
    - Method: getComplianceChecklist() returns List<ComplianceChecklistItemResponse>
      - Query all checklist items from database
      - Calculate overall status:
        - GREEN: all items GREEN
        - YELLOW: any item YELLOW
        - RED: any item RED
      - Return sorted list with overall status
    - Method: updateChecklistItem(UUID itemId, ComplianceStatus newStatus, String notes) returns ComplianceChecklistItemResponse
      - Update item status and notes
      - Set lastReviewedAt = now
      - Log COMPLIANCE_CHECKLIST_ITEM_UPDATED audit event
      - Return updated item
    - Method: generateSubmissionPackage() returns byte[] (PDF)
      - Create PDF with all checklist items
      - Include: item name, description, status, GDPR articles, evidence links
      - Add summary: X items GREEN, Y items YELLOW, Z items RED
      - Add timestamp and DPO contact info
  - [ ] Unit tests: mock repository, test status calculation

- [ ] Task 3: Create Compliance REST Controller (AC: 4, 9)
  - [ ] Create ComplianceChecklistController (src/main/java/com/creditapp/compliance/controller/ComplianceChecklistController.java)
    - GET /api/compliance/checklist
      - @PreAuthorize("hasAuthority('COMPLIANCE_OFFICER')")
      - Call ComplianceChecklistService.getComplianceChecklist()
      - Return List<ComplianceChecklistItemResponse> with overall status
    - PUT /api/compliance/checklist/{itemId}
      - @PreAuthorize("hasAuthority('COMPLIANCE_OFFICER')")
      - Body: { "status": "GREEN", "notes": "..." }
      - Call ComplianceChecklistService.updateChecklistItem()
      - Return updated item
      - Log COMPLIANCE_CHECKLIST_REVIEWED audit event
    - GET /api/compliance/submission-package
      - @PreAuthorize("hasAuthority('COMPLIANCE_OFFICER')")
      - Call ComplianceChecklistService.generateSubmissionPackage()
      - Return PDF for download
  - [ ] Unit tests: mock service, test endpoints
  - [ ] Integration tests: real HTTP requests with COMPLIANCE_OFFICER JWT

- [ ] Task 4: Create Compliance Evidence Mapping (AC: 1, 2, 3)
  - [ ] Create ComplianceEvidence entity (or JSON in checklist item)
    - Fields: itemId (FK), evidenceType (CODE, DOCUMENTATION, TEST_RESULT), source (URL or file path), description, verifiedAt
    - Examples:
      - Explicit Consent: src/main/java/com/creditapp/borrower/service/ConsentService.java
      - Privacy Policy: /api/legal/privacy-policy endpoint
      - Data Export: src/main/java/com/creditapp/borrower/service/DataExportService.java
      - Data Deletion: /api/borrower/data-deletion endpoint
      - Encryption: src/main/java/com/creditapp/shared/security/EncryptedAttributeConverter.java
      - Audit Logs: /api/compliance/audit-logs endpoint
  - [ ] Auto-generate evidence links in code (annotations or configuration)

- [ ] Task 5: Create PDF Generation for Submission Package (AC: 6)
  - [ ] Create SubmissionPackageGenerator
    - Generate PDF with sections:
      1. Cover page: Organization name, date, DPO signature line
      2. Executive Summary: Status overview (red/yellow/green counts)
      3. Detailed Checklist: Each item with status, description, evidence, GDPR articles
      4. ROPA (Records of Processing Activities): Auto-generated list of processing activities
      5. Data Retention Schedule: 3-year retention for audit logs, grace periods for others
      6. Security Measures: Encryption, TLS, bcrypt, audit trails
      7. Subprocessor List: Email provider, S3, Redis provider, etc.
      8. DPO Contact: Name, email, phone (manual entry)
      9. Attestation: "We certify compliance with GDPR and Moldovan law"
    - Use iText, Apache FOP, or Jasper Reports
    - Return PDF bytes

- [ ] Task 6: Create NBM/CNPF Template Letter (AC: 7)
  - [ ] Create template document: docs/NBM_CNPF_LICENSING_REQUEST_TEMPLATE.md
    - Template for official letter to NBM (National Bank of Moldova) or CNPF (Consumer Financial Protection agency)
    - Request: clarification on licensing requirements for fintech marketplace
    - Attach: compliance checklist, privacy policy, data protection measures
    - Tone: professional, compliant, requesting guidance
  - [ ] Store in docs folder for manual customization and submission

- [ ] Task 7: Create Data Processing Activity Log (ROPA) (AC: 1, 3)
  - [ ] Create ProcessingActivityLog entity
    - Fields: id, processingPurpose, dataCategories, recipients, retentionPeriod, lawfulBasis, dataSubjects, processingLocation
    - Predefined entries:
      1. User Registration: purpose=account creation, data=name/email/phone, retention=3 years, lawful basis=explicit consent
      2. Application Processing: purpose=loan evaluation, data=application details, retention=3 years, lawful basis=contract
      3. Offer Management: purpose=lending offers, data=application + rating data, retention=3 years
      4. Compliance/Audit: purpose=regulatory compliance, data=all user actions, retention=3 years, lawful basis=legal obligation
      5. Email Notifications: purpose=communication, data=email address, retention=until deletion
  - [ ] Auto-generate ROPA PDF section in submission package

- [ ] Task 8: Create Annual Compliance Review Job (AC: 8)
  - [ ] Create ScheduledComplianceReview (or manual trigger)
    - Scheduled: annually on Jan 1, or on-demand via admin endpoint
    - Action: set all items to status=YELLOW (pending annual review)
    - Email notification to DPO: "Annual compliance review due"
    - Create audit log: COMPLIANCE_ANNUAL_REVIEW_INITIATED
  - [ ] Or create API endpoint: POST /api/compliance/annual-review (admin-only)

- [ ] Task 9: Create Compliance Monitoring Dashboard (Optional) (AC: 5)
  - [ ] Create ComplianceDashboardResponse DTO
    - Overall status (RED, YELLOW, GREEN)
    - Item breakdown: count of each status
    - Timeline: last checklist update, next annual review date
    - Recent actions: last 5 compliance events from audit log
  - [ ] Optional: display in compliance officer portal (UI feature)

- [ ] Task 10: Create Unit Tests (AC: 1, 3, 5)
  - [ ] Create ComplianceChecklistUnitTest
    - Test 1: Retrieve all checklist items, verify count = 12
    - Test 2: Verify items map to GDPR articles correctly
    - Test 3: Update item status, verify persisted
    - Test 4: Calculate overall status: all GREEN = overall GREEN
    - Test 5: Calculate overall status: any RED = overall RED
    - Test 6: Verify evidence links generated
    - Test 7: Verify ROPA processing activities created
  - [ ] Mock: ComplianceChecklistRepository

- [ ] Task 11: Create Integration Tests (AC: 10)
  - [ ] Create ComplianceChecklistIntegrationTest
    - Setup: Authenticate as COMPLIANCE_OFFICER
    - Test 1: GET compliance checklist, verify all 12 items returned
    - Test 2: Verify all items status=GREEN (compliance complete)
    - Test 3: Verify each item maps to GDPR articles
    - Test 4: Update one item status to YELLOW, verify updated
    - Test 5: GET submission package, verify PDF generated
    - Test 6: Verify PDF includes: cover page, executive summary, detailed checklist, ROPA, security measures
    - Test 7: Verify NBM/CNPF template letter available
    - Test 8: Verify annual review trigger works
    - Test 9: Verify audit log: COMPLIANCE_CHECKLIST_REVIEWED
  - [ ] Use TestContainers for PostgreSQL, iText for PDF verification

## Dev Notes

### Previous Story Insights & Dependencies
- **5.1 Consent Management Framework**: Source of explicit consent capture and withdrawal; provides consent types, audit events, and RBAC restrictions used for checklist evidence.
- **5.2 Privacy Policy & Terms of Service**: Legal content versioning, material-change workflow, and re-consent triggers; evidence for policy publication and version history.
- **5.3 Data Export (GDPR Art. 20)**: Async export flow, secure S3 delivery with SSE-KMS, one-time tokens; evidence for data portability.
- **5.4 Data Deletion (GDPR Art. 17)**: Grace period, SHA-256 anonymization, scheduled erasure, retention carve-outs; evidence for right to erasure and retention policies.
- **5.5 Audit Trail Immutability**: Append-only audit store, tamper detection, retention and archival strategy; evidence for security controls and accountability.
- **5.7 Encryption at Rest & In Transit (GDPR Art. 32)**: TLS 1.3 everywhere, SSE-KMS for S3, field-level encryption where applicable; evidence for security of processing.
- Supporting foundations: **1.6 RBAC** (role `COMPLIANCE_OFFICER`), **1.7 AuditService**, **1.9 Email/Notifications** (review reminders, submission delivery), and data model from **2.x**.

### Technology Stack
[Source: docs/architecture/index.md, 1-system-architecture-overview.md, 4-security-architecture.md, 8-compliance-regulatory.md]
- Spring Boot 3.2.1, Java 21; PostgreSQL 15.4 (Flyway); Redis 7.2.3.
- Security: Spring Security with JWT RBAC; TLS 1.3; hashing and encryption per 5.7.
- Storage: AWS S3 with SSE-KMS for evidence bundles and generated PDFs.
- Observability: Structured JSON logs; immutable audit trail per 5.5.

### Compliance Scope & Legal Basis
- GDPR Articles: 6 (Lawful basis), 7 (Consent), 15 (Access), 16 (Rectification), 17 (Erasure), 20 (Portability), 32 (Security).
- Moldova Law 133/2011 on Personal Data Protection (localization, authority registration, language requirements for policies where applicable).
- Records of Processing Activities (ROPA) maintained and included in submission package; DPIA considered for high-risk processing.

### Evidence Mapping Matrix (What proves each checklist item)
- Explicit Consent → 5.1 endpoints and DB schema; audit events: CONSENT_GIVEN/CONSENT_WITHDRAWN; UI evidence: consent prompts.
- Privacy Policy Published/Versioned → 5.2 legal-doc endpoints, version table, material-change logs; notification template for re-acceptance.
- Data Export → 5.3 export request/fulfillment endpoints, S3 object with SSE-KMS, one-time download token; audit of export issuance and access.
- Data Deletion → 5.4 delete request endpoint, scheduled job config, anonymization function (SHA-256), retention carve-outs; audit events.
- Audit Logs Immutable → 5.5 append-only configuration, integrity verification strategy, retention/archival plan.
- Encryption → 5.7 KMS configuration, TLS enforcement, entity-level encryption strategy where applicable.
- Retention Policy (3 years) → 5.4 and 5.5 policy docs and scheduled archival jobs; lifecycle configuration (S3 Glacier if used).
- DPO Identified → Organizational policy document (docs/compliance/DPO.md) with contact details.
- DPAs & Subprocessors → docs/compliance/data-processing-agreements.md and docs/compliance/subprocessors.md listing email, storage, analytics.
- ROPA → Generated artifact from processing-activity model (Task 7); included in PDF.
- Breach Notification Procedure → docs/security/security-incident-runbook.md including 72-hour notification workflow.

### Directory Structure (proposed locations)
```
docs/compliance/
  DPO.md
  data-processing-agreements.md
  subprocessors.md
  security-incident-runbook.md
  templates/
    NBM_CNPF_LICENSING_REQUEST_TEMPLATE.md

src/main/java/com/creditapp/compliance/
  controller/
  service/
  dto/
  model/
```

### Key Notes
- Checklist is the “evidence index,” not the evidence itself. Each item must link to living artifacts (code, migrations, endpoints, policies, tests).
- Annual review toggles GREEN→YELLOW to force re-validation; create audit entries for transparency.
- Submission package must redact secrets and PII while still proving controls (e.g., show config excerpts, not keys).

### Optional Dependencies (for PDF generation)
- iText, JasperReports, or Apache PDFBox; choose one per org standards. Keep generation deterministic for test verification.

## Testing

### Testing Framework & Location
- Framework: JUnit 5, Spring Boot Test, Mockito; PDF assertions via chosen library utilities.
- Integration: TestContainers (PostgreSQL), Spring Security Test for RBAC.
- Location: `src/test/java/com/creditapp/compliance/` for unit/integration; evidence cross-check tests can live adjacent to producing modules.

### Testing Checklist
- Access Control: `GET /api/compliance/checklist` requires `COMPLIANCE_OFFICER`; borrower/bank-admin receive 403; unauthenticated 401.
- Data Integrity: Returns all predefined items (≥12) with correct GDPR article mappings and non-null statuses.
- Evidence Links: For each GREEN item, evidence link resolves to an existing artifact (file exists or endpoint returns 200).
- Overall Status Logic: All GREEN → overall GREEN; any YELLOW → overall YELLOW; any RED → overall RED.
- Update Flow: `PUT /api/compliance/checklist/{itemId}` updates status and notes; `lastReviewedAt` set; audit event recorded.
- Submission Package: `GET /api/compliance/submission-package` returns a PDF that includes:
  - Cover, Executive Summary (counts by status), Detailed Checklist with articles and evidence, ROPA section, Security Measures, Retention Schedule, Subprocessors, DPO contact, Attestation.
  - PDF metadata includes generation timestamp and checklist version.
- ROPA Generation: Task 7 produces entries matching predefined processing activities; PDF contains those entries.
- Annual Review: Scheduled job or API sets items to YELLOW, sends email, writes `COMPLIANCE_ANNUAL_REVIEW_INITIATED` audit event.
- Encryption Assertions: Evidence items referencing 5.7 include KMS-enabled S3 artifacts and TLS config; redaction verified (no secrets in package).
- Localization: If Moldovan-language policy is required, verify presence of RO/RU variants in evidence for 5.2.
- Performance: Checklist endpoint responds <200ms p95 with typical dataset; PDF generation completes within acceptable bounds (e.g., <5s) for standard content.
- Coverage: Target ≥80% across compliance service/controller; ensure negative-path tests for RBAC and missing evidence.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - GDPR & Moldovan Data Protection Compliance Checklist | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
