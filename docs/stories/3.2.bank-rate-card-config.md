# Story 3.2: Bank Rate Card Configuration API

## Status
Ready for Development

## Story

**As a** bank administrator,
**I want** to configure my bank's loan calculator formulas in the admin panel,
**so that** the platform can simulate what my bank's calculator would return for borrower applications.

## Acceptance Criteria

1. POST /api/bank/rate-cards endpoint creates rate card for loan type/currency
2. Request body: loan_type, currency, min_loan_amount, max_loan_amount, base_apr, apr_adjustment_range, origination_fee_percent, insurance_percent (optional)
3. Rate card represents bank's calculator formula: banks manually enter parameters their website calculators use
4. Validation: min < max, APR ranges 0.5-50%, origination_fee 0-10%, insurance 0-5%
5. Rate cards versioned: new card marks previous version inactive
6. GET /api/bank/rate-cards returns all active rate cards for authenticated bank
7. PUT /api/bank/rate-cards/{rateCardId} updates existing card (creates new version, marks old inactive)
8. Soft-delete preserves history (valid_from, valid_to timestamps)
9. Only BANK_ADMIN role can create/update rate cards
10. Integration test: create rate card, verify appears, update, verify calculations use updated rates

## Tasks / Subtasks

- [ ] Task 1: Create Request Validation DTOs (AC: 2, 3, 4)
  - [ ] Create BankRateCardRequest DTO
    - Fields: loanType (PERSONAL, HOME, AUTO, etc.), currency (EUR, USD, MDL), minLoanAmount (100-1M), maxLoanAmount (100-1M), baseApr (0.5-50%), aprAdjustmentRange (0-5%), originationFeePercent (0-10%), insurancePercent (0-5%)
    - Validations: @DecimalMin, @DecimalMax, @NotBlank, minLoanAmount < maxLoanAmount

  - [ ] Create BankRateCardResponse DTO
    - Fields: id, loanType, currency, minLoanAmount, maxLoanAmount, baseApr, aprAdjustmentRange, originationFeePercent, insurancePercent, validFrom, validTo (nullable), active (boolean)

- [ ] Task 2: Create Bank Rate Card Service (AC: 3, 5, 7)
  - [ ] Create BankRateCardService
    - Method: createRateCard(UUID bankId, BankRateCardRequest request) returns BankRateCardResponse
      - Validate request parameters
      - Mark any existing active rate card (same loan_type, currency, valid_to IS NULL) as inactive (set valid_to = now)
      - Create new BankRateCard entity with valid_from = now, valid_to = NULL
      - Save to BankRateCardRepository
      - Log RATE_CARD_CREATED audit event
      - Return BankRateCardResponse
      
    - Method: updateRateCard(UUID bankId, UUID rateCardId, BankRateCardRequest request) returns BankRateCardResponse
      - Verify bank owns rate card
      - Instead of updating, create new version (mark old as inactive, create new card)
      - Log RATE_CARD_UPDATED audit event
      - Return BankRateCardResponse for new version

    - Method: getActiveRateCards(UUID bankId) returns List<BankRateCardResponse>
      - Query rate cards where valid_to IS NULL
      - Return list of active rate cards for bank

    - Method: getRateCardsByLoanType(UUID bankId, String loanType, String currency) returns BankRateCardResponse
      - Find active rate card for specific loan_type and currency
      - Return most recent active card
      - Throw RateCardNotFoundException if not configured

  - [ ] Unit tests: mock repository, test versioning logic, test validation

- [ ] Task 3: Create REST Controller Endpoints (AC: 1, 6, 7, 9)
  - [ ] Create BankAdminRateCardController (src/main/java/com/creditapp/bank/controller/BankAdminRateCardController.java)
    - POST /api/bank/rate-cards
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Extract bankId from SecurityContext
      - Accept @Valid BankRateCardRequest
      - Call BankRateCardService.createRateCard(bankId, request)
      - Return 201 Created with BankRateCardResponse
      - Error handling: 400 Bad Request (validation), 409 Conflict (duplicate config)

    - GET /api/bank/rate-cards
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Extract bankId from SecurityContext
      - Call BankRateCardService.getActiveRateCards(bankId)
      - Return 200 OK with List<BankRateCardResponse>

    - PUT /api/bank/rate-cards/{rateCardId}
      - @PreAuthorize("hasAuthority('BANK_ADMIN')")
      - Extract bankId from SecurityContext
      - Accept @Valid BankRateCardRequest
      - Call BankRateCardService.updateRateCard(bankId, rateCardId, request)
      - Return 200 OK with updated BankRateCardResponse
      - Error handling: 404 Not Found (rate card), 403 Forbidden (different bank)

  - [ ] Add exception handlers to GlobalExceptionHandler
    - RateCardNotFoundException (404)
    - InvalidRateCardException (400)
    - DuplicateRateCardException (409)

  - [ ] Unit tests: mock service, test endpoints and error paths
  - [ ] Integration tests: real HTTP requests with BANK_ADMIN JWT token

- [ ] Task 4: Create Rate Card Versioning Logic (AC: 5, 8)
  - [ ] Verify BankRateCard entity has valid_from and valid_to fields
  - [ ] Implement version marking:
    - When new rate card created, find existing active (valid_to IS NULL)
    - Set valid_to = now on old card
    - Create new card with valid_from = now, valid_to = NULL
  - [ ] Query logic: always fetch rate card where valid_to IS NULL for "active" cards
  - [ ] Unit tests: verify versioning transitions correctly

- [ ] Task 5: Create Data Validation (AC: 4)
  - [ ] Validation rules in service:
    - minLoanAmount: >= 100
    - maxLoanAmount: >= minLoanAmount, <= 1,000,000
    - baseApr: >= 0.5, <= 50.0
    - aprAdjustmentRange: >= 0, <= 5.0
    - originationFeePercent: >= 0, <= 10.0
    - insurancePercent: >= 0, <= 5.0
  - [ ] Add @Min, @Max, @DecimalMin, @DecimalMax annotations to DTO

- [ ] Task 6: Create Audit Logging (AC: 1, 7)
  - [ ] Ensure service logs to AuditService:
    - Event: RATE_CARD_CREATED when new card created
    - Event: RATE_CARD_UPDATED when existing card updated (versioning)
    - Fields: bankId, loanType, currency, baseApr, aprAdjustmentRange

- [ ] Task 7: Create API Documentation (AC: 1, 6, 7)
  - [ ] Update docs/API_ENDPOINTS.md
    - POST /api/bank/rate-cards
      - Request: { "loanType": "PERSONAL", "currency": "EUR", "minLoanAmount": 5000, "maxLoanAmount": 100000, "baseApr": 8.5, "aprAdjustmentRange": 3.0, "originationFeePercent": 2.5, "insurancePercent": 0.5 }
      - Response (201): { "id": "...", "loanType": "PERSONAL", "currency": "EUR", "baseApr": 8.5, "active": true, "validFrom": "2026-01-14T10:30:00Z" }
    - GET /api/bank/rate-cards
      - Response (200): List of active rate cards
    - PUT /api/bank/rate-cards/{rateCardId}
      - Same request/response as POST (creates new version)

- [ ] Task 8: Create Integration Tests (AC: 9, 10)
  - [ ] Create BankRateCardIntegrationTest
    - Setup: Authenticate as BANK_ADMIN, get JWT token
    - Test 1: Create valid rate card, verify 201 and persisted
    - Test 2: Create rate card, verify marks previous as inactive
    - Test 3: GET rate cards, verify returns active cards only
    - Test 4: Update rate card, verify new version created, old marked inactive
    - Test 5: Invalid min/max amounts, verify 400 Bad Request
    - Test 6: APR out of range, verify 400 Bad Request
    - Test 7: Non-BANK_ADMIN role, verify 403 Forbidden
    - Test 8: Verify calculations use updated rate card from database

  - [ ] Use TestContainers for PostgreSQL, TestRestTemplate for HTTP

## Dev Notes

### Previous Story Insights
- **Story 1.4**: Bank admin registration (BANK_ADMIN role)
- **Story 1.6**: RBAC - @PreAuthorize for BANK_ADMIN only
- **Story 3.1**: BankRateCard entity and repository

### Technology Stack
[Source: architecture/1-system-architecture-overview.md]
- **Framework**: Spring Boot 3.2.1, Spring Web
- **Validation**: Hibernate Validator
- **Financial Calculations**: BigDecimal for precision

### API Specification
[Source: architecture/2-detailed-service-architecture.md]
- Endpoint pattern: /api/bank/rate-cards
- Only BANK_ADMIN authenticated access
- Versioning: immutable history

### Project Directory Structure
`
src/main/java/com/creditapp/
 bank/
    controller/        # BankAdminRateCardController.java
    service/           # BankRateCardService.java (updated)
    dto/               # BankRateCardRequest.java, BankRateCardResponse.java
    exception/         # RateCardNotFoundException.java, etc.
`

## Testing

### Testing Checklist
- [ ] BankRateCardRequest validates all fields correctly
- [ ] Service creates rate card with valid parameters
- [ ] Service marks previous card inactive on new creation
- [ ] Service creates new version on update (doesn't modify existing)
- [ ] GET returns only active rate cards (valid_to IS NULL)
- [ ] POST endpoint returns 201 Created
- [ ] GET endpoint returns 200 OK with list
- [ ] PUT endpoint returns 200 OK with new version
- [ ] BANK_ADMIN role required (403 for others)
- [ ] Invalid parameter values return 400 Bad Request
- [ ] Duplicate rate card handling verified
- [ ] Audit logging: RATE_CARD_CREATED and RATE_CARD_UPDATED events
- [ ] Integration test: create, verify in database, update, verify versioning
- [ ] All tests pass with mvn clean test
- [ ] Code coverage >80%

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-14 | 1.0 | Initial story draft - Bank Rate Card Configuration API | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*To be completed by development agent*

### Debug Log References
*To be completed by development agent*

### Completion Notes
*To be completed by development agent*

### File List
*To be completed by development agent*

## QA Results

*To be completed by QA agent after story is implemented*
