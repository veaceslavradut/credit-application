<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BankOfferExpirationNotificationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.bank.service</a> &gt; <span class="el_source">BankOfferExpirationNotificationService.java</span></div><h1>BankOfferExpirationNotificationService.java</h1><pre class="source lang-java linenums">package com.creditapp.bank.service;

import com.creditapp.bank.model.Offer;
import com.creditapp.borrower.model.Application;
import com.creditapp.borrower.repository.ApplicationRepository;
import com.creditapp.shared.model.Organization;
import com.creditapp.shared.model.User;
import com.creditapp.shared.repository.OrganizationRepository;
import com.creditapp.shared.service.AuditService;
import com.creditapp.shared.service.EmailService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.UUID;

/**
 * Service for sending expiration notifications to banks when offers are about to expire.
 * Part of Story 4.6 - Offer Expiration Notification.
 */
@Service
<span class="fc" id="L26">@RequiredArgsConstructor</span>
<span class="fc" id="L27">@Slf4j</span>
public class BankOfferExpirationNotificationService {
    
    private final OrganizationRepository organizationRepository;
    private final ApplicationRepository applicationRepository;
    private final EmailService emailService;
    private final AuditService auditService;
    private final BankNotificationService notificationService;
    
    @Value(&quot;${app.base-url:http://localhost:8080}&quot;)
    private String baseUrl;
    
    /**
     * Send expiration notification to bank via email.
     * Runs asynchronously to avoid blocking the batch job.
     * 
     * @param offer The offer that is about to expire
     * @return true if notification sent successfully, false otherwise
     */
    @Async
    public void notifyBankOfExpiration(Offer offer) {
        try {
            // Fetch bank organization
<span class="nc" id="L50">            Organization bank = organizationRepository.findById(offer.getBankId())</span>
<span class="nc" id="L51">                    .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Bank not found: &quot; + offer.getBankId()));</span>
            
            // Fetch application for borrower details
<span class="nc" id="L54">            Application application = applicationRepository.findById(offer.getApplicationId())</span>
<span class="nc" id="L55">                    .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Application not found: &quot; + offer.getApplicationId()));</span>
            
            // Calculate hours remaining until expiration
<span class="nc" id="L58">            long hoursRemaining = Duration.between(LocalDateTime.now(), offer.getExpiresAt()).toHours();</span>
            
            // Build email content
<span class="nc" id="L61">            String subject = String.format(&quot;Offer Expiring Soon - Application %s&quot;, application.getId());</span>
            
<span class="nc" id="L63">            StringBuilder htmlContent = new StringBuilder();</span>
<span class="nc" id="L64">            htmlContent.append(&quot;&lt;html&gt;&lt;body&gt;&quot;);</span>
<span class="nc" id="L65">            htmlContent.append(&quot;&lt;h2&gt;Offer Expiration Warning&lt;/h2&gt;&quot;);</span>
<span class="nc" id="L66">            htmlContent.append(&quot;&lt;p&gt;Your loan offer is about to expire:&lt;/p&gt;&quot;);</span>
<span class="nc" id="L67">            htmlContent.append(&quot;&lt;ul&gt;&quot;);</span>
<span class="nc" id="L68">            htmlContent.append(&quot;&lt;li&gt;&lt;strong&gt;Application ID:&lt;/strong&gt; &quot;).append(application.getId()).append(&quot;&lt;/li&gt;&quot;);</span>
<span class="nc" id="L69">            htmlContent.append(&quot;&lt;li&gt;&lt;strong&gt;Borrower Loan Amount:&lt;/strong&gt; $&quot;).append(application.getLoanAmount()).append(&quot;&lt;/li&gt;&quot;);</span>
<span class="nc" id="L70">            htmlContent.append(&quot;&lt;li&gt;&lt;strong&gt;Your APR:&lt;/strong&gt; &quot;).append(offer.getApr()).append(&quot;%&lt;/li&gt;&quot;);</span>
<span class="nc" id="L71">            htmlContent.append(&quot;&lt;li&gt;&lt;strong&gt;Monthly Payment:&lt;/strong&gt; $&quot;).append(offer.getMonthlyPayment()).append(&quot;&lt;/li&gt;&quot;);</span>
<span class="nc" id="L72">            htmlContent.append(&quot;&lt;li&gt;&lt;strong&gt;Hours Remaining:&lt;/strong&gt; &quot;).append(hoursRemaining).append(&quot; hours&lt;/li&gt;&quot;);</span>
<span class="nc" id="L73">            htmlContent.append(&quot;&lt;/ul&gt;&quot;);</span>
<span class="nc" id="L74">            htmlContent.append(&quot;&lt;p&gt;&lt;strong&gt;Actions:&lt;/strong&gt;&lt;/p&gt;&quot;);</span>
<span class="nc" id="L75">            htmlContent.append(&quot;&lt;p&gt;&lt;a href=\&quot;&quot;).append(baseUrl).append(&quot;/api/bank/applications/&quot;).append(application.getId()).append(&quot;\&quot;&gt;Review Application&lt;/a&gt;&lt;/p&gt;&quot;);</span>
<span class="nc" id="L76">            htmlContent.append(&quot;&lt;p&gt;&lt;a href=\&quot;&quot;).append(baseUrl).append(&quot;/api/bank/offers/&quot;).append(offer.getId()).append(&quot;/resubmit&quot;).append(&quot;\&quot;&gt;Resubmit Offer&lt;/a&gt;&lt;/p&gt;&quot;);</span>
<span class="nc" id="L77">            htmlContent.append(&quot;&lt;p&gt;If no action is taken, the offer will expire automatically.&lt;/p&gt;&quot;);</span>
<span class="nc" id="L78">            htmlContent.append(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
            
<span class="nc" id="L80">            String textContent = String.format(</span>
                    &quot;Offer Expiration Warning\n\n&quot; +
                            &quot;Your loan offer is about to expire:\n&quot; +
                            &quot;Application ID: %s\n&quot; +
                            &quot;Borrower Loan Amount: $%s\n&quot; +
                            &quot;Your APR: %s%%\n&quot; +
                            &quot;Monthly Payment: $%s\n&quot; +
                            &quot;Hours Remaining: %d hours\n\n&quot; +
                            &quot;Review Application: %s/api/bank/applications/%s\n&quot; +
                            &quot;Resubmit Offer: %s/api/bank/offers/%s/resubmit\n\n&quot; +
                            &quot;If no action is taken, the offer will expire automatically.&quot;,
<span class="nc" id="L91">                    application.getId(),</span>
<span class="nc" id="L92">                    application.getLoanAmount(),</span>
<span class="nc" id="L93">                    offer.getApr(),</span>
<span class="nc" id="L94">                    offer.getMonthlyPayment(),</span>
<span class="nc" id="L95">                    hoursRemaining,</span>
<span class="nc" id="L96">                    baseUrl, application.getId(),</span>
<span class="nc" id="L97">                    baseUrl, offer.getId()</span>
            );
            
            // Send email
<span class="nc" id="L101">            emailService.sendEmail(bank.getContactEmail(), subject, htmlContent.toString(), textContent);</span>
            
            // Create in-portal notification
<span class="nc" id="L104">            String notificationTitle = String.format(&quot;Offer Expiring in %d hours&quot;, hoursRemaining);</span>
<span class="nc" id="L105">            String notificationMessage = String.format(</span>
                    &quot;Your offer for application %s (APR: %s%%, Payment: $%s) expires in %d hours. Take action to resubmit or review.&quot;,
<span class="nc" id="L107">                    application.getId().toString().substring(0, 8),</span>
<span class="nc" id="L108">                    offer.getApr(),</span>
<span class="nc" id="L109">                    offer.getMonthlyPayment(),</span>
<span class="nc" id="L110">                    hoursRemaining</span>
            );
<span class="nc" id="L112">            String notificationLink = String.format(&quot;/bank/offers/%s/resubmit&quot;, offer.getId());</span>
            
<span class="nc" id="L114">            notificationService.createNotification(</span>
<span class="nc" id="L115">                    offer.getBankId(),</span>
                    &quot;OFFER_EXPIRING&quot;,
                    notificationTitle,
                    notificationMessage,
                    notificationLink
            );
            
            // Create audit log
<span class="nc" id="L123">            auditService.logAction(</span>
                    &quot;OFFER&quot;,
<span class="nc" id="L125">                    offer.getId(),</span>
                    com.creditapp.shared.model.AuditAction.OFFER_EXPIRATION_NOTIFICATION_SENT,
<span class="nc" id="L127">                    offer.getBankId(),</span>
                    &quot;BANK&quot;
            );
            
<span class="nc" id="L131">            log.info(&quot;Offer expiration notification sent to bank {}. OfferId: {}, ApplicationId: {}, Hours remaining: {}&quot;,</span>
<span class="nc" id="L132">                    bank.getName(), offer.getId(), application.getId(), hoursRemaining);</span>
                    
<span class="nc" id="L134">        } catch (Exception e) {</span>
<span class="nc" id="L135">            log.error(&quot;Failed to send offer expiration notification. OfferId: {}, Error: {}&quot;,</span>
<span class="nc" id="L136">                    offer.getId(), e.getMessage(), e);</span>
<span class="nc" id="L137">        }</span>
<span class="nc" id="L138">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>