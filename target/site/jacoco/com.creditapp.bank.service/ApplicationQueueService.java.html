<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationQueueService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.bank.service</a> &gt; <span class="el_source">ApplicationQueueService.java</span></div><h1>ApplicationQueueService.java</h1><pre class="source lang-java linenums">package com.creditapp.bank.service;

import com.creditapp.bank.dto.ApplicationQueueItem;
import com.creditapp.bank.dto.ApplicationQueueRequest;
import com.creditapp.bank.dto.ApplicationQueueResponse;
import com.creditapp.bank.model.Offer;
import com.creditapp.bank.model.OfferStatus;
import com.creditapp.bank.repository.OfferRepository;
import com.creditapp.borrower.model.Application;
import com.creditapp.borrower.model.ApplicationStatus;
import com.creditapp.borrower.repository.ApplicationDocumentRepository;
import com.creditapp.borrower.repository.ApplicationRepository;
import com.creditapp.shared.model.ApplicationQueueMetrics;
import com.creditapp.shared.util.PaginationUtils;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Collectors;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;

@Service
<span class="fc" id="L35">@RequiredArgsConstructor</span>
<span class="fc" id="L36">@Slf4j</span>
public class ApplicationQueueService {
    private final OfferRepository offerRepository;
    private final ApplicationRepository applicationRepository;
    private final ApplicationDocumentRepository applicationDocumentRepository;

    public ApplicationQueueResponse getApplicationQueue(UUID bankId, ApplicationQueueRequest request) {
<span class="nc" id="L43">        long start = System.currentTimeMillis();</span>
<span class="nc" id="L44">        log.debug(&quot;[QUEUE] Querying application queue for bankId={}, request={}&quot;, bankId, request);</span>

        // Basic validation
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (bankId == null) {</span>
<span class="nc" id="L48">            log.warn(&quot;[QUEUE] Missing bankId for queue request&quot;);</span>
<span class="nc" id="L49">            return emptyResponse(request);</span>
        }
<span class="nc" id="L51">        int limit = safeLimit(request.getLimit());</span>
<span class="nc" id="L52">        int offset = safeOffset(request.getOffset());</span>
<span class="nc" id="L53">        Sort sort = Sort.by(Sort.Direction.DESC, &quot;createdAt&quot;);</span>
<span class="nc" id="L54">        Pageable pageable = PaginationUtils.validateAndGetPageable(limit, offset, sort);</span>

<span class="nc" id="L56">        Page&lt;Offer&gt; offerPage = offerRepository.findByBankId(bankId, pageable);</span>
<span class="nc" id="L57">        List&lt;Offer&gt; offers = offerPage.getContent();</span>

        // Deduplicate applications preserving order (most recent offer first)
<span class="nc" id="L60">        Set&lt;UUID&gt; applicationIdsOrdered = offers.stream()</span>
<span class="nc" id="L61">            .map(Offer::getApplicationId)</span>
<span class="nc" id="L62">            .collect(Collectors.toCollection(LinkedHashSet::new));</span>
<span class="nc" id="L63">        List&lt;UUID&gt; applicationIds = new ArrayList&lt;&gt;(applicationIdsOrdered);</span>

<span class="nc bnc" id="L65" title="All 2 branches missed.">        if (applicationIds.isEmpty()) {</span>
<span class="nc" id="L66">            ApplicationQueueMetrics metrics = ApplicationQueueMetrics.builder()</span>
<span class="nc" id="L67">                .totalApplications(0)</span>
<span class="nc" id="L68">                .documentsAwaitingReview(0)</span>
<span class="nc" id="L69">                .approvedCount(0)</span>
<span class="nc" id="L70">                .rejectedCount(0)</span>
<span class="nc" id="L71">                .build();</span>
<span class="nc" id="L72">            ApplicationQueueResponse response = ApplicationQueueResponse.builder()</span>
<span class="nc" id="L73">                .applications(Collections.emptyList())</span>
<span class="nc" id="L74">                .totalCount(0)</span>
<span class="nc" id="L75">                .limit(limit)</span>
<span class="nc" id="L76">                .offset(offset)</span>
<span class="nc" id="L77">                .hasMore(false)</span>
<span class="nc" id="L78">                .queueMetrics(metrics)</span>
<span class="nc" id="L79">                .retrievedAt(LocalDateTime.now())</span>
<span class="nc" id="L80">                .build();</span>
<span class="nc" id="L81">            logQueuePerf(start, bankId, response.getTotalCount());</span>
<span class="nc" id="L82">            return response;</span>
        }

        // Load applications
<span class="nc" id="L86">        List&lt;Application&gt; applications = applicationRepository.findAllById(applicationIds);</span>
<span class="nc" id="L87">        Map&lt;UUID, Application&gt; applicationMap = applications.stream()</span>
<span class="nc" id="L88">            .filter(Objects::nonNull)</span>
<span class="nc" id="L89">            .collect(Collectors.toMap(Application::getId, a -&gt; a));</span>

        // Build queue items
<span class="nc" id="L92">        List&lt;ApplicationQueueItem&gt; items = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L93">        int docsAwaitingReview = 0;</span>
<span class="nc" id="L94">        int approvedCount = 0;</span>
<span class="nc" id="L95">        int rejectedCount = 0;</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">        for (UUID appId : applicationIds) {</span>
<span class="nc" id="L98">            Application app = applicationMap.get(appId);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (app == null) continue;</span>

<span class="nc" id="L101">            Offer selected = selectOfferForBankApp(offers, appId, bankId);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            BigDecimal apr = selected != null ? selected.getApr() : null;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            BigDecimal monthlyPayment = selected != null ? selected.getMonthlyPayment() : null;</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">            String borrowerName = app.getBorrower() != null</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">                ? ((app.getBorrower().getFirstName() != null ? app.getBorrower().getFirstName() : &quot;&quot;)</span>
                   + &quot; &quot;
<span class="nc bnc" id="L108" title="All 2 branches missed.">                   + (app.getBorrower().getLastName() != null ? app.getBorrower().getLastName() : &quot;&quot;)).trim()</span>
<span class="nc" id="L109">                : null;</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            String borrowerEmail = app.getBorrower() != null ? app.getBorrower().getEmail() : null;</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            String borrowerPhone = app.getBorrower() != null</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                ? (app.getBorrower().getPhoneNumber() != null ? app.getBorrower().getPhoneNumber() : app.getBorrower().getPhone())</span>
<span class="nc" id="L113">                : null;</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">            String documentsStatus = applicationDocumentRepository.findByApplicationIdAndDeletedAtIsNull(appId).isEmpty()</span>
<span class="nc" id="L116">                ? &quot;none&quot; : &quot;submitted&quot;;</span>
<span class="nc" id="L117">            String approvalStatus = deriveApprovalStatus(app.getStatus());</span>

<span class="nc bnc" id="L119" title="All 4 branches missed.">            docsAwaitingReview += (&quot;submitted&quot;.equals(documentsStatus) &amp;&amp; &quot;pending&quot;.equals(approvalStatus)) ? 1 : 0;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            approvedCount += (&quot;approved&quot;.equals(approvalStatus)) ? 1 : 0;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            rejectedCount += (&quot;rejected&quot;.equals(approvalStatus)) ? 1 : 0;</span>

<span class="nc" id="L123">            items.add(ApplicationQueueItem.builder()</span>
<span class="nc" id="L124">                .applicationId(app.getId())</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                .referenceNumber(app.getId() != null ? app.getId().toString() : null)</span>
<span class="nc" id="L126">                .borrowerName(borrowerName)</span>
<span class="nc" id="L127">                .borrowerEmail(borrowerEmail)</span>
<span class="nc" id="L128">                .borrowerPhone(borrowerPhone)</span>
<span class="nc" id="L129">                .loanAmount(app.getLoanAmount())</span>
<span class="nc" id="L130">                .termMonths(app.getLoanTermMonths())</span>
<span class="nc" id="L131">                .selectedOfferAPR(apr)</span>
<span class="nc" id="L132">                .selectedOfferMonthlyPayment(monthlyPayment)</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                .status(app.getStatus() != null ? app.getStatus().name() : null)</span>
<span class="nc" id="L134">                .receivedAt(app.getCreatedAt())</span>
<span class="nc" id="L135">                .submittedAt(app.getSubmittedAt())</span>
<span class="nc" id="L136">                .lastUpdatedAt(app.getUpdatedAt())</span>
<span class="nc" id="L137">                .documentsStatus(documentsStatus)</span>
<span class="nc" id="L138">                .approvalStatus(approvalStatus)</span>
<span class="nc" id="L139">                .actionItems(Collections.emptyList())</span>
<span class="nc" id="L140">                .build());</span>
<span class="nc" id="L141">        }</span>

<span class="nc" id="L143">        long totalDistinct = Optional.ofNullable(offerRepository.countDistinctApplicationsByBankId(bankId)).orElse(0L);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        boolean hasMore = offset + items.size() &lt; totalDistinct;</span>

<span class="nc" id="L146">        ApplicationQueueMetrics metrics = ApplicationQueueMetrics.builder()</span>
<span class="nc" id="L147">            .totalApplications((int) totalDistinct)</span>
<span class="nc" id="L148">            .documentsAwaitingReview(docsAwaitingReview)</span>
<span class="nc" id="L149">            .approvedCount(approvedCount)</span>
<span class="nc" id="L150">            .rejectedCount(rejectedCount)</span>
<span class="nc" id="L151">            .build();</span>

<span class="nc" id="L153">        ApplicationQueueResponse response = ApplicationQueueResponse.builder()</span>
<span class="nc" id="L154">            .applications(items)</span>
<span class="nc" id="L155">            .totalCount((int) totalDistinct)</span>
<span class="nc" id="L156">            .limit(limit)</span>
<span class="nc" id="L157">            .offset(offset)</span>
<span class="nc" id="L158">            .hasMore(hasMore)</span>
<span class="nc" id="L159">            .queueMetrics(metrics)</span>
<span class="nc" id="L160">            .retrievedAt(LocalDateTime.now())</span>
<span class="nc" id="L161">            .build();</span>

<span class="nc" id="L163">        logQueuePerf(start, bankId, response.getTotalCount());</span>
<span class="nc" id="L164">        return response;</span>
    }

    private ApplicationQueueResponse emptyResponse(ApplicationQueueRequest request) {
<span class="nc" id="L168">        return ApplicationQueueResponse.builder()</span>
<span class="nc" id="L169">            .applications(Collections.&lt;ApplicationQueueItem&gt;emptyList())</span>
<span class="nc" id="L170">            .totalCount(0)</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">            .limit(safeLimit(request != null ? request.getLimit() : null))</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            .offset(safeOffset(request != null ? request.getOffset() : null))</span>
<span class="nc" id="L173">            .hasMore(false)</span>
<span class="nc" id="L174">            .queueMetrics(ApplicationQueueMetrics.builder().build())</span>
<span class="nc" id="L175">            .retrievedAt(LocalDateTime.now())</span>
<span class="nc" id="L176">            .build();</span>
    }

    private int safeLimit(Integer limit) {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        int l = limit == null ? 20 : limit;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        if (l &lt;= 0) l = 20;</span>
<span class="nc" id="L182">        return Math.min(l, 100);</span>
    }

    private int safeOffset(Integer offset) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">        int o = offset == null ? 0 : offset;</span>
<span class="nc" id="L187">        return Math.max(o, 0);</span>
    }

    private void logQueuePerf(long start, UUID bankId, int totalCount) {
<span class="nc" id="L191">        long took = System.currentTimeMillis() - start;</span>
<span class="nc" id="L192">        log.info(&quot;[QUEUE] Retrieved {} applications for bankId={} in {}ms&quot;, totalCount, bankId, took);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (took &gt; 200) {</span>
<span class="nc" id="L194">            log.warn(&quot;[QUEUE] Performance warning: query took {}ms (&gt;200ms)&quot;, took);</span>
        }
<span class="nc" id="L196">    }</span>

    private Offer selectOfferForBankApp(List&lt;Offer&gt; offersForBankPage, UUID applicationId, UUID bankId) {
        // Prefer accepted offer if it belongs to this bank
<span class="nc" id="L200">        Optional&lt;Offer&gt; acceptedAnyBank = offerRepository.findByApplicationIdAndOfferStatus(applicationId, OfferStatus.ACCEPTED);</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">        if (acceptedAnyBank.isPresent() &amp;&amp; bankId.equals(acceptedAnyBank.get().getBankId())) {</span>
<span class="nc" id="L202">            return acceptedAnyBank.get();</span>
        }
        // Otherwise choose the lowest APR offer from this bank present in page content
<span class="nc" id="L205">        return offersForBankPage.stream()</span>
<span class="nc" id="L206">            .filter(o -&gt; applicationId.equals(o.getApplicationId()))</span>
<span class="nc" id="L207">            .min((a, b) -&gt; a.getApr().compareTo(b.getApr()))</span>
<span class="nc" id="L208">            .orElse(null);</span>
    }

    private String deriveApprovalStatus(ApplicationStatus status) {
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (status == null) return &quot;pending&quot;;</span>
<span class="nc bnc" id="L213" title="All 3 branches missed.">        return switch (status) {</span>
<span class="nc" id="L214">            case ACCEPTED, COMPLETED -&gt; &quot;approved&quot;;</span>
<span class="nc" id="L215">            case REJECTED -&gt; &quot;rejected&quot;;</span>
<span class="nc" id="L216">            default -&gt; &quot;pending&quot;;</span>
        };
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>