<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BankOfferSubmissionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.bank.service</a> &gt; <span class="el_source">BankOfferSubmissionService.java</span></div><h1>BankOfferSubmissionService.java</h1><pre class="source lang-java linenums">package com.creditapp.bank.service;

import com.creditapp.bank.dto.BankOfferSubmissionRequest;
import com.creditapp.bank.dto.BankOfferSubmissionResponse;
import com.creditapp.bank.model.Offer;
import com.creditapp.bank.model.OfferStatus;
import com.creditapp.bank.repository.OfferRepository;
import com.creditapp.borrower.model.Application;
import com.creditapp.borrower.repository.ApplicationRepository;
import com.creditapp.shared.exception.NotFoundException;
import com.creditapp.shared.model.AuditAction;
import com.creditapp.shared.service.AuditService;
import com.creditapp.shared.service.BankOfferSubmissionEmailService;
import com.creditapp.shared.util.CalculationUtils;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.*;

@Service
<span class="fc" id="L25">@RequiredArgsConstructor</span>
<span class="fc" id="L26">@Slf4j</span>
public class BankOfferSubmissionService {

    private final ApplicationRepository applicationRepository;
    private final OfferRepository offerRepository;
    private final AuditService auditService;
    private final BankOfferSubmissionEmailService emailService;

    @Transactional
    public BankOfferSubmissionResponse submitOffer(
            UUID bankId,
            UUID officerId,
            BankOfferSubmissionRequest request) {
        
<span class="fc" id="L40">        long start = System.currentTimeMillis();</span>
<span class="fc" id="L41">        log.debug(&quot;[OFFER_SUBMIT] Bank officer {} submitting offer for application {}&quot;,</span>
<span class="fc" id="L42">                officerId, request.getApplicationId());</span>

        // Fetch and validate application
<span class="fc" id="L45">        Application application = applicationRepository.findById(request.getApplicationId())</span>
<span class="fc" id="L46">                .orElseThrow(() -&gt; new NotFoundException(&quot;Application not found: &quot; + request.getApplicationId()));</span>

        // Validate loan amount matches
<span class="fc bfc" id="L49" title="All 2 branches covered.">        if (application.getLoanAmount() == null) {</span>
<span class="fc" id="L50">            throw new IllegalArgumentException(&quot;Application loan amount is not set&quot;);</span>
        }

        // Get term months (from request or application)
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        Integer termMonths = request.getTermMonths() != null </span>
<span class="nc" id="L55">                ? request.getTermMonths() </span>
<span class="fc" id="L56">                : application.getLoanTermMonths();</span>

<span class="fc bfc" id="L58" title="All 2 branches covered.">        if (termMonths == null) {</span>
<span class="fc" id="L59">            throw new IllegalArgumentException(&quot;Term months must be provided&quot;);</span>
        }

        // Calculate monthly payment if not provided
<span class="fc" id="L63">        BigDecimal monthlyPayment = request.getMonthlyPayment();</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (monthlyPayment == null) {</span>
<span class="fc" id="L65">            monthlyPayment = CalculationUtils.calculateMonthlyPayment(</span>
<span class="fc" id="L66">                    application.getLoanAmount(),</span>
<span class="fc" id="L67">                    termMonths,</span>
<span class="fc" id="L68">                    request.getApr()</span>
            );
<span class="fc" id="L70">            log.debug(&quot;[OFFER_SUBMIT] Calculated monthly payment: {}&quot;, monthlyPayment);</span>
        }

        // Calculate total cost if not provided
<span class="fc" id="L74">        BigDecimal totalCost = request.getTotalCost();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (totalCost == null) {</span>
<span class="fc" id="L76">            totalCost = monthlyPayment.multiply(BigDecimal.valueOf(termMonths));</span>
<span class="fc" id="L77">            log.debug(&quot;[OFFER_SUBMIT] Calculated total cost: {}&quot;, totalCost);</span>
        }

        // Calculate origination fee if not provided (default 1.5%)
<span class="fc" id="L81">        BigDecimal originationFee = request.getOriginationFee();</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (originationFee == null) {</span>
<span class="fc" id="L83">            originationFee = application.getLoanAmount()</span>
<span class="fc" id="L84">                    .multiply(BigDecimal.valueOf(0.015));</span>
<span class="fc" id="L85">            log.debug(&quot;[OFFER_SUBMIT] Calculated origination fee: {}&quot;, originationFee);</span>
        }

        // Calculate insurance cost if not provided (default 0.5%)
<span class="fc" id="L89">        BigDecimal insuranceCost = request.getInsuranceCost();</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (insuranceCost == null) {</span>
<span class="fc" id="L91">            insuranceCost = application.getLoanAmount()</span>
<span class="fc" id="L92">                    .multiply(BigDecimal.valueOf(0.005));</span>
<span class="fc" id="L93">            log.debug(&quot;[OFFER_SUBMIT] Calculated insurance cost: {}&quot;, insuranceCost);</span>
        }

        // Create new offer
<span class="fc" id="L97">        Offer offer = new Offer();</span>
<span class="fc" id="L98">        offer.setId(UUID.randomUUID());</span>
<span class="fc" id="L99">        offer.setApplicationId(request.getApplicationId());</span>
<span class="fc" id="L100">        offer.setBankId(bankId);</span>
<span class="fc" id="L101">        offer.setOfferStatus(OfferStatus.SUBMITTED);</span>
<span class="fc" id="L102">        offer.setApr(request.getApr());</span>
<span class="fc" id="L103">        offer.setMonthlyPayment(monthlyPayment);</span>
<span class="fc" id="L104">        offer.setTotalCost(totalCost);</span>
<span class="fc" id="L105">        offer.setOriginationFee(originationFee);</span>
<span class="fc" id="L106">        offer.setInsuranceCost(insuranceCost);</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        offer.setProcessingTimeDays(request.getProcessingTimeDays() != null </span>
<span class="pc" id="L108">                ? request.getProcessingTimeDays() : 5);</span>
<span class="fc" id="L109">        offer.setValidityPeriodDays(1); // 24 hours</span>
        
        // Set required documents
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        String requiredDocs = request.getRequiredDocuments() != null </span>
<span class="nc" id="L113">                ? String.join(&quot;,&quot;, request.getRequiredDocuments())</span>
<span class="fc" id="L114">                : &quot;paystubs,tax_returns,bank_statements,government_id&quot;;</span>
<span class="fc" id="L115">        offer.setRequiredDocuments(requiredDocs);</span>
        
        // Set expiration (24 hours from now)
<span class="fc" id="L118">        offer.setExpiresAt(LocalDateTime.now().plusDays(1));</span>
<span class="fc" id="L119">        offer.setOfferSubmittedAt(LocalDateTime.now());</span>
        
        // Set officer tracking fields
<span class="fc" id="L122">        offer.setSubmittedByOfficerId(officerId);</span>
<span class="fc" id="L123">        offer.setSubmissionNotes(request.getNotes());</span>

        // Save offer
<span class="fc" id="L126">        offer = offerRepository.save(offer);</span>

        // Send email notification to borrower
        try {
<span class="fc" id="L130">            emailService.sendOfferSubmittedByBankNotification(</span>
                    offer,
                    application,
                    officerId,
                    &quot;Bank Name&quot;, // TODO: Get from bank repository
                    &quot;Officer Name&quot; // TODO: Get from user repository
            );
<span class="nc" id="L137">        } catch (Exception e) {</span>
<span class="nc" id="L138">            log.error(&quot;[OFFER_SUBMIT] Failed to send email notification&quot;, e);</span>
            // Continue - email failure shouldn't fail offer submission
<span class="fc" id="L140">        }</span>

        // Log audit event
        try {
<span class="fc" id="L144">            Map&lt;String, Object&gt; auditData = Map.of(</span>
<span class="fc" id="L145">                    &quot;bankId&quot;, bankId.toString(),</span>
<span class="fc" id="L146">                    &quot;officerId&quot;, officerId.toString(),</span>
<span class="fc" id="L147">                    &quot;applicationId&quot;, request.getApplicationId().toString(),</span>
<span class="fc" id="L148">                    &quot;apr&quot;, request.getApr().toString(),</span>
<span class="fc" id="L149">                    &quot;monthlyPayment&quot;, monthlyPayment.toString(),</span>
<span class="fc" id="L150">                    &quot;totalCost&quot;, totalCost.toString()</span>
            );
<span class="fc" id="L152">            auditService.logActionWithValues(</span>
                    &quot;Offer&quot;,
<span class="fc" id="L154">                    offer.getId(),</span>
                    AuditAction.OFFER_SUBMITTED,
<span class="fc" id="L156">                    Map.of(),</span>
                    auditData
            );
<span class="nc" id="L159">        } catch (Exception e) {</span>
<span class="nc" id="L160">            log.error(&quot;[OFFER_SUBMIT] Failed to log audit event&quot;, e);</span>
<span class="fc" id="L161">        }</span>

<span class="fc" id="L163">        long took = System.currentTimeMillis() - start;</span>
<span class="fc" id="L164">        log.info(&quot;[OFFER_SUBMIT] Bank officer {} submitted offer {} for application {} in {}ms&quot;,</span>
<span class="fc" id="L165">                officerId, offer.getId(), request.getApplicationId(), took);</span>

        // Build response
<span class="fc" id="L168">        return BankOfferSubmissionResponse.builder()</span>
<span class="fc" id="L169">                .offerId(offer.getId())</span>
<span class="fc" id="L170">                .applicationId(offer.getApplicationId())</span>
<span class="fc" id="L171">                .apr(offer.getApr())</span>
<span class="fc" id="L172">                .monthlyPayment(offer.getMonthlyPayment())</span>
<span class="fc" id="L173">                .totalCost(offer.getTotalCost())</span>
<span class="fc" id="L174">                .status(offer.getOfferStatus().name())</span>
<span class="fc" id="L175">                .submittedAt(offer.getOfferSubmittedAt())</span>
<span class="fc" id="L176">                .expiresAt(offer.getExpiresAt())</span>
<span class="fc" id="L177">                .borrowerNotificationStatus(&quot;pending&quot;)</span>
<span class="fc" id="L178">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>