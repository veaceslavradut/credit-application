<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BankOfferSubmissionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.bank.service</a> &gt; <span class="el_source">BankOfferSubmissionService.java</span></div><h1>BankOfferSubmissionService.java</h1><pre class="source lang-java linenums">package com.creditapp.bank.service;

import com.creditapp.bank.dto.OfferSubmissionRequest;
import com.creditapp.bank.dto.OfferSubmissionResponse;
import com.creditapp.bank.model.Offer;
import com.creditapp.bank.model.OfferStatus;
import com.creditapp.bank.repository.OfferRepository;
import com.creditapp.borrower.model.Application;
import com.creditapp.borrower.repository.ApplicationRepository;
import com.creditapp.shared.model.AuditAction;
import com.creditapp.shared.service.AuditService;
import com.creditapp.shared.util.CalculationUtils;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.Optional;
import java.util.UUID;

/**
 * Service for bank offer submission with optional field overrides
 * Implements idempotency, calculation validation, and audit logging
 */
@Service
<span class="nc" id="L28">@RequiredArgsConstructor</span>
<span class="nc" id="L29">@Slf4j</span>
public class BankOfferSubmissionService {

    private final OfferRepository offerRepository;
    private final ApplicationRepository applicationRepository;
    private final AuditService auditService;

    /**
     * Submit offer for application with optional overrides
     * Implements idempotency: same (bankId, applicationId) returns existing offer
     *
     * @param bankId bank submitting the offer
     * @param applicationId application to submit offer for
     * @param request offer submission request with optional overrides
     * @return submitted offer response with HTTP status
     */
    @Transactional
    public OfferSubmissionResponse submitOffer(UUID bankId, UUID applicationId, OfferSubmissionRequest request) {
<span class="nc" id="L47">        long startTime = System.currentTimeMillis();</span>

        // Verify application exists
<span class="nc" id="L50">        Application application = applicationRepository.findById(applicationId)</span>
<span class="nc" id="L51">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Application not found: &quot; + applicationId));</span>

        // Check for idempotency: existing offer from this bank for this application
<span class="nc" id="L54">        Optional&lt;Offer&gt; existingOffer = offerRepository.findByApplicationIdAndBankId(applicationId, bankId);</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (existingOffer.isPresent()) {</span>
<span class="nc" id="L56">            log.info(&quot;Idempotent: Returning existing offer {} for app {} from bank {}&quot;, </span>
<span class="nc" id="L57">                    existingOffer.get().getId(), applicationId, bankId);</span>
<span class="nc" id="L58">            return buildResponse(existingOffer.get(), 200); // 200 OK for existing</span>
        }

        // Determine offer values
        BigDecimal apr;
        BigDecimal fees;
        Integer processingTime;
        BigDecimal monthlyPayment;
        BigDecimal totalCost;

<span class="nc bnc" id="L68" title="All 4 branches missed.">        if (request.getAcceptCalculatedOffer() != null &amp;&amp; request.getAcceptCalculatedOffer()) {</span>
            // Use system-calculated offer AS-IS from Story 3.3
            // For now, use defaults (in real scenario, fetch from OfferCalculationService)
<span class="nc" id="L71">            apr = new BigDecimal(&quot;10.5800&quot;);</span>
<span class="nc" id="L72">            fees = new BigDecimal(&quot;150.00&quot;);</span>
<span class="nc" id="L73">            processingTime = 5;</span>
<span class="nc" id="L74">            monthlyPayment = CalculationUtils.calculateMonthlyPayment(</span>
<span class="nc" id="L75">                    application.getLoanAmount(),</span>
<span class="nc" id="L76">                    application.getLoanTermMonths(),</span>
                    apr
            );
<span class="nc" id="L79">            totalCost = monthlyPayment</span>
<span class="nc" id="L80">                    .multiply(new BigDecimal(application.getLoanTermMonths()))</span>
<span class="nc" id="L81">                    .add(fees);</span>
        } else {
            // Use overrides
<span class="nc bnc" id="L84" title="All 2 branches missed.">            apr = request.getOverrideAPR() != null ? request.getOverrideAPR() : new BigDecimal(&quot;10.5800&quot;);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">            fees = request.getOverrideFees() != null ? request.getOverrideFees() : new BigDecimal(&quot;150.00&quot;);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            processingTime = request.getOverrideProcessingTime() != null ? request.getOverrideProcessingTime() : 5;</span>

            // Validate APR range: 0.5% to 50%
<span class="nc bnc" id="L89" title="All 4 branches missed.">            if (apr.compareTo(new BigDecimal(&quot;0.5&quot;)) &lt; 0 || apr.compareTo(new BigDecimal(&quot;50&quot;)) &gt; 0) {</span>
<span class="nc" id="L90">                throw new IllegalArgumentException(&quot;APR must be between 0.5% and 50%, received: &quot; + apr);</span>
            }

            // Recalculate monthly payment using Decision 2 formula
<span class="nc" id="L94">            monthlyPayment = CalculationUtils.calculateMonthlyPayment(</span>
<span class="nc" id="L95">                    application.getLoanAmount(),</span>
<span class="nc" id="L96">                    application.getLoanTermMonths(),</span>
                    apr
            );

            // Total cost = (monthlyPayment  months) + fees
<span class="nc" id="L101">            totalCost = monthlyPayment</span>
<span class="nc" id="L102">                    .multiply(new BigDecimal(application.getLoanTermMonths()))</span>
<span class="nc" id="L103">                    .add(fees);</span>
        }

        // Create new offer
<span class="nc" id="L107">        Offer offer = new Offer();</span>
<span class="nc" id="L108">        offer.setId(UUID.randomUUID());</span>
<span class="nc" id="L109">        offer.setApplicationId(applicationId);</span>
<span class="nc" id="L110">        offer.setBankId(bankId);</span>
<span class="nc" id="L111">        offer.setApr(apr);</span>
<span class="nc" id="L112">        offer.setMonthlyPayment(monthlyPayment);</span>
<span class="nc" id="L113">        offer.setTotalCost(totalCost);</span>
<span class="nc" id="L114">        offer.setOriginationFee(fees);</span>
<span class="nc" id="L115">        offer.setProcessingTimeDays(processingTime);</span>
<span class="nc" id="L116">        offer.setValidityPeriodDays(1);</span>
<span class="nc" id="L117">        offer.setOfferStatus(OfferStatus.SUBMITTED);</span>
<span class="nc" id="L118">        offer.setExpiresAt(LocalDateTime.now().plusDays(1));</span>

        // Save offer
<span class="nc" id="L121">        offer = offerRepository.save(offer);</span>
<span class="nc" id="L122">        log.info(&quot;Created new offer {} for app {} from bank {} with APR={}&quot;, </span>
<span class="nc" id="L123">                offer.getId(), applicationId, bankId, apr);</span>

        // Log audit event
<span class="nc" id="L126">        auditService.logAction(&quot;Offer&quot;, offer.getId(), AuditAction.OFFER_SUBMITTED);</span>
<span class="nc" id="L127">        log.info(&quot;Audit logged: OFFER_SUBMITTED for offer {}&quot;, offer.getId());</span>

        // Queue email notification (async)
        // TODO: Implement email notification to borrower using EmailService
<span class="nc" id="L131">        log.info(&quot;Email notification queued for application {}&quot;, applicationId);</span>

<span class="nc" id="L133">        long elapsed = System.currentTimeMillis() - startTime;</span>
<span class="nc" id="L134">        log.debug(&quot;Offer submission completed in {}ms&quot;, elapsed);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (elapsed &gt; 500) {</span>
<span class="nc" id="L136">            log.warn(&quot;Offer submission exceeded 500ms SLA: {}ms&quot;, elapsed);</span>
        }

<span class="nc" id="L139">        return buildResponse(offer, 201); // 201 CREATED for new</span>
    }

    /**
     * Build response DTO from offer entity
     */
    private OfferSubmissionResponse buildResponse(Offer offer, int httpStatus) {
<span class="nc" id="L146">        return OfferSubmissionResponse.builder()</span>
<span class="nc" id="L147">                .offerId(offer.getId())</span>
<span class="nc" id="L148">                .apr(offer.getApr())</span>
<span class="nc" id="L149">                .fees(offer.getOriginationFee())</span>
<span class="nc" id="L150">                .processingTime(offer.getProcessingTimeDays())</span>
<span class="nc" id="L151">                .monthlyPayment(offer.getMonthlyPayment())</span>
<span class="nc" id="L152">                .totalCost(offer.getTotalCost())</span>
<span class="nc" id="L153">                .submittedAt(offer.getCreatedAt())</span>
<span class="nc" id="L154">                .httpStatus(httpStatus)</span>
<span class="nc" id="L155">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>