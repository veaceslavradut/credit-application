<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NotificationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.shared.service</a> &gt; <span class="el_source">NotificationService.java</span></div><h1>NotificationService.java</h1><pre class="source lang-java linenums">package com.creditapp.shared.service;

import com.creditapp.shared.dto.EmailMetricsDTO;
import com.creditapp.shared.model.DeliveryStatus;
import com.creditapp.shared.model.EmailDeliveryLog;
import com.creditapp.shared.model.EmailTemplate;
import com.creditapp.shared.repository.EmailDeliveryLogRepository;
import com.creditapp.shared.repository.EmailTemplateRepository;
import com.creditapp.shared.util.EmailRateLimiter;
import com.sendgrid.Response;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Map;

/**
 * NotificationService orchestrates email notifications
 * Handles template processing, variable substitution, and delivery tracking
 */
@Service
@RequiredArgsConstructor
<span class="nc" id="L26">@Slf4j</span>
public class NotificationService {
    
    private final EmailTemplateRepository emailTemplateRepository;
    private final EmailDeliveryLogRepository emailDeliveryLogRepository;
    private final EmailService emailService;
    private final RabbitTemplate rabbitTemplate;
    private final EmailRateLimiter emailRateLimiter;
    
    /**
     * Send email using template with variable substitution
     * @param recipient recipient email address
     * @param templateName template name
     * @param variables template variables
     * @return true if sent successfully
     */
    @Transactional
    public boolean sendEmail(String recipient, String templateName, Map&lt;String, String&gt; variables) {
        try {
            // Check rate limit before sending
<span class="nc bnc" id="L46" title="All 2 branches missed.">            if (!emailRateLimiter.checkRateLimit()) {</span>
<span class="nc" id="L47">                log.warn(&quot;Rate limit exceeded for email to: {}&quot;, recipient);</span>
<span class="nc" id="L48">                logDeliveryStatus(recipient, templateName, DeliveryStatus.FAILED, </span>
<span class="nc" id="L49">                    &quot;Rate limit exceeded - email will be retried&quot;);</span>
<span class="nc" id="L50">                return false;</span>
            }
            
            // Fetch template
<span class="nc" id="L54">            EmailTemplate template = emailTemplateRepository</span>
<span class="nc" id="L55">                .findByTemplateNameAndActiveTrue(templateName)</span>
<span class="nc" id="L56">                .orElseThrow(() -&gt; new RuntimeException(&quot;Email template not found: &quot; + templateName));</span>
            
            // Substitute variables in template
<span class="nc" id="L59">            String subject = substituteVariables(template.getSubject(), variables);</span>
<span class="nc" id="L60">            String htmlBody = substituteVariables(template.getHtmlBody(), variables);</span>
<span class="nc" id="L61">            String textBody = substituteVariables(template.getTextBody(), variables);</span>
            
            // Send email via email service
<span class="nc" id="L64">            Response response = emailService.sendEmail(recipient, subject, htmlBody, textBody);</span>
            
            // Log delivery
<span class="nc bnc" id="L67" title="All 4 branches missed.">            DeliveryStatus status = (response.getStatusCode() &gt;= 200 &amp;&amp; response.getStatusCode() &lt; 300) </span>
<span class="nc" id="L68">                ? DeliveryStatus.SENT </span>
<span class="nc" id="L69">                : DeliveryStatus.FAILED;</span>
            
<span class="nc" id="L71">            logDeliveryStatus(recipient, templateName, status, null);</span>
            
<span class="nc bnc" id="L73" title="All 2 branches missed.">            return status == DeliveryStatus.SENT;</span>
            
<span class="nc" id="L75">        } catch (Exception e) {</span>
<span class="nc" id="L76">            log.error(&quot;Failed to send email to {} using template {}: {}&quot;, </span>
<span class="nc" id="L77">                recipient, templateName, e.getMessage());</span>
<span class="nc" id="L78">            logDeliveryStatus(recipient, templateName, DeliveryStatus.FAILED, e.getMessage());</span>
<span class="nc" id="L79">            return false;</span>
        }
    }
    
    /**
     * Substitute variables in template text
     * Replaces {variableName} placeholders with actual values
     */
    private String substituteVariables(String template, Map&lt;String, String&gt; variables) {
<span class="nc bnc" id="L88" title="All 4 branches missed.">        if (template == null || variables == null) {</span>
<span class="nc" id="L89">            return template;</span>
        }
        
<span class="nc" id="L92">        String result = template;</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        for (Map.Entry&lt;String, String&gt; entry : variables.entrySet()) {</span>
<span class="nc" id="L94">            String placeholder = &quot;{&quot; + entry.getKey() + &quot;}&quot;;</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            result = result.replace(placeholder, entry.getValue() != null ? entry.getValue() : &quot;&quot;);</span>
        }
<span class="nc" id="L97">        return result;</span>
    }
    
    /**
     * Queue notification for async processing
     * @param eventType event type (e.g., APPLICATION_SUBMITTED)
     * @param recipient recipient email
     * @param variables template variables
     */
    public void queueNotification(String eventType, String recipient, Map&lt;String, String&gt; variables) {
        try {
<span class="nc" id="L108">            com.creditapp.shared.dto.NotificationEvent event = com.creditapp.shared.dto.NotificationEvent.builder()</span>
<span class="nc" id="L109">                .id(java.util.UUID.randomUUID())</span>
<span class="nc" id="L110">                .eventType(eventType)</span>
<span class="nc" id="L111">                .recipientEmail(recipient)</span>
<span class="nc" id="L112">                .templateName(eventType)</span>
<span class="nc" id="L113">                .variables(variables)</span>
<span class="nc" id="L114">                .timestamp(LocalDateTime.now())</span>
<span class="nc" id="L115">                .retryCount(0)</span>
<span class="nc" id="L116">                .build();</span>
            
<span class="nc" id="L118">            rabbitTemplate.convertAndSend(</span>
<span class="nc" id="L119">                com.creditapp.shared.config.RabbitMQConfig.NOTIFICATION_EXCHANGE,</span>
<span class="nc" id="L120">                &quot;notification.event&quot;,</span>
<span class="nc" id="L121">                event</span>
            );
            
<span class="nc" id="L124">            log.info(&quot;Queued notification event: {} for recipient: {}&quot;, eventType, recipient);</span>
            
<span class="nc" id="L126">        } catch (Exception e) {</span>
<span class="nc" id="L127">            log.error(&quot;Failed to queue notification: {}&quot;, e.getMessage());</span>
        }
<span class="nc" id="L129">    }</span>
    
    /**
     * Log email delivery status
     */
    public void logDeliveryStatus(String recipientEmail, String templateName, 
                                    DeliveryStatus status, String errorMessage) {
<span class="nc" id="L136">        EmailDeliveryLog log = EmailDeliveryLog.builder()</span>
<span class="nc" id="L137">            .recipientEmail(recipientEmail)</span>
<span class="nc" id="L138">            .templateName(templateName)</span>
<span class="nc" id="L139">            .status(status)</span>
<span class="nc" id="L140">            .sentAt(LocalDateTime.now())</span>
<span class="nc" id="L141">            .errorMessage(errorMessage)</span>
<span class="nc" id="L142">            .build();</span>
        
<span class="nc" id="L144">        emailDeliveryLogRepository.save(log);</span>
<span class="nc" id="L145">    }</span>
    
    /**
     * Get email metrics for health check
     */
    public EmailMetricsDTO getEmailMetrics() {
<span class="nc" id="L151">        LocalDateTime oneHourAgo = LocalDateTime.now().minusHours(1);</span>
        
<span class="nc" id="L153">        Long sent = emailDeliveryLogRepository.countByStatusAndSentAtAfter(</span>
<span class="nc" id="L154">            DeliveryStatus.SENT, oneHourAgo);</span>
<span class="nc" id="L155">        Long delivered = emailDeliveryLogRepository.countByStatusAndSentAtAfter(</span>
<span class="nc" id="L156">            DeliveryStatus.DELIVERED, oneHourAgo);</span>
<span class="nc" id="L157">        Long bounced = emailDeliveryLogRepository.countByStatusAndSentAtAfter(</span>
<span class="nc" id="L158">            DeliveryStatus.BOUNCED, oneHourAgo);</span>
<span class="nc" id="L159">        Long failed = emailDeliveryLogRepository.countByStatusAndSentAtAfter(</span>
<span class="nc" id="L160">            DeliveryStatus.FAILED, oneHourAgo);</span>
        
<span class="nc" id="L162">        long total = sent + delivered + bounced + failed;</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        double successRate = total &gt; 0 ? (double) (sent + delivered) / total : 0.0;</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">        double failureRate = total &gt; 0 ? (double) (bounced + failed) / total : 0.0;</span>
        
<span class="nc" id="L166">        return EmailMetricsDTO.builder()</span>
<span class="nc" id="L167">            .emailsSent(sent)</span>
<span class="nc" id="L168">            .emailsDelivered(delivered)</span>
<span class="nc" id="L169">            .emailsBounced(bounced)</span>
<span class="nc" id="L170">            .emailsFailed(failed)</span>
<span class="nc" id="L171">            .successRate(successRate)</span>
<span class="nc" id="L172">            .failureRate(failureRate)</span>
<span class="nc" id="L173">            .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>