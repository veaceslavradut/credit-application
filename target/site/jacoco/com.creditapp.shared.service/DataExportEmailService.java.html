<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataExportEmailService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.shared.service</a> &gt; <span class="el_source">DataExportEmailService.java</span></div><h1>DataExportEmailService.java</h1><pre class="source lang-java linenums">package com.creditapp.shared.service;

import com.creditapp.shared.model.DataExport;
import com.sendgrid.Response;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.UUID;

@Service
<span class="nc" id="L18">@RequiredArgsConstructor</span>
<span class="nc" id="L19">@Slf4j</span>
public class DataExportEmailService {
    
    private final EmailService emailService;
    
    @Value(&quot;${app.base-url:https://creditapp.com}&quot;)
    private String baseUrl;
    
    @Value(&quot;${app.download-endpoint:/api/borrower/data-export/download}&quot;)
    private String downloadEndpoint;

    public void sendDataExportReadyEmail(DataExport export, String borrowerEmail) {
        try {
<span class="nc" id="L32">            log.info(&quot;Sending data export ready email to: {}&quot;, borrowerEmail);</span>
            
            // Load HTML template
<span class="nc" id="L35">            String template = loadEmailTemplate();</span>
            
            // Build download link with token
<span class="nc" id="L38">            String downloadLink = buildDownloadLink(export.getDownloadToken());</span>
            
            // Format file size (placeholder - would get actual size from S3)
<span class="nc" id="L41">            String fileSize = &quot;~1-50 MB&quot;;</span>
            
            // Format export timestamp
<span class="nc bnc" id="L44" title="All 2 branches missed.">            String generatedAt = formatDateTime(export.getCompletedAt() != null ? export.getCompletedAt() : LocalDateTime.now());</span>
            
            // Replace placeholders
<span class="nc" id="L47">            String htmlContent = template</span>
<span class="nc" id="L48">                .replace(&quot;{DOWNLOAD_LINK}&quot;, downloadLink)</span>
<span class="nc" id="L49">                .replace(&quot;{FILE_FORMAT}&quot;, export.getFormat().name())</span>
<span class="nc" id="L50">                .replace(&quot;{FILE_SIZE}&quot;, fileSize)</span>
<span class="nc" id="L51">                .replace(&quot;{GENERATED_AT}&quot;, generatedAt);</span>
            
            // Create plain text version
<span class="nc" id="L54">            String textContent = createPlainTextVersion(borrowerEmail, export, downloadLink);</span>
            
            // Send email
<span class="nc" id="L57">            Response response = emailService.sendEmail(</span>
                borrowerEmail,
                &quot;Your Data Export is Ready&quot;,
                htmlContent,
                textContent
            );
            
<span class="nc bnc" id="L64" title="All 4 branches missed.">            if (response != null &amp;&amp; response.getStatusCode() == 202) {</span>
<span class="nc" id="L65">                log.info(&quot;Data export email sent successfully to: {}&quot;, borrowerEmail);</span>
            } else {
<span class="nc" id="L67">                log.warn(&quot;Data export email send returned status: {}&quot;, </span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                    response != null ? response.getStatusCode() : &quot;null&quot;);</span>
            }
            
<span class="nc" id="L71">        } catch (Exception e) {</span>
<span class="nc" id="L72">            log.error(&quot;Error sending data export ready email to: {}&quot;, borrowerEmail, e);</span>
            // Don't throw - allow export to complete even if email fails
<span class="nc" id="L74">        }</span>
<span class="nc" id="L75">    }</span>
    
    private String loadEmailTemplate() {
        try {
<span class="nc" id="L79">            String templatePath = &quot;src/main/resources/templates/data-export-ready.html&quot;;</span>
<span class="nc" id="L80">            return new String(Files.readAllBytes(Paths.get(templatePath)));</span>
<span class="nc" id="L81">        } catch (IOException e) {</span>
<span class="nc" id="L82">            log.error(&quot;Error loading email template&quot;, e);</span>
            // Return fallback template if file not found
<span class="nc" id="L84">            return getFallbackTemplate();</span>
        }
    }
    
    private String buildDownloadLink(String downloadToken) {
<span class="nc" id="L89">        return String.format(&quot;%s%s?token=%s&quot;, baseUrl, downloadEndpoint, downloadToken);</span>
    }
    
    private String formatDateTime(LocalDateTime dateTime) {
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (dateTime == null) {</span>
<span class="nc" id="L94">            return &quot;Unknown&quot;;</span>
        }
<span class="nc" id="L96">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;MMMM dd, yyyy 'at' HH:mm:ss&quot;);</span>
<span class="nc" id="L97">        return dateTime.format(formatter);</span>
    }
    
    private String createPlainTextVersion(String email, DataExport export, String downloadLink) {
<span class="nc" id="L101">        return String.format(</span>
            &quot;Your Data Export is Ready\n\n&quot; +
            &quot;Hello,\n\n&quot; +
            &quot;Your data export request has been processed successfully. Your personal data file is ready for download.\n\n&quot; +
            &quot;Download Your Data:\n&quot; +
            &quot;Click this link to download your data export: %s\n\n&quot; +
            &quot;File Information:\n&quot; +
            &quot;- Format: %s\n&quot; +
            &quot;- Generated at: %s\n\n&quot; +
            &quot;What's Included:\n&quot; +
            &quot;- Profile: Your personal information\n&quot; +
            &quot;- Applications: All loan applications with history\n&quot; +
            &quot;- Offers: All offers received for your applications\n&quot; +
            &quot;- Consents: Record of all data processing consents\n&quot; +
            &quot;- Audit Log: Recent activity log\n\n&quot; +
            &quot;Important Information:\n&quot; +
            &quot;- Link Expiry: This download link will expire in 24 hours.\n&quot; +
            &quot;- One-Time Use: This link can only be used once for security reasons.\n&quot; +
            &quot;- Sensitive Data: Please store this file securely and delete after verification.\n\n&quot; +
            &quot;Need Help?\n&quot; +
            &quot;If you have questions, contact support at support@creditapp.com\n\n&quot; +
            &quot;Best regards,\nCredit Application Platform Team\n\n&quot; +
            &quot;This is an automated email. Please do not reply.&quot;,
            downloadLink,
<span class="nc" id="L125">            export.getFormat().name()</span>
        );
    }
    
    private String getFallbackTemplate() {
<span class="nc" id="L130">        return &quot;&lt;html&gt;&lt;body&gt;&quot; +</span>
            &quot;&lt;h1&gt;Your Data Export is Ready&lt;/h1&gt;&quot; +
            &quot;&lt;p&gt;Download your data: {DOWNLOAD_LINK}&lt;/p&gt;&quot; +
            &quot;&lt;p&gt;Format: {FILE_FORMAT}&lt;/p&gt;&quot; +
            &quot;&lt;p&gt;This link expires in 24 hours.&lt;/p&gt;&quot; +
            &quot;&lt;/body&gt;&lt;/html&gt;&quot;;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>