<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OfferExpirationWarningScheduler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.batch</a> &gt; <span class="el_source">OfferExpirationWarningScheduler.java</span></div><h1>OfferExpirationWarningScheduler.java</h1><pre class="source lang-java linenums">package com.creditapp.batch;

import com.creditapp.bank.model.Offer;
import com.creditapp.bank.repository.OfferRepository;
import com.creditapp.bank.service.BankOfferExpirationNotificationService;
import io.micrometer.core.instrument.MeterRegistry;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;

/**
 * Scheduled batch job to check for offers expiring within 24 hours and send notifications.
 * Part of Story 4.6 - Offer Expiration Notification.
 * Runs every hour.
 */
@Component
@RequiredArgsConstructor
<span class="nc" id="L23">@Slf4j</span>
public class OfferExpirationWarningScheduler {
    
    private final OfferRepository offerRepository;
    private final BankOfferExpirationNotificationService notificationService;
    private final MeterRegistry meterRegistry;
    
    /**
     * Run every 1 hour to check for offers expiring within 24 hours.
     * fixedRate = 3600000ms = 1 hour
     */
    @Scheduled(fixedRate = 3600000)
    @Transactional
    public void checkExpiringOffers() {
<span class="nc" id="L37">        log.info(&quot;Starting offer expiration warning batch job at {}&quot;, LocalDateTime.now());</span>
<span class="nc" id="L38">        long startTime = System.currentTimeMillis();</span>
        
        try {
<span class="nc" id="L41">            LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L42">            LocalDateTime expirationWindow = now.plusHours(24);</span>
            
            // Query offers expiring within 24 hours that haven't been notified
<span class="nc" id="L45">            List&lt;Offer&gt; expiringOffers = offerRepository.findOffersExpiringSoon(now, expirationWindow);</span>
            
<span class="nc" id="L47">            log.info(&quot;Found {} offers expiring within 24 hours&quot;, expiringOffers.size());</span>
            
<span class="nc" id="L49">            int notifiedCount = 0;</span>
<span class="nc" id="L50">            int failedCount = 0;</span>
            
<span class="nc bnc" id="L52" title="All 2 branches missed.">            for (Offer offer : expiringOffers) {</span>
                try {
                    // Send notification (async)
<span class="nc" id="L55">                    notificationService.notifyBankOfExpiration(offer);</span>
                    
                    // Mark as notified
<span class="nc" id="L58">                    offer.setNotified(true);</span>
<span class="nc" id="L59">                    offerRepository.save(offer);</span>
                    
<span class="nc" id="L61">                    notifiedCount++;</span>
<span class="nc" id="L62">                    log.debug(&quot;Notified bank for offer {}. Expires at: {}&quot;, offer.getId(), offer.getExpiresAt());</span>
<span class="nc" id="L63">                } catch (Exception e) {</span>
<span class="nc" id="L64">                    failedCount++;</span>
<span class="nc" id="L65">                    log.error(&quot;Failed to notify bank for offer {}: {}&quot;, offer.getId(), e.getMessage(), e);</span>
                }
            }
            
<span class="nc" id="L69">            long duration = System.currentTimeMillis() - startTime;</span>
            
            // Metrics
<span class="nc" id="L72">            meterRegistry.counter(&quot;creditapp.offers.expiration_warnings.sent&quot;).increment(notifiedCount);</span>
<span class="nc" id="L73">            meterRegistry.counter(&quot;creditapp.offers.expiration_warnings.failed&quot;).increment(failedCount);</span>
<span class="nc" id="L74">            meterRegistry.timer(&quot;creditapp.scheduler.offer-expiration-warning.duration&quot;)</span>
<span class="nc" id="L75">                    .record(duration, java.util.concurrent.TimeUnit.MILLISECONDS);</span>
            
<span class="nc" id="L77">            log.info(&quot;Offer expiration warning batch job completed. Notified: {}, Failed: {}, Duration: {}ms&quot;,</span>
<span class="nc" id="L78">                    notifiedCount, failedCount, duration);</span>
                    
<span class="nc" id="L80">        } catch (Exception e) {</span>
<span class="nc" id="L81">            log.error(&quot;Offer expiration warning batch job failed: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L82">            meterRegistry.counter(&quot;creditapp.scheduler.offer-expiration-warning.errors&quot;).increment();</span>
        }
<span class="nc" id="L84">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>