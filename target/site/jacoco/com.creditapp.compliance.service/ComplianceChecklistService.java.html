<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComplianceChecklistService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.compliance.service</a> &gt; <span class="el_source">ComplianceChecklistService.java</span></div><h1>ComplianceChecklistService.java</h1><pre class="source lang-java linenums">package com.creditapp.compliance.service;

import com.creditapp.compliance.dto.ComplianceChecklistItemResponse;
import com.creditapp.compliance.dto.ComplianceChecklistResponse;
import com.creditapp.compliance.dto.ComplianceChecklistUpdateRequest;
import com.creditapp.shared.model.AuditAction;
import com.creditapp.shared.model.ComplianceChecklistItem;
import com.creditapp.shared.model.ComplianceStatus;
import com.creditapp.shared.repository.ComplianceChecklistItemRepository;
import com.creditapp.shared.service.AuditService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import java.io.ByteArrayOutputStream;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.stream.Collectors;

@Service
<span class="fc" id="L22">@RequiredArgsConstructor</span>
<span class="fc" id="L23">@Slf4j</span>
public class ComplianceChecklistService {
    
    private final ComplianceChecklistItemRepository checklistItemRepository;
    private final AuditService auditService;
    
<span class="fc" id="L29">    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;);</span>
    
    /**
     * Predefined compliance checklist items aligned with GDPR and Moldovan requirements
     */
<span class="fc" id="L34">    private static final List&lt;ComplianceChecklistItem&gt; PREDEFINED_ITEMS = Arrays.asList(</span>
<span class="fc" id="L35">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L36">            .itemName(&quot;Explicit Consent Capture&quot;)</span>
<span class="fc" id="L37">            .description(&quot;User consent collected for data processing via Story 5.1 ConsentService&quot;)</span>
<span class="fc" id="L38">            .gdprArticles(&quot;6, 7&quot;)</span>
<span class="fc" id="L39">            .evidence(&quot;src/main/java/com/creditapp/borrower/service/ConsentService.java&quot;)</span>
<span class="fc" id="L40">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L41">            .build(),</span>
<span class="fc" id="L42">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L43">            .itemName(&quot;Privacy Policy Published&quot;)</span>
<span class="fc" id="L44">            .description(&quot;Privacy policy versioned and published via /api/legal/privacy-policy endpoint&quot;)</span>
<span class="fc" id="L45">            .gdprArticles(&quot;13, 14&quot;)</span>
<span class="fc" id="L46">            .evidence(&quot;src/main/java/com/creditapp/shared/controller/LegalDocumentController.java&quot;)</span>
<span class="fc" id="L47">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L48">            .build(),</span>
<span class="fc" id="L49">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L50">            .itemName(&quot;Data Export Capability (GDPR Art. 20)&quot;)</span>
<span class="fc" id="L51">            .description(&quot;Async export service provides data portability via /api/borrower/data-export&quot;)</span>
<span class="fc" id="L52">            .gdprArticles(&quot;15, 20&quot;)</span>
<span class="fc" id="L53">            .evidence(&quot;src/main/java/com/creditapp/borrower/service/DataExportService.java&quot;)</span>
<span class="fc" id="L54">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L55">            .build(),</span>
<span class="fc" id="L56">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L57">            .itemName(&quot;Data Deletion Capability (GDPR Art. 17)&quot;)</span>
<span class="fc" id="L58">            .description(&quot;Right to erasure with grace period and SHA-256 anonymization via Story 5.4&quot;)</span>
<span class="fc" id="L59">            .gdprArticles(&quot;17&quot;)</span>
<span class="fc" id="L60">            .evidence(&quot;src/main/java/com/creditapp/shared/service/DataDeletionService.java&quot;)</span>
<span class="fc" id="L61">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L62">            .build(),</span>
<span class="fc" id="L63">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L64">            .itemName(&quot;Audit Logs Immutable&quot;)</span>
<span class="fc" id="L65">            .description(&quot;Append-only audit trail with tamper detection via Story 5.5&quot;)</span>
<span class="fc" id="L66">            .gdprArticles(&quot;32&quot;)</span>
<span class="fc" id="L67">            .evidence(&quot;src/main/java/com/creditapp/shared/service/AuditService.java&quot;)</span>
<span class="fc" id="L68">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L69">            .build(),</span>
<span class="fc" id="L70">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L71">            .itemName(&quot;Data Encryption at Rest &amp; in Transit&quot;)</span>
<span class="fc" id="L72">            .description(&quot;TLS 1.3, HSTS headers, AES-256-GCM encryption via Story 5.7&quot;)</span>
<span class="fc" id="L73">            .gdprArticles(&quot;32&quot;)</span>
<span class="fc" id="L74">            .evidence(&quot;src/main/resources/application.yml, src/main/java/com/creditapp/shared/security/EncryptionService.java&quot;)</span>
<span class="fc" id="L75">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L76">            .build(),</span>
<span class="fc" id="L77">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L78">            .itemName(&quot;Data Retention Policy (3 Years)&quot;)</span>
<span class="fc" id="L79">            .description(&quot;Audit logs retained for 3 years per Moldovan requirements; grace periods for other data&quot;)</span>
<span class="fc" id="L80">            .gdprArticles(&quot;5&quot;)</span>
<span class="fc" id="L81">            .evidence(&quot;docs/ENCRYPTION_STRATEGY.md&quot;)</span>
<span class="fc" id="L82">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L83">            .build(),</span>
<span class="fc" id="L84">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L85">            .itemName(&quot;PII Redaction in Audit Logs&quot;)</span>
<span class="fc" id="L86">            .description(&quot;Email, phone, name, address redacted in audit log details via DataRedactionService&quot;)</span>
<span class="fc" id="L87">            .gdprArticles(&quot;32&quot;)</span>
<span class="fc" id="L88">            .evidence(&quot;src/main/java/com/creditapp/shared/service/DataRedactionService.java&quot;)</span>
<span class="fc" id="L89">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L90">            .build(),</span>
<span class="fc" id="L91">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L92">            .itemName(&quot;Data Processing Agreement with Processors&quot;)</span>
<span class="fc" id="L93">            .description(&quot;DPA executed with email provider, S3, Redis providers&quot;)</span>
<span class="fc" id="L94">            .gdprArticles(&quot;28&quot;)</span>
<span class="fc" id="L95">            .evidence(&quot;docs/compliance/data-processing-agreements.md&quot;)</span>
<span class="fc" id="L96">            .status(ComplianceStatus.YELLOW)</span>
<span class="fc" id="L97">            .notes(&quot;Requires manual evidence upload from legal team&quot;)</span>
<span class="fc" id="L98">            .build(),</span>
<span class="fc" id="L99">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L100">            .itemName(&quot;Subprocessor List&quot;)</span>
<span class="fc" id="L101">            .description(&quot;Third-party subprocessors (AWS S3, Redis, SendGrid) documented and updated annually&quot;)</span>
<span class="fc" id="L102">            .gdprArticles(&quot;28&quot;)</span>
<span class="fc" id="L103">            .evidence(&quot;docs/compliance/subprocessors.md&quot;)</span>
<span class="fc" id="L104">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L105">            .build(),</span>
<span class="fc" id="L106">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L107">            .itemName(&quot;Data Protection Officer (DPO) Identified&quot;)</span>
<span class="fc" id="L108">            .description(&quot;DPO appointed and contact information published&quot;)</span>
<span class="fc" id="L109">            .gdprArticles(&quot;37, 38&quot;)</span>
<span class="fc" id="L110">            .evidence(&quot;docs/compliance/DPO.md&quot;)</span>
<span class="fc" id="L111">            .status(ComplianceStatus.YELLOW)</span>
<span class="fc" id="L112">            .notes(&quot;Awaiting DPO appointment confirmation&quot;)</span>
<span class="fc" id="L113">            .build(),</span>
<span class="fc" id="L114">        ComplianceChecklistItem.builder()</span>
<span class="fc" id="L115">            .itemName(&quot;Data Breach Notification Procedure&quot;)</span>
<span class="fc" id="L116">            .description(&quot;72-hour notification workflow to supervisory authority and data subjects in place&quot;)</span>
<span class="fc" id="L117">            .gdprArticles(&quot;33, 34&quot;)</span>
<span class="fc" id="L118">            .evidence(&quot;docs/security/security-incident-runbook.md&quot;)</span>
<span class="fc" id="L119">            .status(ComplianceStatus.GREEN)</span>
<span class="fc" id="L120">            .build()</span>
    );
    
    /**
     * Initialize predefined compliance checklist items on first use
     */
    public void initializeChecklistItems() {
<span class="fc" id="L127">        log.info(&quot;Initializing compliance checklist items&quot;);</span>
        
<span class="fc bfc" id="L129" title="All 2 branches covered.">        for (ComplianceChecklistItem item : PREDEFINED_ITEMS) {</span>
<span class="fc" id="L130">            ComplianceChecklistItem existing = checklistItemRepository.findByItemName(item.getItemName());</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">            if (existing == null) {</span>
<span class="fc" id="L132">                item.setCreatedAt(LocalDateTime.now());</span>
<span class="fc" id="L133">                item.setUpdatedAt(LocalDateTime.now());</span>
<span class="fc" id="L134">                checklistItemRepository.save(item);</span>
<span class="fc" id="L135">                log.info(&quot;Created compliance item: {}&quot;, item.getItemName());</span>
            }
<span class="fc" id="L137">        }</span>
<span class="fc" id="L138">    }</span>
    
    /**
     * Get complete compliance checklist with overall status
     */
    public ComplianceChecklistResponse getComplianceChecklist() {
<span class="fc" id="L144">        List&lt;ComplianceChecklistItem&gt; items = checklistItemRepository.findAll();</span>
        
<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (items.isEmpty()) {</span>
<span class="fc" id="L147">            initializeChecklistItems();</span>
<span class="fc" id="L148">            items = checklistItemRepository.findAll();</span>
        }
        
<span class="fc" id="L151">        items.sort(Comparator.comparing(ComplianceChecklistItem::getItemName));</span>
        
<span class="fc" id="L153">        List&lt;ComplianceChecklistItemResponse&gt; responses = items.stream()</span>
<span class="fc" id="L154">            .map(this::toResponse)</span>
<span class="fc" id="L155">            .collect(Collectors.toList());</span>
        
<span class="fc" id="L157">        ComplianceStatus overallStatus = calculateOverallStatus(items);</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">        int redCount = (int) items.stream().filter(i -&gt; i.getStatus() == ComplianceStatus.RED).count();</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">        int yellowCount = (int) items.stream().filter(i -&gt; i.getStatus() == ComplianceStatus.YELLOW).count();</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">        int greenCount = (int) items.stream().filter(i -&gt; i.getStatus() == ComplianceStatus.GREEN).count();</span>
        
<span class="fc" id="L162">        LocalDateTime lastUpdate = items.stream()</span>
<span class="fc" id="L163">            .map(ComplianceChecklistItem::getUpdatedAt)</span>
<span class="fc" id="L164">            .max(LocalDateTime::compareTo)</span>
<span class="fc" id="L165">            .orElse(LocalDateTime.now());</span>
        
<span class="fc" id="L167">        log.info(&quot;Compliance checklist retrieved: {} green, {} yellow, {} red&quot;, greenCount, yellowCount, redCount);</span>
        
<span class="fc" id="L169">        return ComplianceChecklistResponse.builder()</span>
<span class="fc" id="L170">            .items(responses)</span>
<span class="fc" id="L171">            .overallStatus(overallStatus)</span>
<span class="fc" id="L172">            .redCount(redCount)</span>
<span class="fc" id="L173">            .yellowCount(yellowCount)</span>
<span class="fc" id="L174">            .greenCount(greenCount)</span>
<span class="fc" id="L175">            .lastUpdateDate(lastUpdate.format(DATE_FORMATTER))</span>
<span class="fc" id="L176">            .build();</span>
    }
    
    /**
     * Update compliance checklist item status
     */
    public ComplianceChecklistItemResponse updateChecklistItem(UUID itemId, ComplianceChecklistUpdateRequest request) {
<span class="fc" id="L183">        ComplianceChecklistItem item = checklistItemRepository.findById(itemId)</span>
<span class="fc" id="L184">            .orElseThrow(() -&gt; new RuntimeException(&quot;Compliance item not found: &quot; + itemId));</span>
        
<span class="fc" id="L186">        ComplianceStatus oldStatus = item.getStatus();</span>
<span class="fc" id="L187">        item.setStatus(request.getStatus());</span>
<span class="fc" id="L188">        item.setNotes(request.getNotes());</span>
<span class="fc" id="L189">        item.setLastReviewedAt(LocalDateTime.now());</span>
        
<span class="fc" id="L191">        ComplianceChecklistItem updated = checklistItemRepository.save(item);</span>
<span class="fc" id="L192">        log.info(&quot;Updated compliance item {} from {} to {}&quot;, item.getItemName(), oldStatus, request.getStatus());</span>
        
<span class="fc" id="L194">        auditService.logAction(</span>
            &quot;COMPLIANCE_CHECKLIST_ITEM&quot;,
<span class="fc" id="L196">            item.getId(),</span>
            AuditAction.COMPLIANCE_CHECKLIST_REVIEWED
        );
        
<span class="fc" id="L200">        return toResponse(updated);</span>
    }
    
    /**
     * Generate PDF submission package with all compliance evidence
     */
    public byte[] generateSubmissionPackage() {
<span class="fc" id="L207">        log.info(&quot;Generating compliance submission package&quot;);</span>
        
<span class="fc" id="L209">        ComplianceChecklistResponse compliance = getComplianceChecklist();</span>
        
<span class="fc" id="L211">        StringBuilder content = new StringBuilder();</span>
<span class="fc" id="L212">        content.append(&quot;GDPR &amp; MOLDOVAN COMPLIANCE CHECKLIST\n&quot;);</span>
<span class="fc" id="L213">        content.append(&quot;=====================================\n\n&quot;);</span>
<span class="fc" id="L214">        content.append(&quot;Generated: &quot;).append(LocalDateTime.now().format(DATE_FORMATTER)).append(&quot;\n\n&quot;);</span>
        
<span class="fc" id="L216">        content.append(&quot;EXECUTIVE SUMMARY\n&quot;);</span>
<span class="fc" id="L217">        content.append(&quot;-----------------\n&quot;);</span>
<span class="fc" id="L218">        content.append(&quot;Overall Status: &quot;).append(compliance.getOverallStatus().getDisplayName()).append(&quot;\n&quot;);</span>
<span class="fc" id="L219">        content.append(&quot;GREEN (Compliant): &quot;).append(compliance.getGreenCount()).append(&quot;\n&quot;);</span>
<span class="fc" id="L220">        content.append(&quot;YELLOW (In Progress): &quot;).append(compliance.getYellowCount()).append(&quot;\n&quot;);</span>
<span class="fc" id="L221">        content.append(&quot;RED (Not Compliant): &quot;).append(compliance.getRedCount()).append(&quot;\n\n&quot;);</span>
        
<span class="fc" id="L223">        content.append(&quot;DETAILED COMPLIANCE CHECKLIST\n&quot;);</span>
<span class="fc" id="L224">        content.append(&quot;------------------------------\n&quot;);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">        for (ComplianceChecklistItemResponse item : compliance.getItems()) {</span>
<span class="fc" id="L226">            content.append(&quot;\n[&quot;).append(item.getStatus().getCode().toUpperCase()).append(&quot;] &quot;);</span>
<span class="fc" id="L227">            content.append(item.getItemName()).append(&quot;\n&quot;);</span>
<span class="fc" id="L228">            content.append(&quot;Description: &quot;).append(item.getDescription()).append(&quot;\n&quot;);</span>
<span class="fc" id="L229">            content.append(&quot;GDPR Articles: &quot;).append(item.getGdprArticles()).append(&quot;\n&quot;);</span>
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            content.append(&quot;Evidence: &quot;).append(item.getEvidence() != null ? item.getEvidence() : &quot;N/A&quot;).append(&quot;\n&quot;);</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (item.getNotes() != null) {</span>
<span class="fc" id="L232">                content.append(&quot;Notes: &quot;).append(item.getNotes()).append(&quot;\n&quot;);</span>
            }
<span class="fc" id="L234">        }</span>
        
<span class="fc" id="L236">        content.append(&quot;\n\nATTESTATION\n&quot;);</span>
<span class="fc" id="L237">        content.append(&quot;-----------\n&quot;);</span>
<span class="fc" id="L238">        content.append(&quot;We certify that this platform complies with GDPR requirements and Moldovan Personal Data Protection Law.\n&quot;);</span>
<span class="fc" id="L239">        content.append(&quot;All processing activities are documented and controls are in place to protect personal data.\n&quot;);</span>
        
<span class="fc" id="L241">        byte[] textBytes = content.toString().getBytes(StandardCharsets.UTF_8);</span>
<span class="fc" id="L242">        log.info(&quot;Compliance submission package generated: {} bytes&quot;, textBytes.length);</span>
<span class="fc" id="L243">        return textBytes;</span>
    }
    
    /**
     * Calculate overall compliance status
     */
    private ComplianceStatus calculateOverallStatus(List&lt;ComplianceChecklistItem&gt; items) {
<span class="fc bfc" id="L250" title="All 4 branches covered.">        if (items.stream().anyMatch(i -&gt; i.getStatus() == ComplianceStatus.RED)) {</span>
<span class="fc" id="L251">            return ComplianceStatus.RED;</span>
        }
<span class="fc bfc" id="L253" title="All 4 branches covered.">        if (items.stream().anyMatch(i -&gt; i.getStatus() == ComplianceStatus.YELLOW)) {</span>
<span class="fc" id="L254">            return ComplianceStatus.YELLOW;</span>
        }
<span class="fc" id="L256">        return ComplianceStatus.GREEN;</span>
    }
    
    /**
     * Convert entity to response DTO
     */
    private ComplianceChecklistItemResponse toResponse(ComplianceChecklistItem item) {
<span class="fc" id="L263">        return ComplianceChecklistItemResponse.builder()</span>
<span class="fc" id="L264">            .id(item.getId())</span>
<span class="fc" id="L265">            .itemName(item.getItemName())</span>
<span class="fc" id="L266">            .description(item.getDescription())</span>
<span class="fc" id="L267">            .status(item.getStatus())</span>
<span class="fc" id="L268">            .gdprArticles(item.getGdprArticles())</span>
<span class="fc" id="L269">            .evidence(item.getEvidence())</span>
<span class="fc" id="L270">            .lastReviewedAt(item.getLastReviewedAt())</span>
<span class="fc" id="L271">            .notes(item.getNotes())</span>
<span class="fc" id="L272">            .createdAt(item.getCreatedAt())</span>
<span class="fc" id="L273">            .updatedAt(item.getUpdatedAt())</span>
<span class="fc" id="L274">            .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>