<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.borrower.service</a> &gt; <span class="el_source">ApplicationService.java</span></div><h1>ApplicationService.java</h1><pre class="source lang-java linenums">package com.creditapp.borrower.service;

import com.creditapp.borrower.dto.ApplicationDTO;
import com.creditapp.borrower.dto.ApplicationHistoryDTO;
import com.creditapp.borrower.dto.CreateApplicationRequest;
import com.creditapp.borrower.dto.SubmitApplicationResponse;
import com.creditapp.borrower.dto.UpdateApplicationRequest;
import com.creditapp.borrower.dto.UpdateApplicationResponse;
import com.creditapp.borrower.event.ApplicationSubmittedEvent;
import com.creditapp.borrower.exception.ApplicationAlreadySubmittedException;
import com.creditapp.borrower.exception.ApplicationCreationException;
import com.creditapp.borrower.exception.ApplicationNotDraftException;
import com.creditapp.borrower.exception.ApplicationNotFoundException;
import com.creditapp.borrower.exception.ApplicationNotEditableException;
import com.creditapp.borrower.exception.ApplicationStaleException;
import com.creditapp.borrower.exception.InvalidApplicationException;
import com.creditapp.borrower.exception.SubmissionValidationException;
import com.creditapp.borrower.model.Application;
import com.creditapp.borrower.model.ApplicationHistory;
import com.creditapp.borrower.model.ApplicationStatus;
import com.creditapp.borrower.repository.ApplicationHistoryRepository;
import com.creditapp.borrower.repository.ApplicationRepository;
import com.creditapp.shared.audit.BusinessAudit;
import com.creditapp.shared.model.AuditAction;
import com.creditapp.shared.service.AuditService;
import com.creditapp.shared.service.NotificationService;
import com.creditapp.auth.repository.UserRepository;
import com.creditapp.bank.service.OfferCalculationService;
import com.creditapp.shared.service.GDPRConsentService;
import com.creditapp.shared.model.ConsentType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;
import org.springframework.orm.ObjectOptimisticLockingFailureException;
import org.springframework.context.ApplicationEventPublisher;
import java.time.LocalDateTime;

/**
 * Service for application operations.
 */
@Service
<span class="fc" id="L50">@RequiredArgsConstructor</span>
<span class="fc" id="L51">@Slf4j</span>
public class ApplicationService {

    private final ApplicationRepository applicationRepository;
    private final ApplicationHistoryRepository applicationHistoryRepository;
    private final AuditService auditService;
    private final NotificationService notificationService;
    private final UserRepository userRepository;
    private final OfferCalculationService offerCalculationService;
    private final GDPRConsentService consentService;
    private final ApplicationEventPublisher eventPublisher;

    /**
     * Create a new application in DRAFT status.
     */
    @BusinessAudit(action = AuditAction.APPLICATION_CREATED, entityType = &quot;Application&quot;)
    public ApplicationDTO createApplication(UUID borrowerId, CreateApplicationRequest request) {
        // Validate loan amount (100 - 1,000,000)
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (request.getLoanAmount() == null) {</span>
<span class="fc" id="L70">            throw new InvalidApplicationException(&quot;Loan amount is required&quot;);</span>
        }
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (request.getLoanAmount().compareTo(BigDecimal.valueOf(100)) &lt; 0) {</span>
<span class="fc" id="L73">            throw new InvalidApplicationException(&quot;Loan amount must be at least 100&quot;);</span>
        }
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (request.getLoanAmount().compareTo(BigDecimal.valueOf(1000000)) &gt; 0) {</span>
<span class="fc" id="L76">            throw new InvalidApplicationException(&quot;Loan amount cannot exceed 1,000,000&quot;);</span>
        }

        // Validate loan term (6 - 360 months)
<span class="fc bfc" id="L80" title="All 2 branches covered.">        if (request.getLoanTermMonths() == null) {</span>
<span class="fc" id="L81">            throw new InvalidApplicationException(&quot;Loan term is required&quot;);</span>
        }
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (request.getLoanTermMonths() &lt; 6) {</span>
<span class="fc" id="L84">            throw new InvalidApplicationException(&quot;Loan term must be at least 6 months&quot;);</span>
        }
<span class="fc bfc" id="L86" title="All 2 branches covered.">        if (request.getLoanTermMonths() &gt; 360) {</span>
<span class="fc" id="L87">            throw new InvalidApplicationException(&quot;Loan term cannot exceed 360 months&quot;);</span>
        }

        try {
            // Create application
<span class="fc" id="L92">            Application application = Application.builder()</span>
<span class="fc" id="L93">                    .borrowerId(borrowerId)</span>
<span class="fc" id="L94">                    .loanType(request.getLoanType())</span>
<span class="fc" id="L95">                    .loanAmount(request.getLoanAmount())</span>
<span class="fc" id="L96">                    .loanTermMonths(request.getLoanTermMonths())</span>
<span class="fc" id="L97">                    .currency(request.getCurrency())</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">                    .ratePreference(request.getRatePreference() != null ? request.getRatePreference() : &quot;VARIABLE&quot;)</span>
<span class="fc" id="L99">                    .status(ApplicationStatus.DRAFT)</span>
<span class="fc" id="L100">                    .build();</span>

<span class="fc" id="L102">            application = applicationRepository.save(application);</span>
            // Flush and reload to ensure @CreationTimestamp is populated by database
<span class="fc" id="L104">            applicationRepository.flush();</span>
            // Use Java Optional API to handle the reload safely
<span class="fc" id="L106">            UUID appId = application.getId();</span>
<span class="fc" id="L107">            application = applicationRepository.findById(appId)</span>
<span class="pc" id="L108">                    .orElseThrow(() -&gt; new ApplicationCreationException(&quot;Failed to retrieve saved application&quot;));</span>

            // Audit event logged via @BusinessAudit annotation
<span class="fc" id="L111">            log.info(&quot;Application created: {} for borrower: {}&quot;, application.getId(), borrowerId);</span>
<span class="fc" id="L112">            return mapToDTO(application);</span>
            
<span class="nc" id="L114">        } catch (Exception e) {</span>
<span class="nc" id="L115">            log.error(&quot;Failed to create application for borrower: {}&quot;, borrowerId, e);</span>
<span class="nc" id="L116">            throw new ApplicationCreationException(&quot;Failed to create application&quot;, e);</span>
        }
    }

    /**
     * Get an application by ID for a specific borrower.
     */
    public ApplicationDTO getApplication(UUID applicationId, UUID borrowerId) {
<span class="fc" id="L124">        Application application = applicationRepository.findById(applicationId)</span>
<span class="fc" id="L125">                .orElseThrow(() -&gt; new ApplicationNotFoundException(</span>
                        &quot;Application not found: &quot; + applicationId));

        // Verify borrower owns the application
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="fc" id="L130">            throw new ApplicationNotFoundException(</span>
                    &quot;Access denied to application: &quot; + applicationId);
        }

<span class="fc" id="L134">        return mapToDTO(application);</span>
    }

    /**
     * Get application status history.
     */
    public List&lt;ApplicationHistoryDTO&gt; getApplicationHistory(UUID applicationId, UUID borrowerId) {
        // Verify borrower owns the application
<span class="fc" id="L142">        Application application = applicationRepository.findById(applicationId)</span>
<span class="fc" id="L143">                .orElseThrow(() -&gt; new ApplicationNotFoundException(</span>
                        &quot;Application not found: &quot; + applicationId));

<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="fc" id="L147">            throw new ApplicationNotFoundException(</span>
                    &quot;Access denied to application: &quot; + applicationId);
        }

<span class="fc" id="L151">        return applicationHistoryRepository</span>
<span class="fc" id="L152">                .findByApplicationIdOrderByChangedAtDesc(applicationId)</span>
<span class="fc" id="L153">                .stream()</span>
<span class="fc" id="L154">                .map(this::mapHistoryToDTO)</span>
<span class="fc" id="L155">                .collect(Collectors.toList());</span>
    }

    /**
     * Get application status history with pagination.
     */
    public Page&lt;ApplicationHistoryDTO&gt; getApplicationHistory(UUID applicationId, UUID borrowerId, Pageable pageable) {
        // Verify borrower owns the application
<span class="fc" id="L163">        Application application = applicationRepository.findById(applicationId)</span>
<span class="pc" id="L164">                .orElseThrow(() -&gt; new ApplicationNotFoundException(</span>
                        &quot;Application not found: &quot; + applicationId));

<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="nc" id="L168">            throw new ApplicationNotFoundException(</span>
                    &quot;Access denied to application: &quot; + applicationId);
        }

<span class="fc" id="L172">        Page&lt;ApplicationHistory&gt; historyPage = applicationHistoryRepository</span>
<span class="fc" id="L173">                .findByApplicationIdOrderByChangedAtDesc(applicationId, pageable);</span>
        
<span class="fc" id="L175">        return historyPage.map(this::mapHistoryToDTO);</span>
    }

    /**
     * List applications for a borrower with pagination.
     */
    public Page&lt;ApplicationDTO&gt; listApplicationsByBorrower(UUID borrowerId, Pageable pageable) {
<span class="fc" id="L182">        return applicationRepository.findByBorrowerId(borrowerId, pageable)</span>
<span class="fc" id="L183">                .map(this::mapToDTO);</span>
    }

    /**
     * Submit an application for underwriting review (transition DRAFT -&gt; SUBMITTED).
     */
    @BusinessAudit(action = AuditAction.APPLICATION_SUBMITTED, entityType = &quot;Application&quot;)
    public SubmitApplicationResponse submitApplication(UUID applicationId, UUID borrowerId) {
        // Verify borrower owns the application
<span class="fc" id="L192">        Application application = applicationRepository.findById(applicationId)</span>
<span class="fc" id="L193">                .orElseThrow(() -&gt; new ApplicationNotFoundException(</span>
                        &quot;Application not found: &quot; + applicationId));

<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="fc" id="L197">            throw new ApplicationNotFoundException(</span>
                    &quot;Access denied to application: &quot; + applicationId);
        }

        // Verify application is in DRAFT status
<span class="fc bfc" id="L202" title="All 2 branches covered.">        if (application.getStatus() != ApplicationStatus.DRAFT) {</span>
<span class="fc" id="L203">            throw new ApplicationAlreadySubmittedException(</span>
<span class="fc" id="L204">                    &quot;Application is already in &quot; + application.getStatus() + &quot; status. Only DRAFT applications can be submitted.&quot;);</span>
        }

        // Validate required consents before submission (GDPR compliance)
<span class="fc" id="L208">        validateRequiredConsents(borrowerId);</span>

        // Validate required fields
<span class="fc" id="L211">        List&lt;String&gt; missingFields = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L212" title="1 of 4 branches missed.">        if (application.getLoanType() == null || application.getLoanType().isEmpty()) {</span>
<span class="fc" id="L213">            missingFields.add(&quot;loanType&quot;);</span>
        }
<span class="fc bfc" id="L215" title="All 2 branches covered.">        if (application.getLoanAmount() == null) {</span>
<span class="fc" id="L216">            missingFields.add(&quot;loanAmount&quot;);</span>
        }
<span class="fc bfc" id="L218" title="All 2 branches covered.">        if (application.getLoanTermMonths() == null) {</span>
<span class="fc" id="L219">            missingFields.add(&quot;loanTermMonths&quot;);</span>
        }
<span class="pc bpc" id="L221" title="1 of 4 branches missed.">        if (application.getCurrency() == null || application.getCurrency().isEmpty()) {</span>
<span class="fc" id="L222">            missingFields.add(&quot;currency&quot;);</span>
        }

<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (!missingFields.isEmpty()) {</span>
<span class="fc" id="L226">            throw new SubmissionValidationException(</span>
<span class="fc" id="L227">                    &quot;Required fields missing: &quot; + String.join(&quot;, &quot;, missingFields),</span>
                    missingFields);
        }

        // Update status to SUBMITTED
<span class="fc" id="L232">        application.setStatus(ApplicationStatus.SUBMITTED);</span>
<span class="fc" id="L233">        application.setSubmittedAt(LocalDateTime.now());</span>
        
        try {
<span class="fc" id="L236">            application = applicationRepository.save(application);</span>

            // Record history entry
<span class="fc" id="L239">            ApplicationHistory history = ApplicationHistory.builder()</span>
<span class="fc" id="L240">                    .applicationId(applicationId)</span>
<span class="fc" id="L241">                    .oldStatus(ApplicationStatus.DRAFT)</span>
<span class="fc" id="L242">                    .newStatus(ApplicationStatus.SUBMITTED)</span>
<span class="fc" id="L243">                    .changedAt(LocalDateTime.now())</span>
<span class="fc" id="L244">                    .changeReason(&quot;Application submitted&quot;)</span>
<span class="fc" id="L245">                    .build();</span>
<span class="fc" id="L246">            applicationHistoryRepository.save(history);</span>

<span class="fc" id="L248">            log.info(&quot;Application submitted: {} by borrower: {}&quot;, applicationId, borrowerId);</span>

            // Queue email notification for borrower (APPLICATION_SUBMITTED)
            try {
<span class="fc" id="L252">                final Application appFinal = application;</span>
<span class="fc" id="L253">                java.util.Optional&lt;com.creditapp.shared.model.User&gt; borrowerOpt = userRepository.findById(borrowerId);</span>
<span class="fc" id="L254">                borrowerOpt.ifPresent(borrower -&gt; {</span>
<span class="fc" id="L255">                    String subject = &quot;Application Submitted&quot;;</span>
<span class="fc" id="L256">                    String message = String.format(</span>
                        &quot;Dear %s, your loan application for %s %s has been submitted successfully. Application ID: %s&quot;,
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">                        borrower.getFirstName() != null ? borrower.getFirstName() : &quot;&quot;,</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                        appFinal.getLoanAmount() != null ? appFinal.getLoanAmount().toPlainString() : &quot;&quot;,</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">                        appFinal.getCurrency() != null ? appFinal.getCurrency() : &quot;&quot;,</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">                        appFinal.getId() != null ? appFinal.getId().toString() : &quot;&quot;</span>
                    );
<span class="fc" id="L263">                    notificationService.createNotification(</span>
                        borrowerId,
<span class="fc" id="L265">                        appFinal.getId(),</span>
                        com.creditapp.shared.model.NotificationType.APPLICATION_SUBMITTED,
                        subject,
                        message
                    );
<span class="fc" id="L270">                });</span>
<span class="nc" id="L271">            } catch (Exception notifyEx) {</span>
<span class="nc" id="L272">                log.warn(&quot;Failed to create APPLICATION_SUBMITTED notification for application {}: {}&quot;,</span>
<span class="nc" id="L273">                        application.getId(), notifyEx.getMessage());</span>
<span class="fc" id="L274">            }</span>

            // Trigger async offer calculation for all active banks
            try {
<span class="fc" id="L278">                log.info(&quot;Triggering async offer calculation for application: {}&quot;, application.getId());</span>
<span class="fc" id="L279">                offerCalculationService.calculateOffers(application.getId());</span>
<span class="fc" id="L280">            } catch (Exception calcEx) {</span>
<span class="fc" id="L281">                log.error(&quot;Failed to trigger offer calculation for application {}: {}&quot;,</span>
<span class="fc" id="L282">                        application.getId(), calcEx.getMessage(), calcEx);</span>
                // Don't fail submission if calculation trigger fails - calculation can be retried
<span class="fc" id="L284">            }</span>

<span class="fc" id="L286">            return SubmitApplicationResponse.builder()</span>
<span class="fc" id="L287">                    .id(application.getId())</span>
<span class="fc" id="L288">                    .loanType(application.getLoanType())</span>
<span class="fc" id="L289">                    .loanAmount(application.getLoanAmount())</span>
<span class="fc" id="L290">                    .loanTermMonths(application.getLoanTermMonths())</span>
<span class="fc" id="L291">                    .currency(application.getCurrency())</span>
<span class="fc" id="L292">                    .ratePreference(application.getRatePreference())</span>
<span class="fc" id="L293">                    .status(application.getStatus().toString())</span>
<span class="fc" id="L294">                    .submittedAt(application.getSubmittedAt())</span>
<span class="fc" id="L295">                    .createdAt(application.getCreatedAt())</span>
<span class="fc" id="L296">                    .version(application.getVersion())</span>
<span class="fc" id="L297">                    .message(&quot;Application submitted successfully. Banks will review and contact you with offers.&quot;)</span>
<span class="fc" id="L298">                    .build();</span>
                    
<span class="nc" id="L300">        } catch (Exception e) {</span>
<span class="nc" id="L301">            log.error(&quot;Failed to submit application: {}&quot;, applicationId, e);</span>
<span class="nc" id="L302">            throw new ApplicationCreationException(&quot;Failed to submit application&quot;, e);</span>
        }
    }

    /**
     * Update an existing DRAFT application.
     */
    @BusinessAudit(action = AuditAction.APPLICATION_UPDATED, entityType = &quot;Application&quot;)
    public UpdateApplicationResponse updateApplication(UUID applicationId, UUID borrowerId, UpdateApplicationRequest request) {
        // Verify borrower owns the application
<span class="fc" id="L312">        Application application = applicationRepository.findById(applicationId)</span>
<span class="fc" id="L313">                .orElseThrow(() -&gt; new ApplicationNotFoundException(</span>
                        &quot;Application not found: &quot; + applicationId));

<span class="fc bfc" id="L316" title="All 2 branches covered.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="fc" id="L317">            throw new ApplicationNotFoundException(</span>
                    &quot;Access denied to application: &quot; + applicationId);
        }

        // Verify application is in DRAFT status
<span class="fc bfc" id="L322" title="All 2 branches covered.">        if (application.getStatus() != ApplicationStatus.DRAFT) {</span>
<span class="fc" id="L323">            throw new ApplicationNotEditableException(</span>
<span class="fc" id="L324">                    &quot;Cannot edit application in &quot; + application.getStatus() + &quot; status. Only DRAFT applications can be edited.&quot;);</span>
        }

        // Track old values for audit
<span class="fc" id="L328">        List&lt;String&gt; editedFields = new ArrayList&lt;&gt;();</span>
        
        // Validate and update loan amount if provided
<span class="fc bfc" id="L331" title="All 2 branches covered.">        if (request.getLoanAmount() != null) {</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">            if (request.getLoanAmount().compareTo(BigDecimal.valueOf(100)) &lt; 0) {</span>
<span class="fc" id="L333">                throw new InvalidApplicationException(&quot;Loan amount must be at least 100&quot;);</span>
            }
<span class="fc bfc" id="L335" title="All 2 branches covered.">            if (request.getLoanAmount().compareTo(BigDecimal.valueOf(1000000)) &gt; 0) {</span>
<span class="fc" id="L336">                throw new InvalidApplicationException(&quot;Loan amount cannot exceed 1,000,000&quot;);</span>
            }
<span class="fc bfc" id="L338" title="All 2 branches covered.">            if (!request.getLoanAmount().equals(application.getLoanAmount())) {</span>
<span class="fc" id="L339">                application.setLoanAmount(request.getLoanAmount());</span>
<span class="fc" id="L340">                editedFields.add(&quot;loanAmount&quot;);</span>
            }
        }

        // Validate and update loan term if provided
<span class="fc bfc" id="L345" title="All 2 branches covered.">        if (request.getLoanTermMonths() != null) {</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">            if (request.getLoanTermMonths() &lt; 6) {</span>
<span class="fc" id="L347">                throw new InvalidApplicationException(&quot;Loan term must be at least 6 months&quot;);</span>
            }
<span class="fc bfc" id="L349" title="All 2 branches covered.">            if (request.getLoanTermMonths() &gt; 360) {</span>
<span class="fc" id="L350">                throw new InvalidApplicationException(&quot;Loan term cannot exceed 360 months&quot;);</span>
            }
<span class="fc bfc" id="L352" title="All 2 branches covered.">            if (!request.getLoanTermMonths().equals(application.getLoanTermMonths())) {</span>
<span class="fc" id="L353">                application.setLoanTermMonths(request.getLoanTermMonths());</span>
<span class="fc" id="L354">                editedFields.add(&quot;loanTermMonths&quot;);</span>
            }
        }

        // Update other fields if provided
<span class="fc bfc" id="L359" title="All 4 branches covered.">        if (request.getLoanType() != null &amp;&amp; !request.getLoanType().equals(application.getLoanType())) {</span>
<span class="fc" id="L360">            application.setLoanType(request.getLoanType());</span>
<span class="fc" id="L361">            editedFields.add(&quot;loanType&quot;);</span>
        }

<span class="fc bfc" id="L364" title="All 4 branches covered.">        if (request.getCurrency() != null &amp;&amp; !request.getCurrency().equals(application.getCurrency())) {</span>
<span class="fc" id="L365">            application.setCurrency(request.getCurrency());</span>
<span class="fc" id="L366">            editedFields.add(&quot;currency&quot;);</span>
        }

<span class="fc bfc" id="L369" title="All 4 branches covered.">        if (request.getRatePreference() != null &amp;&amp; !request.getRatePreference().equals(application.getRatePreference())) {</span>
<span class="fc" id="L370">            application.setRatePreference(request.getRatePreference());</span>
<span class="fc" id="L371">            editedFields.add(&quot;ratePreference&quot;);</span>
        }

        // Update application details if provided
<span class="fc bfc" id="L375" title="All 2 branches covered.">        if (request.getApplicationDetails() != null) {</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">            if (application.getDetails() == null) {</span>
<span class="fc" id="L377">                application.setDetails(com.creditapp.borrower.model.ApplicationDetails.builder()</span>
<span class="fc" id="L378">                        .applicationId(application.getId())</span>
<span class="fc" id="L379">                        .build());</span>
            }
            
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">            if (request.getApplicationDetails().getAnnualIncome() != null) {</span>
<span class="fc" id="L383">                application.getDetails().setAnnualIncome(request.getApplicationDetails().getAnnualIncome());</span>
<span class="fc" id="L384">                editedFields.add(&quot;annualIncome&quot;);</span>
            }
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">            if (request.getApplicationDetails().getEmploymentStatus() != null) {</span>
<span class="fc" id="L387">                application.getDetails().setEmploymentStatus(request.getApplicationDetails().getEmploymentStatus());</span>
<span class="fc" id="L388">                editedFields.add(&quot;employmentStatus&quot;);</span>
            }
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">            if (request.getApplicationDetails().getDownPaymentAmount() != null) {</span>
<span class="fc" id="L391">                application.getDetails().setDownPaymentAmount(request.getApplicationDetails().getDownPaymentAmount());</span>
<span class="fc" id="L392">                editedFields.add(&quot;downPaymentAmount&quot;);</span>
            }
        }

        try {
            // Save application (JPA will increment version)
<span class="fc" id="L398">            application = applicationRepository.save(application);</span>
            
<span class="fc" id="L400">            log.info(&quot;Application updated: {} by borrower: {}, fields changed: {}&quot;, </span>
                    applicationId, borrowerId, editedFields);

<span class="fc" id="L403">            return UpdateApplicationResponse.builder()</span>
<span class="fc" id="L404">                    .id(application.getId())</span>
<span class="fc" id="L405">                    .loanType(application.getLoanType())</span>
<span class="fc" id="L406">                    .loanAmount(application.getLoanAmount())</span>
<span class="fc" id="L407">                    .loanTermMonths(application.getLoanTermMonths())</span>
<span class="fc" id="L408">                    .currency(application.getCurrency())</span>
<span class="fc" id="L409">                    .ratePreference(application.getRatePreference())</span>
<span class="fc" id="L410">                    .status(application.getStatus().toString())</span>
<span class="fc" id="L411">                    .version(application.getVersion())</span>
<span class="fc" id="L412">                    .updatedAt(application.getUpdatedAt())</span>
<span class="fc" id="L413">                    .editedFields(editedFields)</span>
<span class="fc" id="L414">                    .build();</span>
                    
<span class="fc" id="L416">        } catch (ObjectOptimisticLockingFailureException e) {</span>
            // Application was modified by another request
<span class="fc" id="L418">            Application current = applicationRepository.findById(applicationId)</span>
<span class="pc" id="L419">                    .orElseThrow(() -&gt; new ApplicationNotFoundException(&quot;Application not found: &quot; + applicationId));</span>
<span class="fc" id="L420">            throw new ApplicationStaleException(</span>
                    &quot;Application was modified by another request. Please refresh and try again.&quot;, 
<span class="fc" id="L422">                    current.getVersion());</span>
<span class="nc" id="L423">        } catch (Exception e) {</span>
<span class="nc" id="L424">            log.error(&quot;Failed to update application: {}&quot;, applicationId, e);</span>
<span class="nc" id="L425">            throw new ApplicationCreationException(&quot;Failed to update application&quot;, e);</span>
        }
    }

    private ApplicationDTO mapToDTO(Application application) {
<span class="fc" id="L430">        return ApplicationDTO.builder()</span>
<span class="fc" id="L431">                .id(application.getId())</span>
<span class="fc" id="L432">                .loanType(application.getLoanType())</span>
<span class="fc" id="L433">                .loanAmount(application.getLoanAmount())</span>
<span class="fc" id="L434">                .loanTermMonths(application.getLoanTermMonths())</span>
<span class="fc" id="L435">                .currency(application.getCurrency())</span>
<span class="fc" id="L436">                .ratePreference(application.getRatePreference())</span>
<span class="fc" id="L437">                .status(application.getStatus())</span>
<span class="fc" id="L438">                .createdAt(application.getCreatedAt())</span>
<span class="fc" id="L439">                .submittedAt(application.getSubmittedAt())</span>
<span class="fc" id="L440">                .updatedAt(application.getUpdatedAt())</span>
<span class="fc" id="L441">                .build();</span>
    }

    private ApplicationHistoryDTO mapHistoryToDTO(com.creditapp.borrower.model.ApplicationHistory history) {
<span class="fc" id="L445">        return ApplicationHistoryDTO.builder()</span>
<span class="fc" id="L446">                .oldStatus(history.getOldStatus())</span>
<span class="fc" id="L447">                .newStatus(history.getNewStatus())</span>
<span class="fc" id="L448">                .changedAt(history.getChangedAt())</span>
<span class="fc" id="L449">                .changedByUserId(history.getChangedByUserId())</span>
<span class="fc" id="L450">                .changeReason(history.getChangeReason())</span>
<span class="fc" id="L451">                .build();</span>
    }

    /**
     * Validate that required GDPR consents are given before application submission.
     * Requires: DATA_COLLECTION and BANK_SHARING consents.
     */
    private void validateRequiredConsents(UUID borrowerId) {
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">        if (!consentService.isConsentGiven(borrowerId, ConsentType.DATA_COLLECTION)) {</span>
<span class="nc" id="L460">            throw new SubmissionValidationException(</span>
                    &quot;Required consent missing: You must consent to data collection to submit an application.&quot;,
<span class="nc" id="L462">                    List.of(&quot;DATA_COLLECTION_CONSENT&quot;));</span>
        }
        
<span class="pc bpc" id="L465" title="1 of 2 branches missed.">        if (!consentService.isConsentGiven(borrowerId, ConsentType.BANK_SHARING)) {</span>
<span class="nc" id="L466">            throw new SubmissionValidationException(</span>
                    &quot;Required consent missing: You must consent to bank sharing to submit an application.&quot;,
<span class="nc" id="L468">                    List.of(&quot;BANK_SHARING_CONSENT&quot;));</span>
        }
        
<span class="fc" id="L471">        log.info(&quot;Consent validation passed for borrower: {}&quot;, borrowerId);</span>
<span class="fc" id="L472">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>