<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.borrower.service</a> &gt; <span class="el_source">ApplicationService.java</span></div><h1>ApplicationService.java</h1><pre class="source lang-java linenums">package com.creditapp.borrower.service;

import com.creditapp.borrower.dto.ApplicationDTO;
import com.creditapp.borrower.dto.ApplicationHistoryDTO;
import com.creditapp.borrower.dto.CreateApplicationRequest;
import com.creditapp.borrower.exception.ApplicationCreationException;
import com.creditapp.borrower.exception.ApplicationNotFoundException;
import com.creditapp.borrower.exception.InvalidApplicationException;
import com.creditapp.borrower.model.Application;
import com.creditapp.borrower.model.ApplicationStatus;
import com.creditapp.borrower.repository.ApplicationHistoryRepository;
import com.creditapp.borrower.repository.ApplicationRepository;
import com.creditapp.shared.audit.BusinessAudit;
import com.creditapp.shared.model.AuditAction;
import com.creditapp.shared.service.AuditService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

/**
 * Service for application operations.
 */
@Service
<span class="fc" id="L31">@RequiredArgsConstructor</span>
<span class="fc" id="L32">@Slf4j</span>
public class ApplicationService {

    private final ApplicationRepository applicationRepository;
    private final ApplicationHistoryRepository applicationHistoryRepository;
    private final AuditService auditService;

    /**
     * Create a new application in DRAFT status.
     */
    @BusinessAudit(action = AuditAction.APPLICATION_CREATED, entityType = &quot;Application&quot;)
    public ApplicationDTO createApplication(UUID borrowerId, CreateApplicationRequest request) {
        // Validate loan amount (100 - 1,000,000)
<span class="fc bfc" id="L45" title="All 2 branches covered.">        if (request.getLoanAmount() == null) {</span>
<span class="fc" id="L46">            throw new InvalidApplicationException(&quot;Loan amount is required&quot;);</span>
        }
<span class="fc bfc" id="L48" title="All 2 branches covered.">        if (request.getLoanAmount().compareTo(BigDecimal.valueOf(100)) &lt; 0) {</span>
<span class="fc" id="L49">            throw new InvalidApplicationException(&quot;Loan amount must be at least 100&quot;);</span>
        }
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (request.getLoanAmount().compareTo(BigDecimal.valueOf(1000000)) &gt; 0) {</span>
<span class="fc" id="L52">            throw new InvalidApplicationException(&quot;Loan amount cannot exceed 1,000,000&quot;);</span>
        }

        // Validate loan term (6 - 360 months)
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (request.getLoanTermMonths() == null) {</span>
<span class="fc" id="L57">            throw new InvalidApplicationException(&quot;Loan term is required&quot;);</span>
        }
<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (request.getLoanTermMonths() &lt; 6) {</span>
<span class="fc" id="L60">            throw new InvalidApplicationException(&quot;Loan term must be at least 6 months&quot;);</span>
        }
<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (request.getLoanTermMonths() &gt; 360) {</span>
<span class="fc" id="L63">            throw new InvalidApplicationException(&quot;Loan term cannot exceed 360 months&quot;);</span>
        }

        try {
            // Create application
<span class="fc" id="L68">            Application application = Application.builder()</span>
<span class="fc" id="L69">                    .borrowerId(borrowerId)</span>
<span class="fc" id="L70">                    .loanType(request.getLoanType())</span>
<span class="fc" id="L71">                    .loanAmount(request.getLoanAmount())</span>
<span class="fc" id="L72">                    .loanTermMonths(request.getLoanTermMonths())</span>
<span class="fc" id="L73">                    .currency(request.getCurrency())</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">                    .ratePreference(request.getRatePreference() != null ? request.getRatePreference() : &quot;VARIABLE&quot;)</span>
<span class="fc" id="L75">                    .status(ApplicationStatus.DRAFT)</span>
<span class="fc" id="L76">                    .build();</span>

<span class="fc" id="L78">            application = applicationRepository.save(application);</span>

            // Audit event logged via @BusinessAudit annotation
<span class="fc" id="L81">            log.info(&quot;Application created: {} for borrower: {}&quot;, application.getId(), borrowerId);</span>
<span class="fc" id="L82">            return mapToDTO(application);</span>
            
<span class="nc" id="L84">        } catch (Exception e) {</span>
<span class="nc" id="L85">            log.error(&quot;Failed to create application for borrower: {}&quot;, borrowerId, e);</span>
<span class="nc" id="L86">            throw new ApplicationCreationException(&quot;Failed to create application&quot;, e);</span>
        }
    }

    /**
     * Get an application by ID for a specific borrower.
     */
    public ApplicationDTO getApplication(UUID applicationId, UUID borrowerId) {
<span class="nc" id="L94">        Application application = applicationRepository.findById(applicationId)</span>
<span class="nc" id="L95">                .orElseThrow(() -&gt; new ApplicationNotFoundException(</span>
                        &quot;Application not found: &quot; + applicationId));

        // Verify borrower owns the application
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="nc" id="L100">            throw new ApplicationNotFoundException(</span>
                    &quot;Access denied to application: &quot; + applicationId);
        }

<span class="nc" id="L104">        return mapToDTO(application);</span>
    }

    /**
     * Get application status history.
     */
    public List&lt;ApplicationHistoryDTO&gt; getApplicationHistory(UUID applicationId, UUID borrowerId) {
        // Verify borrower owns the application
<span class="nc" id="L112">        Application application = applicationRepository.findById(applicationId)</span>
<span class="nc" id="L113">                .orElseThrow(() -&gt; new ApplicationNotFoundException(</span>
                        &quot;Application not found: &quot; + applicationId));

<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="nc" id="L117">            throw new ApplicationNotFoundException(</span>
                    &quot;Access denied to application: &quot; + applicationId);
        }

<span class="nc" id="L121">        return applicationHistoryRepository</span>
<span class="nc" id="L122">                .findByApplicationIdOrderByChangedAtDesc(applicationId)</span>
<span class="nc" id="L123">                .stream()</span>
<span class="nc" id="L124">                .map(this::mapHistoryToDTO)</span>
<span class="nc" id="L125">                .collect(Collectors.toList());</span>
    }

    /**
     * List applications for a borrower with pagination.
     */
    public Page&lt;ApplicationDTO&gt; listApplicationsByBorrower(UUID borrowerId, Pageable pageable) {
<span class="nc" id="L132">        return applicationRepository.findByBorrowerId(borrowerId, pageable)</span>
<span class="nc" id="L133">                .map(this::mapToDTO);</span>
    }

    private ApplicationDTO mapToDTO(Application application) {
<span class="fc" id="L137">        return ApplicationDTO.builder()</span>
<span class="fc" id="L138">                .id(application.getId())</span>
<span class="fc" id="L139">                .loanType(application.getLoanType())</span>
<span class="fc" id="L140">                .loanAmount(application.getLoanAmount())</span>
<span class="fc" id="L141">                .loanTermMonths(application.getLoanTermMonths())</span>
<span class="fc" id="L142">                .currency(application.getCurrency())</span>
<span class="fc" id="L143">                .ratePreference(application.getRatePreference())</span>
<span class="fc" id="L144">                .status(application.getStatus())</span>
<span class="fc" id="L145">                .createdAt(application.getCreatedAt())</span>
<span class="fc" id="L146">                .submittedAt(application.getSubmittedAt())</span>
<span class="fc" id="L147">                .updatedAt(application.getUpdatedAt())</span>
<span class="fc" id="L148">                .build();</span>
    }

    private ApplicationHistoryDTO mapHistoryToDTO(com.creditapp.borrower.model.ApplicationHistory history) {
<span class="nc" id="L152">        return ApplicationHistoryDTO.builder()</span>
<span class="nc" id="L153">                .oldStatus(history.getOldStatus())</span>
<span class="nc" id="L154">                .newStatus(history.getNewStatus())</span>
<span class="nc" id="L155">                .changedAt(history.getChangedAt())</span>
<span class="nc" id="L156">                .changedByUserId(history.getChangedByUserId())</span>
<span class="nc" id="L157">                .changeReason(history.getChangeReason())</span>
<span class="nc" id="L158">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>