<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OfferInsightsService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Credit Application Platform</a> &gt; <a href="index.source.html" class="el_package">com.creditapp.borrower.service</a> &gt; <span class="el_source">OfferInsightsService.java</span></div><h1>OfferInsightsService.java</h1><pre class="source lang-java linenums">package com.creditapp.borrower.service;

import com.creditapp.bank.model.Offer;
import com.creditapp.bank.repository.OfferRepository;
import com.creditapp.borrower.dto.OfferInsightsDTO;
import com.creditapp.borrower.dto.OfferSummaryDTO;
import com.creditapp.borrower.dto.SavingsAnalysisDTO;
import com.creditapp.borrower.exception.ApplicationNotFoundException;
import com.creditapp.borrower.repository.ApplicationRepository;
import com.creditapp.shared.model.Organization;
import com.creditapp.shared.repository.OrganizationRepository;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.function.Function;
import java.util.stream.Collectors;

@Service
public class OfferInsightsService {

    private final OfferRepository offerRepository;
    private final ApplicationRepository applicationRepository;
    private final OrganizationRepository organizationRepository;

<span class="fc" id="L30">    public OfferInsightsService(OfferRepository offerRepository, </span>
                               ApplicationRepository applicationRepository,
                               OrganizationRepository organizationRepository) {
<span class="fc" id="L33">        this.offerRepository = offerRepository;</span>
<span class="fc" id="L34">        this.applicationRepository = applicationRepository;</span>
<span class="fc" id="L35">        this.organizationRepository = organizationRepository;</span>
<span class="fc" id="L36">    }</span>

    public OfferInsightsDTO calculateInsights(UUID applicationId, UUID borrowerId) {
        // Verify borrower owns the application
<span class="fc" id="L40">        var application = applicationRepository.findById(applicationId)</span>
<span class="fc" id="L41">                .orElseThrow(() -&gt; new ApplicationNotFoundException(&quot;Application not found&quot;));</span>
        
<span class="fc bfc" id="L43" title="All 2 branches covered.">        if (!application.getBorrowerId().equals(borrowerId)) {</span>
<span class="fc" id="L44">            throw new IllegalArgumentException(&quot;Cannot access another borrower's application&quot;);</span>
        }

        // Fetch all offers for the application
<span class="fc" id="L48">        List&lt;Offer&gt; offers = offerRepository.findByApplicationId(applicationId);</span>

        // Need at least 2 offers for meaningful insights
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (offers.size() &lt; 2) {</span>
<span class="fc" id="L52">            return null; // Controller will return 204 No Content</span>
        }

        // Get bank names for offers
<span class="fc" id="L56">        Map&lt;UUID, String&gt; bankNames = getBankNames(offers);</span>

        // Find best offers
<span class="fc" id="L59">        Offer bestAprOffer = offers.stream()</span>
<span class="fc" id="L60">                .min(Comparator.comparing(Offer::getApr))</span>
<span class="fc" id="L61">                .orElseThrow();</span>
        
<span class="fc" id="L63">        Offer lowestMonthlyPaymentOffer = offers.stream()</span>
<span class="fc" id="L64">                .min(Comparator.comparing(Offer::getMonthlyPayment))</span>
<span class="fc" id="L65">                .orElseThrow();</span>
        
<span class="fc" id="L67">        Offer lowestTotalCostOffer = offers.stream()</span>
<span class="fc" id="L68">                .min(Comparator.comparing(Offer::getTotalCost))</span>
<span class="fc" id="L69">                .orElseThrow();</span>

        // Calculate average APR
<span class="fc" id="L72">        BigDecimal averageApr = offers.stream()</span>
<span class="fc" id="L73">                .map(Offer::getApr)</span>
<span class="fc" id="L74">                .reduce(BigDecimal.ZERO, BigDecimal::add)</span>
<span class="fc" id="L75">                .divide(BigDecimal.valueOf(offers.size()), 2, RoundingMode.HALF_UP);</span>

        // Calculate APR spread
<span class="fc" id="L78">        BigDecimal maxApr = offers.stream()</span>
<span class="fc" id="L79">                .map(Offer::getApr)</span>
<span class="fc" id="L80">                .max(BigDecimal::compareTo)</span>
<span class="fc" id="L81">                .orElse(BigDecimal.ZERO);</span>
<span class="fc" id="L82">        BigDecimal minApr = offers.stream()</span>
<span class="fc" id="L83">                .map(Offer::getApr)</span>
<span class="fc" id="L84">                .min(BigDecimal::compareTo)</span>
<span class="fc" id="L85">                .orElse(BigDecimal.ZERO);</span>
<span class="fc" id="L86">        BigDecimal aprSpread = maxApr.subtract(minApr);</span>

        // Calculate recommended offer (highest weighted score)
<span class="fc" id="L89">        UUID recommendedOfferId = calculateRecommendedOffer(offers);</span>

        // Calculate savings analysis
<span class="fc" id="L92">        SavingsAnalysisDTO savingsAnalysis = calculateSavings(offers, bankNames);</span>

        // Convert to DTOs
<span class="fc" id="L95">        OfferSummaryDTO bestAprDTO = toSummaryDTO(bestAprOffer, bankNames.get(bestAprOffer.getBankId()));</span>
<span class="fc" id="L96">        OfferSummaryDTO lowestMonthlyPaymentDTO = toSummaryDTO(lowestMonthlyPaymentOffer, </span>
<span class="fc" id="L97">                                                                bankNames.get(lowestMonthlyPaymentOffer.getBankId()));</span>
<span class="fc" id="L98">        OfferSummaryDTO lowestTotalCostDTO = toSummaryDTO(lowestTotalCostOffer, </span>
<span class="fc" id="L99">                                                            bankNames.get(lowestTotalCostOffer.getBankId()));</span>

<span class="fc" id="L101">        return new OfferInsightsDTO(</span>
<span class="fc" id="L102">                bestAprDTO,</span>
<span class="fc" id="L103">                lowestMonthlyPaymentDTO,</span>
<span class="fc" id="L104">                lowestTotalCostDTO,</span>
<span class="fc" id="L105">                averageApr,</span>
<span class="fc" id="L106">                aprSpread,</span>
<span class="fc" id="L107">                recommendedOfferId,</span>
<span class="fc" id="L108">                savingsAnalysis</span>
        );
    }

    public UUID calculateRecommendedOffer(List&lt;Offer&gt; offers) {
        // Weighted scoring: APR (40%), monthly payment (30%), total cost (20%), processing time (10%)
<span class="fc" id="L114">        return offers.stream()</span>
<span class="fc" id="L115">                .max(Comparator.comparing(offer -&gt; calculateScore(offer, offers)))</span>
<span class="fc" id="L116">                .map(Offer::getId)</span>
<span class="fc" id="L117">                .orElseThrow();</span>
    }

    private BigDecimal calculateScore(Offer offer, List&lt;Offer&gt; allOffers) {
        // Lower is better, so use 1/value for scoring
        // Normalize by finding min/max for each metric across all offers
        
<span class="fc" id="L124">        BigDecimal aprScore = BigDecimal.ONE.divide(offer.getApr(), 6, RoundingMode.HALF_UP)</span>
<span class="fc" id="L125">                .multiply(new BigDecimal(&quot;0.4&quot;));</span>
        
<span class="fc" id="L127">        BigDecimal monthlyPaymentScore = BigDecimal.ONE.divide(offer.getMonthlyPayment(), 6, RoundingMode.HALF_UP)</span>
<span class="fc" id="L128">                .multiply(new BigDecimal(&quot;0.3&quot;));</span>
        
<span class="fc" id="L130">        BigDecimal totalCostScore = BigDecimal.ONE.divide(offer.getTotalCost(), 6, RoundingMode.HALF_UP)</span>
<span class="fc" id="L131">                .multiply(new BigDecimal(&quot;0.2&quot;));</span>
        
<span class="fc" id="L133">        BigDecimal processingTimeScore = BigDecimal.ONE.divide(</span>
<span class="fc" id="L134">                        BigDecimal.valueOf(offer.getProcessingTimeDays()), 6, RoundingMode.HALF_UP)</span>
<span class="fc" id="L135">                .multiply(new BigDecimal(&quot;0.1&quot;));</span>

<span class="fc" id="L137">        return aprScore.add(monthlyPaymentScore).add(totalCostScore).add(processingTimeScore);</span>
    }

    public SavingsAnalysisDTO calculateSavings(List&lt;Offer&gt; offers, Map&lt;UUID, String&gt; bankNames) {
<span class="fc" id="L141">        Offer bestOffer = offers.stream()</span>
<span class="fc" id="L142">                .min(Comparator.comparing(Offer::getTotalCost))</span>
<span class="fc" id="L143">                .orElseThrow();</span>
        
<span class="fc" id="L145">        Offer worstOffer = offers.stream()</span>
<span class="fc" id="L146">                .max(Comparator.comparing(Offer::getTotalCost))</span>
<span class="fc" id="L147">                .orElseThrow();</span>

<span class="fc" id="L149">        BigDecimal savingsVsWorst = worstOffer.getTotalCost().subtract(bestOffer.getTotalCost());</span>

<span class="fc" id="L151">        BigDecimal averageTotalCost = offers.stream()</span>
<span class="fc" id="L152">                .map(Offer::getTotalCost)</span>
<span class="fc" id="L153">                .reduce(BigDecimal.ZERO, BigDecimal::add)</span>
<span class="fc" id="L154">                .divide(BigDecimal.valueOf(offers.size()), 2, RoundingMode.HALF_UP);</span>

<span class="fc" id="L156">        BigDecimal savingsVsAverage = averageTotalCost.subtract(bestOffer.getTotalCost());</span>

<span class="fc" id="L158">        String bestBankName = bankNames.getOrDefault(bestOffer.getBankId(), &quot;Best Offer&quot;);</span>
<span class="fc" id="L159">        String worstBankName = bankNames.getOrDefault(worstOffer.getBankId(), &quot;Highest Cost Offer&quot;);</span>

<span class="fc" id="L161">        String savingsMessage = String.format(</span>
<span class="fc" id="L162">                &quot;You could save $%,.2f by choosing %s over %s&quot;,</span>
<span class="fc" id="L163">                savingsVsWorst,</span>
<span class="fc" id="L164">                bestBankName,</span>
<span class="fc" id="L165">                worstBankName</span>
        );

<span class="fc" id="L168">        return new SavingsAnalysisDTO(</span>
<span class="fc" id="L169">                bestOffer.getId(),</span>
<span class="fc" id="L170">                savingsVsWorst,</span>
<span class="fc" id="L171">                savingsVsAverage,</span>
<span class="fc" id="L172">                savingsMessage</span>
        );
    }

    private Map&lt;UUID, String&gt; getBankNames(List&lt;Offer&gt; offers) {
<span class="fc" id="L177">        List&lt;UUID&gt; bankIds = offers.stream()</span>
<span class="fc" id="L178">                .map(Offer::getBankId)</span>
<span class="fc" id="L179">                .distinct()</span>
<span class="fc" id="L180">                .toList();</span>

<span class="fc" id="L182">        return organizationRepository.findAllById(bankIds).stream()</span>
<span class="fc" id="L183">                .collect(Collectors.toMap(Organization::getId, Organization::getName));</span>
    }

    private OfferSummaryDTO toSummaryDTO(Offer offer, String bankName) {
<span class="fc" id="L187">        return new OfferSummaryDTO(</span>
<span class="fc" id="L188">                offer.getId(),</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">                bankName != null ? bankName : &quot;Unknown Bank&quot;,</span>
<span class="fc" id="L190">                offer.getApr(),</span>
<span class="fc" id="L191">                offer.getMonthlyPayment(),</span>
<span class="fc" id="L192">                offer.getTotalCost()</span>
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>